<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>å–µå”æ²¡è¯è¯´</title>
    <link>//blog.betacat.io/</link>
    <description>Recent content on å–µå”æ²¡è¯è¯´</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>zh-cn</language>
    <lastBuildDate>Thu, 29 Aug 2019 10:17:24 +0800</lastBuildDate>
    
        <atom:link href="//blog.betacat.io/index.xml" rel="self" type="application/rss+xml" />
    
    
    <item>
      <title>About</title>
      <link>//blog.betacat.io/about/</link>
      <pubDate>Sat, 15 Dec 2018 23:04:52 +0800</pubDate>
      
      <guid>//blog.betacat.io/about/</guid>
      
        <description>

&lt;h1 id=&#34;å…³äºåšå®¢&#34;&gt;å…³äºåšå®¢&lt;/h1&gt;

&lt;p&gt;&lt;img src=&#34;//blog.betacat.io/image/information-is-power.jpg&#34; alt=&#34;Information is power&#34; /&gt;&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;Information is power. But like all power, there are those who want to keep it for themselves.&lt;/p&gt;

&lt;p&gt;&amp;mdash;&lt;cite&gt;Aaron Swartz&lt;/cite&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;è®¡ç®—æœºè¡Œä¸šæ›´æ–°æ¢ä»£å¤ªå¿«ï¼Œæ–°æŠ€æœ¯å±‚å‡ºä¸ç©·ã€‚åœ¨è¿½é€çƒ­ç‚¹çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘é€æ¸æœ‰äº†äº›ç§¯ç´¯ã€‚è¿™ä¸ªåšå®¢çš„ç›®çš„å°±æ˜¯å°†æˆ‘çš„ä¸€äº›ç§¯ç´¯åˆ†äº«å‡ºæ¥ï¼Œå¸Œæœ›èƒ½å‡è½»å¤§å®¶åœ¨å­¦ä¹ è¿‡ç¨‹ä¸­çš„è´Ÿæ‹…ã€‚å› æ­¤ï¼Œè¿™é‡Œçš„æ–‡ç« éƒ½å°†ä»¥æµ…æ˜¾æ˜“æ‡‚ä¸ºç›®æ ‡ï¼Œå°½é‡åšåˆ°ä»åˆå­¦è€…è§’åº¦è€ƒè™‘ï¼Œæƒ³ä¸€æƒ³å¦‚æœæˆ‘ä½œä¸ºä¸€ä¸ªåˆå­¦è€…ï¼Œåœ¨å­¦ä¹ ä¸€ä¸ªæ–°æŠ€æœ¯çš„æ—¶å€™ï¼Œæœ€å¸Œæœ›å¾—åˆ°çš„æŒ‡å¯¼æœ‰å“ªäº›ã€‚&lt;/p&gt;

&lt;h1 id=&#34;å…³äºæˆ‘&#34;&gt;å…³äºæˆ‘&lt;/h1&gt;

&lt;p&gt;éšç€å¹´çºªçš„å¢é•¿ï¼Œè¶Šæ¥è¶Šå¤šçš„å°æœ‹å‹å¼€å§‹å«æˆ‘å”å”ï¼Œå†åŠ ä¸Šæˆ‘å§“&lt;code&gt;ç¼ª(miÃ o)&lt;/code&gt;ï¼Œå› æ­¤å¾—å&lt;code&gt;å–µå”&lt;/code&gt;ã€‚&lt;/p&gt;

&lt;p&gt;ä½ å¯ä»¥é€šè¿‡é¡µé¢ä¸‹çš„ç¤¾äº¤åª’ä½“è”ç³»åˆ°æˆ‘ã€‚&lt;/p&gt;
</description>
      
    </item>
    
    <item>
      <title>è·Ÿ etcd å­¦ä¹ æ•°æ®åº“ä¸­äº‹åŠ¡éš”ç¦»çš„å®ç°</title>
      <link>//blog.betacat.io/post/2019/08/learn-transaction-isolation-levels-from-etcd/</link>
      <pubDate>Thu, 29 Aug 2019 10:17:24 +0800</pubDate>
      
      <guid>//blog.betacat.io/post/2019/08/learn-transaction-isolation-levels-from-etcd/</guid>
      
        <description>

&lt;p&gt;ä¼—æ‰€å‘¨çŸ¥ï¼Œetcd çš„æ•°æ®æ¨¡å‹æ˜¯å»ºç«‹åœ¨ MVCC åŸºç¡€ä¸Šçš„ï¼ˆå¦‚æœä½ ä¸çŸ¥ï¼Œé‚£ä¸€å®šæ˜¯æ²¡çœ‹è¿‡æˆ‘çš„&lt;a href=&#34;//blog.betacat.io/post/mvcc-implementation-in-etcd/&#34;&gt;è¿™ç¯‡åšå®¢&lt;/a&gt;ğŸ™ƒï¼‰ã€‚åœ¨å½“å‰çš„å®ç°ä¸­&lt;sup class=&#34;footnote-ref&#34; id=&#34;fnref:etcd-v3-3-10&#34;&gt;&lt;a href=&#34;#fn:etcd-v3-3-10&#34;&gt;1&lt;/a&gt;&lt;/sup&gt;ï¼Œetcd ä¸ä»…æä¾›äº†åŸå­æ€§çš„äº‹åŠ¡æ“ä½œï¼Œè¿˜å¯¹å¤–æš´éœ²äº†å®ç°è¿™äº›åŸå­æ“ä½œçš„ MVCC ç‰ˆæœ¬ä¿¡æ¯ã€‚è¦çŸ¥é“ï¼Œåœ¨å¤§éƒ¨åˆ†ä½¿ç”¨äº† MVCC æœºåˆ¶çš„æ•°æ®åº“ä¸­ï¼Œä½ å¾ˆéš¾æ‰¾åˆ°åº•å±‚ MVCC çš„å½±å­ï¼Œå› ä¸ºä¸Šå±‚çš„æ•°æ®åº“éƒ½æŠŠå®ƒå±è”½æ‰äº†ï¼Œç”¨æˆ·åªèƒ½ä½¿ç”¨æ•°æ®åº“å°è£…å¥½çš„ä¸€äº›èƒ½åŠ›ã€‚è€Œåœ¨ etcd ä¸­ï¼Œæœ€åº•å±‚çš„ç‰ˆæœ¬ä¿¡æ¯æ˜¯å…¬å¼€çš„ï¼Œè¿™å°±ç»™æˆ‘ä»¬æä¾›äº†å¾ˆå¤šç§å¯èƒ½æ€§ã€‚æ¯”å¦‚åœ¨å®˜æ–¹çš„å®¢æˆ·ç«¯ clientv3 ä¸­ï¼Œæœ‰ä¸€ä¸ª &lt;a href=&#34;https://github.com/etcd-io/etcd/tree/v3.3.10/clientv3/concurrency&#34;&gt;concurrency&lt;/a&gt; åŒ…ï¼Œè¿™é‡Œé¢å°è£…å¥½çš„èƒ½åŠ›å°±è¶³ä»¥è¦†ç›– etcd å¸¸è§çš„å‡ ç§ä½¿ç”¨åœºæ™¯ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/etcd-io/etcd/blob/v3.3.10/clientv3/concurrency/mutex.go&#34;&gt;mutex.go&lt;/a&gt; ä¸€ä¸ªåˆ†å¸ƒå¼é”çš„å®ç°&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/etcd-io/etcd/blob/v3.3.10/clientv3/concurrency/election.go&#34;&gt;election.go&lt;/a&gt; ä¸€ä¸ªåˆ†å¸ƒå¼é€‰ä¸¾çš„å®ç°ï¼Œå¤šç”¨æ¥å®ç° Active-Standby çš„é«˜å¯ç”¨æ¨¡å¼&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/etcd-io/etcd/blob/v3.3.10/clientv3/concurrency/stm.go&#34;&gt;stm.go&lt;/a&gt; ä¸€ä¸ªåœ¨&lt;strong&gt;å®¢æˆ·ç«¯&lt;/strong&gt;å®ç°çš„äº‹åŠ¡æ¡†æ¶ï¼Œèƒ½å°†å¤šæ¡ä¸šåŠ¡è¯­å¥æ‰“åŒ…æˆä¸€ä¸ªåŸå­æ“ä½œ&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;å…¶ä¸­çš„ stm (&lt;a href=&#34;https://en.wikipedia.org/wiki/Software_transactional_memory&#34;&gt;software transactional memory&lt;/a&gt;) å®ç°çš„æœ€æœ‰æ„æ€ï¼Œå®ƒå°†åŸå­æ€§çš„äº‹åŠ¡å®ç°å¾—æœ‰æ¨¡æœ‰æ ·ï¼Œè¿˜å…è®¸æŒ‡å®šä¸åŒçš„éš”ç¦»çº§åˆ«ï¼Œå°±åƒåœ¨ä½¿ç”¨é‚£äº›é‡é‡çº§çš„æ•°æ®åº“ä¸€æ ·ã€‚è¿™è®©äººä¸ç¦å¥½å¥‡ï¼Œåœ¨æ‹¥æœ‰ MVCC åŸè¯­çš„åŸºç¡€ä¸Šï¼Œå®ƒæ˜¯æ€æ ·ç”¨ 380 è¡Œä»£ç å®ç°å‡ºé‡é‡çº§çš„éš”ç¦»æ•ˆæœçš„ï¼Ÿ&lt;/p&gt;

&lt;h2 id=&#34;é¢„å¤‡çŸ¥è¯†&#34;&gt;é¢„å¤‡çŸ¥è¯†&lt;/h2&gt;

&lt;p&gt;åœ¨è¿›å…¥ä»£ç ç»†èŠ‚ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆè¦äº†è§£å¸¸è§çš„å‡ ç§éš”ç¦»çº§åˆ«æ˜¯ä»€ä¹ˆï¼Œä»¥åŠ etcd æš´éœ²å‡ºæ¥çš„ç‰ˆæœ¬ä¿¡æ¯æœ‰å“ªäº›ï¼Ÿ&lt;/p&gt;

&lt;h3 id=&#34;äº‹åŠ¡éš”ç¦»çº§åˆ«&#34;&gt;äº‹åŠ¡éš”ç¦»çº§åˆ«&lt;/h3&gt;

&lt;p&gt;æ•°æ®åº“çš„å‡ ç§&lt;a href=&#34;https://zh.wikipedia.org/zh-cn/äº‹åŠ¡éš”ç¦»&#34;&gt;äº‹åŠ¡éš”ç¦»çº§åˆ«&lt;/a&gt; ï¼ˆTransaction Isolation Levelsï¼‰ä¸€ç›´æ˜¯é¢è¯•çš„çƒ­ç‚¹ï¼Œå‡ ä¹é€¢é¢å¿…é—®ï¼ˆä¸è¦é—®æˆ‘æ€ä¹ˆçŸ¥é“çš„ï¼‰ã€‚å½“ç„¶è¿™ç§ç†è®ºçŸ¥è¯†ç¨å¾®ç†è§£ä¸€ä¸‹ä¹Ÿä¸éš¾è®°ä½ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;æœªæäº¤è¯»ï¼ˆRead Uncommittedï¼‰ï¼šèƒ½å¤Ÿè¯»å–åˆ°å…¶ä»–äº‹åŠ¡ä¸­è¿˜æœªæäº¤çš„æ•°æ®ï¼Œè¿™å¯èƒ½ä¼šå¯¼è‡´è„è¯»çš„é—®é¢˜ã€‚&lt;/li&gt;
&lt;li&gt;è¯»å·²æäº¤ï¼ˆRead Committedï¼‰ï¼šåªèƒ½è¯»å–åˆ°å·²ç»æäº¤çš„æ•°æ®ï¼Œå³åˆ«çš„äº‹åŠ¡ä¸€æäº¤ï¼Œå½“å‰äº‹åŠ¡å°±èƒ½è¯»å–åˆ°è¢«ä¿®æ”¹çš„æ•°æ®ï¼Œè¿™å¯èƒ½å¯¼è‡´ä¸å¯é‡å¤è¯»çš„é—®é¢˜ã€‚&lt;/li&gt;
&lt;li&gt;å¯é‡å¤è¯»ï¼ˆRepeated Readï¼‰ï¼šä¸€ä¸ªäº‹åŠ¡ä¸­ï¼ŒåŒä¸€ä¸ªè¯»æ“ä½œåœ¨äº‹åŠ¡çš„ä»»æ„æ—¶åˆ»éƒ½èƒ½å¾—åˆ°åŒæ ·çš„ç»“æœï¼Œå…¶ä»–äº‹åŠ¡çš„æäº¤æ“ä½œå¯¹æœ¬äº‹åŠ¡ä¸ä¼šäº§ç”Ÿå½±å“ã€‚&lt;/li&gt;
&lt;li&gt;ä¸²è¡ŒåŒ–ï¼ˆSerializableï¼‰ï¼šä¸²è¡ŒåŒ–çš„æ‰§è¡Œå¯èƒ½å†²çªçš„äº‹åŠ¡ï¼Œå³ä¸€ä¸ªäº‹åŠ¡ä¼šé˜»å¡å…¶ä»–äº‹åŠ¡ã€‚å®ƒé€šè¿‡ç‰ºç‰²å¹¶å‘èƒ½åŠ›æ¥æ¢å–æ•°æ®çš„å®‰å…¨ï¼Œå±äºæœ€é«˜çš„éš”ç¦»çº§åˆ«ã€‚&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&#34;etcd-ä¸­çš„ç‰ˆæœ¬&#34;&gt;etcd ä¸­çš„ç‰ˆæœ¬&lt;/h3&gt;

&lt;p&gt;MVCC å…¨ç§°æ˜¯å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼Œå®ƒä¿ç•™æ¯ä¸€æ¬¡çš„ä¿®æ”¹ï¼Œå¹¶ç”¨ç‰ˆæœ¬å·æ¥è¿½è¸ªè¿™äº›ä¿®æ”¹ã€‚æ‰€ä»¥ç›¸åº”çš„ etcd é‡Œé¢ä¹Ÿæœ‰å¾ˆå¤šç‰ˆæœ¬çš„æ¦‚å¿µï¼Œæˆ‘ä»¬å…ˆæ¥ç†æ¸…æ¥šå®ƒä»¬ä¹‹é—´çš„åŒºåˆ«&lt;sup class=&#34;footnote-ref&#34; id=&#34;fnref:etcd-revisions&#34;&gt;&lt;a href=&#34;#fn:etcd-revisions&#34;&gt;2&lt;/a&gt;&lt;/sup&gt;ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;code&gt;Revision&lt;/code&gt;æ˜¯ä¸€ä¸ªå…¨å±€çš„çŠ¶æ€ï¼Œæ¯ä¸€æ¬¡æœ‰æ›´æ”¹æ“ä½œï¼ˆPut, Delete, Txnï¼‰æ—¶ï¼ŒRevision çš„å€¼éƒ½ä¼šå¢åŠ ã€‚å®ƒçš„ä½œç”¨æœ‰ç‚¹åƒä¸€ä¸ªé€»è¾‘æ—¶é’Ÿï¼Œå…¨å±€é€’å¢ä¸é‡å¤ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ &lt;a href=&#34;https://github.com/etcd-io/etcd/blob/v3.3.10/etcdserver/etcdserverpb/rpc.pb.go#L223&#34;&gt;Response.Header.Revision&lt;/a&gt; è·å–åˆ°å½“å‰çš„å€¼ã€‚&lt;/li&gt;
&lt;li&gt;&lt;code&gt;CreateRevision&lt;/code&gt;ä»…ä½œç”¨äºå•ä¸ª keyï¼Œå®ƒè®°å½•çš„æ˜¯è¿™ä¸ª key è¢«åˆ›å»ºæ—¶çš„å…¨å±€æ—¶é’Ÿï¼ˆRevisionï¼‰ã€‚ä¸€èˆ¬é€šè¿‡ &lt;a href=&#34;https://github.com/etcd-io/etcd/blob/v3.3.10/mvcc/mvccpb/kv.pb.go#L64&#34;&gt;KeyValue.CreateRevision&lt;/a&gt; æ¥è·å–ã€‚&lt;/li&gt;
&lt;li&gt;&lt;code&gt;ModRevision&lt;/code&gt;ä¹Ÿæ˜¯å•ä¸ª key æ‰æœ‰çš„æ¦‚å¿µï¼Œå®ƒè¡¨ç¤ºè¿™ä¸ª key ä¸Šä¸€æ¬¡è¢«æ›´æ”¹æ—¶ï¼Œå…¨å±€çš„ç‰ˆæœ¬æ˜¯å¤šå°‘ã€‚ä¹Ÿæ˜¯é€šè¿‡ &lt;a href=&#34;https://github.com/etcd-io/etcd/blob/v3.3.10/mvcc/mvccpb/kv.pb.go#L66&#34;&gt;KeyValue.ModRevision &lt;/a&gt;è·å–åˆ°ã€‚&lt;/li&gt;
&lt;li&gt;&lt;code&gt;Version&lt;/code&gt;ä»…ä»…æ˜¯ä¸ªè®¡æ•°å™¨ï¼Œä¸å…¨å±€çš„ Revision æ— å…³ï¼Œä»£è¡¨äº†å½“å‰çš„ key ä»åˆ›å»ºåˆ°ç°åœ¨è¢«æ›´æ”¹äº†å¤šå°‘æ¬¡ã€‚&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;è¿™é‡Œçš„æ¦‚å¿µæœ‰ç‚¹åƒ Linux æ–‡ä»¶ç³»ç»Ÿé‡Œçš„å„ç§æ—¶é—´ã€‚æ•´ä¸ªç³»ç»Ÿçš„æ—¶é’Ÿæ˜¯ä¸€ç›´å¾€å‰èµ°çš„ï¼ˆRevisionï¼‰ï¼Œæˆ‘ä»¬åœ¨08:01åˆ›å»ºäº†ä¸€ä¸ªæ–‡ä»¶&lt;code&gt;my.file&lt;/code&gt;ï¼ˆCreateRevisionï¼‰ï¼Œ08:07åˆ†åˆæ›´æ”¹äº†å®ƒï¼ˆModRevisionï¼‰ã€‚ç³»ç»Ÿä¼šè®°å½•ä¸‹è¿™å‡ ä¸ªæ—¶é—´ç‚¹ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;lnt&#34;&gt;1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;2
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;3
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;4
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;5
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;6
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;$ stat my.file
...
Access: &lt;span class=&#34;m&#34;&gt;2019&lt;/span&gt;-08-29 &lt;span class=&#34;m&#34;&gt;08&lt;/span&gt;:01:43.345815131 +0800
Modify: &lt;span class=&#34;m&#34;&gt;2019&lt;/span&gt;-08-29 &lt;span class=&#34;m&#34;&gt;09&lt;/span&gt;:07:46.461380645 +0800
Change: &lt;span class=&#34;m&#34;&gt;2019&lt;/span&gt;-08-29 &lt;span class=&#34;m&#34;&gt;09&lt;/span&gt;:07:46.461380645 +0800
 Birth: -&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;æœ‰äº†è¿™ä¸ª Revision ä¹‹åï¼Œæˆ‘ä»¬å°±åƒæœ‰äº†æ—¶å…‰æœºä¸€æ ·ï¼Œå¯ä»¥è·å–åˆ°ç³»ç»Ÿåœ¨è¿‡å»æŸä¸ªæ—¶é—´ç‚¹çš„çŠ¶æ€ã€‚æ¯”å¦‚&lt;code&gt;GET&lt;/code&gt;å‡½æ•°å°±æ”¯æŒä¼ å…¥ä¸€ä¸ª&lt;code&gt;WithRev(revision)&lt;/code&gt;å‚æ•°ï¼Œæ¥å¾—åˆ°æŒ‡å®šçš„ key åœ¨æŒ‡å®šçš„ revision æ—¶çš„å€¼ã€‚&lt;/p&gt;

&lt;h3 id=&#34;etcd-ä¸­çš„å¾®äº‹åŠ¡&#34;&gt;etcd ä¸­çš„å¾®äº‹åŠ¡&lt;/h3&gt;

&lt;p&gt;etcd v3 ä¸­å¼•å…¥äº†ä¸€ä¸ªå¾®äº‹åŠ¡çš„æ¦‚å¿µï¼ˆmini-transactionï¼‰ï¼Œå…è®¸ç”¨æˆ·åœ¨ä¸€æ¬¡ä¿®æ”¹ä¸­æ‰¹é‡æ‰§è¡Œå¤šä¸ªæ“ä½œï¼Œè¿™æ„å‘³ç€è¿™ä¸€ç»„æ“ä½œè¢«ç»‘å®šæˆä¸€ä¸ªåŸå­æ“ä½œï¼Œå¹¶å…±äº«åŒä¸€ä¸ªä¿®è®¢å·ã€‚å®ƒçš„å†™æ³•æœ‰ç‚¹ç±»ä¼¼ä¸€ä¸ª &lt;a href=&#34;https://zh.wikipedia.org/wiki/æ¯”è¾ƒå¹¶äº¤æ¢&#34;&gt;CAS&lt;/a&gt; ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;lnt&#34;&gt;1
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;nf&#34;&gt;Txn&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;().&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;If&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;cond1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;cond2&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;err&#34;&gt;â€¦&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;).&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;Then&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;op1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;op2&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;err&#34;&gt;â€¦&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;).&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;Else&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;op1&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;â€™&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;op2&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;â€™&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;err&#34;&gt;â€¦&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;).&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;commit&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;å¦‚æœ&lt;code&gt;If&lt;/code&gt;è¯­å¥ä¸­çš„æ¡ä»¶å…¨éƒ¨ä¸ºçœŸï¼Œåˆ™æ•´ä¸ªäº‹åŠ¡çš„è¿”å›å€¼ä¸º&lt;code&gt;true&lt;/code&gt;ï¼Œå¹¶ä¸”&lt;code&gt;Then&lt;/code&gt;ä¸­çš„æ“ä½œä¼šè¢«æ‰§è¡Œï¼Œå¦åˆ™è¿”å›&lt;code&gt;false&lt;/code&gt;å¹¶æ‰§è¡Œ&lt;code&gt;Else&lt;/code&gt;ä¸­çš„æ“ä½œã€‚&lt;/p&gt;

&lt;h2 id=&#34;ä½¿ç”¨å§¿åŠ¿&#34;&gt;ä½¿ç”¨å§¿åŠ¿&lt;/h2&gt;

&lt;p&gt;åœ¨å¹¶å‘ç¼–ç¨‹é¢†åŸŸï¼Œæˆ‘ä»¬ç»å¸¸ç”¨é“¶è¡Œè½¬è´¦çš„ä¾‹å­æ¥è¯´æ˜åŸå­æ“ä½œçš„é‡è¦æ€§ã€‚ä¸ºäº†ç¡®ä¿å¹¶å‘å®‰å…¨ï¼Œè¦ä¹ˆä½¿ç”¨ä¸€ä¸ªæ‚²è§‚é”æ¥é¿å…å†²çªï¼Œè¦ä¹ˆå°±ç”¨ä¹è§‚é”æ¥æ£€æµ‹å†²çªå¹¶é‡è¯•ã€‚ç°åœ¨åœ¨ etcd çš„åœºæ™¯ä¸‹ï¼Œæœ‰äº†&lt;code&gt;mini-transaction&lt;/code&gt;å’Œ&lt;code&gt;ModRevision&lt;/code&gt;çš„åŠ æŒï¼Œæˆ‘ä»¬å¾ˆå®¹æ˜“å°±æƒ³åˆ°ç”¨å®ƒä»¬æ¥å®ç°ä¸€æŠŠä¹è§‚é”ï¼š&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;//blog.betacat.io/image/2019/08/etcd-transaction-isolation-levels/cas-transfer-money.svg&#34; alt=&#34;cas transfer money&#34; /&gt;&lt;/p&gt;

&lt;p&gt;æ ¹æ®è¿™ä¸ªæ€è·¯å†™å‡ºæ¥çš„ä»£ç ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;lnt&#34;&gt; 1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 2
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 3
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 4
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 5
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 6
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 7
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 8
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 9
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;10
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;11
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;12
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;13
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;14
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;15
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;16
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;17
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;18
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;19
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;20
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;21
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;22
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;23
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;24
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;25
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;26
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;27
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;28
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;29
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;30
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;31
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;32
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;33
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;34
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;35
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;36
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;37
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;38
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;39
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;40
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;kd&#34;&gt;func&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;txnXfer&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;etcd&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;v3&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Client&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;from&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;to&lt;/span&gt; &lt;span class=&#34;kt&#34;&gt;string&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;amount&lt;/span&gt; &lt;span class=&#34;kt&#34;&gt;uint&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;kt&#34;&gt;error&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
    &lt;span class=&#34;k&#34;&gt;for&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
        &lt;span class=&#34;k&#34;&gt;if&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;ok&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;err&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;doTxnXfer&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;etcd&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;from&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;to&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;amount&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;err&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;!=&lt;/span&gt; &lt;span class=&#34;kc&#34;&gt;nil&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
            &lt;span class=&#34;k&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;err&lt;/span&gt; &lt;span class=&#34;c1&#34;&gt;// å‘ç”Ÿäº†é”™è¯¯ï¼Œåˆ™ç›´æ¥ç»™ç”¨æˆ·è¿”å›é”™è¯¯
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;        &lt;span class=&#34;p&#34;&gt;}&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;else&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;if&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;ok&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
            &lt;span class=&#34;k&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;kc&#34;&gt;nil&lt;/span&gt;  &lt;span class=&#34;c1&#34;&gt;// è½¬è´¦æˆåŠŸå°±è¿”å›
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;        &lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
        &lt;span class=&#34;c1&#34;&gt;// å‘ç”Ÿå†²çªäº†ï¼Œéœ€è¦é‡è¯•
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;    &lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;

&lt;span class=&#34;kd&#34;&gt;func&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;doTxnXfer&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;etcd&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;v3&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Client&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;from&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;to&lt;/span&gt; &lt;span class=&#34;kt&#34;&gt;string&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;amount&lt;/span&gt; &lt;span class=&#34;kt&#34;&gt;uint&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;bool&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;kt&#34;&gt;error&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
    &lt;span class=&#34;c1&#34;&gt;// åˆ©ç”¨ Txn çš„åŸå­æ€§åŒæ—¶è·å–Aå’ŒBçš„ä½™é¢ä»¥åŠModRevision
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;    &lt;span class=&#34;nx&#34;&gt;getResp&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;err&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;etcd&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;Txn&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;etcd&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;Ctx&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()).&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;Then&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;OpGet&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;from&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;OpGet&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;to&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)).&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;Commit&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;
    &lt;span class=&#34;k&#34;&gt;if&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;err&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;!=&lt;/span&gt; &lt;span class=&#34;kc&#34;&gt;nil&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
         &lt;span class=&#34;k&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;kc&#34;&gt;false&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;err&lt;/span&gt;
    &lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
    &lt;span class=&#34;c1&#34;&gt;// è¯»å–åœ¨å½“å‰æ—¶åˆ»Aå’ŒBçš„å€¼
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;    &lt;span class=&#34;nx&#34;&gt;fromKV&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;getResp&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Responses&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;].&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;GetRangeResponse&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;().&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Kvs&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt;
    &lt;span class=&#34;nx&#34;&gt;toKV&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;getResp&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Responses&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;].&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;GetRangeResponse&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;().&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Kvs&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt;
    &lt;span class=&#34;nx&#34;&gt;fromValue&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;toValue&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;toUInt64&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;fromKV&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Value&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;toUint64&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;toKV&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Value&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
    &lt;span class=&#34;k&#34;&gt;if&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;fromValue&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;amount&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
        &lt;span class=&#34;k&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;kc&#34;&gt;false&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;fmt&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;Errorf&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;â€œ&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;insufficient&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;value&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;â€&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
    &lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
    &lt;span class=&#34;c1&#34;&gt;// å†å‡†å¤‡ä¸€ä¸ªäº‹åŠ¡ï¼Œå…¶ä¸­çš„æ¯”è¾ƒéƒ¨åˆ†æ˜¯æŸ¥çœ‹ ModRevision æœ‰æ²¡æœ‰å˜åŒ–
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;    &lt;span class=&#34;nx&#34;&gt;txn&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;etcd&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;Txn&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;etcd&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;Ctx&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()).&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;If&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;
        &lt;span class=&#34;nx&#34;&gt;v3&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;Compare&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;v3&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;ModRevision&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;from&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt; &lt;span class=&#34;s&#34;&gt;&amp;#34;=&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;fromKV&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;ModRevision&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;
        &lt;span class=&#34;nx&#34;&gt;v3&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;Compare&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;v3&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;ModRevision&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;to&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt; &lt;span class=&#34;s&#34;&gt;&amp;#34;=&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;toKV&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;ModRevision&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;))&lt;/span&gt;
    &lt;span class=&#34;c1&#34;&gt;// å¦‚æœä»ä¸Šæ¬¡è¯»å–åˆ°ç°åœ¨è¿˜æ²¡æœ‰åˆ«äººæ›´æ”¹è¿‡ï¼Œé‚£å°±å†™å…¥å¤„ç†åçš„å€¼
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;    &lt;span class=&#34;nx&#34;&gt;txn&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;txn&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;Then&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;
        &lt;span class=&#34;nf&#34;&gt;OpPut&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;from&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;fromUint64&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;fromValue&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;-&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;amount&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)),&lt;/span&gt;
        &lt;span class=&#34;nf&#34;&gt;OpPut&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;to&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;fromUint64&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;toValue&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;-&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;amount&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;))&lt;/span&gt;
    &lt;span class=&#34;c1&#34;&gt;// æäº¤ç¬¬äºŒä¸ªäº‹åŠ¡
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;    &lt;span class=&#34;nx&#34;&gt;putResp&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;err&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;txn&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;Commit&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;
    &lt;span class=&#34;k&#34;&gt;if&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;err&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;!=&lt;/span&gt; &lt;span class=&#34;kc&#34;&gt;nil&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
        &lt;span class=&#34;k&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;kc&#34;&gt;false&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;err&lt;/span&gt;
    &lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
    &lt;span class=&#34;c1&#34;&gt;// å¦‚æœäº‹åŠ¡çš„æ¯”è¾ƒéƒ¨åˆ†ä¸ºçœŸï¼ŒputResp.Succeededå°±æ˜¯trueï¼Œå¦åˆ™ä¸ºfalse
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;    &lt;span class=&#34;k&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;putResp&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Succeeded&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;kc&#34;&gt;nil&lt;/span&gt;
&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;å¯ä»¥çœ‹åˆ°ï¼Œè¿™éƒ¨åˆ†ä»£ç é™¤äº†è½¬è´¦çš„ä¸šåŠ¡é€»è¾‘å¤–ï¼Œå¤§éƒ¨åˆ†éƒ½æ˜¯å®ç°ä¹è§‚é”çš„æ ·æ¿ä»£ç ï¼ŒåŒ…æ‹¬ä¸¤æ¬¡äº‹åŠ¡æ“ä½œã€å†²çªæ£€æµ‹ã€å†²çªå‘ç”Ÿæ—¶çš„é‡è¯•ç­‰ï¼Œå†™èµ·æ¥æ¯”è¾ƒç¹çã€‚å¹¸å¥½ stm.go æŠŠè¿™éƒ¨åˆ†é€»è¾‘è¿›è¡Œäº†å°è£…ï¼ŒæŠ½è±¡å‡ºäº†ä¸€ä¸ªå…¬å…±çš„äº‹åŠ¡å¤„ç†æ¡†æ¶ï¼Œæˆ‘ä»¬åªéœ€æŠŠä¸šåŠ¡ç›¸å…³çš„ä»£ç ä¼ ç»™ stmï¼Œå®ƒä¼šåšäº‹åŠ¡ç®¡ç†ï¼Œå¹¶é€‚æ—¶è°ƒç”¨æˆ‘ä»¬çš„ä¸šåŠ¡ä»£ç ã€‚ç°åœ¨æ¥çœ‹çœ‹ç”¨ stm é‡æ„åçš„ä»£ç ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;lnt&#34;&gt; 1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 2
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 3
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 4
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 5
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 6
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 7
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 8
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 9
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;10
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;11
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;12
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;13
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;14
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;15
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;16
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;kd&#34;&gt;func&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;txnXfer&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;cli&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;v3&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Client&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;from&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;to&lt;/span&gt; &lt;span class=&#34;kt&#34;&gt;string&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;amount&lt;/span&gt; &lt;span class=&#34;kt&#34;&gt;uint&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;kt&#34;&gt;error&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
    &lt;span class=&#34;c1&#34;&gt;// NewSTMåˆ›å»ºäº†ä¸€ä¸ªåŸå­äº‹åŠ¡çš„ä¸Šä¸‹æ–‡ï¼Œå¹¶æŠŠæˆ‘ä»¬çš„ä¸šåŠ¡ä»£ç ä½œä¸ºä¸€ä¸ªå‡½æ•°ä¼ è¿›å»
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;    &lt;span class=&#34;nx&#34;&gt;_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;err&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;concurrency&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;NewSTM&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;cli&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;kd&#34;&gt;func&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;stm&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;concurrency&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;STM&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;kt&#34;&gt;error&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
        &lt;span class=&#34;c1&#34;&gt;// stm.Getå°è£…å¥½äº†äº‹åŠ¡çš„è¯»æ“ä½œ
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;        &lt;span class=&#34;nx&#34;&gt;fromV&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;toUInt64&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;stm&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;Get&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;from&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;))&lt;/span&gt;
        &lt;span class=&#34;nx&#34;&gt;toV&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;toUInt64&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;stm&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;Get&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;to&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;))&lt;/span&gt;
        &lt;span class=&#34;k&#34;&gt;if&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;fromV&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;amount&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
            &lt;span class=&#34;k&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;fmt&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;Errorf&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;â€œ&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;insufficient&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;value&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;â€&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
        &lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
        &lt;span class=&#34;c1&#34;&gt;// stm.Putå°è£…å¥½äº†äº‹åŠ¡çš„å†™æ“ä½œ
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;        &lt;span class=&#34;nx&#34;&gt;stm&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;Put&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;to&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;fromUInt64&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;toV&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;+&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;amount&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;))&lt;/span&gt;
        &lt;span class=&#34;nx&#34;&gt;stm&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;Put&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;from&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;fromUInt64&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;fromV&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;-&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;amount&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;))&lt;/span&gt;
        &lt;span class=&#34;k&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;kc&#34;&gt;nil&lt;/span&gt;
    &lt;span class=&#34;p&#34;&gt;})&lt;/span&gt;
    &lt;span class=&#34;k&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;err&lt;/span&gt;
&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;çœ¼èŠ±ç¼­ä¹±çš„&lt;code&gt;ModRevision&lt;/code&gt;ä¸è§äº†ï¼Œäº‹åŠ¡å¤„ç†ä¹Ÿä¸è§äº†ï¼Œæ•´æ®µä»£ç å˜å¾—æ¸…æ™°æ˜äº†äº†å¾ˆå¤šã€‚æ‰€ä»¥ stm çš„ä½¿ç”¨ç‰¹åˆ«ç®€å•â€”â€”æˆ‘ä»¬åªéœ€æŠŠä¸šåŠ¡ç›¸å…³çš„ä»£ç å°è£…æˆå¯é‡å…¥çš„å‡½æ•°ä¼ ç»™ stmï¼Œç„¶å stm ä¼šå¤„ç†å¥½å…¶ä½™æ‰€æœ‰çš„ç»†èŠ‚ï¼Œcool~&lt;/p&gt;

&lt;h2 id=&#34;å†…éƒ¨å®ç°&#34;&gt;å†…éƒ¨å®ç°&lt;/h2&gt;

&lt;p&gt;å…ˆæ¥çœ‹çœ‹ä¼ ç»™ä¸šåŠ¡ç¨‹åºçš„&lt;code&gt;concurrency.STM&lt;/code&gt;é•¿ä»€ä¹ˆæ ·ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;lnt&#34;&gt; 1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 2
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 3
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 4
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 5
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 6
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 7
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 8
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 9
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;10
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;11
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;12
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;13
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;14
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;15
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;c1&#34;&gt;// STM is an interface for software transactional memory.
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;type&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;STM&lt;/span&gt; &lt;span class=&#34;kd&#34;&gt;interface&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
    &lt;span class=&#34;c1&#34;&gt;// Get returns the value for a key and inserts the key in the txn&amp;#39;s read set.
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;    &lt;span class=&#34;nf&#34;&gt;Get&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;key&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;...&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;string&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;kt&#34;&gt;string&lt;/span&gt;
    &lt;span class=&#34;c1&#34;&gt;// Put adds a value for a key to the write set.
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;    &lt;span class=&#34;nf&#34;&gt;Put&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;key&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;val&lt;/span&gt; &lt;span class=&#34;kt&#34;&gt;string&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;opts&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;...&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;v3&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;OpOption&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
    &lt;span class=&#34;c1&#34;&gt;// Rev returns the revision of a key in the read set.
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;    &lt;span class=&#34;nf&#34;&gt;Rev&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;key&lt;/span&gt; &lt;span class=&#34;kt&#34;&gt;string&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;kt&#34;&gt;int64&lt;/span&gt;
    &lt;span class=&#34;c1&#34;&gt;// Del deletes a key.
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;    &lt;span class=&#34;nf&#34;&gt;Del&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;key&lt;/span&gt; &lt;span class=&#34;kt&#34;&gt;string&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;

    &lt;span class=&#34;c1&#34;&gt;// commit attempts to apply the txn&amp;#39;s changes to the server.
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;    &lt;span class=&#34;nf&#34;&gt;commit&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;v3&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;TxnResponse&lt;/span&gt;
    &lt;span class=&#34;nf&#34;&gt;reset&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;
&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;åŸæ¥å®ƒæ˜¯ä¸€ä¸ªæ¥å£ï¼Œæä¾›äº†å¯¹æŸä¸ª key çš„ &lt;a href=&#34;https://en.wikipedia.org/wiki/Create,_read,_update_and_delete&#34;&gt;CURD&lt;/a&gt; æ“ä½œã€‚è€Œå®ç°äº† STM æ¥å£çš„æ€»å…±æœ‰ä¸¤ä¸ªç±»ï¼š&lt;a href=&#34;https://github.com/etcd-io/etcd/blob/v3.3.10/clientv3/concurrency/stm.go#L170&#34;&gt;stm&lt;/a&gt; å’Œ &lt;a href=&#34;https://github.com/etcd-io/etcd/blob/v3.3.10/clientv3/concurrency/stm.go#L300&#34;&gt;stmSerializable&lt;/a&gt;ã€‚å…·ä½“é€‰æ‹©å“ªä¸ªå®ç°ï¼Œåˆ™æ˜¯ç”±æˆ‘ä»¬æŒ‡å®šçš„éš”ç¦»çº§åˆ«å†³å®šçš„ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;lnt&#34;&gt; 1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 2
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 3
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 4
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 5
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 6
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 7
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 8
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 9
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;10
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;11
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;12
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;13
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;14
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;15
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;16
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;17
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;18
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;19
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;20
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;kd&#34;&gt;func&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;mkSTM&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;c&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;v3&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Client&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;opts&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;stmOptions&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;STM&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
    &lt;span class=&#34;k&#34;&gt;switch&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;opts&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;iso&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
    &lt;span class=&#34;k&#34;&gt;case&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;SerializableSnapshot&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;
        &lt;span class=&#34;nx&#34;&gt;s&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;stmSerializable&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;...&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
        &lt;span class=&#34;nx&#34;&gt;s&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;conflicts&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;kd&#34;&gt;func&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;[]&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;v3&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Cmp&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;append&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;s&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;rset&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;cmps&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(),&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;s&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;wset&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;cmps&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;s&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;rset&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;first&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;...&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)}&lt;/span&gt;
        &lt;span class=&#34;k&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;s&lt;/span&gt;
    &lt;span class=&#34;k&#34;&gt;case&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;Serializable&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;
        &lt;span class=&#34;nx&#34;&gt;s&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;stmSerializable&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;...&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
        &lt;span class=&#34;nx&#34;&gt;s&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;conflicts&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;kd&#34;&gt;func&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;[]&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;v3&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Cmp&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;s&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;rset&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;cmps&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
        &lt;span class=&#34;k&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;s&lt;/span&gt;
    &lt;span class=&#34;k&#34;&gt;case&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;RepeatableReads&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;
        &lt;span class=&#34;nx&#34;&gt;s&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;stm&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;...&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
        &lt;span class=&#34;nx&#34;&gt;s&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;conflicts&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;kd&#34;&gt;func&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;[]&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;v3&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Cmp&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;s&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;rset&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;cmps&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
        &lt;span class=&#34;k&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;s&lt;/span&gt;
    &lt;span class=&#34;k&#34;&gt;case&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;ReadCommitted&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;
        &lt;span class=&#34;nx&#34;&gt;s&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;stm&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;...&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
        &lt;span class=&#34;nx&#34;&gt;s&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;conflicts&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;kd&#34;&gt;func&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;[]&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;v3&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Cmp&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;kc&#34;&gt;nil&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
        &lt;span class=&#34;k&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;s&lt;/span&gt;
    &lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;å¯ä»¥çœ‹åˆ°ç›®å‰å…±æ”¯æŒäº†4ç§éš”ç¦»çº§åˆ«ï¼Œå¹¶ä¸”ä¸åŒçš„éš”ç¦»çº§åˆ«é™¤äº†ä½¿ç”¨ä¸åŒçš„ STM å®ç°å¤–ï¼Œä»–ä»¬çš„&lt;code&gt;conflicts&lt;/code&gt;å‡½æ•°ä¹Ÿä¸ä¸€æ ·ï¼Œè¿™ä¸ªæˆ‘ä»¬å¾…ä¼šå†è®²ã€‚å…ˆæŒ‘ä¸€ä¸ªå…¸å‹çš„&lt;code&gt;RepeatableReads&lt;/code&gt;æ¥çœ‹çœ‹å®ƒçš„å®ç°ï¼š&lt;/p&gt;

&lt;h3 id=&#34;repeatablereads&#34;&gt;RepeatableReads&lt;/h3&gt;

&lt;p&gt;å†…éƒ¨çš„çŠ¶æ€ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;lnt&#34;&gt; 1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 2
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 3
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 4
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 5
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 6
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 7
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 8
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 9
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;10
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;11
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;12
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;c1&#34;&gt;// stm implements repeatable-read software transactional memory over etcd
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;type&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;stm&lt;/span&gt; &lt;span class=&#34;kd&#34;&gt;struct&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
    &lt;span class=&#34;o&#34;&gt;...&lt;/span&gt;
    &lt;span class=&#34;c1&#34;&gt;// rset holds read key values and revisions
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;    &lt;span class=&#34;nx&#34;&gt;rset&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;readSet&lt;/span&gt;
    &lt;span class=&#34;c1&#34;&gt;// wset holds overwritten keys and their values
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;    &lt;span class=&#34;nx&#34;&gt;wset&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;writeSet&lt;/span&gt;
    &lt;span class=&#34;c1&#34;&gt;// getOpts are the opts used for gets
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;    &lt;span class=&#34;nx&#34;&gt;getOpts&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;[]&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;v3&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;OpOption&lt;/span&gt;
    &lt;span class=&#34;c1&#34;&gt;// conflicts computes the current conflicts on the txn
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;    &lt;span class=&#34;nx&#34;&gt;conflicts&lt;/span&gt; &lt;span class=&#34;kd&#34;&gt;func&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;[]&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;v3&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Cmp&lt;/span&gt;
&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;è¿™é‡Œçš„ä¸¤ä¸ªå­—æ®µ&lt;code&gt;readSet&lt;/code&gt;å’Œ&lt;code&gt;writeSet&lt;/code&gt;ï¼Œåº•å±‚ç±»å‹æ˜¯ä¸€ä¸ª&lt;code&gt;map&lt;/code&gt;ï¼Œç”¨æ¥ç¼“å­˜åœ¨å½“å‰äº‹åŠ¡ä¸­è¿›è¡Œè¿‡çš„è¯»å†™æ“ä½œã€‚&lt;code&gt;conflicts&lt;/code&gt;æ˜¯åœ¨ä¸Šé¢çš„å·¥å‚å‡½æ•°&lt;code&gt;mkSTM&lt;/code&gt;ä¸­èµ‹å€¼çš„ï¼Œç”¨æ¥åœ¨äº‹åŠ¡æäº¤çš„æ—¶å€™åšå†²çªæ£€æµ‹ã€‚&lt;/p&gt;

&lt;h4 id=&#34;è¯»å†™&#34;&gt;è¯»å†™&lt;/h4&gt;

&lt;p&gt;äº‹åŠ¡ä¸­çš„è¯»å†™è°ƒç”¨çš„æ˜¯&lt;code&gt;stm.Get&lt;/code&gt;å’Œ&lt;code&gt;stm.Put&lt;/code&gt;å‡½æ•°ã€‚ç®€åŒ–åçš„é€»è¾‘å¤§æ¦‚æ˜¯è¿™æ ·çš„ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;lnt&#34;&gt; 1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 2
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 3
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 4
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 5
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 6
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 7
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 8
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 9
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;10
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;11
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;12
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;13
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;14
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;15
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;16
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;17
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;18
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;kd&#34;&gt;func&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;s&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;stm&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;Get&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;key&lt;/span&gt; &lt;span class=&#34;kt&#34;&gt;string&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;kt&#34;&gt;string&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
    &lt;span class=&#34;c1&#34;&gt;// å…ˆçœ‹çœ‹ä¹‹å‰æœ‰æ²¡æœ‰å†™è¿‡è¿™ä¸ªå€¼
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;    &lt;span class=&#34;k&#34;&gt;if&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;wv&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;ok&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;s&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;wset&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;key&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;];&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;ok&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
       &lt;span class=&#34;k&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;wv&lt;/span&gt;
    &lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
    &lt;span class=&#34;c1&#34;&gt;// å†çœ‹çœ‹æœ‰æ²¡æœ‰è¯»è¿‡
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;    &lt;span class=&#34;k&#34;&gt;if&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;rv&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;ok&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;s&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;rset&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;key&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;];&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;ok&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
        &lt;span class=&#34;k&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;string&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;rv&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Kvs&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;].&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Value&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
    &lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
    &lt;span class=&#34;c1&#34;&gt;// å¦‚æœéƒ½æ²¡æœ‰ï¼Œåˆ™å‘etcdå‘èµ·ä¸€æ¬¡æŸ¥è¯¢è¯·æ±‚
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;    &lt;span class=&#34;nx&#34;&gt;rk&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;err&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;s&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;c&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;Get&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;s&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;ctx&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;key&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;s&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;getOpts&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;...&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
    &lt;span class=&#34;c1&#34;&gt;// æŸ¥è¯¢åå†ç¼“å­˜è¿›read set
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;    &lt;span class=&#34;nx&#34;&gt;s&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;rset&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;key&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;rk&lt;/span&gt;
    &lt;span class=&#34;k&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;string&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;rk&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Kvs&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;].&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Value&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;

&lt;span class=&#34;c1&#34;&gt;// å†™æ“ä½œéƒ½æ˜¯å…ˆå†™è¿›æœ¬åœ°ç¼“å­˜é‡Œ
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;func&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;s&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;stm&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;Put&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;key&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;val&lt;/span&gt; &lt;span class=&#34;kt&#34;&gt;string&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;s&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;wset&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;key&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;val&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;å¯¹äºè¯»è¯·æ±‚ï¼Œå…ˆä»¥æœ¬åœ°æœ€æ–°çš„æ›´æ–°ä¸ºå‡†ï¼Œå¦‚æœä¹‹å‰ä»æ²¡å¤„ç†è¿‡è¿™ä¸ª key ï¼Œåˆ™åˆ° etcd ä¸­æŸ¥è¯¢ï¼Œå¹¶ç¼“å­˜ä¸‹æ¥ï¼Œè¿™æ ·å°±å¯ä»¥åšåˆ°&lt;em&gt;å¯é‡å¤è¯»&lt;/em&gt; ï¼ˆRepeatableReadsï¼‰ã€‚å¯¹äºå†™æ“ä½œï¼Œéƒ½æ˜¯å…ˆå†™è¿›æœ¬åœ°ç¼“å­˜ï¼Œç›´åˆ°äº‹åŠ¡æäº¤æ—¶æ‰çœŸæ­£å†™åˆ° etcd é‡Œã€‚&lt;/p&gt;

&lt;h4 id=&#34;æäº¤&#34;&gt;æäº¤&lt;/h4&gt;

&lt;p&gt;å½“æˆ‘ä»¬çš„ä¸šåŠ¡ä»£ç è°ƒç”¨ç»“æŸåï¼Œstm å°±æ¥å°è¯•æäº¤äº‹åŠ¡äº†ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;lnt&#34;&gt;1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;2
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;3
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;4
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;5
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;kd&#34;&gt;func&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;s&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;stm&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;commit&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;v3&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;TxnResponse&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
    &lt;span class=&#34;nx&#34;&gt;txnresp&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;err&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;s&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;client&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;Txn&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;s&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;ctx&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;).&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;If&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;
      &lt;span class=&#34;nx&#34;&gt;s&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;conflicts&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;...&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;).&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;Then&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;s&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;wset&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;puts&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;...&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;).&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;Commit&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;
    &lt;span class=&#34;o&#34;&gt;...&lt;/span&gt;
&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;æäº¤äº‹åŠ¡å°±æ˜¯åˆ©ç”¨ etcd çš„&lt;code&gt;Txn&lt;/code&gt;ï¼ŒæŠŠ&lt;code&gt;writeSet&lt;/code&gt;ä¸­çš„æ•°æ®å†™å‡ºå»ï¼Œè¿™é‡Œè¦æ³¨æ„çš„æ˜¯&lt;code&gt;If&lt;/code&gt;ä¸­çš„å†²çªæ£€æµ‹ï¼Œå°±æ˜¯æˆ‘ä»¬åœ¨æ„å»ºçš„æ—¶å€™æŒ‡å®šçš„&lt;code&gt;conflicts&lt;/code&gt;å‡½æ•°ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;lnt&#34;&gt;1
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;nx&#34;&gt;s&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;conflicts&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;kd&#34;&gt;func&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;[]&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;v3&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Cmp&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;s&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;rset&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;cmps&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;çœ‹æ¥&lt;code&gt;conflicts&lt;/code&gt;å‡½æ•°ä¸­çœŸæ­£å¹²æ´»çš„æ˜¯&lt;code&gt;readSet.cmps()&lt;/code&gt;ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;lnt&#34;&gt;1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;2
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;3
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;4
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;5
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;6
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;7
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;8
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;9
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;c1&#34;&gt;// cmps guards the txn from updates to read set
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;func&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;rs&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;readSet&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;cmps&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;[]&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;v3&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Cmp&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
    &lt;span class=&#34;nx&#34;&gt;cmps&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;make&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;([]&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;v3&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Cmp&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;len&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;rs&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;))&lt;/span&gt;
    &lt;span class=&#34;k&#34;&gt;for&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;k&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;rk&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;range&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;rs&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
        &lt;span class=&#34;nx&#34;&gt;cmps&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;append&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;cmps&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; 
                 &lt;span class=&#34;nx&#34;&gt;v3&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;Compare&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;v3&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;ModRevision&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;k&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt; &lt;span class=&#34;s&#34;&gt;&amp;#34;=&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;rk&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Kvs&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;].&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;ModRevision&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;))&lt;/span&gt;
    &lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
    &lt;span class=&#34;k&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;cmps&lt;/span&gt;
&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;å®ƒçš„é€»è¾‘å°±æ˜¯æ„é€ ä¸€å †æ¯”è¾ƒæ“ä½œç¬¦ï¼Œç¡®ä¿&lt;code&gt;readSet&lt;/code&gt;ä¸­çš„æ•°æ®ï¼Œåœ¨è¯»å–è¿›ç¼“å­˜ä¹‹åå†ä¹Ÿæ²¡æœ‰è¢«æ›´æ”¹è¿‡ï¼Œå³ ModRevision æ²¡æœ‰å˜ã€‚&lt;/p&gt;

&lt;p&gt;æ‰€ä»¥æ¢³ç†ä¸€ä¸‹ï¼Œ&lt;code&gt;RepeatableReads&lt;/code&gt;å®ç°çš„ä¸¤ä¸ªå…³é”®ç‚¹ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;ç”¨&lt;code&gt;readSet&lt;/code&gt;ç¼“å­˜å·²ç»è¯»è¿‡çš„æ•°æ®ï¼Œè¿™æ ·ä¸‹æ¬¡å†è¯»å–åŒæ ·æ•°æ®çš„æ—¶å€™æ‰èƒ½å¾—åˆ°åŒæ ·çš„ç»“æœï¼Œè¿™ç¡®ä¿äº†å¯é‡å¤è¯»ã€‚&lt;/li&gt;
&lt;li&gt;ç”¨&lt;code&gt;readSet&lt;/code&gt;æ•°æ®çš„&lt;code&gt;ModRevision&lt;/code&gt;åšå†²çªæ£€æµ‹ï¼Œç¡®ä¿æœ¬äº‹åŠ¡è¯»åˆ°çš„æ•°æ®éƒ½æ˜¯æœ€æ–°çš„ã€‚&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&#34;readcommitted&#34;&gt;ReadCommitted&lt;/h3&gt;

&lt;p&gt;&lt;code&gt;ReadCommitted&lt;/code&gt;è·Ÿ&lt;code&gt;RepeatableReads&lt;/code&gt;çš„å®ç°ç±»ä¼¼ï¼Œå”¯ä¸€ä¸åŒçš„æ˜¯å®ƒçš„å†²çªæ£€æµ‹å‡½æ•°ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;lnt&#34;&gt;1
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;nx&#34;&gt;s&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;conflicts&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;kd&#34;&gt;func&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;[]&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;v3&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Cmp&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;kc&#34;&gt;nil&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;å¯ä»¥çœ‹åˆ°ï¼Œå…¶å®&lt;code&gt;ReadCommitted&lt;/code&gt;å•¥å†²çªä¹Ÿä¸æ£€æµ‹ï¼Œå®ƒåªæ˜¯ç¡®ä¿è‡ªå·±è¯»åˆ°çš„æ˜¯åˆ«äººå·²ç»æäº¤çš„æ•°æ®ï¼Œå…¶ä»–ä»€ä¹ˆä¿éšœä¹Ÿæ²¡æœ‰å•Šï¼Ÿï¼&lt;/p&gt;

&lt;h3 id=&#34;serializable&#34;&gt;Serializable&lt;/h3&gt;

&lt;p&gt;&lt;code&gt;Serializable&lt;/code&gt;ä½¿ç”¨çš„æ˜¯&lt;code&gt;stmSerializable&lt;/code&gt;ç±»ï¼Œå®ƒä¸ä¸Šé¢ä¸¤ä¸ªä½¿ç”¨çš„&lt;code&gt;stm&lt;/code&gt;ä¸€ä¸ªä¸»è¦ä¸åŒç‚¹åœ¨äºï¼Œå®ƒç¬¬ä¸€æ¬¡è¯»å®Œäº†ä¼šæŠŠå½“æ—¶çš„ç‰ˆæœ¬å·ç»™è®°å½•ä¸‹æ¥ï¼Œä¸‹æ¬¡å†å‘ etcd å‘å‡ºè¯»è¯·æ±‚çš„æ—¶å€™ä¼šå¸¦ä¸Šè¿™ä¸ªç‰ˆæœ¬å·ï¼Œè¡¨ç¤ºæˆ‘å°±è¦å½“æ—¶é‚£ä¸ªç‰ˆæœ¬çš„æ•°æ®ï¼Œè¿™ç¡®ä¿äº†è¯¥äº‹åŠ¡æ‰€æœ‰çš„è¯»æ“ä½œè¯»åˆ°çš„éƒ½æ˜¯&lt;strong&gt;åŒä¸€æ—¶åˆ»&lt;/strong&gt;çš„å†…å®¹ã€‚è¿™å°±ç›¸å½“äºåœ¨äº‹åŠ¡å¼€å§‹æ—¶ï¼Œå¯¹ etcd åšäº†ä¸€ä¸ªå¿«ç…§ï¼Œè¿™æ ·å®ƒè¯»å–åˆ°çš„æ•°æ®å°±ä¸ä¼šå—åˆ°å…¶ä»–äº‹åŠ¡çš„å½±å“ï¼Œä»è€Œè¾¾åˆ°äº‹åŠ¡ä¸²è¡ŒåŒ–ï¼ˆSerializableï¼‰æ‰§è¡Œçš„æ•ˆæœã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;lnt&#34;&gt; 1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 2
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 3
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 4
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 5
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 6
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 7
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 8
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 9
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;10
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;11
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;12
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;13
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;kd&#34;&gt;func&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;s&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;stmSerializable&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;Get&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;keys&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;...&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;string&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;kt&#34;&gt;string&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
    &lt;span class=&#34;c1&#34;&gt;// ...
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;    &lt;span class=&#34;nx&#34;&gt;firstRead&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;len&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;s&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;rset&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;==&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt; &lt;span class=&#34;c1&#34;&gt;// æ˜¯ä¸æ˜¯ç¬¬ä¸€æ¬¡è¯»æ“ä½œ
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;    &lt;span class=&#34;nx&#34;&gt;resp&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;s&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;stm&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;fetch&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;keys&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;...&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
    &lt;span class=&#34;k&#34;&gt;if&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;firstRead&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
        &lt;span class=&#34;c1&#34;&gt;// è®°å½•ä¸‹first readçš„ç‰ˆæœ¬å·ï¼Œä½œä¸ºåç»­Getæ“ä½œçš„Optionå‚æ•°ä¼ è¿›å»
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;        &lt;span class=&#34;nx&#34;&gt;s&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;getOpts&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;[]&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;v3&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;OpOption&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
            &lt;span class=&#34;nx&#34;&gt;v3&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;WithRev&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;resp&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Header&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Revision&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;
            &lt;span class=&#34;nx&#34;&gt;v3&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;WithSerializable&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(),&lt;/span&gt;
        &lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
    &lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
    &lt;span class=&#34;k&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;respToValue&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;resp&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;h3 id=&#34;serializablesnapshot&#34;&gt;SerializableSnapshot&lt;/h3&gt;

&lt;p&gt;&lt;code&gt;SerializableSnapshot&lt;/code&gt;å’Œ&lt;code&gt;Serializable&lt;/code&gt;ä¹Ÿæ˜¯ç±»ä¼¼ï¼Œä¸åŒçš„æ˜¯å®ƒçš„éš”ç¦»çº§åˆ«æ›´ä¸¥æ ¼äº›ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;lnt&#34;&gt; 1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 2
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 3
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 4
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 5
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 6
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 7
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 8
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 9
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;10
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;11
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;12
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;nx&#34;&gt;s&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;conflicts&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;kd&#34;&gt;func&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;[]&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;v3&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Cmp&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
    &lt;span class=&#34;k&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;append&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;s&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;rset&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;cmps&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(),&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;s&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;wset&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;cmps&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;s&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;rset&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;first&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;...&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;

&lt;span class=&#34;c1&#34;&gt;// cmps returns a cmp list testing no writes have happened past rev
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;func&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;ws&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;writeSet&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;cmps&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;rev&lt;/span&gt; &lt;span class=&#34;kt&#34;&gt;int64&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;[]&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;v3&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Cmp&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
    &lt;span class=&#34;nx&#34;&gt;cmps&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;make&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;([]&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;v3&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Cmp&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;len&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;ws&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;))&lt;/span&gt;
    &lt;span class=&#34;k&#34;&gt;for&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;key&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;range&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;ws&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
        &lt;span class=&#34;nx&#34;&gt;cmps&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;append&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;cmps&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;v3&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;Compare&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;v3&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;ModRevision&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;key&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt; &lt;span class=&#34;s&#34;&gt;&amp;#34;&amp;lt;&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;rev&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;))&lt;/span&gt;
    &lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
    &lt;span class=&#34;k&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;cmps&lt;/span&gt;
&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;å³ï¼Œå®ƒä¸ä»…è¦ç¡®ä¿æˆ‘è¯»å–è¿‡çš„æ•°æ®æ˜¯æœ€æ–°çš„ï¼Œä¹Ÿè¦ç¡®ä¿æˆ‘è¦å†™å…¥çš„æ•°æ®ä¹Ÿæ²¡æœ‰è¢«åˆ«äººæ›´æ”¹è¿‡ï¼Œè¿™æ˜¯æœ€é«˜çš„éš”ç¦»çº§åˆ«ï¼Œä¹Ÿæ˜¯ stm çš„é»˜è®¤éš”ç¦»çº§åˆ«ã€‚åœ¨ä¼ ç»Ÿæ•°æ®åº“ä¸­ï¼Œè¦å®ç°è¿™æ ·ä¸€ä¸ªéš”ç¦»çº§åˆ«ï¼Œä¸€èˆ¬é€šè¿‡è¯»å†™é”æ¥é™åˆ¶ç«æ€å†²çªï¼Œè€Œè¿™é‡Œåˆ™æ˜¯é€šè¿‡æå…¶ä¸¥æ ¼çš„å†²çªæ£€æµ‹ï¼Œç¨å¾®æœ‰ç‚¹ä¸ä¸€æ ·çš„åœ°æ–¹å®ƒå°±è®¤ä¸ºå‘ç”Ÿå†²çªäº†ï¼Œéœ€è¦ stm å»é‡è¯•ã€‚&lt;/p&gt;

&lt;h3 id=&#34;åŒºåˆ«æ±‡æ€»&#34;&gt;åŒºåˆ«æ±‡æ€»&lt;/h3&gt;

&lt;p&gt;ç»¼ä¸Šæ‰€è¿°ï¼Œè¿™å››ç§éš”ç¦»çº§åˆ«åœ¨å®ç°ä¸Šä¸»è¦æœ‰ä¸¤ç‚¹åŒºåˆ«ï¼š&lt;strong&gt;è¯»å–æ•°æ®çš„ç‰ˆæœ¬&lt;/strong&gt;å’Œ&lt;strong&gt;å†²çªæ£€æµ‹çš„æ–¹æ³•&lt;/strong&gt;ã€‚å¦‚æœæˆ‘ä»¬å°†äº‹åŠ¡åˆšå¼€å§‹æ—¶çš„ç‰ˆæœ¬å·ç§°ä¸º&lt;code&gt;FIRST_REV&lt;/code&gt;ï¼Œå°†è¯»æ“ä½œçœŸæ­£å‘ç”Ÿæ—¶å€™çš„ç‰ˆæœ¬å·ç§°ä¸º&lt;code&gt;CURRENT_REV&lt;/code&gt;ï¼Œå°† key çš„ ModRevision ç®€ç§°ä¸º&lt;code&gt;MOD_REV&lt;/code&gt;ï¼Œé‚£å®ƒä»¬çš„åŒºåˆ«å¯ä»¥ç”¨ä¸€å¼ è¡¨æ€»ç»“å‡ºæ¥ï¼š&lt;/p&gt;

&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;Isolation Level&lt;/th&gt;
&lt;th&gt;Read Revision&lt;/th&gt;
&lt;th&gt;Conflict Detection&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;

&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;RepeatableReads&lt;/td&gt;
&lt;td&gt;CURRENT_REV&lt;/td&gt;
&lt;td&gt;readSet: MOD_REV == CURRENT_REV&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;ReadCommitted&lt;/td&gt;
&lt;td&gt;CURRENT_REV&lt;/td&gt;
&lt;td&gt;nil&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;Serializable&lt;/td&gt;
&lt;td&gt;FIRST_REV&lt;/td&gt;
&lt;td&gt;readSet: MOD_REV == FIRST_REV&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;SerializableSnapshot&lt;/td&gt;
&lt;td&gt;FIRST_REV&lt;/td&gt;
&lt;td&gt;readSet: MOD_REV == FIRST_REV&lt;br /&gt;writeSet: MOD_REV &amp;lt; FIRST_REV&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;

&lt;p&gt;è€Œå¯¹äº STM æ¥å£çš„ä¸¤ä¸ªå®ç°&lt;code&gt;stm&lt;/code&gt;å’Œ&lt;code&gt;stmSerializable&lt;/code&gt;ï¼Œå®ƒä»¬çš„åŒºåˆ«åœ¨äºï¼Œè¯»å–æ“ä½œæ˜¯å¦ä¼šå—åˆ°å…¶ä»–äº‹åŠ¡çš„å½±å“ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;//blog.betacat.io/image/2019/08/etcd-transaction-isolation-levels/serializable-read.svg&#34; alt=&#34;serializable read&#34; /&gt;&lt;/p&gt;

&lt;h2 id=&#34;æ€»ç»“&#34;&gt;æ€»ç»“&lt;/h2&gt;

&lt;p&gt;æœ¬æ–‡ä»¥ etcd ä¸ºä¾‹ï¼Œä»‹ç»äº†äº‹åŠ¡éš”ç¦»æœºåˆ¶çš„å®ç°ã€‚å½“ç„¶ï¼Œè¿™é‡Œçš„å®ç°è·Ÿä¼ ç»Ÿå…³ç³»å‹æ•°æ®åº“ï¼ˆMySQLã€PostgreSQLï¼‰çš„å®ç°è¿˜æ˜¯æœ‰ä¸€å®šåŒºåˆ«çš„ã€‚å…³ç³»å‹æ•°æ®åº“ä¸€èˆ¬é€šè¿‡ç»™ä¸€ä¸ª row å¢åŠ ä¸¤ä¸ªå­—æ®µï¼ˆtransaction-created, transaction-deletedï¼‰æ¥åšæ•°æ®å¯è§æ€§çš„éš”ç¦»ï¼Œå†è¾…ä»¥æ‚²è§‚é”æ¥åšå¹¶å‘æ§åˆ¶ï¼Œè€Œ etcd é‡Œçš„å®ç°ç±»ä¼¼äºäº‹åŠ¡å‹å†…å­˜ï¼Œåœ¨ä¸€ä¸ªäº‹åŠ¡çš„ä¸Šä¸‹æ–‡é‡Œå…ˆç¼“å­˜ä¸šåŠ¡ä»£ç çš„æ‰€æœ‰è¯»ã€å†™è¯·æ±‚ï¼Œåœ¨çœŸæ­£æäº¤çš„æ—¶å€™æ ¹æ®ä¸åŒçš„éš”ç¦»çº§åˆ«åšå†²çªæ£€æµ‹ï¼Œä»è€Œå†³å®šæ˜¯å¦é‡è¯•ã€‚å¯ä»¥çœ‹åˆ°ï¼Œåº•å±‚æš´éœ²å‡ºæ¥çš„ MVCC åŸè¯­å…·æœ‰æå¼ºçš„è¡¨è¾¾èƒ½åŠ›ï¼Œæˆ‘ä»¬åœ¨å®¢æˆ·ç«¯å°±å¯ä»¥åšåˆ°åŸæœ¬åœ¨æœåŠ¡ç«¯æ‰èƒ½åšåˆ°çš„äº‹æƒ…ã€‚&lt;/p&gt;

&lt;p&gt;å¦å¤–ï¼Œå°± etcd å¸¸è§çš„ä½¿ç”¨åœºæ™¯å®˜æ–¹çš„ SDK ä¸­éƒ½æœ‰ç°æˆçš„å®ç°ï¼ˆå‚è§ &lt;a href=&#34;https://github.com/etcd-io/etcd/tree/v3.3.10/clientv3/concurrency&#34;&gt;concurrency&lt;/a&gt;, &lt;a href=&#34;https://github.com/etcd-io/etcd/tree/v3.3.10/contrib/recipes&#34;&gt;contrib/recipes&lt;/a&gt;ï¼‰ï¼Œå¸Œæœ›å¤§å®¶ä¸è¦å†é‡å¤é€ è½®å­äº†ï¼Œå®˜æ–¹çš„è½®å­åˆå¤§åˆåœ†ï¼Œè€Œè‡ªå·±é€ çš„è½®å­å¾€å¾€éƒ½æ˜¯ ctrl+cã€ctrl+v æ¥çš„ä»£ç ï¼Œåˆ°å¤„æ˜¯å‘ã€‚å¤šè¯»è¯»æºä»£ç ï¼Œèƒ½è®©ä½ å°‘è¶Ÿå¾ˆå¤šå‘ã€‚&lt;/p&gt;
&lt;div class=&#34;footnotes&#34;&gt;

&lt;hr /&gt;

&lt;ol&gt;
&lt;li id=&#34;fn:etcd-v3-3-10&#34;&gt;&lt;a href=&#34;https://github.com/etcd-io/etcd/tree/v3.3.10&#34;&gt;etcd v3.3.10&lt;/a&gt;
 &lt;a class=&#34;footnote-return&#34; href=&#34;#fnref:etcd-v3-3-10&#34;&gt;&lt;sup&gt;[return]&lt;/sup&gt;&lt;/a&gt;&lt;/li&gt;
&lt;li id=&#34;fn:etcd-revisions&#34;&gt;&lt;a href=&#34;https://github.com/etcd-io/etcd/issues/6518&#34;&gt;What is different between Revision, ModRevision and Version?&lt;/a&gt;
 &lt;a class=&#34;footnote-return&#34; href=&#34;#fnref:etcd-revisions&#34;&gt;&lt;sup&gt;[return]&lt;/sup&gt;&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;/div&gt;
</description>
      
    </item>
    
    <item>
      <title>ä½¿ç”¨ Telepresence åœ¨æœ¬åœ°è°ƒè¯• Kubernetes å¾®æœåŠ¡</title>
      <link>//blog.betacat.io/post/develop-and-debug-k8s-microservices-locally-using-telepresence/</link>
      <pubDate>Wed, 24 Jul 2019 23:10:21 +0800</pubDate>
      
      <guid>//blog.betacat.io/post/develop-and-debug-k8s-microservices-locally-using-telepresence/</guid>
      
        <description>

&lt;p&gt;å¾®æœåŠ¡ä½œä¸ºä¸€ç§å…¨æ–°çš„è½¯ä»¶æ¶æ„ç°åœ¨æ­£å˜å¾—è¶Šæ¥è¶Šç«ã€‚åŸºæœ¬åŸå› æˆ‘è§‰å¾—æœ‰ä¸¤ç‚¹ï¼šä¸€æ–¹é¢è½¯ä»¶ç³»ç»Ÿè¶Šåšè¶Šå¤æ‚ï¼Œé€šè¿‡æ‹†åˆ†å°†ä¸€ä¸ªå¤§ç³»ç»Ÿè§£è€¦æˆä¸€ä¸ªä¸ªç‹¬ç«‹çš„å­ç³»ç»Ÿï¼Œæˆ‘ä»¬å°±é™ä½äº†æ•´ä¸ªç³»ç»Ÿçš„å¤æ‚æ€§ã€‚å¦ä¸€æ–¹é¢ï¼Œ&lt;a href=&#34;https://zh.wikipedia.org/wiki/Kubernetes&#34;&gt;Kubernetes&lt;/a&gt; çš„å‡ºç°ä½¿å¾—ç¼–æ’è¿™ä¹ˆå¤šå­ç³»ç»Ÿå˜å¾—ç®€å•ï¼Œå¯ä»¥è¯´ Kubernetes æ˜¯ç›®å‰ä¸ºæ­¢å¾®æœåŠ¡æœ€å¥½çš„è½½ä½“ã€‚&lt;/p&gt;

&lt;p&gt;Kubernetes è§£å†³äº†å¾®æœåŠ¡è¿è¡Œæ—¶çš„ç¯å¢ƒé—®é¢˜ï¼Œä½†å¯¹å¼€å‘ç¯å¢ƒå°±ä¸é‚£ä¹ˆå‹å¥½äº†ã€‚æ¯”æ–¹è¯´å¦‚æœæˆ‘ä»¬è¦åœ¨æœ¬åœ°å¼€å‘è°ƒè¯•ä¸€ä¸ªæœåŠ¡Aï¼Œä½†æœåŠ¡Aå¯èƒ½ä¾èµ–æœåŠ¡Bã€Cï¼Œè€ŒæœåŠ¡Båˆæœ‰ä¸€å±‚ä¾èµ–Dï¼Œæˆ‘ä»¬å°±éœ€è¦åœ¨æœ¬åœ°æŠŠæœåŠ¡Bã€Cã€Déƒ½æ­å»ºèµ·æ¥æ‰èƒ½è°ƒè¯•æœåŠ¡Aã€‚è¿™æ˜¾ç„¶æ˜¯ä¸€ä¸ªå¾ˆç—›è‹¦çš„è¿‡ç¨‹ã€‚&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;//blog.betacat.io/image/telepresence/dependency-hell.svg&#34; alt=&#34;Microservices Dependency Hell&#34; /&gt;&lt;/p&gt;

&lt;p&gt;ä¸šç•Œæœ‰æœ‹å‹ç”¨ &lt;code&gt;docker-compose&lt;/code&gt; æ¥æ¨¡æ‹Ÿé›†ç¾¤ä¸­çš„åœºæ™¯ã€‚è¿™ä¸ªæ–¹æ¡ˆçš„ä¸è¶³ä¹‹å¤„åœ¨äºå®ƒéœ€è¦æŠŠ Kubernetes çš„é‚£ä¸€å¥—é€»è¾‘ç”¨ &lt;code&gt;docker-compose.yml&lt;/code&gt; æ–‡ä»¶é‡å†™ä¸€éï¼Œè¿™ç»™æˆ‘ä»¬å¸¦æ¥äº†ç»´æŠ¤æˆæœ¬ã€‚å¦ä¸€æ–¹é¢ï¼Œæœ¬åœ°æœºå™¨å¾ˆå¯èƒ½ä¸å…·å¤‡æŸäº›å¾®æœåŠ¡æ‰€ä¾èµ–çš„èµ„æºã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-yaml&#34; data-lang=&#34;yaml&#34;&gt;&lt;span class=&#34;lnt&#34;&gt; 1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 2
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 3
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 4
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 5
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 6
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 7
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 8
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 9
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;10
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;11
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;12
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;13
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;14
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;15
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;16
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;17
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;18
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;19
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;20
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;21
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;22
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-yaml&#34; data-lang=&#34;yaml&#34;&gt;ratesvc&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;image&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;kubeapps/ratesvc&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;latest&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;environment&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;-&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;JWT_KEY=secret&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;c&#34;&gt;# &amp;lt;------------------------ æ‰‹å·¥ç»´æŠ¤&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;command&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;-&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;/ratesvc&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;-&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;--mongo-url=mongodb&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;//root@mongodb&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;c&#34;&gt;# &amp;lt;---- æ‰‹å·¥ç»´æŠ¤&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;-&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;--mongo-database=ratesvc&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;mongodb&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;image&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;bitnami/mongodb&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;3&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;environment&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;-&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;MONGODB_ROOT_PASSWORD=password123&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;auth&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;image&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;kubeapps/oauth2-bitnami&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;latest&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;volumes&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;-&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;./config.yaml&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;/config/monocular.yaml&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;c&#34;&gt;# &amp;lt;-- æ‰‹å·¥ç»´æŠ¤&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;...&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;volumnes&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;c&#34;&gt;# &amp;lt;----------------------------------- æ‰‹å·¥ç»´æŠ¤&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;monocular-data&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;å¦ä¸€ç§è§£å†³æ–¹æ¡ˆå°±æ˜¯æˆ‘è¿™é‡Œè¦ä»‹ç»çš„ Telepresence äº†ï¼Œå®ƒèƒ½å¤Ÿåœ¨ä¸ä¿®æ”¹ç¨‹åºä»£ç çš„æƒ…å†µä¸‹ï¼Œè®©æœ¬åœ°åº”ç”¨ç¨‹åºæ— æ„Ÿçš„æ¥å…¥åˆ° Kubernetes é›†ç¾¤ä¸­ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥ç›´æ¥åœ¨æœ¬åœ°å¼€å‘è°ƒè¯•å¾®æœåŠ¡äº†ã€‚&lt;/p&gt;

&lt;h2 id=&#34;ç®€ä»‹&#34;&gt;ç®€ä»‹&lt;/h2&gt;

&lt;p&gt;&lt;a href=&#34;https://www.telepresence.io/&#34;&gt;Telepresence&lt;/a&gt; æ˜¯ä¸€ä¸ª CNCF &lt;sup class=&#34;footnote-ref&#34; id=&#34;fnref:CNCF&#34;&gt;&lt;a href=&#34;#fn:CNCF&#34;&gt;1&lt;/a&gt;&lt;/sup&gt; åŸºé‡‘ä¼šä¸‹çš„é¡¹ç›®ã€‚å®ƒçš„å·¥ä½œåŸç†æ˜¯åœ¨æœ¬åœ°å’Œ Kubernetes é›†ç¾¤ä¸­æ­å»ºä¸€ä¸ªé€æ˜çš„åŒå‘ä»£ç†ï¼Œè¿™ä½¿å¾—æˆ‘ä»¬å¯ä»¥åœ¨æœ¬åœ°ç”¨ç†Ÿæ‚‰çš„ IDE å’Œè°ƒè¯•å·¥å…·æ¥è¿è¡Œä¸€ä¸ªå¾®æœåŠ¡ï¼ŒåŒæ—¶è¯¥æœåŠ¡è¿˜å¯ä»¥æ— ç¼çš„ä¸ Kubernetes é›†ç¾¤ä¸­çš„å…¶ä»–æœåŠ¡è¿›è¡Œäº¤äº’ï¼Œå¥½åƒå®ƒå°±è¿è¡Œåœ¨è¿™ä¸ªé›†ç¾¤ä¸­ä¸€æ ·ã€‚&lt;/p&gt;

&lt;p&gt;è¿™æ˜¯ä¸€ä¸ª Telepresence å·¥ä½œåŸç†å›¾ï¼Œå®ƒå°†é›†ç¾¤ä¸­çš„æ•°æ®å·ã€ç¯å¢ƒå˜é‡ã€ç½‘ç»œéƒ½ä»£ç†åˆ°äº†æœ¬åœ°ï¼ˆé™¤äº†æ•°æ®å·å¤–ï¼Œå…¶ä»–ä¸¤ä¸ªå¯¹åº”ç”¨ç¨‹åºæ¥è¯´éƒ½æ˜¯é€æ˜çš„ï¼‰ï¼š&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;//blog.betacat.io/image/telepresence/telepresence-proxies.svg&#34; alt=&#34;Telepresence Proxies&#34; /&gt;&lt;/p&gt;

&lt;p&gt;æœ‰äº†è¿™äº›ä»£ç†ä¹‹åï¼š&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;æœ¬åœ°çš„æœåŠ¡å°±å¯ä»¥ç›´æ¥ä½¿ç”¨åŸŸåè®¿é—®åˆ°è¿œç¨‹é›†ç¾¤ä¸­çš„å…¶ä»–æœåŠ¡&lt;/li&gt;
&lt;li&gt;æœ¬åœ°çš„æœåŠ¡ç›´æ¥è®¿é—®åˆ° Kubernetes é‡Œçš„å„ç§èµ„æºï¼ŒåŒ…æ‹¬ç¯å¢ƒå˜é‡ã€secretsã€config mapç­‰&lt;/li&gt;
&lt;li&gt;ç”šè‡³é›†ç¾¤ä¸­çš„æœåŠ¡è¿˜èƒ½ç›´æ¥è®¿é—®åˆ°æœ¬åœ°æš´éœ²å‡ºæ¥çš„æ¥å£&lt;/li&gt;
&lt;/ol&gt;

&lt;h2 id=&#34;å®‰è£…&#34;&gt;å®‰è£…&lt;/h2&gt;

&lt;p&gt;macOS:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;lnt&#34;&gt;1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;2
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;brew cask install osxfuse  &lt;span class=&#34;c1&#34;&gt;# required by sshfs to mount the pod&amp;#39;s filesystem&lt;/span&gt;
brew install datawire/blackbird/telepresence&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;å…¶ä»–å¹³å°è¯·å‚è€ƒï¼š&lt;a href=&#34;https://www.telepresence.io/reference/install&#34;&gt;https://www.telepresence.io/reference/install&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;å¦‚æœå®˜æ–¹çš„å®‰è£…åŒ…æ²¡æœ‰è¦†ç›–åˆ°ä½ çš„å¹³å°ï¼Œå…¶å®ä¹Ÿå¯ä»¥ä»æºä»£ç å®‰è£…ï¼Œå› ä¸ºå®ƒæœ¬èº«å°±æ˜¯ç”¨ Python3 å†™çš„ï¼Œç†Ÿæ‚‰ Python çš„æœ‹å‹å®‰è£…è¿™ä¸ªç¨‹åºåº”è¯¥ä¸éš¾ï¼Œæˆ‘è‡ªå·±å°±åœ¨ CentOS 7 ä¸Šå®‰è£…æˆåŠŸäº†ã€‚&lt;/p&gt;

&lt;h2 id=&#34;ä½¿ç”¨åœºæ™¯&#34;&gt;ä½¿ç”¨åœºæ™¯&lt;/h2&gt;

&lt;p&gt;å‡è®¾æˆ‘ä»¬æœ‰ä¸¤ä¸ªæœåŠ¡ A å’Œ Bï¼ŒæœåŠ¡ A æ˜¯ä¾èµ–äºæœåŠ¡ B çš„ã€‚ä¸‹é¢åˆ†ä¸¤ä¸ªåœºæ™¯æ¥çœ‹çœ‹å¦‚ä½•ç”¨ Telepresence  åˆ†åˆ«è°ƒè¯• A å’Œ Bã€‚&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;//blog.betacat.io/image/telepresence/service-a-b.svg&#34; alt=&#34;Service A&amp;amp;B&#34; /&gt;&lt;/p&gt;

&lt;h3 id=&#34;è°ƒè¯•æœåŠ¡-a-æœ¬åœ°ä¸è¿œç«¯æœåŠ¡è”è°ƒ&#34;&gt;è°ƒè¯•æœåŠ¡ A - æœ¬åœ°ä¸è¿œç«¯æœåŠ¡è”è°ƒ&lt;/h3&gt;

&lt;p&gt;æœåŠ¡ A åœ¨æœ¬åœ°è¿è¡Œï¼ŒæœåŠ¡ B è¿è¡Œåœ¨è¿œç«¯é›†ç¾¤ä¸­ã€‚å€ŸåŠ© Telepresence æ­å»ºçš„ä»£ç†ï¼ŒA å°±èƒ½ç›´æ¥è®¿é—®åˆ° Bã€‚æ¯”æ–¹è¯´æˆ‘ä»¬çš„æœåŠ¡ B æ˜¯è¿™æ ·ä¸€ä¸ªç¨‹åºï¼Œå®ƒç›‘å¬åœ¨8000ç«¯å£ä¸Šã€‚æ¯å½“æœ‰äººè®¿é—®æ—¶å®ƒå°±è¿”å›&lt;code&gt;Hello, world!&lt;/code&gt;ã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;lnt&#34;&gt;1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;2
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;3
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;4
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;$ kubectl run service-b --image&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;datawire/hello-world --port&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;8000&lt;/span&gt; --expose
$ kubectl get service service-b
NAME        CLUSTER-IP   EXTERNAL-IP   PORT&lt;span class=&#34;o&#34;&gt;(&lt;/span&gt;S&lt;span class=&#34;o&#34;&gt;)&lt;/span&gt;    AGE
service-b   &lt;span class=&#34;m&#34;&gt;10&lt;/span&gt;.0.0.12    &amp;lt;none&amp;gt;        &lt;span class=&#34;m&#34;&gt;8000&lt;/span&gt;/TCP   1m&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;ç°åœ¨åœ¨æœ¬åœ°ç”¨é»˜è®¤å‚æ•°å¯åŠ¨ Telepresence ï¼Œç­‰å®ƒè¿æ¥å¥½é›†ç¾¤ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;lnt&#34;&gt; 1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 2
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 3
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 4
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 5
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 6
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 7
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 8
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 9
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;10
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;11
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;12
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;$ telepresence
T: Starting proxy with method &lt;span class=&#34;s1&#34;&gt;&amp;#39;vpn-tcp&amp;#39;&lt;/span&gt;, which has the following limitations: All processes are affected, only one telepresence can run per machine, and you
T: can&lt;span class=&#34;err&#34;&gt;&amp;#39;&lt;/span&gt;t use other VPNs. You may need to add cloud hosts and headless services with --also-proxy. For a full list of method limitations see
T: https://telepresence.io/reference/methods.html
T: Volumes are rooted at &lt;span class=&#34;nv&#34;&gt;$TELEPRESENCE_ROOT&lt;/span&gt;. See https://telepresence.io/howto/volumes.html &lt;span class=&#34;k&#34;&gt;for&lt;/span&gt; details.
T: Starting network proxy to cluster using new Deployment telepresence-1566230249-7112632-14485

T: No traffic is being forwarded from the remote Deployment to your &lt;span class=&#34;nb&#34;&gt;local&lt;/span&gt; machine. You can use the --expose option to specify which ports you want to
T: forward.

T: Setup complete. Launching your command.
@test_cluster&lt;span class=&#34;p&#34;&gt;|&lt;/span&gt;bash-4.2#&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;è¿™æ—¶å€™å°±å¯ä»¥å¼€å§‹è°ƒè¯•æœåŠ¡ A äº†ï¼Œå› ä¸ºæœåŠ¡ B æš´éœ²å‡ºæ¥çš„æ¥å£æœ¬åœ°å·²ç»å¯ä»¥ç›´æ¥è®¿é—®åˆ°ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;lnt&#34;&gt;1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;2
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;$ curl http://service-b:8000/
Hello, world!&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;è¿™é‡Œè¦è¯´æ˜ä¸€ä¸‹è¿™èƒŒåå‘ç”Ÿçš„äº‹æƒ…ï¼š&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;å½“è¿è¡Œ Telepresence å‘½ä»¤çš„æ—¶å€™ï¼Œå®ƒåˆ›å»ºäº†ä¸€ä¸ª&lt;code&gt;Deployment&lt;/code&gt;ï¼Œè¿™ä¸ª&lt;code&gt;Deployment&lt;/code&gt;çš„ Spec æ˜¯ä¸€ä¸ªè½¬å‘æµé‡çš„ä»£ç†å®¹å™¨ï¼Œæˆ‘ä»¬å¯ä»¥è¿™æ ·æŸ¥çœ‹åˆ°å®ƒ &lt;code&gt;kubectl get pod -l telepresence&lt;/code&gt;ã€‚&lt;/li&gt;
&lt;li&gt;åŒæ—¶å®ƒè¿˜åœ¨æœ¬åœ°åˆ›å»ºäº†ä¸€ä¸ªå…¨å±€çš„ VPNï¼Œä½¿å¾—æœ¬åœ°çš„æ‰€æœ‰ç¨‹åºéƒ½å¯ä»¥è®¿é—®åˆ°é›†ç¾¤ä¸­çš„æœåŠ¡ã€‚ Telepresence å…¶å®è¿˜æ”¯æŒå…¶ä»–çš„ç½‘ç»œä»£ç†æ¨¡å¼ï¼ˆä½¿ç”¨&lt;code&gt;--method&lt;/code&gt;åˆ‡æ¢ï¼‰ï¼Œ&lt;code&gt;vpn-tcp&lt;/code&gt;æ˜¯é»˜è®¤çš„æ–¹å¼ï¼Œå…¶ä»–çš„å¥½åƒç”¨å¤„ä¸å¤§ï¼Œ&lt;code&gt;inject-tcp&lt;/code&gt;ç”šè‡³è¦åœ¨åç»­çš„ç‰ˆæœ¬ä¸­&lt;a href=&#34;https://www.youtube.com/watch?v=k9lh4ZuKsiQ&#34;&gt;å–æ¶ˆæ‰&lt;/a&gt;ã€‚&lt;/li&gt;
&lt;li&gt;å½“æœ¬åœ°çš„&lt;code&gt;curl&lt;/code&gt;è®¿é—®&lt;code&gt;http://service-b:8000/&lt;/code&gt;æ—¶ï¼Œå¯¹åº”çš„ DNS æŸ¥è¯¢å’Œ HTTP è¯·æ±‚éƒ½è¢« VPN è·¯ç”±åˆ°é›†ç¾¤ä¸­åˆšåˆšåˆ›å»ºçš„å®¹å™¨ä¸­å¤„ç†ã€‚å¦‚æœåŸŸåè§£æä¸äº† (Could not resolve host)ï¼Œå¯ä»¥è¯•è¯•åŠ ä¸Š search åç¼€ï¼š&lt;code&gt;service-b.&amp;lt;NAMESPACE&amp;gt;.svc.cluster.local&lt;/code&gt;ã€‚&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;æ–°çš„æ‹“æ‰‘ç»“æ„ä¸ºï¼š&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;//blog.betacat.io/image/telepresence/local-service-a.svg&#34; alt=&#34;Local Service A&#34; /&gt;&lt;/p&gt;

&lt;p&gt;é™¤æ­¤ä¹‹å¤– Telepresence è¿˜å°†è¿œç«¯çš„æ–‡ä»¶ç³»ç»Ÿé€šè¿‡&lt;code&gt;sshfs&lt;/code&gt;æŒ‚è½½åˆ°æœ¬åœ°&lt;code&gt;$TELEPRESENCE_ROOT&lt;/code&gt;ä¸‹é¢ï¼ˆä¹Ÿæ”¯æŒé€šè¿‡å‚æ•°&lt;code&gt;--mount &amp;lt;MOUNT_PATH&amp;gt;&lt;/code&gt;æŒ‡å®šæŒ‚è½½çš„è·¯å¾„ï¼‰ã€‚è¿™æ ·ï¼Œæˆ‘ä»¬çš„åº”ç”¨ç¨‹åºå°±å¯ä»¥åœ¨æœ¬åœ°è®¿é—®åˆ°è¿œç«¯çš„æ–‡ä»¶ç³»ç»Ÿï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;lnt&#34;&gt;1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;2
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;$ ls &lt;span class=&#34;nv&#34;&gt;$TELEPRESENCE_ROOT&lt;/span&gt;/var/run/secrets/kubernetes.io/serviceaccount
ca.crt  namespace  token&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;å¦‚æœæˆ‘ä»¬é€€å‡º Telepresence å¯¹åº”çš„ Shellï¼Œå®ƒä¹Ÿä¼šåšä¸€äº›æ¸…ç†å·¥ä½œï¼Œæ¯”å¦‚å–æ¶ˆæœ¬åœ° VPNã€åˆ é™¤åˆšåˆšåˆ›å»ºçš„&lt;code&gt;Deployment&lt;/code&gt;ç­‰ã€‚&lt;/p&gt;

&lt;h3 id=&#34;è°ƒè¯•æœåŠ¡-b-é›†ç¾¤å†…æœåŠ¡ä¸æœ¬åœ°è”è°ƒ&#34;&gt;è°ƒè¯•æœåŠ¡ B - é›†ç¾¤å†…æœåŠ¡ä¸æœ¬åœ°è”è°ƒ&lt;/h3&gt;

&lt;p&gt;æœåŠ¡ B ä¸åˆšæ‰çš„ä¸åŒä¹‹å¤„åœ¨äºï¼Œå®ƒæ˜¯è¢«åˆ«äººè®¿é—®çš„ï¼Œè¦è°ƒè¯•å®ƒï¼Œé¦–å…ˆå¾—è¦æœ‰çœŸå®çš„è®¿é—®æµé‡ã€‚æˆ‘ä»¬å¦‚ä½•æ‰èƒ½åšåˆ°å°†åˆ«äººå¯¹å®ƒçš„è®¿é—®è·¯ç”±åˆ°æœ¬åœ°æ¥ï¼Œä»è€Œå®ç°åœ¨æœ¬åœ°æ•æ‰åˆ°é›†ç¾¤ä¸­çš„æµé‡å‘¢ï¼Ÿ&lt;/p&gt;

&lt;p&gt;Telepresence æä¾›è¿™æ ·ä¸€ä¸ªå‚æ•°ï¼Œ&lt;code&gt;--swap-deployment &amp;lt;DEPLOYMENT_NAME[:CONTAINER]&amp;gt;&lt;/code&gt;ï¼Œç”¨æ¥å°†é›†ç¾¤ä¸­çš„ä¸€ä¸ª&lt;code&gt;Deployment&lt;/code&gt;æ›¿æ¢ä¸ºæœ¬åœ°çš„æœåŠ¡ã€‚å¯¹äºä¸Šé¢çš„&lt;code&gt;service-b&lt;/code&gt;ï¼Œæˆ‘ä»¬å¯ä»¥è¿™æ ·æ›¿æ¢ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;lnt&#34;&gt;1
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;$ telepresence --swap-deployment service-b --expose &lt;span class=&#34;m&#34;&gt;8000&lt;/span&gt;:8000&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;è¿™ä¸ªæ—¶å€™é›†ç¾¤ä¸­çš„æœåŠ¡ A å†æƒ³è®¿é—®æœåŠ¡ B çš„8000ç«¯å£æ—¶ï¼ŒTelepresence å°±ä¼šå°†è¿™ä¸ªè¯·æ±‚è½¬å‘åˆ°æœ¬åœ°çš„8000ç«¯å£ã€‚å³æ–°çš„æ‹“æ‰‘ç»“æ„å˜æˆï¼š&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;//blog.betacat.io/image/telepresence/local-service-b.svg&#34; alt=&#34;Local Service B&#34; /&gt;&lt;/p&gt;

&lt;p&gt;å®ƒçš„å·¥ä½œåŸç†æ¦‚è¿°å¦‚ä¸‹ï¼š&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;åœ¨é›†ç¾¤ä¸­åˆ›å»ºä¸€ä¸ªä»£ç†&lt;code&gt;Deployment&lt;/code&gt;ï¼Œå¹¶å¤åˆ¶&lt;code&gt;service-b&lt;/code&gt;çš„æ‰€æœ‰&lt;code&gt;Label&lt;/code&gt;ã€‚&lt;/li&gt;
&lt;li&gt;å»ºç«‹ä¸€ä¸ªè·¯ç”±é€šé“ï¼Œå°†ä»£ç†å®¹å™¨çš„æ‰€æœ‰æµé‡è½¬å‘åˆ°æœ¬åœ° 8000 ç«¯å£ã€‚&lt;/li&gt;
&lt;li&gt;å°†&lt;code&gt;service-b&lt;/code&gt;çš„ replicas æ•°è®¾ä¸º0ï¼Œè¿™æ · K8S &lt;code&gt;Service&lt;/code&gt; çš„ selector å°±åªèƒ½åŒ¹é…åˆ°åˆšåˆšåˆ›å»ºçš„ä»£ç†å®¹å™¨ä¸Šã€‚&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;é€šè¿‡è¿™æ ·çš„æ–¹æ³•ï¼Œæˆ‘ä»¬å°±æœ‰æœºä¼šå°†é›†ç¾¤ä¸­çš„è¯·æ±‚è½¬å‘åˆ°æœ¬åœ°ï¼Œç„¶ååœ¨æœ¬åœ°æŸ¥çœ‹åˆ°å…·ä½“çš„è¯·æ±‚æ•°æ®ï¼Œè°ƒè¯•é€»è¾‘ï¼Œä»¥åŠç”Ÿæˆæ–°çš„å›å¤ã€‚&lt;/p&gt;

&lt;h2 id=&#34;æ€»ç»“&#34;&gt;æ€»ç»“&lt;/h2&gt;

&lt;p&gt;è¿™ç¯‡æ–‡ç« é‡Œæˆ‘å…ˆæå‡ºäº†å¾®æœåŠ¡å¼€å‘ä¸­ä¸€ä¸ªå¸¸è§çš„é—®é¢˜ï¼Œç„¶åä»‹ç»äº† Telepresence é¡¹ç›®ï¼Œå¹¶ä¸”ä¸¾ä¾‹è¯´æ˜äº†æ€æ ·ç”¨å®ƒæ¥è°ƒè¯•ä¸¤ç§å¸¸è§çš„å¾®æœåŠ¡åœºæ™¯ã€‚å½“ç„¶ï¼ŒTelepresence è¿˜åœ¨ä¸æ–­çš„æ¼”è¿›ï¼Œæœ¬æ–‡ä¸­ä½¿ç”¨çš„æ˜¯&lt;a href=&#34;https://github.com/telepresenceio/telepresence/tree/0.103&#34;&gt;v0.103&lt;/a&gt;ç‰ˆæœ¬ï¼Œåç»­ç‰ˆæœ¬å¾ˆå¯èƒ½æœ‰äº›ä¸ä¸€æ ·çš„åœ°æ–¹ï¼Œä¹Ÿæ¬¢è¿å¤§å®¶ä¸æ–­æŒ‡æ­£ã€‚&lt;/p&gt;
&lt;div class=&#34;footnotes&#34;&gt;

&lt;hr /&gt;

&lt;ol&gt;
&lt;li id=&#34;fn:CNCF&#34;&gt;Cloud Native Computing Foundationï¼Œè‡´åŠ›äºæ¨å¹¿äº‘åŸç”Ÿåº”ç”¨ï¼Œæ——ä¸‹çš„ä»£è¡¨é¡¹ç›®æœ‰ Kubernetesï¼Œetcdç­‰ã€‚
 &lt;a class=&#34;footnote-return&#34; href=&#34;#fnref:CNCF&#34;&gt;&lt;sup&gt;[return]&lt;/sup&gt;&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;/div&gt;
</description>
      
    </item>
    
    <item>
      <title>ç†è§£ Go æ ‡å‡†åº“ä¸­çš„ atomic.Value ç±»å‹</title>
      <link>//blog.betacat.io/post/golang-atomic-value-exploration/</link>
      <pubDate>Fri, 15 Mar 2019 21:30:47 +0800</pubDate>
      
      <guid>//blog.betacat.io/post/golang-atomic-value-exploration/</guid>
      
        <description>

&lt;p&gt;åœ¨ Go è¯­è¨€æ ‡å‡†åº“ä¸­ï¼Œ&lt;code&gt;sync/atomic&lt;/code&gt;åŒ…å°†åº•å±‚ç¡¬ä»¶æä¾›çš„åŸå­æ“ä½œå°è£…æˆäº† Go çš„å‡½æ•°ã€‚ä½†è¿™äº›æ“ä½œåªæ”¯æŒå‡ ç§åŸºæœ¬æ•°æ®ç±»å‹ï¼Œå› æ­¤ä¸ºäº†æ‰©å¤§åŸå­æ“ä½œçš„é€‚ç”¨èŒƒå›´ï¼ŒGo è¯­è¨€åœ¨ 1.4 ç‰ˆæœ¬çš„æ—¶å€™å‘&lt;code&gt;sync/atomic&lt;/code&gt;åŒ…ä¸­æ·»åŠ äº†ä¸€ä¸ªæ–°çš„ç±»å‹&lt;code&gt;Value&lt;/code&gt;ã€‚æ­¤ç±»å‹çš„å€¼ç›¸å½“äºä¸€ä¸ªå®¹å™¨ï¼Œå¯ä»¥è¢«ç”¨æ¥â€œåŸå­åœ°&amp;rdquo;å­˜å‚¨ï¼ˆStoreï¼‰å’ŒåŠ è½½ï¼ˆLoadï¼‰&lt;strong&gt;ä»»æ„ç±»å‹&lt;/strong&gt;çš„å€¼ã€‚&lt;/p&gt;

&lt;h2 id=&#34;å†å²èµ·æº&#34;&gt;å†å²èµ·æº&lt;/h2&gt;

&lt;p&gt;æˆ‘åœ¨&lt;code&gt;golang-dev&lt;/code&gt;é‚®ä»¶åˆ—è¡¨ä¸­ç¿»åˆ°äº†14å¹´çš„&lt;a href=&#34;https://groups.google.com/forum/#!msg/golang-dev/SBmIen68ys0/WGfYQQSO4nAJ&#34;&gt;è¿™æ®µè®¨è®º&lt;/a&gt;ï¼Œæœ‰ç”¨æˆ·æŠ¥å‘Šäº†&lt;code&gt;encoding/gob&lt;/code&gt;åŒ…åœ¨å¤šæ ¸æœºå™¨ä¸Šï¼ˆ80-coreï¼‰ä¸Šçš„æ€§èƒ½é—®é¢˜ï¼Œè®¤ä¸º&lt;code&gt;encoding/gob&lt;/code&gt;ä¹‹æ‰€ä»¥ä¸èƒ½å®Œå…¨åˆ©ç”¨åˆ°å¤šæ ¸çš„ç‰¹æ€§æ˜¯å› ä¸ºå®ƒé‡Œé¢ä½¿ç”¨äº†å¤§é‡çš„äº’æ–¥é”ï¼ˆmutexï¼‰ï¼Œå¦‚æœæŠŠè¿™äº›äº’æ–¥é”æ¢æˆç”¨&lt;code&gt;atomic.LoadPointer/StorePointer&lt;/code&gt;æ¥åšå¹¶å‘æ§åˆ¶ï¼Œé‚£æ€§èƒ½å°†èƒ½æå‡20å€ã€‚&lt;/p&gt;

&lt;p&gt;é’ˆå¯¹è¿™ä¸ªé—®é¢˜ï¼Œæœ‰äººæè®®åœ¨å·²æœ‰çš„&lt;code&gt;atomic&lt;/code&gt;åŒ…çš„åŸºç¡€ä¸Šå°è£…å‡ºä¸€ä¸ª&lt;code&gt;atomic.Value&lt;/code&gt;ç±»å‹ï¼Œè¿™æ ·ç”¨æˆ·å°±å¯ä»¥åœ¨ä¸ä¾èµ– Go å†…éƒ¨ç±»å‹&lt;code&gt;unsafe.Pointer&lt;/code&gt;çš„æƒ…å†µä¸‹ä½¿ç”¨åˆ°&lt;code&gt;atomic&lt;/code&gt;æä¾›çš„åŸå­æ“ä½œã€‚æ‰€ä»¥æˆ‘ä»¬ç°åœ¨çœ‹åˆ°çš„&lt;code&gt;atomic&lt;/code&gt;åŒ…ä¸­é™¤äº†&lt;code&gt;atomic.Value&lt;/code&gt;å¤–ï¼Œå…¶ä½™éƒ½æ˜¯æ—©æœŸç”±æ±‡ç¼–å†™æˆçš„ï¼Œå¹¶ä¸”&lt;code&gt;atomic.Value&lt;/code&gt;ç±»å‹çš„åº•å±‚å®ç°ä¹Ÿæ˜¯å»ºç«‹åœ¨å·²æœ‰çš„&lt;code&gt;atomic&lt;/code&gt;åŒ…çš„åŸºç¡€ä¸Šã€‚&lt;/p&gt;

&lt;p&gt;é‚£ä¸ºä»€ä¹ˆåœ¨ä¸Šé¢çš„åœºæ™¯ä¸­ï¼Œ&lt;code&gt;atomic&lt;/code&gt;ä¼šæ¯”&lt;code&gt;mutex&lt;/code&gt;æ€§èƒ½å¥½å¾ˆå¤šå‘¢ï¼Ÿä½œè€… &lt;a href=&#34;https://github.com/dvyukov&#34;&gt;Dmitry Vyukov&lt;/a&gt; æ€»ç»“äº†è¿™ä¸¤è€…çš„ä¸€ä¸ªåŒºåˆ«ï¼š&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;Mutexes do no scale. Atomic loads do.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;&lt;code&gt;Mutex&lt;/code&gt;ç”±&lt;strong&gt;æ“ä½œç³»ç»Ÿ&lt;/strong&gt;å®ç°ï¼Œè€Œ&lt;code&gt;atomic&lt;/code&gt;åŒ…ä¸­çš„åŸå­æ“ä½œåˆ™ç”±&lt;strong&gt;åº•å±‚ç¡¬ä»¶&lt;/strong&gt;ç›´æ¥æä¾›æ”¯æŒã€‚åœ¨ CPU å®ç°çš„æŒ‡ä»¤é›†é‡Œï¼Œæœ‰ä¸€äº›æŒ‡ä»¤è¢«å°è£…è¿›äº†&lt;code&gt;atomic&lt;/code&gt;åŒ…ï¼Œè¿™äº›æŒ‡ä»¤åœ¨æ‰§è¡Œçš„è¿‡ç¨‹ä¸­æ˜¯ä¸å…è®¸ä¸­æ–­ï¼ˆinterruptï¼‰çš„ï¼Œå› æ­¤åŸå­æ“ä½œå¯ä»¥åœ¨&lt;code&gt;lock-free&lt;/code&gt;çš„æƒ…å†µä¸‹ä¿è¯å¹¶å‘å®‰å…¨ï¼Œå¹¶ä¸”å®ƒçš„æ€§èƒ½ä¹Ÿèƒ½åšåˆ°éš CPU ä¸ªæ•°çš„å¢å¤šè€Œçº¿æ€§æ‰©å±•ã€‚&lt;/p&gt;

&lt;p&gt;å¥½äº†ï¼Œè¯´äº†è¿™ä¹ˆå¤šçš„åŸå­æ“ä½œï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ä»€ä¹ˆæ ·çš„æ“ä½œèƒ½è¢«å«åš&lt;em&gt;åŸå­æ“ä½œ&lt;/em&gt; ã€‚&lt;/p&gt;

&lt;h3 id=&#34;åŸå­æ€§&#34;&gt;åŸå­æ€§&lt;/h3&gt;

&lt;p&gt;ä¸€ä¸ªæˆ–è€…å¤šä¸ªæ“ä½œåœ¨ CPU æ‰§è¡Œçš„è¿‡ç¨‹ä¸­ä¸è¢«ä¸­æ–­çš„ç‰¹æ€§ï¼Œç§°ä¸º&lt;em&gt;åŸå­æ€§ï¼ˆatomicityï¼‰&lt;/em&gt; ã€‚è¿™äº›æ“ä½œå¯¹å¤–è¡¨ç°æˆä¸€ä¸ªä¸å¯åˆ†å‰²çš„æ•´ä½“ï¼Œä»–ä»¬è¦ä¹ˆéƒ½æ‰§è¡Œï¼Œè¦ä¹ˆéƒ½ä¸æ‰§è¡Œï¼Œå¤–ç•Œä¸ä¼šçœ‹åˆ°ä»–ä»¬åªæ‰§è¡Œåˆ°ä¸€åŠçš„çŠ¶æ€ã€‚è€Œåœ¨ç°å®ä¸–ç•Œä¸­ï¼ŒCPU ä¸å¯èƒ½ä¸ä¸­æ–­çš„æ‰§è¡Œä¸€ç³»åˆ—æ“ä½œï¼Œä½†å¦‚æœæˆ‘ä»¬åœ¨æ‰§è¡Œå¤šä¸ªæ“ä½œæ—¶ï¼Œèƒ½è®©ä»–ä»¬çš„&lt;strong&gt;ä¸­é—´çŠ¶æ€å¯¹å¤–ä¸å¯è§&lt;/strong&gt;ï¼Œé‚£æˆ‘ä»¬å°±å¯ä»¥å®£ç§°ä»–ä»¬æ‹¥æœ‰äº†&amp;rdquo;ä¸å¯åˆ†å‰²â€çš„åŸå­æ€§ã€‚&lt;/p&gt;

&lt;p&gt;æœ‰äº›æœ‹å‹å¯èƒ½ä¸çŸ¥é“ï¼Œåœ¨ Goï¼ˆç”šè‡³æ˜¯å¤§éƒ¨åˆ†è¯­è¨€ï¼‰ä¸­ï¼Œä¸€æ¡æ™®é€šçš„èµ‹å€¼è¯­å¥å…¶å®ä¸æ˜¯ä¸€ä¸ªåŸå­æ“ä½œã€‚ä¾‹å¦‚ï¼Œåœ¨32ä½æœºå™¨ä¸Šå†™&lt;code&gt;int64&lt;/code&gt;ç±»å‹çš„å˜é‡å°±ä¼šæœ‰ä¸­é—´çŠ¶æ€ï¼Œå› ä¸ºå®ƒä¼šè¢«æ‹†æˆä¸¤æ¬¡å†™æ“ä½œï¼ˆ&lt;code&gt;MOV&lt;/code&gt;ï¼‰â€”â€”å†™ä½ 32 ä½å’Œå†™é«˜ 32 ä½ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;//blog.betacat.io/image/golang-atomic-value/64-bit-write.svg&#34; alt=&#34;64ä½å˜é‡çš„èµ‹å€¼æ“ä½œ&#34; /&gt;&lt;/p&gt;

&lt;p&gt;å¦‚æœä¸€ä¸ªçº¿ç¨‹åˆšå†™å®Œä½32ä½ï¼Œè¿˜æ²¡æ¥å¾—åŠå†™é«˜32ä½æ—¶ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹è¯»å–äº†è¿™ä¸ªå˜é‡ï¼Œé‚£å®ƒå¾—åˆ°çš„å°±æ˜¯ä¸€ä¸ªæ¯«æ— é€»è¾‘çš„ä¸­é—´å˜é‡ï¼Œè¿™å¾ˆæœ‰å¯èƒ½ä½¿æˆ‘ä»¬çš„ç¨‹åºå‡ºç°è¯¡å¼‚çš„ Bugã€‚&lt;/p&gt;

&lt;p&gt;è¿™è¿˜åªæ˜¯ä¸€ä¸ªåŸºç¡€ç±»å‹ï¼Œå¦‚æœæˆ‘ä»¬å¯¹ä¸€ä¸ªç»“æ„ä½“è¿›è¡Œèµ‹å€¼ï¼Œé‚£å®ƒå‡ºç°å¹¶å‘é—®é¢˜çš„æ¦‚ç‡å°±æ›´é«˜äº†ã€‚å¾ˆå¯èƒ½å†™çº¿ç¨‹åˆšå†™å®Œä¸€å°åŠçš„å­—æ®µï¼Œè¯»çº¿ç¨‹å°±æ¥è¯»å–è¿™ä¸ªå˜é‡ï¼Œé‚£ä¹ˆå°±åªèƒ½è¯»åˆ°ä»…ä¿®æ”¹äº†ä¸€éƒ¨åˆ†çš„å€¼ã€‚è¿™æ˜¾ç„¶ç ´åäº†å˜é‡çš„å®Œæ•´æ€§ï¼Œè¯»å‡ºæ¥çš„å€¼ä¹Ÿæ˜¯å®Œå…¨é”™è¯¯çš„ã€‚&lt;/p&gt;

&lt;p&gt;é¢å¯¹è¿™ç§å¤šçº¿ç¨‹ä¸‹å˜é‡çš„è¯»å†™é—®é¢˜ï¼Œæˆ‘ä»¬çš„ä¸»è§’â€”â€”&lt;code&gt;atomic.Value&lt;/code&gt;ç™»åœºäº†ï¼Œå®ƒä½¿å¾—æˆ‘ä»¬å¯ä»¥ä¸ä¾èµ–äºä¸ä¿è¯å…¼å®¹æ€§çš„&lt;code&gt;unsafe.Pointer&lt;/code&gt;ç±»å‹ï¼ŒåŒæ—¶åˆèƒ½å°†ä»»æ„æ•°æ®ç±»å‹çš„è¯»å†™æ“ä½œå°è£…æˆåŸå­æ€§æ“ä½œï¼ˆè®©ä¸­é—´çŠ¶æ€å¯¹å¤–ä¸å¯è§ï¼‰ã€‚&lt;/p&gt;

&lt;h2 id=&#34;ä½¿ç”¨å§¿åŠ¿&#34;&gt;ä½¿ç”¨å§¿åŠ¿&lt;/h2&gt;

&lt;p&gt;&lt;code&gt;atomic.Value&lt;/code&gt;ç±»å‹å¯¹å¤–æš´éœ²çš„æ–¹æ³•å°±ä¸¤ä¸ªï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;code&gt;v.Store(c)&lt;/code&gt; - å†™æ“ä½œï¼Œå°†åŸå§‹çš„å˜é‡&lt;code&gt;c&lt;/code&gt;å­˜æ”¾åˆ°ä¸€ä¸ª&lt;code&gt;atomic.Value&lt;/code&gt;ç±»å‹çš„&lt;code&gt;v&lt;/code&gt;é‡Œã€‚&lt;/li&gt;
&lt;li&gt;&lt;code&gt;c = v.Load()&lt;/code&gt; - è¯»æ“ä½œï¼Œä»çº¿ç¨‹å®‰å…¨çš„&lt;code&gt;v&lt;/code&gt;ä¸­è¯»å–ä¸Šä¸€æ­¥å­˜æ”¾çš„å†…å®¹ã€‚&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;ç®€æ´çš„æ¥å£ä½¿å¾—å®ƒçš„ä½¿ç”¨ä¹Ÿå¾ˆç®€å•ï¼Œåªéœ€å°†éœ€è¦ä½œå¹¶å‘ä¿æŠ¤çš„å˜é‡è¯»å–å’Œèµ‹å€¼æ“ä½œç”¨&lt;code&gt;Load()&lt;/code&gt;å’Œ&lt;code&gt;Store()&lt;/code&gt;ä»£æ›¿å°±è¡Œäº†ã€‚&lt;/p&gt;

&lt;p&gt;ä¸‹é¢æ˜¯ä¸€ä¸ªå¸¸è§çš„ä½¿ç”¨åœºæ™¯ï¼šåº”ç”¨ç¨‹åºå®šæœŸçš„ä»å¤–ç•Œè·å–æœ€æ–°çš„é…ç½®ä¿¡æ¯ï¼Œç„¶åæ›´æ”¹è‡ªå·±å†…å­˜ä¸­ç»´æŠ¤çš„é…ç½®å˜é‡ã€‚å·¥ä½œçº¿ç¨‹æ ¹æ®æœ€æ–°çš„é…ç½®æ¥å¤„ç†è¯·æ±‚ã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;lnt&#34;&gt; 1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 2
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 3
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 4
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 5
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 6
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 7
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 8
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 9
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;10
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;11
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;12
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;13
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;14
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;15
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;16
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;17
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;18
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;19
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;20
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;21
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;22
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;23
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;24
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;25
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;26
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;27
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;28
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;29
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;30
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;31
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;32
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;33
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;34
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;35
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;36
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;37
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;38
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;39
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;40
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;41
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;42
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;43
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;kn&#34;&gt;package&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;main&lt;/span&gt;

&lt;span class=&#34;kn&#34;&gt;import&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;
  &lt;span class=&#34;s&#34;&gt;&amp;#34;sync/atomic&amp;#34;&lt;/span&gt;
  &lt;span class=&#34;s&#34;&gt;&amp;#34;time&amp;#34;&lt;/span&gt;
&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;

&lt;span class=&#34;kd&#34;&gt;func&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;loadConfig&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt; &lt;span class=&#34;kd&#34;&gt;map&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;string&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;string&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
  &lt;span class=&#34;c1&#34;&gt;// ä»æ•°æ®åº“æˆ–è€…æ–‡ä»¶ç³»ç»Ÿä¸­è¯»å–é…ç½®ä¿¡æ¯ï¼Œç„¶åä»¥mapçš„å½¢å¼å­˜æ”¾åœ¨å†…å­˜é‡Œ
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;  &lt;span class=&#34;k&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;make&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;map&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;string&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;string&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;

&lt;span class=&#34;kd&#34;&gt;func&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;requests&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt; &lt;span class=&#34;kd&#34;&gt;chan&lt;/span&gt; &lt;span class=&#34;kt&#34;&gt;int&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
  &lt;span class=&#34;c1&#34;&gt;// å°†ä»å¤–ç•Œä¸­æ¥å—åˆ°çš„è¯·æ±‚æ”¾å…¥åˆ°channelé‡Œ
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;  &lt;span class=&#34;k&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;make&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;chan&lt;/span&gt; &lt;span class=&#34;kt&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;

&lt;span class=&#34;kd&#34;&gt;func&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;main&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
  &lt;span class=&#34;c1&#34;&gt;// configå˜é‡ç”¨æ¥å­˜æ”¾è¯¥æœåŠ¡çš„é…ç½®ä¿¡æ¯
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;  &lt;span class=&#34;kd&#34;&gt;var&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;config&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;atomic&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Value&lt;/span&gt;
  &lt;span class=&#34;c1&#34;&gt;// åˆå§‹åŒ–æ—¶ä»åˆ«çš„åœ°æ–¹åŠ è½½é…ç½®æ–‡ä»¶ï¼Œå¹¶å­˜åˆ°configå˜é‡é‡Œ
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;  &lt;span class=&#34;nx&#34;&gt;config&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;Store&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;loadConfig&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;())&lt;/span&gt;
  &lt;span class=&#34;k&#34;&gt;go&lt;/span&gt; &lt;span class=&#34;kd&#34;&gt;func&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
    &lt;span class=&#34;c1&#34;&gt;// æ¯10ç§’é’Ÿå®šæ—¶çš„æ‹‰å–æœ€æ–°çš„é…ç½®ä¿¡æ¯ï¼Œå¹¶ä¸”æ›´æ–°åˆ°configå˜é‡é‡Œ
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;    &lt;span class=&#34;k&#34;&gt;for&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
      &lt;span class=&#34;nx&#34;&gt;time&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;Sleep&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;10&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;*&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;time&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Second&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
      &lt;span class=&#34;c1&#34;&gt;// å¯¹åº”äºèµ‹å€¼æ“ä½œ config = loadConfig()
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;      &lt;span class=&#34;nx&#34;&gt;config&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;Store&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;loadConfig&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;())&lt;/span&gt;
    &lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
  &lt;span class=&#34;p&#34;&gt;}()&lt;/span&gt;
  &lt;span class=&#34;c1&#34;&gt;// åˆ›å»ºå·¥ä½œçº¿ç¨‹ï¼Œæ¯ä¸ªå·¥ä½œçº¿ç¨‹éƒ½ä¼šæ ¹æ®å®ƒæ‰€è¯»å–åˆ°çš„æœ€æ–°çš„é…ç½®ä¿¡æ¯æ¥å¤„ç†è¯·æ±‚
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;  &lt;span class=&#34;k&#34;&gt;for&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;i&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;i&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;10&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;++&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
    &lt;span class=&#34;k&#34;&gt;go&lt;/span&gt; &lt;span class=&#34;kd&#34;&gt;func&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
      &lt;span class=&#34;k&#34;&gt;for&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;r&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;range&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;requests&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
        &lt;span class=&#34;c1&#34;&gt;// å¯¹åº”äºå–å€¼æ“ä½œ c := config
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;        &lt;span class=&#34;c1&#34;&gt;// ç”±äºLoad()è¿”å›çš„æ˜¯ä¸€ä¸ªinterface{}ç±»å‹ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦å…ˆå¼ºåˆ¶è½¬æ¢ä¸€ä¸‹
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;        &lt;span class=&#34;nx&#34;&gt;c&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;config&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;Load&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;().(&lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;map&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;string&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;string&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
        &lt;span class=&#34;c1&#34;&gt;// è¿™é‡Œæ˜¯æ ¹æ®é…ç½®ä¿¡æ¯å¤„ç†è¯·æ±‚çš„é€»è¾‘...
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;        &lt;span class=&#34;nx&#34;&gt;_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;_&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;c&lt;/span&gt;
      &lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
    &lt;span class=&#34;p&#34;&gt;}()&lt;/span&gt;
  &lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;h2 id=&#34;å†…éƒ¨å®ç°&#34;&gt;å†…éƒ¨å®ç°&lt;/h2&gt;

&lt;p&gt;&lt;a href=&#34;https://zh.wikipedia.org/wiki/ç½—æ°¸æµ©&#34;&gt;ç½—æ°¸æµ©æµ©&lt;/a&gt;æ›¾è¯´è¿‡ï¼š&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;Simplicity is the hidden complexity&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;æˆ‘ä»¬æ¥çœ‹çœ‹åœ¨ç®€å•çš„å¤–è¡¨ä¸‹ï¼Œå®ƒåˆ°åº•æœ‰å“ªäº› hidden complexityã€‚&lt;/p&gt;

&lt;h3 id=&#34;æ•°æ®ç»“æ„&#34;&gt;æ•°æ®ç»“æ„&lt;/h3&gt;

&lt;p&gt;&lt;code&gt;atomic.Value&lt;/code&gt;è¢«è®¾è®¡ç”¨æ¥å­˜å‚¨ä»»æ„ç±»å‹çš„æ•°æ®ï¼Œæ‰€ä»¥å®ƒå†…éƒ¨çš„å­—æ®µæ˜¯ä¸€ä¸ª&lt;code&gt;interface{}&lt;/code&gt;ç±»å‹ï¼Œéå¸¸çš„ç®€å•ç²—æš´ã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;lnt&#34;&gt;1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;2
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;3
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;kd&#34;&gt;type&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;Value&lt;/span&gt; &lt;span class=&#34;kd&#34;&gt;struct&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
  &lt;span class=&#34;nx&#34;&gt;v&lt;/span&gt; &lt;span class=&#34;kd&#34;&gt;interface&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{}&lt;/span&gt;
&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;é™¤äº†&lt;code&gt;Value&lt;/code&gt;å¤–ï¼Œè¿™ä¸ªæ–‡ä»¶é‡Œè¿˜å®šä¹‰äº†ä¸€ä¸ª&lt;code&gt;ifaceWords&lt;/code&gt;ç±»å‹ï¼Œè¿™å…¶å®æ˜¯ä¸€ä¸ªç©ºinterface (&lt;code&gt;interface{}&lt;/code&gt;ï¼‰çš„å†…éƒ¨è¡¨ç¤ºæ ¼å¼ï¼ˆå‚è§runtime/runtime2.goä¸­efaceçš„å®šä¹‰ï¼‰ã€‚å®ƒçš„ä½œç”¨æ˜¯å°†&lt;code&gt;interface{}&lt;/code&gt;ç±»å‹åˆ†è§£ï¼Œå¾—åˆ°å…¶ä¸­çš„ä¸¤ä¸ªå­—æ®µã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;lnt&#34;&gt;1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;2
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;3
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;4
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;kd&#34;&gt;type&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;ifaceWords&lt;/span&gt; &lt;span class=&#34;kd&#34;&gt;struct&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
  &lt;span class=&#34;nx&#34;&gt;typ&lt;/span&gt;  &lt;span class=&#34;nx&#34;&gt;unsafe&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Pointer&lt;/span&gt;
  &lt;span class=&#34;nx&#34;&gt;data&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;unsafe&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Pointer&lt;/span&gt;
&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;h3 id=&#34;å†™å…¥-store-æ“ä½œ&#34;&gt;å†™å…¥ï¼ˆStoreï¼‰æ“ä½œ&lt;/h3&gt;

&lt;p&gt;åœ¨ä»‹ç»å†™å…¥ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹ Go è¯­è¨€å†…éƒ¨çš„&lt;code&gt;unsafe.Pointer&lt;/code&gt;ç±»å‹ã€‚&lt;/p&gt;

&lt;h4 id=&#34;unsafe-pointer&#34;&gt;unsafe.Pointer&lt;/h4&gt;

&lt;p&gt;å‡ºäºå®‰å…¨è€ƒè™‘ï¼ŒGo è¯­è¨€å¹¶ä¸æ”¯æŒç›´æ¥æ“ä½œå†…å­˜ï¼Œä½†å®ƒçš„æ ‡å‡†åº“ä¸­åˆæä¾›ä¸€ç§&lt;em&gt;ä¸å®‰å…¨ï¼ˆä¸ä¿è¯å‘åå…¼å®¹æ€§ï¼‰&lt;/em&gt; çš„æŒ‡é’ˆç±»å‹&lt;code&gt;unsafe.Pointer&lt;/code&gt;ï¼Œè®©ç¨‹åºå¯ä»¥çµæ´»çš„æ“ä½œå†…å­˜ã€‚&lt;/p&gt;

&lt;p&gt;&lt;code&gt;unsafe.Pointer&lt;/code&gt;çš„ç‰¹åˆ«ä¹‹å¤„åœ¨äºï¼Œå®ƒå¯ä»¥ç»•è¿‡ Go è¯­è¨€ç±»å‹ç³»ç»Ÿçš„æ£€æŸ¥ï¼Œä¸ä»»æ„çš„æŒ‡é’ˆç±»å‹äº’ç›¸è½¬æ¢ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœä¸¤ç§ç±»å‹å…·æœ‰ç›¸åŒçš„å†…å­˜ç»“æ„ï¼ˆlayoutï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥å°†&lt;code&gt;unsafe.Pointer&lt;/code&gt;å½“åšæ¡¥æ¢ï¼Œè®©è¿™ä¸¤ç§ç±»å‹çš„æŒ‡é’ˆç›¸äº’è½¬æ¢ï¼Œä»è€Œå®ç°åŒä¸€ä»½å†…å­˜æ‹¥æœ‰ä¸¤ç§ä¸åŒçš„&lt;strong&gt;è§£è¯»&lt;/strong&gt;æ–¹å¼ã€‚&lt;/p&gt;

&lt;p&gt;æ¯”å¦‚è¯´ï¼Œ&lt;code&gt;[]byte&lt;/code&gt;å’Œ&lt;code&gt;string&lt;/code&gt;å…¶å®å†…éƒ¨çš„å­˜å‚¨ç»“æ„éƒ½æ˜¯ä¸€æ ·çš„ï¼Œä½† Go è¯­è¨€çš„ç±»å‹ç³»ç»Ÿç¦æ­¢ä»–ä¿©äº’æ¢ã€‚å¦‚æœå€ŸåŠ©&lt;code&gt;unsafe.Pointer&lt;/code&gt;ï¼Œæˆ‘ä»¬å°±å¯ä»¥å®ç°åœ¨é›¶æ‹·è´çš„æƒ…å†µä¸‹ï¼Œå°†&lt;code&gt;[]byte&lt;/code&gt;æ•°ç»„ç›´æ¥è½¬æ¢æˆ&lt;code&gt;string&lt;/code&gt;ç±»å‹ã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;lnt&#34;&gt;1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;2
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;3
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;4
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;5
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;nx&#34;&gt;bytes&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;[]&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;byte&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;104&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;101&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;108&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;108&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;111&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;

&lt;span class=&#34;nx&#34;&gt;p&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;unsafe&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;Pointer&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;bytes&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;c1&#34;&gt;//å¼ºåˆ¶è½¬æ¢æˆunsafe.Pointerï¼Œç¼–è¯‘å™¨ä¸ä¼šæŠ¥é”™
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;str&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;string&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;p&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;c1&#34;&gt;//ç„¶åå¼ºåˆ¶è½¬æ¢æˆstringç±»å‹çš„æŒ‡é’ˆï¼Œå†å°†è¿™ä¸ªæŒ‡é’ˆçš„å€¼å½“åšstringç±»å‹å–å‡ºæ¥
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;fmt&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;Println&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;str&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;//&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;è¾“å‡º&lt;/span&gt; &lt;span class=&#34;s&#34;&gt;&amp;#34;hello&amp;#34;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;çŸ¥é“äº†&lt;code&gt;unsafe.Pointer&lt;/code&gt;çš„ä½œç”¨ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥æ¥çœ‹ä»£ç äº†ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;lnt&#34;&gt; 1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 2
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 3
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 4
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 5
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 6
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 7
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 8
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 9
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;10
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;11
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;12
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;13
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;14
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;15
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;16
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;17
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;18
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;19
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;20
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;21
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;22
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;23
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;24
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;25
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;26
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;27
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;28
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;29
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;30
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;31
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;32
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;33
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;34
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;35
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;36
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;37
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;38
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;kd&#34;&gt;func&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;v&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Value&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;Store&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;x&lt;/span&gt; &lt;span class=&#34;kd&#34;&gt;interface&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{})&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
  &lt;span class=&#34;k&#34;&gt;if&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;x&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;==&lt;/span&gt; &lt;span class=&#34;kc&#34;&gt;nil&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
    &lt;span class=&#34;nb&#34;&gt;panic&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;sync/atomic: store of nil value into Value&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
  &lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
  &lt;span class=&#34;nx&#34;&gt;vp&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;ifaceWords&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;unsafe&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;Pointer&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;v&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;))&lt;/span&gt;  &lt;span class=&#34;c1&#34;&gt;// Old value
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;  &lt;span class=&#34;nx&#34;&gt;xp&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;ifaceWords&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;unsafe&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;Pointer&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;x&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;))&lt;/span&gt; &lt;span class=&#34;c1&#34;&gt;// New value
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;  &lt;span class=&#34;k&#34;&gt;for&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
    &lt;span class=&#34;nx&#34;&gt;typ&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;LoadPointer&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;vp&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;typ&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
    &lt;span class=&#34;k&#34;&gt;if&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;typ&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;==&lt;/span&gt; &lt;span class=&#34;kc&#34;&gt;nil&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
      &lt;span class=&#34;c1&#34;&gt;// Attempt to start first store.
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;      &lt;span class=&#34;c1&#34;&gt;// Disable preemption so that other goroutines can use
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;      &lt;span class=&#34;c1&#34;&gt;// active spin wait to wait for completion; and so that
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;      &lt;span class=&#34;c1&#34;&gt;// GC does not see the fake type accidentally.
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;      &lt;span class=&#34;nf&#34;&gt;runtime_procPin&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;
      &lt;span class=&#34;k&#34;&gt;if&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;!&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;CompareAndSwapPointer&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;vp&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;typ&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;kc&#34;&gt;nil&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;unsafe&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;Pointer&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(^&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;uintptr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)))&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
        &lt;span class=&#34;nf&#34;&gt;runtime_procUnpin&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;
        &lt;span class=&#34;k&#34;&gt;continue&lt;/span&gt;
      &lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
      &lt;span class=&#34;c1&#34;&gt;// Complete first store.
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;      &lt;span class=&#34;nf&#34;&gt;StorePointer&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;vp&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;data&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;xp&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;data&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
      &lt;span class=&#34;nf&#34;&gt;StorePointer&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;vp&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;typ&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;xp&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;typ&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
      &lt;span class=&#34;nf&#34;&gt;runtime_procUnpin&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;
      &lt;span class=&#34;k&#34;&gt;return&lt;/span&gt;
    &lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
    &lt;span class=&#34;k&#34;&gt;if&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;uintptr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;typ&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;==&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;^&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;uintptr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
      &lt;span class=&#34;c1&#34;&gt;// First store in progress. Wait.
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;      &lt;span class=&#34;c1&#34;&gt;// Since we disable preemption around the first store,
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;      &lt;span class=&#34;c1&#34;&gt;// we can wait with active spinning.
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;      &lt;span class=&#34;k&#34;&gt;continue&lt;/span&gt;
    &lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
    &lt;span class=&#34;c1&#34;&gt;// First store completed. Check type and overwrite data.
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;    &lt;span class=&#34;k&#34;&gt;if&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;typ&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;!=&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;xp&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;typ&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
      &lt;span class=&#34;nb&#34;&gt;panic&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;sync/atomic: store of inconsistently typed value into Value&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
    &lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
    &lt;span class=&#34;nf&#34;&gt;StorePointer&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;vp&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;data&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;xp&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;data&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
    &lt;span class=&#34;k&#34;&gt;return&lt;/span&gt;
  &lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;å¤§æ¦‚çš„é€»è¾‘ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;ç¬¬5~6è¡Œ - é€šè¿‡&lt;code&gt;unsafe.Pointer&lt;/code&gt;å°†&lt;strong&gt;ç°æœ‰çš„&lt;/strong&gt;å’Œ&lt;strong&gt;è¦å†™å…¥çš„&lt;/strong&gt;å€¼åˆ†åˆ«è½¬æˆ&lt;code&gt;ifaceWords&lt;/code&gt;ç±»å‹ï¼Œè¿™æ ·æˆ‘ä»¬ä¸‹ä¸€æ­¥å°±å¯ä»¥å¾—åˆ°è¿™ä¸¤ä¸ª&lt;code&gt;interface{}&lt;/code&gt;çš„åŸå§‹ç±»å‹ï¼ˆtypï¼‰å’ŒçœŸæ­£çš„å€¼ï¼ˆdataï¼‰ã€‚&lt;/li&gt;
&lt;li&gt;ä»ç¬¬7è¡Œå¼€å§‹å°±æ˜¯ä¸€ä¸ªæ— é™ for å¾ªç¯ã€‚é…åˆ&lt;code&gt;CompareAndSwap&lt;/code&gt;é£Ÿç”¨ï¼Œå¯ä»¥è¾¾åˆ°ä¹è§‚é”çš„åŠŸæ•ˆã€‚&lt;/li&gt;
&lt;li&gt;ç¬¬8è¡Œï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡&lt;code&gt;LoadPointer&lt;/code&gt;è¿™ä¸ªåŸå­æ“ä½œæ‹¿åˆ°å½“å‰&lt;code&gt;Value&lt;/code&gt;ä¸­å­˜å‚¨çš„ç±»å‹ã€‚ä¸‹é¢æ ¹æ®è¿™ä¸ªç±»å‹çš„ä¸åŒï¼Œåˆ†3ç§æƒ…å†µå¤„ç†ã€‚

&lt;br /&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;ol&gt;
&lt;li&gt;ç¬¬ä¸€æ¬¡å†™å…¥ï¼ˆç¬¬9~24è¡Œï¼‰ - ä¸€ä¸ª&lt;code&gt;Value&lt;/code&gt;å®ä¾‹è¢«åˆå§‹åŒ–åï¼Œå®ƒçš„&lt;code&gt;typ&lt;/code&gt;å­—æ®µä¼šè¢«è®¾ç½®ä¸ºæŒ‡é’ˆçš„é›¶å€¼ nilï¼Œæ‰€ä»¥ç¬¬9è¡Œå…ˆåˆ¤æ–­å¦‚æœ&lt;code&gt;typ&lt;/code&gt;æ˜¯ nil é‚£å°±è¯æ˜è¿™ä¸ª&lt;code&gt;Value&lt;/code&gt;è¿˜æœªè¢«å†™å…¥è¿‡æ•°æ®ã€‚é‚£ä¹‹åå°±æ˜¯ä¸€æ®µåˆå§‹å†™å…¥çš„æ“ä½œï¼š

&lt;ul&gt;
&lt;li&gt;&lt;code&gt;runtime_procPin()&lt;/code&gt;è¿™æ˜¯runtimeä¸­çš„ä¸€æ®µå‡½æ•°ï¼Œå…·ä½“çš„åŠŸèƒ½æˆ‘ä¸æ˜¯ç‰¹åˆ«æ¸…æ¥šï¼Œä¹Ÿæ²¡æœ‰æ‰¾åˆ°ç›¸å…³çš„æ–‡æ¡£ã€‚è¿™é‡ŒçŒœæµ‹ä¸€ä¸‹ï¼Œä¸€æ–¹é¢å®ƒç¦æ­¢äº†è°ƒåº¦å™¨å¯¹å½“å‰ goroutine çš„æŠ¢å ï¼ˆpreemptionï¼‰ï¼Œä½¿å¾—å®ƒåœ¨æ‰§è¡Œå½“å‰é€»è¾‘çš„æ—¶å€™ä¸è¢«æ‰“æ–­ï¼Œä»¥ä¾¿å¯ä»¥å°½å¿«åœ°å®Œæˆå·¥ä½œï¼Œå› ä¸ºåˆ«äººä¸€ç›´åœ¨ç­‰å¾…å®ƒã€‚å¦ä¸€æ–¹é¢ï¼Œåœ¨ç¦æ­¢æŠ¢å æœŸé—´ï¼ŒGC çº¿ç¨‹ä¹Ÿæ— æ³•è¢«å¯ç”¨ï¼Œè¿™æ ·å¯ä»¥é˜²æ­¢ GC çº¿ç¨‹çœ‹åˆ°ä¸€ä¸ªè«åå…¶å¦™çš„æŒ‡å‘&lt;code&gt;^uintptr(0)&lt;/code&gt;çš„ç±»å‹ï¼ˆè¿™æ˜¯èµ‹å€¼è¿‡ç¨‹ä¸­çš„ä¸­é—´çŠ¶æ€ï¼‰ã€‚&lt;/li&gt;
&lt;li&gt;ä½¿ç”¨&lt;code&gt;CAS&lt;/code&gt;æ“ä½œï¼Œå…ˆå°è¯•å°†&lt;code&gt;typ&lt;/code&gt;è®¾ç½®ä¸º&lt;code&gt;^uintptr(0)&lt;/code&gt;è¿™ä¸ªä¸­é—´çŠ¶æ€ã€‚å¦‚æœå¤±è´¥ï¼Œåˆ™è¯æ˜å·²ç»æœ‰åˆ«çš„çº¿ç¨‹æŠ¢å…ˆå®Œæˆäº†èµ‹å€¼æ“ä½œï¼Œé‚£å®ƒå°±è§£é™¤æŠ¢å é”ï¼Œç„¶åé‡æ–°å›åˆ° for å¾ªç¯ç¬¬ä¸€æ­¥ã€‚&lt;/li&gt;
&lt;li&gt;å¦‚æœè®¾ç½®æˆåŠŸï¼Œé‚£è¯æ˜å½“å‰çº¿ç¨‹æŠ¢åˆ°äº†è¿™ä¸ª&amp;rdquo;ä¹è§‚é”&amp;rdquo;ï¼Œå®ƒå¯ä»¥å®‰å…¨çš„æŠŠ&lt;code&gt;v&lt;/code&gt;è®¾ä¸ºä¼ å…¥çš„æ–°å€¼äº†ï¼ˆ19~23è¡Œï¼‰ã€‚æ³¨æ„ï¼Œè¿™é‡Œæ˜¯å…ˆå†™&lt;code&gt;data&lt;/code&gt;å­—æ®µï¼Œç„¶åå†å†™&lt;code&gt;typ&lt;/code&gt;å­—æ®µã€‚å› ä¸ºæˆ‘ä»¬æ˜¯ä»¥&lt;code&gt;typ&lt;/code&gt;å­—æ®µçš„å€¼ä½œä¸ºå†™å…¥å®Œæˆä¸å¦çš„åˆ¤æ–­ä¾æ®çš„ã€‚&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;ç¬¬ä¸€æ¬¡å†™å…¥è¿˜æœªå®Œæˆï¼ˆç¬¬25~30è¡Œï¼‰- å¦‚æœçœ‹åˆ°&lt;code&gt;typ&lt;/code&gt;å­—æ®µè¿˜æ˜¯&lt;code&gt;^uintptr(0)&lt;/code&gt;è¿™ä¸ªä¸­é—´ç±»å‹ï¼Œè¯æ˜åˆšåˆšçš„ç¬¬ä¸€æ¬¡å†™å…¥è¿˜æ²¡æœ‰å®Œæˆï¼Œæ‰€ä»¥å®ƒä¼šç»§ç»­å¾ªç¯ï¼Œ&amp;rdquo;å¿™ç­‰&amp;rdquo;åˆ°ç¬¬ä¸€æ¬¡å†™å…¥å®Œæˆã€‚&lt;/li&gt;
&lt;li&gt;ç¬¬ä¸€æ¬¡å†™å…¥å·²å®Œæˆï¼ˆç¬¬31è¡ŒåŠä¹‹åï¼‰ - é¦–å…ˆæ£€æŸ¥ä¸Šä¸€æ¬¡å†™å…¥çš„ç±»å‹ä¸è¿™ä¸€æ¬¡è¦å†™å…¥çš„ç±»å‹æ˜¯å¦ä¸€è‡´ï¼Œå¦‚æœä¸ä¸€è‡´åˆ™æŠ›å‡ºå¼‚å¸¸ã€‚åä¹‹ï¼Œåˆ™ç›´æ¥æŠŠè¿™ä¸€æ¬¡è¦å†™å…¥çš„å€¼å†™å…¥åˆ°&lt;code&gt;data&lt;/code&gt;å­—æ®µã€‚&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;è¿™ä¸ªé€»è¾‘çš„ä¸»è¦æ€æƒ³å°±æ˜¯ï¼Œä¸ºäº†å®Œæˆå¤šä¸ªå­—æ®µçš„åŸå­æ€§å†™å…¥ï¼Œæˆ‘ä»¬å¯ä»¥æŠ“ä½å…¶ä¸­çš„ä¸€ä¸ªå­—æ®µï¼Œä»¥å®ƒçš„çŠ¶æ€æ¥æ ‡å¿—æ•´ä¸ªåŸå­å†™å…¥çš„çŠ¶æ€ã€‚è¿™ä¸ªæƒ³æ³•æˆ‘åœ¨&lt;a href=&#34;https://pingcap.com/blog-cn/percolator-and-txn/&#34;&gt; TiDB çš„äº‹åŠ¡&lt;/a&gt;å®ç°ä¸­çœ‹åˆ°è¿‡ç±»ä¼¼çš„ï¼Œä»–ä»¬é‚£è¾¹å«&lt;code&gt;Percolator&lt;/code&gt;æ¨¡å‹ï¼Œä¸»è¦æ€æƒ³ä¹Ÿæ˜¯å…ˆé€‰å‡ºä¸€ä¸ª&lt;code&gt;primaryRow&lt;/code&gt;ï¼Œç„¶åæ‰€æœ‰çš„æ“ä½œä¹Ÿæ˜¯ä»¥&lt;code&gt;primaryRow&lt;/code&gt;çš„æˆåŠŸä¸å¦ä½œä¸ºæ ‡å¿—ã€‚å—¯ï¼Œæœç„¶æ˜¯å¤ªé˜³åº•ä¸‹æ²¡æœ‰æ–°ä¸œè¥¿ã€‚&lt;/p&gt;

&lt;p&gt;å¦‚æœæ²¡æœ‰è€å¿ƒçœ‹ä»£ç ï¼Œæ²¡å…³ç³»ï¼Œè¿™å„¿è¿˜æœ‰ä¸ªç®€åŒ–ç‰ˆçš„æµç¨‹å›¾ï¼š&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;//blog.betacat.io/image/golang-atomic-value/atomic-value-store.svg&#34; alt=&#34;atomic.Value Store æµç¨‹&#34; /&gt;&lt;/p&gt;

&lt;h3 id=&#34;è¯»å–-load-æ“ä½œ&#34;&gt;è¯»å–ï¼ˆLoadï¼‰æ“ä½œ&lt;/h3&gt;

&lt;p&gt;å…ˆä¸Šä»£ç ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;lnt&#34;&gt; 1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 2
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 3
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 4
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 5
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 6
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 7
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 8
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 9
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;10
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;11
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;12
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;13
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;kd&#34;&gt;func&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;v&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Value&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;Load&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;x&lt;/span&gt; &lt;span class=&#34;kd&#34;&gt;interface&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{})&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
  &lt;span class=&#34;nx&#34;&gt;vp&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;ifaceWords&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;unsafe&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;Pointer&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;v&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;))&lt;/span&gt;
  &lt;span class=&#34;nx&#34;&gt;typ&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;LoadPointer&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;vp&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;typ&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
  &lt;span class=&#34;k&#34;&gt;if&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;typ&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;==&lt;/span&gt; &lt;span class=&#34;kc&#34;&gt;nil&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;||&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;uintptr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;typ&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;==&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;^&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;uintptr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
    &lt;span class=&#34;c1&#34;&gt;// First store not yet completed.
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;    &lt;span class=&#34;k&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;kc&#34;&gt;nil&lt;/span&gt;
  &lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
  &lt;span class=&#34;nx&#34;&gt;data&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;LoadPointer&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;vp&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;data&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
  &lt;span class=&#34;nx&#34;&gt;xp&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;ifaceWords&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;unsafe&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;Pointer&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;x&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;))&lt;/span&gt;
  &lt;span class=&#34;nx&#34;&gt;xp&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;typ&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;typ&lt;/span&gt;
  &lt;span class=&#34;nx&#34;&gt;xp&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;data&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;data&lt;/span&gt;
  &lt;span class=&#34;k&#34;&gt;return&lt;/span&gt;
&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;è¯»å–ç›¸å¯¹å°±ç®€å•å¾ˆå¤šäº†ï¼Œå®ƒæœ‰ä¸¤ä¸ªåˆ†æ”¯ï¼š&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;å¦‚æœå½“å‰çš„&lt;code&gt;typ&lt;/code&gt;æ˜¯ nil æˆ–è€…&lt;code&gt;^uintptr(0)&lt;/code&gt;ï¼Œé‚£å°±è¯æ˜ç¬¬ä¸€æ¬¡å†™å…¥è¿˜æ²¡æœ‰å¼€å§‹ï¼Œæˆ–è€…è¿˜æ²¡å®Œæˆï¼Œé‚£å°±ç›´æ¥è¿”å› nil ï¼ˆä¸å¯¹å¤–æš´éœ²ä¸­é—´çŠ¶æ€ï¼‰ã€‚&lt;/li&gt;
&lt;li&gt;å¦åˆ™ï¼Œæ ¹æ®å½“å‰çœ‹åˆ°çš„&lt;code&gt;typ&lt;/code&gt;å’Œ&lt;code&gt;data&lt;/code&gt;æ„é€ å‡ºä¸€ä¸ªæ–°çš„&lt;code&gt;interface{}&lt;/code&gt;è¿”å›å‡ºå»ã€‚&lt;/li&gt;
&lt;/ol&gt;

&lt;h2 id=&#34;æ€»ç»“&#34;&gt;æ€»ç»“&lt;/h2&gt;

&lt;p&gt;æœ¬æ–‡ä»é‚®ä»¶åˆ—è¡¨ä¸­çš„ä¸€æ®µè®¨è®ºå¼€å§‹ï¼Œä»‹ç»äº†&lt;code&gt;atomic.Value&lt;/code&gt;çš„è¢«æå‡ºæ¥çš„å†å²ç¼˜ç”±ã€‚ç„¶åç”±æµ…å…¥æ·±çš„ä»‹ç»äº†å®ƒçš„ä½¿ç”¨å§¿åŠ¿ï¼Œä»¥åŠå†…éƒ¨å®ç°ã€‚è®©å¤§å®¶ä¸ä»…çŸ¥å…¶ç„¶ï¼Œè¿˜èƒ½çŸ¥å…¶æ‰€ä»¥ç„¶ã€‚&lt;/p&gt;

&lt;p&gt;å¦å¤–ï¼Œå†å¼ºè°ƒä¸€éï¼ŒåŸå­æ“ä½œç”±&lt;strong&gt;åº•å±‚ç¡¬ä»¶&lt;/strong&gt;æ”¯æŒï¼Œè€Œé”åˆ™ç”±&lt;strong&gt;æ“ä½œç³»ç»Ÿ&lt;/strong&gt;æä¾›çš„ API å®ç°ã€‚è‹¥å®ç°ç›¸åŒçš„åŠŸèƒ½ï¼Œå‰è€…é€šå¸¸ä¼šæ›´æœ‰æ•ˆç‡ï¼Œå¹¶ä¸”æ›´èƒ½åˆ©ç”¨è®¡ç®—æœºå¤šæ ¸çš„ä¼˜åŠ¿ã€‚æ‰€ä»¥ï¼Œä»¥åå½“æˆ‘ä»¬æƒ³å¹¶å‘å®‰å…¨çš„æ›´æ–°ä¸€äº›å˜é‡çš„æ—¶å€™ï¼Œæˆ‘ä»¬åº”è¯¥ä¼˜å…ˆé€‰æ‹©ç”¨&lt;code&gt;atomic.Value&lt;/code&gt;æ¥å®ç°ã€‚&lt;/p&gt;
</description>
      
    </item>
    
    <item>
      <title>ã€è¯‘ã€‘åˆ†é¡µæŠ€æœ¯ç®€ä»‹</title>
      <link>//blog.betacat.io/post/introduction-to-paging/</link>
      <pubDate>Sun, 10 Feb 2019 11:31:31 +0800</pubDate>
      
      <guid>//blog.betacat.io/post/introduction-to-paging/</guid>
      
        <description>

&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;è¯‘æ³¨&lt;/strong&gt;ï¼šè¿™ç¯‡æ–‡ç« èŠ‚é€‰è‡ªã€Šç”¨Rustç¼–å†™ä¸€ä¸ªæ“ä½œç³»ç»Ÿã€‹ç³»åˆ—ã€‚å®ƒç”±æµ…å…¥æ·±çš„ä»‹ç»äº†åˆ†é¡µæŠ€æœ¯ï¼ˆPagingï¼‰çš„å†å²ç”±æ¥ï¼Œä»¥åŠåœ¨ç°ä»£æ“ä½œç³»ç»Ÿä¸­çš„å®ç°ã€‚è¿™æ˜¯æˆ‘ç›®å‰è¯»è¿‡çš„æŠŠPagingè®²çš„æœ€æ¸…æ¥šçš„ä¸€ç¯‡æ–‡ç« ï¼Œå› æ­¤å°†å®ƒç¿»è¯‘å‡ºæ¥ï¼Œå¸Œæœ›æ›´å¤šçš„è¯»è€…èƒ½å¤Ÿå—ç›Šã€‚&lt;br /&gt;
&lt;strong&gt;åŸæ–‡&lt;/strong&gt;ï¼š&lt;a href=&#34;https://os.phil-opp.com/paging-introduction/&#34;&gt;https://os.phil-opp.com/paging-introduction/&lt;/a&gt;&lt;br /&gt;
&lt;strong&gt;ä½œè€…&lt;/strong&gt;ï¼šPhilipp Oppermann&lt;br /&gt;
&lt;strong&gt;ç¿»è¯‘&lt;/strong&gt;ï¼šå–µå”&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;åˆ†é¡µæŠ€æœ¯æ˜¯ç°ä»£æ“ä½œç³»ç»Ÿä¸­å¸¸ç”¨çš„ä¸€ç§å†…å­˜ç®¡ç†æ–¹æ¡ˆã€‚è¿™ç¯‡æ–‡ç« ä»‹ç»äº†æˆ‘ä»¬ä¸ºä»€ä¹ˆéœ€è¦å†…å­˜éš”ç¦»ï¼ˆmemory isolationï¼‰ï¼Œå†…å­˜åˆ†æ®µï¼ˆsegmentationï¼‰æ˜¯æ€ä¹ˆå®ç°çš„ï¼Œè™šæ‹Ÿå†…å­˜ï¼ˆvirtual memoryï¼‰æ˜¯ä»€ä¹ˆï¼Œä»¥åŠåˆ†é¡µæŠ€æœ¯æ˜¯æ€æ ·è§£å†³å†…å­˜ç¢ç‰‡åŒ–ï¼ˆfragmentationï¼‰çš„é—®é¢˜ã€‚åŒæ—¶ï¼Œè¿™é‡Œè¿˜æ¢è®¨äº†åœ¨x86_64æ¶æ„ä¸Šå¤šçº§é¡µè¡¨çš„å±‚æ¬¡ç»“æ„ã€‚&lt;/p&gt;

&lt;p&gt;è¯¥ç³»åˆ—åšå®¢ä½¿ç”¨&lt;a href=&#34;https://github.com/phil-opp/blog_os&#34;&gt;GitHub&lt;/a&gt;è¿›è¡Œç®¡ç†å’Œå¼€å‘ï¼Œå¦‚æœä½ æœ‰ä»»ä½•é—®é¢˜æˆ–ç–‘é—®ï¼Œè¯·ç»™æˆ‘å¼€ä¸€ä¸ªissueï¼Œä½ ä¹Ÿå¯ä»¥åœ¨&lt;a href=&#34;https://os.phil-opp.com/paging-introduction/#comments&#34;&gt;åº•éƒ¨ç•™è¨€&lt;/a&gt;ã€‚è¿™ç¯‡æ–‡ç« çš„å®Œæ•´ä»£ç å¯ä»¥åœ¨&lt;a href=&#34;https://github.com/phil-opp/blog_os/tree/post-09&#34;&gt;è¿™é‡Œ&lt;/a&gt;æ‰¾åˆ°ã€‚&lt;/p&gt;

&lt;h1 id=&#34;å†…å­˜ä¿æŠ¤&#34;&gt;å†…å­˜ä¿æŠ¤&lt;/h1&gt;

&lt;p&gt;æ“ä½œç³»ç»Ÿçš„ä¸€ä¸ªä¸»è¦èŒè´£å°±æ˜¯éš”ç¦»åº”ç”¨ç¨‹åºï¼Œæ¯”å¦‚è¯´ï¼Œwebæµè§ˆå™¨ä¸åº”è¯¥èƒ½å¤Ÿå¹²æ‰°åˆ°æ–‡æœ¬ç¼–è¾‘å™¨ã€‚ä¸ºäº†å®ç°æ­¤ç›®çš„ï¼Œæ“ä½œç³»ç»Ÿä¼šåˆ©ç”¨ç¡¬ä»¶çš„æŸäº›åŠŸèƒ½æ¥ç¡®ä¿ä¸€ä¸ªè¿›ç¨‹çš„å†…å­˜ç©ºé—´ä¸ä¼šè¢«å¦ä¸€ä¸ªè¿›ç¨‹è®¿é—®åˆ°ã€‚å½“ç„¶ï¼Œä¸åŒçš„ç¡¬ä»¶å’Œæ“ä½œç³»ç»Ÿä¹Ÿä¼šæœ‰ä¸åŒçš„å®ç°ã€‚&lt;/p&gt;

&lt;p&gt;ä¸¾ä¸ªæ —å­ï¼ŒæŸäº›ARM Cortex-Må¤„ç†å™¨ï¼ˆå¤šç”¨äºåµŒå…¥å¼ç³»ç»Ÿï¼‰å…·æœ‰&lt;a href=&#34;https://developer.arm.com/docs/ddi0337/e/memory-protection-unit/about-the-mpu&#34;&gt;å†…å­˜ä¿æŠ¤å•å…ƒ&lt;/a&gt;ï¼ˆMPUï¼‰ï¼Œå®ƒå…è®¸ä½ å®šä¹‰å°‘é‡å…·æœ‰ä¸åŒè®¿é—®æƒé™ï¼ˆä¾‹å¦‚æ— è®¿é—®ã€åªè¯»ã€è¯»å†™ï¼‰çš„å†…å­˜åŒºåŸŸã€‚åœ¨æ¯æ¬¡å‘ç”Ÿå†…å­˜è®¿é—®çš„æ—¶å€™ï¼ŒMPUéƒ½ä¼šç¡®ä¿è¯¥åœ°å€æ‰€åœ¨çš„åŒºåŸŸå…·æœ‰åˆæ³•çš„è®¿é—®æƒé™ï¼Œå¦åˆ™å°†è§¦å‘å¼‚å¸¸ã€‚åŒæ—¶åœ¨å‘ç”Ÿè¿›ç¨‹åˆ‡æ¢çš„æ—¶å€™ï¼Œæ“ä½œç³»ç»Ÿä¹Ÿä¼šåŠæ—¶çš„æ›´æ–°ç›¸åº”åŒºåŸŸåŠå…¶è®¿é—®æƒé™ï¼Œè¿™æ ·å°±ç¡®ä¿äº†æ¯ä¸ªè¿›ç¨‹åªèƒ½è®¿é—®è‡ªå·±çš„åœ°å€ç©ºé—´ï¼Œä»è€Œè¾¾åˆ°éš”ç¦»è¿›ç¨‹çš„ä½œç”¨ã€‚&lt;/p&gt;

&lt;p&gt;å¦ä¸€æ–¹é¢ï¼Œåœ¨x86å¹³å°ä¸Šï¼Œç¡¬ä»¶æ”¯æŒä¸¤ç§ä¸åŒçš„å†…å­˜ä¿æŠ¤æ–¹å¼ï¼š&lt;a href=&#34;https://en.wikipedia.org/wiki/X86_memory_segmentation&#34;&gt;åˆ†æ®µ&lt;/a&gt;ï¼ˆsegmentationï¼‰å’Œ&lt;a href=&#34;https://en.wikipedia.org/wiki/Virtual_memory#Paged_virtual_memory&#34;&gt;åˆ†é¡µ&lt;/a&gt;ï¼ˆpagingï¼‰ã€‚&lt;/p&gt;

&lt;h1 id=&#34;åˆ†æ®µ&#34;&gt;åˆ†æ®µ&lt;/h1&gt;

&lt;p&gt;åˆ†æ®µæŠ€æœ¯æ—©åœ¨1978å¹´å°±å·²ç»å‡ºç°ï¼Œèµ·åˆæ˜¯ä¸ºäº†å¢åŠ CPUçš„å¯»å€ç©ºé—´ã€‚å½“æ—¶çš„æƒ…å†µæ˜¯CPUåªä½¿ç”¨16ä½åœ°å€ï¼Œè¿™å°†å¯å¯»å€ç©ºé—´é™åˆ¶ä¸º64KiBï¼ˆ2&lt;sup&gt;16&lt;/sup&gt;ï¼‰ã€‚ä¸ºäº†è®¿é—®åˆ°æ›´é«˜çš„å†…å­˜ï¼Œä¸€äº›æ®µå¯„å­˜å™¨è¢«å¼•å…¥è¿›æ¥ï¼Œæ¯ä¸ªæ®µå¯„å­˜å™¨éƒ½åŒ…å«ä¸€ä¸ªåç§»åœ°å€ã€‚CPUå°†è¿™äº›åç§»åœ°å€ä½œä¸ºåŸºåœ°å€ï¼ŒåŠ åˆ°åº”ç”¨ç¨‹åºè¦è®¿é—®çš„å†…å­˜åœ°å€ä¸Šï¼Œè¿™æ ·å®ƒå°±å¯ä»¥ä½¿ç”¨åˆ°é«˜è¾¾1MiBçš„å†…å­˜ç©ºé—´äº†ã€‚&lt;/p&gt;

&lt;p&gt;æ®µå¯„å­˜å™¨æœ‰å¥½å‡ ç§ï¼ŒCPUä¼šæ ¹æ®ä¸åŒçš„å†…å­˜è®¿é—®è¯·æ±‚è€Œé€‰æ‹©ä¸åŒçš„æ®µå¯„å­˜å™¨ï¼šå¯¹äºå–æŒ‡ä»¤è¯·æ±‚ï¼Œä»£ç æ®µå¯„å­˜å™¨&lt;code&gt;CS&lt;/code&gt;ä¼šè¢«ä½¿ç”¨ï¼›å †æ ˆæ“ä½œï¼ˆpush/popï¼‰ä¼šç”¨åˆ°å †æ ˆæ®µå¯„å­˜å™¨&lt;code&gt;SS&lt;/code&gt;ï¼›å…¶ä»–æ“ä½œåˆ™ä½¿ç”¨æ•°æ®æ®µ&lt;code&gt;DS&lt;/code&gt;æˆ–é¢å¤–çš„æ®µ&lt;code&gt;ES&lt;/code&gt;ï¼Œåæ¥åˆæ·»åŠ äº†ä¸¤ä¸ªå¯ä»¥è‡ªç”±ä½¿ç”¨çš„æ®µå¯„å­˜å™¨&lt;code&gt;FS&lt;/code&gt;å’Œ&lt;code&gt;GS&lt;/code&gt;ã€‚&lt;/p&gt;

&lt;p&gt;åœ¨åˆ†æ®µæŠ€æœ¯çš„ç¬¬ä¸€ç‰ˆå®ç°ä¸­ï¼Œæ®µå¯„å­˜å™¨ç›´æ¥å­˜æ”¾äº†æ®µåç§»é‡ï¼Œå¹¶ä¸”æ²¡æœ‰è®¿é—®æ§åˆ¶çš„æ£€æŸ¥ã€‚åæ¥ï¼Œéšç€&lt;a href=&#34;https://en.wikipedia.org/wiki/X86_memory_segmentation#Protected_mode&#34;&gt;ä¿æŠ¤æ¨¡å¼&lt;/a&gt;çš„å¼•å…¥ï¼Œè¿™ç§æƒ…å†µå‘ç”Ÿäº†æ”¹å˜ã€‚å½“CPUä»¥è¿™ç§æ¨¡å¼è¿è¡Œæ—¶ï¼Œæ®µå¯„å­˜å™¨ä¸­åŒ…å«äº†ä¸€ä¸ªå±€éƒ¨æˆ–å…¨å±€&lt;a href=&#34;https://en.wikipedia.org/wiki/Global_Descriptor_Table&#34;&gt;æè¿°ç¬¦è¡¨&lt;/a&gt;ä¸­çš„ç´¢å¼•ï¼Œè¯¥è¡¨é™¤äº†åŒ…å«åç§»åœ°å€å¤–ï¼Œè¿˜åŒ…å«æ®µå¤§å°å’Œè®¿é—®æƒé™ã€‚é€šè¿‡ä¸ºæ¯ä¸ªè¿›ç¨‹åŠ è½½å•ç‹¬çš„æè¿°ç¬¦è¡¨ï¼Œæ“ä½œç³»ç»Ÿå°±èƒ½å°†è¿›ç¨‹çš„å†…å­˜è®¿é—®é™åˆ¶åˆ°å®ƒè‡ªå·±çš„åœ°å€ç©ºé—´å†…ï¼Œä»è€Œè¾¾åˆ°éš”ç¦»è¿›ç¨‹çš„ä½œç”¨ã€‚&lt;/p&gt;

&lt;p&gt;é€šè¿‡åœ¨å®é™…è®¿é—®å‘ç”Ÿä¹‹å‰ä¿®æ”¹è¦è®¿é—®çš„ç›®æ ‡åœ°å€ï¼Œåˆ†æ®µæŠ€æœ¯å®é™…ä¸Šå·²ç»åœ¨ä½¿ç”¨ä¸€ç§ç°åœ¨å¹¿ä¸ºä½¿ç”¨çš„æŠ€æœ¯ï¼šè™šæ‹Ÿå†…å­˜ã€‚&lt;/p&gt;

&lt;h2 id=&#34;è™šæ‹Ÿå†…å­˜&#34;&gt;è™šæ‹Ÿå†…å­˜&lt;/h2&gt;

&lt;p&gt;è™šæ‹Ÿå†…å­˜èƒŒåçš„æ€æƒ³æ˜¯å°†å†…å­˜åœ°å€ä»åº•å±‚å­˜å‚¨è®¾å¤‡ä¸­æŠ½è±¡å‡ºæ¥ã€‚å³åœ¨è®¿é—®å­˜å‚¨è®¾å¤‡å‰ï¼Œå¢åŠ ä¸€ä¸ªåœ°å€è½¬æ¢çš„è¿‡ç¨‹ã€‚å¯¹äºä¸Šé¢çš„åˆ†æ®µæ¥è¯´ï¼Œè¿™é‡Œçš„è½¬æ¢è¿‡ç¨‹å°±æ˜¯ä¸ºå†…å­˜åœ°å€åŠ ä¸Šä¸€ä¸ªæ®µåç§»é‡ã€‚ä¾‹å¦‚ï¼Œå½“ä¸€ä¸ªè¿›ç¨‹åœ¨ä¸€ä¸ªåç§»é‡ä¸º&lt;code&gt;0x1111000&lt;/code&gt;çš„æ®µä¸­è®¿é—®å†…å­˜åœ°å€&lt;code&gt;0x1234000&lt;/code&gt;æ—¶ï¼Œå®ƒå®é™…è®¿é—®åˆ°çš„åœ°å€æ˜¯&lt;code&gt;0x2345000&lt;/code&gt;ã€‚&lt;/p&gt;

&lt;p&gt;ä¸ºäº†åŒºåˆ†è¿™ä¸¤ç§åœ°å€ç±»å‹ï¼Œæˆ‘ä»¬å°†è½¬æ¢å‰çš„åœ°å€ç§°ä¸ºè™šæ‹Ÿåœ°å€ï¼ˆvirtualï¼‰ï¼Œè½¬æ¢åçš„åœ°å€ç§°ä¸ºç‰©ç†åœ°å€ï¼ˆphysicalï¼‰ã€‚è¿™ä¸¤ç§åœ°å€ä¹‹é—´çš„ä¸€ä¸ªé‡è¦åŒºåˆ«æ˜¯ç‰©ç†åœ°å€æ˜¯å”¯ä¸€çš„ï¼Œå¹¶ä¸”æ€»æ˜¯æŒ‡å‘åŒä¸€ä¸ªå†…å­˜ä½ç½®ã€‚è€Œè™šæ‹Ÿåœ°å€åˆ™ä¾èµ–äºè½¬æ¢å‡½æ•°ï¼Œæ‰€ä»¥ä¸¤ä¸ªä¸åŒçš„è™šæ‹Ÿåœ°å€å®Œå…¨æœ‰å¯èƒ½æŒ‡å‘ç›¸åŒçš„ç‰©ç†åœ°å€ã€‚åŒæ ·ï¼Œç›¸åŒçš„è™šæ‹Ÿåœ°å€åœ¨ä¸åŒçš„è½¬æ¢å‡½æ•°ä½œç”¨ä¸‹ä¹Ÿæœ‰å¯èƒ½æŒ‡å‘ä¸åŒçš„ç‰©ç†åœ°å€ã€‚&lt;/p&gt;

&lt;p&gt;ä¸‹é¢æˆ‘ä»¬å°†åŒä¸€ä¸ªç¨‹åºå¹¶è¡Œçš„è¿è¡Œä¸¤æ¬¡ï¼Œæ¥çœ‹çœ‹å®ƒçš„å†…å­˜æ˜ å°„æƒ…å†µï¼š&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;//blog.betacat.io/image/introduction-to-paging/segmentation-same-program-twice.svg&#34; alt=&#34;segmentation-same-program-twice&#34; /&gt;&lt;/p&gt;

&lt;p&gt;åœ¨è¿™é‡Œï¼Œç›¸åŒçš„ç¨‹åºè¿è¡Œäº†ä¸¤æ¬¡ï¼Œä½†æ˜¯ä½¿ç”¨äº†ä¸åŒçš„è½¬æ¢å‡½æ•°ã€‚ç¬¬ä¸€ä¸ªè¿›ç¨‹å®ä¾‹çš„æ®µåç§»é‡ä¸º100ï¼Œå› æ­¤å®ƒçš„è™šæ‹Ÿåœ°å€0-150è¢«è½¬æ¢ä¸ºç‰©ç†åœ°å€100-250ã€‚ç¬¬äºŒä¸ªè¿›ç¨‹å®ä¾‹çš„åç§»é‡ä¸º300ï¼Œæ‰€ä»¥å®ƒçš„è™šæ‹Ÿåœ°å€0-150è¢«è½¬æ¢ä¸ºç‰©ç†åœ°å€300-450ã€‚è¿™æ ·å°±å…è®¸äº†ä¸¤ä¸ªè¿›ç¨‹äº’ä¸å¹²æ‰°åœ°è¿è¡Œç›¸åŒçš„ä»£ç å¹¶ä¸”ä½¿ç”¨ç›¸åŒçš„è™šæ‹Ÿåœ°å€ã€‚&lt;/p&gt;

&lt;p&gt;è¿™ä¸ªæŠ€æœ¯çš„å¦ä¸€ä¸ªä¼˜ç‚¹æ˜¯ï¼Œä¸ç®¡ç¨‹åºå†…éƒ¨ä½¿ç”¨ä»€ä¹ˆæ ·çš„è™šæ‹Ÿåœ°å€ï¼Œå®ƒéƒ½å¯ä»¥è¢«åŠ è½½åˆ°ä»»æ„çš„ç‰©ç†å†…å­˜ç‚¹ã€‚è¿™æ ·ï¼Œæ“ä½œç³»ç»Ÿå°±å¯ä»¥åœ¨ä¸é‡æ–°ç¼–è¯‘ç¨‹åºçš„å‰æä¸‹ï¼Œå……åˆ†åˆ©ç”¨æ‰€æœ‰çš„å†…å­˜ã€‚&lt;/p&gt;

&lt;h2 id=&#34;å†…å­˜ç¢ç‰‡&#34;&gt;å†…å­˜ç¢ç‰‡&lt;/h2&gt;

&lt;p&gt;åœ¨å°†å†…å­˜åœ°å€åŒºåˆ†ä¸ºè™šæ‹Ÿåœ°å€å’Œç‰©ç†åœ°å€ä¹‹åï¼Œåˆ†æ®µæŠ€æœ¯ä½œä¸ºè¿æ¥è¿™ä¸¤è€…çš„æ¡¥æ¢å°±æ˜¾å¾—å°¤ä¸ºé‡è¦ã€‚ä½†åˆ†æ®µæŠ€æœ¯çš„ä¸€ä¸ªé—®é¢˜åœ¨äºå®ƒå¯èƒ½å¯¼è‡´å†…å­˜ç¢ç‰‡åŒ–ã€‚æ¯”å¦‚ï¼Œå¦‚æœæˆ‘ä»¬æƒ³åœ¨ä¸Šé¢ä¸¤ä¸ªè¿›ç¨‹çš„åŸºç¡€ä¸Šå†è¿è¡Œç¬¬ä¸‰ä¸ªç¨‹åºï¼š&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;//blog.betacat.io/image/introduction-to-paging/segmentation-fragmentation.svg&#34; alt=&#34;segmentation-fragmentation&#34; /&gt;&lt;/p&gt;

&lt;p&gt;å¯ä»¥çœ‹åˆ°ï¼Œå³ä¾¿æœ‰è¶³å¤Ÿå¤šçš„ç©ºé—²å†…å­˜ï¼Œæˆ‘ä»¬ä¹Ÿæ— æ³•å°†ç¬¬ä¸‰ä¸ªè¿›ç¨‹æ˜ å°„åˆ°ç‰©ç†å†…å­˜ä¸­ã€‚è¿™é‡Œçš„ä¸»è¦é—®é¢˜æ˜¯ï¼Œæˆ‘ä»¬éœ€è¦è¿ç»­çš„å¤§å—å†…å­˜ï¼Œè€Œä¸æ˜¯å¤§é‡ä¸è¿ç»­çš„å°å—å†…å­˜ã€‚&lt;/p&gt;

&lt;p&gt;è§£å†³è¿™ç§ç¢ç‰‡åŒ–é—®é¢˜çš„ä¸€ä¸ªåŠæ³•å°±æ˜¯ï¼Œå…ˆæš‚åœç¨‹åºçš„æ‰§è¡Œï¼Œç§»åŠ¨å·²ä½¿ç”¨çš„å†…å­˜ä½¿ä»–ä»¬æ›´ç´§å‡‘ä¸€äº›ï¼Œç„¶åæ›´æ–°è½¬æ¢å‡½æ•°ï¼Œæœ€åå†æ¢å¤æ‰§è¡Œï¼š&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;//blog.betacat.io/image/introduction-to-paging/segmentation-fragmentation-compacted.svg&#34; alt=&#34;segmentation-fragmentation-compacted&#34; /&gt;&lt;/p&gt;

&lt;p&gt;ç°åœ¨æˆ‘ä»¬æœ‰äº†è¶³å¤Ÿçš„è¿ç»­ç©ºé—´æ¥è¿è¡Œç¬¬ä¸‰ä¸ªè¿›ç¨‹äº†ã€‚&lt;/p&gt;

&lt;p&gt;ä½†åœ¨ç¢ç‰‡æ•´ç†çš„è¿‡ç¨‹ä¸­ï¼Œéœ€è¦ç§»åŠ¨å¤§é‡çš„å†…å­˜ï¼Œè¿™ä¼šé™ä½æ€§èƒ½ã€‚è€Œä¸”è¿™ç§æ•´ç†éœ€è¦å®šæœŸå®Œæˆï¼Œä»¥å…å†…å­˜å˜å¾—è¿‡äºåˆ†æ•£ã€‚è¿™ä½¿å¾—ç¨‹åºä¼šè¢«éšæœºçš„æš‚åœå¹¶ä¸”å¤±å»å“åº”ï¼Œæ‰€ä»¥è¿™ç§æ–¹æ³•ä¼šä½¿å¾—ç¨‹åºçš„æ€§èƒ½å˜å¾—ä¸å¯é¢„æµ‹ã€‚&lt;/p&gt;

&lt;p&gt;ç»¼ä¸Šï¼Œå†…å­˜ç¢ç‰‡åŒ–æ˜¯ä½¿å¾—å¤§å¤šæ•°ç³»ç»Ÿä¸å†ä½¿ç”¨åˆ†æ®µæŠ€æœ¯çš„åŸå› ä¹‹ä¸€ã€‚äº‹å®ä¸Šï¼Œ64ä½çš„x86ç”šè‡³ä¸å†æ”¯æŒåˆ†æ®µï¼Œè€Œæ˜¯ä½¿ç”¨å¦ä¸€ç§åˆ†é¡µæŠ€æœ¯ï¼Œå› ä¸ºå®ƒå¯ä»¥å®Œå…¨é¿å…è¿™äº›ç¢ç‰‡é—®é¢˜ã€‚&lt;/p&gt;

&lt;h1 id=&#34;åˆ†é¡µ&#34;&gt;åˆ†é¡µ&lt;/h1&gt;

&lt;p&gt;åˆ†é¡µæŠ€æœ¯çš„æ ¸å¿ƒæ€æƒ³æ˜¯å°†è™šæ‹Ÿå†…å­˜ç©ºé—´å’Œç‰©ç†å†…å­˜ç©ºé—´åˆ’åˆ†æˆå›ºå®šå¤§å°çš„å°å—ï¼Œè™šæ‹Ÿå†…å­˜ç©ºé—´çš„å—ç§°ä¸º&lt;em&gt;é¡µ&lt;/em&gt;(pages)ï¼Œç‰©ç†åœ°å€ç©ºé—´çš„å—ç§°ä¸º&lt;em&gt;å¸§&lt;/em&gt;(frames)ã€‚æ¯ä¸€ä¸ªé¡µéƒ½å¯ä»¥å•ç‹¬æ˜ å°„åˆ°ä¸€ä¸ªå¸§ä¸Šï¼Œè¿™ä½¿å¾—æˆ‘ä»¬å¯ä»¥å°†ä¸€ä¸ªå¤§å—çš„è™šæ‹Ÿå†…å­˜åˆ†æ•£çš„æ˜ å°„åˆ°ä¸€äº›ä¸è¿ç»­çš„ç‰©ç†å¸§ä¸Šã€‚&lt;/p&gt;

&lt;p&gt;å¦‚æœå›é¡¾åˆšæ‰å†…å­˜ç¢ç‰‡åŒ–çš„ç¤ºä¾‹ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä½¿ç”¨åˆ†é¡µæ˜¾ç„¶æ›´æœ‰ä¼˜åŠ¿ï¼š&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;//blog.betacat.io/image/introduction-to-paging/paging-fragmentation.svg&#34; alt=&#34;paging-fragmentation&#34; /&gt;&lt;/p&gt;

&lt;p&gt;åœ¨æœ¬ä¾‹ä¸­ï¼Œæˆ‘ä»¬çš„é¡µå¤§å°ä¸º50å­—èŠ‚ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬çš„æ¯ä¸ªè¿›ç¨‹ç©ºé—´éƒ½è¢«åˆ’åˆ†æˆäº†ä¸‰é¡µï¼Œæ¯é¡µéƒ½å•ç‹¬æ˜ å°„åˆ°ä¸€ä¸ªå¸§ï¼Œå› æ­¤è¿ç»­çš„è™šæ‹Ÿå†…å­˜ç©ºé—´å¯ä»¥è¢«æ˜ å°„åˆ°éè¿ç»­çš„ç‰©ç†å¸§ä¸Šã€‚è¿™å°±å…è®¸æˆ‘ä»¬åœ¨æ²¡æœ‰æ‰§è¡Œç¢ç‰‡æ•´ç†çš„æƒ…å†µä¸‹ç›´æ¥è¿è¡Œç¬¬ä¸‰ä¸ªç¨‹åºã€‚&lt;/p&gt;

&lt;h2 id=&#34;éšè—çš„ç¢ç‰‡&#34;&gt;éšè—çš„ç¢ç‰‡&lt;/h2&gt;

&lt;p&gt;ä¸åˆ†æ®µç›¸æ¯”ï¼Œåˆ†é¡µä½¿ç”¨å¤§é‡å®¹é‡è¾ƒå°ã€ä½†å¤§å°å›ºå®šçš„å†…å­˜åŒºåŸŸï¼Œè€Œä¸æ˜¯å°‘é‡å®¹é‡è¾ƒå¤§ã€ä½†å¤§å°å¯å˜çš„åŒºåŸŸã€‚å› ä¸ºæ¯ä¸ªå¸§éƒ½æœ‰ç›¸åŒçš„å¤§å°ï¼Œæ‰€ä»¥ä¸ä¼šå‡ºç°å› å¸§å¤ªå°è€Œæ— æ³•ä½¿ç”¨çš„æƒ…å†µï¼Œå› è€Œä¹Ÿâ€œä¸ä¼šâ€äº§ç”Ÿå†…å­˜ç¢ç‰‡ã€‚&lt;/p&gt;

&lt;p&gt;å½“ç„¶è¿™ä»…ä»…æ˜¯â€œ&lt;em&gt;çœ‹èµ·æ¥&lt;/em&gt; â€æ²¡æœ‰ç¢ç‰‡äº§ç”Ÿï¼Œå®é™…ä¸Šè¿˜æ˜¯ä¼šæœ‰ä¸€äº›éšè—çš„ç¢ç‰‡ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºâ€œå†…éƒ¨ç¢ç‰‡â€ã€‚å‘ç”Ÿå†…éƒ¨ç¢ç‰‡æ˜¯å› ä¸ºä¸æ˜¯æ¯ä¸ªå†…å­˜åŒºåŸŸéƒ½æ­£å·§æ˜¯é¡µé¢å¤§å°çš„æ•´æ•°å€ã€‚ä»æ‹¿ä¸Šé¢çš„ç¨‹åºä¸¾ä¾‹ï¼Œå‡å¦‚è¯¥ç¨‹åºçš„å¤§å°ä¸º101å­—èŠ‚ï¼Œæˆ‘ä»¬ä»ç„¶éœ€è¦3ä¸ªå¤§å°ä¸º50å­—èŠ‚çš„é¡µæ¥è£…è½½å®ƒï¼Œè¿™æ¯”å®é™…éœ€è¦çš„å¤šå äº†49ä¸ªå­—èŠ‚ã€‚ä¸ºäº†åŒºåˆ†è¿™ä¸¤ç§æƒ…å†µï¼Œæˆ‘ä»¬æŠŠä½¿ç”¨åˆ†æ®µè€Œå¼•å‘çš„ç¢ç‰‡ç§°ä¸ºâ€œå¤–éƒ¨ç¢ç‰‡â€ã€‚&lt;/p&gt;

&lt;p&gt;è™½ç„¶å†…éƒ¨ç¢ç‰‡ä¹Ÿä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„ï¼Œä½†æ¯”èµ·å¤–éƒ¨ç¢ç‰‡æ¥è¯´è¦å¥½å¾ˆå¤šã€‚å®ƒä»ç„¶ä¼šæµªè´¹ä¸€äº›å†…å­˜ï¼Œä½†å¥½åœ¨ä¸éœ€è¦ç¢ç‰‡æ•´ç†ï¼Œå¹¶ä¸”ç¢ç‰‡çš„æ€»é‡æ˜¯å¯é¢„æµ‹çš„ï¼ˆå¹³å‡æ¯ä¸ªå†…å­˜åŒºåŸŸæœ‰åŠé¡µç¢ç‰‡ï¼‰ã€‚&lt;/p&gt;

&lt;h2 id=&#34;é¡µè¡¨&#34;&gt;é¡µè¡¨&lt;/h2&gt;

&lt;p&gt;å¯ä»¥çœ‹åˆ°ï¼Œå¯èƒ½æœ‰æ•°ä»¥ç™¾ä¸‡çš„çš„å†…å­˜é¡µè¢«æ˜ å°„åˆ°äº†å¸§ï¼Œè¿™é‡Œçš„æ˜ å°„ä¿¡æ¯æ˜¯éœ€è¦é¢å¤–å­˜æ”¾çš„ã€‚åœ¨åˆ†æ®µæŠ€æœ¯çš„å®ç°ä¸­ï¼Œæ¯ä¸ªæ´»è·ƒçš„å†…å­˜å•å…ƒéƒ½æœ‰ä¸€ä¸ªå•ç‹¬çš„æ®µå¯„å­˜å™¨æ¥å­˜æ”¾æ®µä¿¡æ¯ï¼Œä½†è¿™å¯¹äºåˆ†é¡µæ¥è¯´æ˜¯ä¸å¯èƒ½çš„ï¼Œå› ä¸ºåˆ†é¡µçš„æ•°é‡è¿œè¿œå¤šäºå¯„å­˜å™¨ã€‚åˆ†é¡µä½¿ç”¨ä¸€ä¸ªåä¸º&lt;em&gt;é¡µè¡¨ï¼ˆpage tableï¼‰&lt;/em&gt; çš„ç»“æ„æ¥å­˜å‚¨å®ƒçš„æ˜ å°„ä¿¡æ¯ã€‚&lt;/p&gt;

&lt;p&gt;å¯¹äºä¸Šé¢çš„ç¤ºä¾‹ï¼Œå®ƒçš„é¡µè¡¨å¤§æ¦‚é•¿è¿™ä¸ªæ ·å­ï¼š&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;//blog.betacat.io/image/introduction-to-paging/paging-page-tables.svg&#34; alt=&#34;paging-page-tables&#34; /&gt;&lt;/p&gt;

&lt;p&gt;æ¯ä¸ªè¿›ç¨‹éƒ½æœ‰å®ƒè‡ªå·±çš„é¡µè¡¨ï¼Œæˆ‘ä»¬ç”¨ä¸€ä¸ªç‰¹æ®Šçš„å¯„å­˜å™¨æ¥å­˜æ”¾æŒ‡å‘å½“å‰æ´»åŠ¨é¡µè¡¨çš„æŒ‡é’ˆã€‚åœ¨&lt;code&gt;x86&lt;/code&gt;ä¸Šï¼Œè¯¥å¯„å­˜å™¨ä¸º&lt;code&gt;CR3&lt;/code&gt;ã€‚åœ¨æ¯æ¬¡è¿è¡Œä¸€ä¸ªè¿›ç¨‹ä¹‹å‰ï¼Œæ“ä½œç³»ç»Ÿå°†è´Ÿè´£æŠŠæ­£ç¡®çš„æŒ‡é’ˆæ”¾åˆ°è¯¥å¯„å­˜å™¨ä¸­ã€‚&lt;/p&gt;

&lt;p&gt;åœ¨æ¯æ¬¡å‘ç”Ÿå†…å­˜è®¿é—®æ—¶ï¼ŒCPUä¼šä»å¯„å­˜å™¨ä¸­è¯»å–é¡µè¡¨æŒ‡é’ˆï¼Œå¹¶ä»é¡µè¡¨ä¸­æŸ¥æ‰¾è¯¥é¡µé¢è¢«æ˜ å°„å“ªä¸ªå¸§ä¸Šã€‚è¿™ä¸ªè¿‡ç¨‹ç”±ç¡¬ä»¶å®Œæˆï¼Œå¯¹ç¨‹åºå®Œå…¨é€æ˜ã€‚ä¸ºäº†åŠ å¿«è¿™é‡Œçš„è½¬æ¢è¿‡ç¨‹ï¼Œè®¸å¤šCPUéƒ½æœ‰ä¸€ä¸ªç‰¹æ®Šçš„ç¼“å­˜ï¼Œç”¨æ¥è®°ä½ä¸Šæ¬¡è½¬æ¢çš„ç»“æœã€‚&lt;/p&gt;

&lt;p&gt;æ ¹æ®æ¶æ„çš„ä¸åŒï¼Œé¡µè¡¨ä¸­çš„æ¯ä¸€é¡¹è¿˜å¯ä»¥åœ¨flagså­—æ®µä¸­å­˜å‚¨è®¿é—®æƒé™ç­‰å±æ€§ã€‚åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œ&lt;code&gt;r/w&lt;/code&gt;è¡¨ç¤ºè¯¥é¡µæ—¢å¯è¯»åˆå¯å†™ã€‚&lt;/p&gt;

&lt;h2 id=&#34;å¤šçº§é¡µè¡¨&#34;&gt;å¤šçº§é¡µè¡¨&lt;/h2&gt;

&lt;p&gt;æˆ‘ä»¬åˆšæ‰çœ‹åˆ°çš„é‚£ä¸ªç®€å•çš„é¡µè¡¨å­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼šåœ¨è¾ƒå¤§çš„åœ°å€ç©ºé—´ä¸­å®ƒä¼šæµªè´¹å†…å­˜ã€‚ä¾‹å¦‚ï¼Œå‡è®¾ä¸€ä¸ªè¿›ç¨‹ä½¿ç”¨4ä¸ªè™šæ‹Ÿé¡µé¢&lt;code&gt;0&lt;/code&gt;ã€&lt;code&gt;1_000_000&lt;/code&gt;ã€&lt;code&gt;1_000_050&lt;/code&gt;å’Œ&lt;code&gt;1_000_100&lt;/code&gt;(è¿™é‡Œçš„&lt;code&gt;_&lt;/code&gt;è¡¨ç¤ºåƒä½åˆ†éš”ç¬¦):&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;//blog.betacat.io/image/introduction-to-paging/single-level-page-table.svg&#34; alt=&#34;single-level-page-table&#34; /&gt;&lt;/p&gt;

&lt;p&gt;å®ƒåªéœ€è¦4ä¸ªç‰©ç†å¸§ï¼Œä½†æ˜¯é¡µè¡¨ä¸­æœ‰è¶…è¿‡100ä¸‡ä¸ªé¡¹ç›®ã€‚è€Œä¸”æˆ‘ä»¬è¿˜ä¸èƒ½çœç•¥ç©ºé¡¹ç›®ï¼Œå› ä¸ºè¿™æ ·çš„è¯åœ¨åœ°å€è½¬æ¢çš„è¿‡ç¨‹ä¸­ï¼ŒCPUå°±ä¸èƒ½ç›´æ¥è·³è½¬åˆ°æ­£ç¡®çš„é¡µè¡¨é¡¹ï¼ˆä¾‹å¦‚ï¼Œä¸èƒ½ä¿è¯ç¬¬å››é¡µå°±åœ¨é¡µè¡¨çš„ç¬¬å››ä½ï¼‰ã€‚&lt;/p&gt;

&lt;p&gt;ä¸ºäº†å‡å°‘å†…å­˜çš„æµªè´¹ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸€ä¸ª&lt;strong&gt;äºŒçº§é¡µè¡¨&lt;/strong&gt;ã€‚è¿™é‡Œçš„ç¬¬äºŒçº§é¡µè¡¨åŒ…å«çš„æ˜¯å†…å­˜åœ°å€åŒºé—´è·Ÿç¬¬ä¸€çº§é¡µè¡¨çš„æ˜ å°„ä¿¡æ¯ã€‚&lt;/p&gt;

&lt;p&gt;æˆ–è®¸ç”¨ä¸€ä¸ªä¾‹å­èƒ½è§£é‡Šçš„æ›´æ¸…æ¥šä¸€ç‚¹ã€‚æˆ‘ä»¬å‡è®¾æ¯ä¸ª1çº§é¡µè¡¨è´Ÿè´£ä¸€ä¸ªå¤§å°ä¸º&lt;code&gt;10_000&lt;/code&gt;çš„å†…å­˜åŒºåŸŸï¼Œé‚£ä¸Šé¢çš„æ˜ å°„å…³ç³»å¯ä»¥æ‰©å±•ä¸ºï¼š&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;//blog.betacat.io/image/introduction-to-paging/multilevel-page-table.svg&#34; alt=&#34;multilevel-page-table&#34; /&gt;&lt;/p&gt;

&lt;p&gt;è¿™é‡Œï¼Œç¬¬0é¡µå±äºç¬¬ä¸€ä¸ª&lt;code&gt;10_000&lt;/code&gt;å­—èŠ‚åŒºåŸŸï¼Œå› æ­¤å®ƒçš„æ˜ å°„å…³ç³»è½å…¥åˆ°ç¬¬äºŒçº§é¡µè¡¨çš„å¤´ä¸€é¡¹ã€‚è¿™ä¸€é¡¹æŒ‡å‘äº†ä¸€ä¸ªä¸€çº§é¡µè¡¨T1ï¼Œè€ŒT1åˆè¡¨æ˜ï¼Œç¬¬0é¡µè¢«æ˜ å°„åˆ°ç¬¬0ä¸ªå¸§ã€‚&lt;/p&gt;

&lt;p&gt;å¦å¤–ï¼Œç¬¬&lt;code&gt;1_000_000&lt;/code&gt;ã€&lt;code&gt;1_000_050&lt;/code&gt;å’Œ&lt;code&gt;1_000_100&lt;/code&gt;é¡µéƒ½å±äºç¬¬100ä¸ª&lt;code&gt;10_000&lt;/code&gt;å­—èŠ‚åŒºåŸŸï¼Œæ‰€ä»¥å®ƒä»¬ä½¿ç”¨ç¬¬äºŒçº§é¡µè¡¨çš„ç¬¬100é¡¹ã€‚è¿™ä¸€é¡¹æŒ‡å‘äº†å¦ä¸€ä¸ªä¸€çº§é¡µè¡¨T2ï¼Œè€ŒT2åˆå°†è¿™ä¸‰ä¸ªé¡µé¢åˆ†åˆ«æ˜ å°„åˆ°å¸§100ã€150å’Œ200ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œä¸€çº§é¡µè¡¨çš„é¡µåœ°å€ä¸åŒ…æ‹¬åŒºåŸŸçš„åç§»é‡ï¼Œæ‰€ä»¥è¿™é‡Œæ˜ å°„&lt;code&gt;1_000_050&lt;/code&gt;é¡µçš„é‚£ä¸€é¡¹å†™çš„ä»…ä»…æ˜¯&lt;code&gt;50&lt;/code&gt;ã€‚&lt;/p&gt;

&lt;p&gt;æˆ‘ä»¬åœ¨ç¬¬2çº§è¡¨ä¸­ä»ç„¶æœ‰100ä¸ªç©ºä½ç½®ï¼Œä½†æ¯”ä¹‹å‰çš„ç™¾ä¸‡ä¸ªç©ºä½ç½®è¦å°‘å¾—å¤šã€‚è¿™æ˜¯å› ä¸ºæˆ‘ä»¬ä¸éœ€è¦ä¸º&lt;code&gt;10_000&lt;/code&gt;å’Œ&lt;code&gt;1_000_000&lt;/code&gt;ä¹‹é—´æœªæ˜ å°„çš„å†…å­˜åŒºåŸŸåˆ›å»º1çº§é¡µè¡¨ã€‚&lt;/p&gt;

&lt;p&gt;ä¸¤çº§é¡µè¡¨çš„åŸç†å¯ä»¥æ‰©å±•åˆ°ä¸‰ã€å››æˆ–æ›´å¤šçº§åˆ«ã€‚ç„¶åï¼Œé¡µè¡¨å¯„å­˜å™¨&lt;code&gt;CR3&lt;/code&gt;å°±æŒ‡å‘æœ€é«˜çº§åˆ«çš„é¡µè¡¨ï¼Œè¯¥è¡¨åˆ™æŒ‡å‘ä¸‹ä¸€ä¸ªè¾ƒä½çº§åˆ«çš„è¡¨ï¼Œè¿™ä¸ªä½çº§åˆ«çš„è¡¨å†æŒ‡å‘å¦ä¸€ä¸ªæ›´ä½ä¸€çº§çš„è¡¨ï¼Œä»¥æ­¤ç±»æ¨ã€‚æœ€åï¼Œ1çº§é¡µé¢è¡¨æŒ‡å‘æ˜ å°„çš„å¸§ã€‚è¯¥åŸç†é€šå¸¸è¢«ç§°ä¸º&lt;em&gt;å¤šçº§&lt;/em&gt; æˆ–&lt;em&gt;åˆ†å±‚&lt;/em&gt; é¡µè¡¨ã€‚&lt;/p&gt;

&lt;p&gt;ç°åœ¨æˆ‘ä»¬å·²ç»äº†è§£äº†åˆ†é¡µå’Œå¤šçº§é¡µè¡¨çš„å·¥ä½œæ–¹å¼ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹çœ‹x86_64æ¶æ„æ˜¯å¦‚ä½•å®ç°åˆ†é¡µçš„ï¼ˆä¸‹é¢å‡è®¾CPUå·¥ä½œåœ¨64ä½æ¨¡å¼ä¸‹ï¼‰ã€‚&lt;/p&gt;

&lt;h1 id=&#34;x86-64ä¸‹çš„åˆ†é¡µ&#34;&gt;x86_64ä¸‹çš„åˆ†é¡µ&lt;/h1&gt;

&lt;p&gt;x86_64æ¶æ„ä½¿ç”¨4çº§é¡µè¡¨ï¼Œé¡µå¤§å°ä¸º4KiBã€‚è¿™é‡Œæ¯çº§é¡µè¡¨éƒ½æœ‰å›ºå®šçš„512é¡¹ï¼Œæ¯é¡¹éƒ½ä¸º8ä¸ªå­—èŠ‚ï¼Œå› æ­¤æ¯ä¸ªé¡µè¡¨çš„å¤§å°ä¸º512 * 8B = 4KiB â€”â€” æ­£å·§æ”¾æ»¡ä¸€é¡µã€‚&lt;/p&gt;

&lt;p&gt;ä¸€ä¸ªè™šæ‹Ÿåœ°å€çš„ç»“æ„å¦‚ä¸‹ï¼Œå®ƒåŒ…å«æ¯çº§é¡µè¡¨çš„ç´¢å¼•ï¼š&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;//blog.betacat.io/image/introduction-to-paging/x86_64-table-indices-from-address.svg&#34; alt=&#34;x86_64-table-indices-from-address&#34; /&gt;&lt;/p&gt;

&lt;p&gt;å¯ä»¥çœ‹åˆ°ï¼Œæ¯çº§é¡µè¡¨çš„ç´¢å¼•éƒ½æ˜¯9æ¯”ç‰¹ï¼Œè¿™æ˜¯å› ä¸ºæ¯çº§é¡µè¡¨éƒ½æœ‰2^9 = 512é¡¹ã€‚è¿™é‡Œæœ€ä½çš„12ä½è¡¨ç¤ºçš„æ˜¯è¯¥åœ°å€åœ¨ä¸€ä¸ª4KiBå¤§å°çš„é¡µä¸­çš„åç§»é‡ï¼ˆ2^12 bytes = 4KiBï¼‰ã€‚ç¬¬48åˆ°64ä½è¢«ä¸¢å¼ƒï¼Œè¿™æ„å‘³ç€x86_64å®é™…ä¸Šåªæ”¯æŒ48ä½åœ°å€ï¼Œæ‰€ä»¥å®ƒå¹¶ä¸æ˜¯çœŸæ­£çš„64ä½ã€‚è™½ç„¶æœ‰è®¡åˆ’é€šè¿‡ä¸€ä¸ª&lt;a href=&#34;https://en.wikipedia.org/wiki/Intel_5-level_paging&#34;&gt;5çº§é¡µè¡¨&lt;/a&gt;æ¥å°†åœ°å€æ‰©å±•åˆ°ç¬¬57ä½ï¼Œä½†æ˜¯ç›®å‰è¿˜æ²¡æœ‰ç”Ÿäº§å‡ºæ”¯æŒæ­¤åŠŸèƒ½çš„å¤„ç†å™¨ã€‚&lt;/p&gt;

&lt;p&gt;è™½è¯´ç¬¬48åˆ°64ä½è¢«ä¸¢å¼ƒï¼Œä½†ä¹Ÿä¸èƒ½å°†å®ƒä»¬è®¾ä¸ºä»»æ„å€¼ã€‚ç›¸åï¼Œæ­¤èŒƒå›´å†…çš„æ‰€æœ‰bitéƒ½å¿…é¡»è·Ÿç¬¬47ä½çš„å€¼ä¸€æ ·ï¼Œè¿™ä¸€æ–¹é¢æ˜¯ä¸ºäº†ä¿è¯åœ°å€çš„å”¯ä¸€æ€§ï¼Œå¦ä¸€æ–¹é¢ä¹Ÿæ˜¯ä¸ºäº†ä»¥åçš„æ‰©å±•ï¼Œæ¯”å¦‚5çº§é¡µè¡¨ã€‚è¿™è¢«ç§°ä¸º&lt;em&gt;ç¬¦å·æ‰©å±•&lt;/em&gt; ï¼Œå› ä¸ºå®ƒä¸&lt;a href=&#34;https://en.wikipedia.org/wiki/Two&#39;s_complement#Sign_extension&#34;&gt;äºŒè¿›åˆ¶è¡¥ç ä¸­çš„ç¬¦å·æ‰©å±•&lt;/a&gt;éå¸¸ç›¸ä¼¼ã€‚ å¦‚æœåœ°å€æœªè¿›è¡Œæ­£ç¡®çš„ç¬¦å·æ‰©å±•ï¼Œåˆ™CPUä¼šæŠ›å‡ºå¼‚å¸¸ã€‚&lt;/p&gt;

&lt;h2 id=&#34;ä¸€ä¸ªåœ°å€è½¬æ¢çš„å®ä¾‹&#34;&gt;ä¸€ä¸ªåœ°å€è½¬æ¢çš„å®ä¾‹&lt;/h2&gt;

&lt;p&gt;è®©æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªä¾‹å­æ¥äº†è§£è¿™æ•´ä¸ªè½¬æ¢çš„è¿‡ç¨‹ï¼š&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;//blog.betacat.io/image/introduction-to-paging/x86_64-page-table-translation.svg&#34; alt=&#34;x86_64-page-table-translation&#34; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;code&gt;CR3&lt;/code&gt;å¯„å­˜å™¨å­˜æ”¾çš„æ˜¯å½“å‰æ´»åŠ¨çš„ç¬¬4çº§é¡µè¡¨çš„ç‰©ç†åœ°å€ï¼Œå³æ•´ä¸ª4çº§é¡µè¡¨çš„æ ¹è¡¨åœ°å€ã€‚è¡¨ä¸­çš„æ¯ä¸€é¡¹éƒ½æŒ‡å‘ä¸‹ä¸€ä¸ªçº§åˆ«è¡¨çš„ç‰©ç†å¸§ï¼Œæœ€ç»ˆï¼Œç¬¬1çº§è¡¨ä¸­çš„å†…å®¹åˆ™æŒ‡å‘è¢«æ˜ å°„çš„é¡µå¸§ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œé¡µè¡¨ä¸­çš„æ‰€æœ‰åœ°å€éƒ½æ˜¯ç‰©ç†çš„è€Œä¸æ˜¯è™šæ‹Ÿçš„ï¼Œå¦åˆ™CPUä¹Ÿéœ€è¦è½¬æ¢è¿™äº›åœ°å€ï¼ˆè¿™ä¼šå¯¼è‡´æ— ä¼‘æ­¢çš„é€’å½’ï¼‰ã€‚&lt;/p&gt;

&lt;p&gt;ä¸Šé¢é¡µè¡¨çš„å±‚æ¬¡ç»“æ„æ˜ å°„äº†ä¸¤ä¸ªé¡µé¢ï¼ˆè“è‰²ï¼‰ã€‚ä»é¡µè¡¨ç´¢å¼•æˆ‘ä»¬å¯ä»¥æ¨æ–­å‡ºè¿™ä¸¤ä¸ªé¡µé¢çš„è™šæ‹Ÿåœ°å€æ˜¯&lt;code&gt;0x803FE7F000&lt;/code&gt;å’Œ&lt;code&gt;0x803FE00000&lt;/code&gt;ã€‚æˆ‘ä»¬æ¥çœ‹çœ‹å½“è¿›ç¨‹è¯»å–åœ°å€&lt;code&gt;0x803FE7F5CE&lt;/code&gt;æ—¶ä¼šå‘ç”Ÿä»€ä¹ˆã€‚é¦–å…ˆï¼Œæˆ‘ä»¬å°†è¯¥åœ°å€è½¬æ¢ä¸ºäºŒè¿›åˆ¶ï¼Œçœ‹çœ‹å®ƒçš„é¡µè¡¨ç´¢å¼•å’Œé¡µé¢åç§»é‡ï¼š&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;//blog.betacat.io/image/introduction-to-paging/x86_64-page-table-translation-addresses.png&#34; alt=&#34;x86_64-page-table-translation-addresses&#34; /&gt;&lt;/p&gt;

&lt;p&gt;ä½¿ç”¨è¿™äº›ç´¢å¼•ï¼Œæˆ‘ä»¬å°±å¯ä»¥éå†é¡µè¡¨çš„å±‚æ¬¡ç»“æ„ä»¥ç¡®å®šè¯¥åœ°å€å¯¹åº”çš„ç‰©ç†å¸§ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;é¦–å…ˆï¼Œæˆ‘ä»¬ä»&lt;code&gt;CR3&lt;/code&gt;å¯„å­˜å™¨ä¸­è¯»å–ç¬¬4çº§é¡µè¡¨çš„ç‰©ç†åœ°å€ã€‚&lt;/li&gt;
&lt;li&gt;ä»ä¸Šé¢çš„äºŒè¿›åˆ¶è¡¨ç¤ºä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¯¥åœ°å€çš„ç¬¬4çº§ç´¢å¼•æ˜¯&lt;code&gt;1&lt;/code&gt;ï¼Œæ‰€ä»¥æˆ‘ä»¬æŸ¥çœ‹ç¬¬4çº§é¡µè¡¨çš„ç¬¬ä¸€é¡¹ï¼Œå®ƒå‘Šè¯‰æˆ‘ä»¬ç¬¬3çº§è¡¨å­˜å‚¨åœ¨åœ°å€16KiBã€‚&lt;/li&gt;
&lt;li&gt;æˆ‘ä»¬ä»è¯¥åœ°å€åŠ è½½ç¬¬3çº§è¡¨ï¼Œå¹¶æŸ¥çœ‹ç´¢å¼•ä¸º0çš„å†…å®¹ï¼Œå®ƒå°†æˆ‘ä»¬å¸¦å‘åœ°å€ä¸º24KiBçš„ç¬¬2çº§é¡µè¡¨ã€‚&lt;/li&gt;
&lt;li&gt;ç¬¬2çº§ç´¢å¼•æ˜¯&lt;code&gt;511&lt;/code&gt;ï¼Œå› æ­¤æˆ‘ä»¬æŸ¥çœ‹è¯¥é¡µè¡¨çš„æœ€åä¸€ä¸ªé¡¹ä»¥æ‰¾å‡ºç¬¬1çº§é¡µè¡¨çš„åœ°å€ã€‚&lt;/li&gt;
&lt;li&gt;åŒæ ·çš„ï¼Œä»ç¬¬1çº§é¡µè¡¨çš„ç¬¬&lt;code&gt;127&lt;/code&gt;é¡¹æˆ‘ä»¬ç»ˆäºæ‰¾åˆ°è¯¥é¡µè¢«æ˜ å°„åˆ°äº†ç‰©ç†å¸§12KiBï¼Œå³åå…­è¿›åˆ¶çš„0xc000ã€‚&lt;/li&gt;
&lt;li&gt;æœ€åä¸€æ­¥å°±æ˜¯å°†é¡µé¢åç§»é‡å’Œå¸§åœ°å€åŠ èµ·æ¥ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¾—åˆ°äº†è¯¥è™šæ‹Ÿåœ°å€å¯¹åº”çš„ç‰©ç†åœ°å€0xc000 + 0x5ce = 0xc5ceã€‚&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;img src=&#34;//blog.betacat.io/image/introduction-to-paging/x86_64-page-table-translation-steps.svg&#34; alt=&#34;x86_64-page-table-translation-steps&#34; /&gt;&lt;/p&gt;

&lt;p&gt;ç¬¬1çº§é¡µè¡¨çš„æƒé™æ ‡å¿—ä½ä¸º&lt;code&gt;r&lt;/code&gt;ï¼Œè¡¨ç¤ºåªè¯»ã€‚ç¡¬ä»¶ä¼šå¼ºåˆ¶æ£€æŸ¥è¿™äº›æƒé™ï¼Œå¦‚æœæˆ‘ä»¬å°è¯•å¯¹è¯¥é¡µé¢è¿›è¡Œå†™æ“ä½œï¼Œé‚£å°†ä¼šè§¦å‘å¼‚å¸¸ã€‚é«˜çº§åˆ«é¡µè¡¨ä¸­çš„æƒé™ä¼šé™åˆ¶ä½çº§åˆ«é¡µè¡¨çš„æƒé™ï¼Œå› æ­¤å¦‚æœæˆ‘ä»¬å°†ç¬¬3çº§é¡µè¡¨ä¸­çš„ç¬¬&lt;code&gt;511&lt;/code&gt;é¡¹è®¾ä¸º&lt;code&gt;åªè¯»&lt;/code&gt;ï¼Œåˆ™ç”±å®ƒæ‰€æŒ‡å‘çš„é¡µé¢éƒ½ä¸å¯å†™ï¼Œå³ä½¿åœ¨ç¬¬4çº§é¡µè¡¨ä¸­æœ‰çš„é¡µé¢æƒé™æ ‡å¿—ä½ä¸º&lt;code&gt;è¯»å†™&lt;/code&gt;ã€‚&lt;/p&gt;

&lt;p&gt;éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå°½ç®¡æœ¬ç¤ºä¾‹ä¸­ï¼Œæ¯çº§é¡µè¡¨ä»…æœ‰ä¸€ä¸ªå®ä¾‹ï¼Œä½†å®é™…ä¸Šï¼Œåœ¨ä¸€ä¸ªåœ°å€ç©ºé—´ä¸­ï¼Œæ¯çº§é¡µè¡¨é€šå¸¸ä¼šæœ‰å¤šä¸ªå®ä¾‹ï¼ŒåŒ…å«ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;ä¸€ä¸ªç¬¬4çº§é¡µè¡¨&lt;/li&gt;
&lt;li&gt;512ä¸ªç¬¬3çº§é¡µè¡¨ï¼ˆç¬¬4çº§é¡µè¡¨æœ‰512é¡¹ï¼‰&lt;/li&gt;
&lt;li&gt;512 * 512ä¸ªç¬¬2çº§é¡µè¡¨ï¼ˆæ¯ä¸ªç¬¬3çº§é¡µè¡¨éƒ½æœ‰512é¡¹ï¼‰&lt;/li&gt;
&lt;li&gt;512 * 512 * 512ä¸ªç¬¬1çº§é¡µè¡¨ï¼ˆæ¯ä¸ªç¬¬2çº§é¡µè¡¨éƒ½æœ‰512é¡¹ï¼‰&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;é¡µè¡¨ç»“æ„&#34;&gt;é¡µè¡¨ç»“æ„&lt;/h2&gt;

&lt;p&gt;x86_64ä¸­çš„é¡µè¡¨å®é™…ä¸Šæ˜¯ä¸€ä¸ªé•¿åº¦ä¸º512çš„æ•°ç»„ã€‚ ç”¨Rustçš„è¯è¯´ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-rust&#34; data-lang=&#34;rust&#34;&gt;&lt;span class=&#34;lnt&#34;&gt;1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;2
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;3
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;4
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-rust&#34; data-lang=&#34;rust&#34;&gt;&lt;span class=&#34;cp&#34;&gt;#[repr(align(4096))]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;pub&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;struct&lt;/span&gt; &lt;span class=&#34;nc&#34;&gt;PageTable&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;entries&lt;/span&gt;: &lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;PageTableEntry&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;512&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;],&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;å¦‚&lt;code&gt;repr&lt;/code&gt;å±æ€§æ‰€ç¤ºï¼Œé¡µè¡¨éœ€è¦è·Ÿé¡µé¢å¯¹é½ï¼Œå³åœ¨4KiBçš„è¾¹ç•Œä¸Šå¯¹é½ã€‚è¿™å¯ä»¥ç¡®ä¿ä¸€ä¸ªé¡µè¡¨å§‹ç»ˆå¡«å……æ»¡æ•´ä¸ªé¡µé¢ï¼Œå¹¶å…è®¸å†…éƒ¨ç»“æ„çš„ç©ºé—´ä¼˜åŒ–ã€‚&lt;/p&gt;

&lt;p&gt;æ•°ç»„ä¸­çš„æ¯ä¸€é¡¹å¤§å°éƒ½ä¸º8 bytesï¼ˆ64bitsï¼‰ï¼Œæ ¼å¼ä¸ºï¼š&lt;/p&gt;

&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;Bit(s)&lt;/th&gt;
&lt;th&gt;Name&lt;/th&gt;
&lt;th&gt;Meaning&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;

&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;0&lt;/td&gt;
&lt;td&gt;present&lt;/td&gt;
&lt;td&gt;è¯¥é¡µå·²ç»è¢«åŠ è½½åˆ°å†…å­˜ä¸­&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;1&lt;/td&gt;
&lt;td&gt;writable&lt;/td&gt;
&lt;td&gt;è¯¥é¡µæ˜¯å¯å†™çš„&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;2&lt;/td&gt;
&lt;td&gt;user accessible&lt;/td&gt;
&lt;td&gt;å¦‚æœæœªè¢«è®¾ç½®ï¼Œåªæœ‰è¿è¡Œåœ¨å†…æ ¸æ¨¡å¼ä¸‹çš„ä»£ç å¯ä»¥è®¿é—®è¿™ä¸ªé¡µé¢&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;3&lt;/td&gt;
&lt;td&gt;write through caching&lt;/td&gt;
&lt;td&gt;å†™æ“ä½œç›´æ¥ååº”åˆ°å†…å­˜ä¸­&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;4&lt;/td&gt;
&lt;td&gt;disable cache&lt;/td&gt;
&lt;td&gt;è¯¥é¡µä¸ä½¿ç”¨ç¼“å­˜&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;5&lt;/td&gt;
&lt;td&gt;accessed&lt;/td&gt;
&lt;td&gt;åœ¨ä½¿ç”¨è¯¥é¡µåï¼ŒCPUä¼šè®¾ç½®æ­¤ä½&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;6&lt;/td&gt;
&lt;td&gt;dirty&lt;/td&gt;
&lt;td&gt;åœ¨å†™æ“ä½œå‘ç”Ÿåï¼ŒCPUä¼šè®¾ç½®æ­¤ä½&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;7&lt;/td&gt;
&lt;td&gt;huge page/null&lt;/td&gt;
&lt;td&gt;åœ¨P1å’ŒP4ä¸­å¿…é¡»æ˜¯0ï¼Œåœ¨P3ä¸­åˆ™åˆ›å»º1GiBé¡µé¢ï¼Œåœ¨P2ä¸­åˆ™åˆ›å»º2MiBé¡µé¢&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;8&lt;/td&gt;
&lt;td&gt;global&lt;/td&gt;
&lt;td&gt;åœ¨åœ°å€ç©ºé—´åˆ‡æ¢çš„æ—¶å€™ï¼Œè¯¥é¡µæœªä»ç¼“å­˜ä¸­åˆ·æ–°ï¼ˆå¿…é¡»è®¾ç½®CR4å¯„å­˜å™¨çš„PGEä½ï¼‰&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;9-11&lt;/td&gt;
&lt;td&gt;available&lt;/td&gt;
&lt;td&gt;å¯ä»¥ç”±æ“ä½œç³»ç»Ÿè‡ªç”±ä½¿ç”¨&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;12-51&lt;/td&gt;
&lt;td&gt;physical address&lt;/td&gt;
&lt;td&gt;è¯¥é¡µè·Ÿé¡µå¸§çš„52ä½å¯¹é½ï¼Œæˆ–è€…æ˜¯ä¸‹ä¸€ä¸ªé¡µè¡¨&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;52-62&lt;/td&gt;
&lt;td&gt;available&lt;/td&gt;
&lt;td&gt;å¯ä»¥ç”±æ“ä½œç³»ç»Ÿè‡ªç”±ä½¿ç”¨&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;63&lt;/td&gt;
&lt;td&gt;no execute&lt;/td&gt;
&lt;td&gt;ç¦æ­¢æ‰§è¡Œæ­¤é¡µä¸Šçš„ä»£ç ï¼ˆå¿…é¡»è®¾ç½®EFERå¯„å­˜å™¨ä¸­çš„NXEä½ï¼‰&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;

&lt;p&gt;å¯ä»¥çœ‹åˆ°åªæœ‰ä½12-51è¢«ç”¨æ¥å­˜å‚¨ç‰©ç†å¸§çš„åœ°å€ï¼Œå…¶ä½™çš„ä½è¢«ç”¨ä½œæ ‡å¿—æˆ–è€…å¯ä»¥è¢«æ“ä½œç³»ç»Ÿè‡ªç”±ä½¿ç”¨ã€‚è¿™æ˜¯å»ºç«‹åœ¨æˆ‘ä»¬æ€»æ˜¯æŒ‡å‘4096 byesæ•´æ•°å€åœ°å€çš„åŸºç¡€ä¸Šï¼Œè¿™ä¸ªåœ°å€å¯èƒ½æ˜¯å¦ä¸€ä¸ªé¡µè¡¨ï¼Œä¹Ÿæœ‰å¯èƒ½æ˜¯ä¸€ä¸ªç‰©ç†å¸§ã€‚è¿™ä¹Ÿæ„å‘³ç€ç¬¬0-11ä½å§‹ç»ˆä¸ºé›¶ï¼Œè€Œä¸”ç¡¬ä»¶ä¼šåœ¨ä½¿ç”¨è¯¥åœ°å€ä¹‹å‰å°†ä»–ä»¬ç½®ä¸º0ï¼Œå› æ­¤æˆ‘ä»¬æ²¡æœ‰å¿…è¦å­˜å‚¨è¿™äº›ä½ã€‚ç¬¬52-63ä½ä¹Ÿæ˜¯å¦‚æ­¤ï¼Œå› ä¸ºx86_64æ¶æ„ä»…æ”¯æŒ52ä½ç‰©ç†åœ°å€ï¼ˆé“ç†è·Ÿå®ƒä»…æ”¯æŒ48ä½è™šæ‹Ÿåœ°å€ç±»ä¼¼ï¼‰ã€‚&lt;/p&gt;

&lt;p&gt;ä¸‹é¢æ¥è¯¦ç»†çš„è§£é‡Šä¸‹è¿™äº›æ ‡å¿—ä½ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;code&gt;present&lt;/code&gt;ç”¨æ¥åŒºåˆ†å·²æ˜ å°„é¡µé¢å’Œæœªæ˜ å°„é¡µé¢ã€‚å½“å†…å­˜ç”¨æ»¡ä¹‹åï¼Œæ“ä½œç³»ç»Ÿä¼šä¸´æ—¶çš„å°†ä¸€äº›é¡µé¢äº¤æ¢åˆ°ç£ç›˜ä¸Šã€‚éšåï¼Œå¦‚æœè¯¥é¡µé¢è¢«è®¿é—®åˆ°äº†ï¼Œä¸€ä¸ªå«&lt;em&gt;ç¼ºé¡µä¸­æ–­&lt;/em&gt; çš„å¼‚å¸¸ä¼šè¢«æŠ›å‡ºï¼Œé‚£ä¹ˆæ“ä½œç³»ç»Ÿå°±çŸ¥é“éœ€è¦ä»ç£ç›˜ä¸­é‡æ–°åŠ è½½è¿™ä¸ªä¸¢å¤±çš„é¡µé¢ï¼Œç„¶åå†ç»§ç»­æ‰§è¡Œåº”ç”¨ç¨‹åºã€‚&lt;/li&gt;
&lt;li&gt;&lt;code&gt;writable&lt;/code&gt;å’Œ&lt;code&gt;no execute&lt;/code&gt;åˆ†åˆ«è¡¨ç¤ºï¼Œè¯¥é¡µçš„å†…å®¹æ˜¯å¯å†™çš„è¿˜æ˜¯åŒ…å«å¯æ‰§è¡Œçš„æŒ‡ä»¤ã€‚&lt;/li&gt;
&lt;li&gt;å½“å¯¹é¡µé¢è¿›è¡Œè¯»æˆ–å†™æ“ä½œæ—¶ï¼ŒCPUä¼šè‡ªåŠ¨è®¾ç½®&lt;code&gt;accessed&lt;/code&gt;å’Œ&lt;code&gt;dirty&lt;/code&gt;æ ‡è®°ã€‚æ“ä½œç³»ç»Ÿå¯ä»¥åˆ©ç”¨è¿™äº›ä¿¡æ¯ï¼Œæ¥å†³å®šæ¯”å¦‚è‡ªä¸Šæ¬¡å­˜ç›˜ä¹‹åï¼Œå“ªäº›é¡µå¯ä»¥è¢«æ¢å‡ºæˆ–è€…å“ªäº›é¡µçš„å†…å®¹å·²ç»è¢«ä¿®æ”¹è¿‡ã€‚&lt;/li&gt;
&lt;li&gt;&lt;code&gt;write through caching&lt;/code&gt;å’Œ&lt;code&gt;disable cache&lt;/code&gt;ç”¨æ¥æ§åˆ¶æ¯ä¸€é¡µçš„ç¼“å­˜ã€‚&lt;/li&gt;
&lt;li&gt;&lt;code&gt;user accessible&lt;/code&gt;ç”¨æ¥æ ‡å¿—è¯¥é¡µæ˜¯å¦å¯ä»¥è¢«ç”¨æˆ·ç©ºé—´çš„ä»£ç è®¿é—®ï¼Œå¦åˆ™åªæœ‰å†…æ ¸ç©ºé—´çš„ä»£ç æ‰å¯ä»¥è®¿é—®ã€‚è¿™ä¸ªç‰¹æ€§ä½¿å¾—åœ¨ç”¨æˆ·ç©ºé—´çš„ç¨‹åºè¿è¡Œæ—¶ï¼Œå†…æ ¸ä»£ç ä»ç„¶ä¿æŒä½å®ƒçš„æ˜ å°„ï¼Œä»è€ŒåŠ å¿«&lt;a href=&#34;https://en.wikipedia.org/wiki/System_call&#34;&gt;ç³»ç»Ÿè°ƒç”¨&lt;/a&gt;ã€‚ç„¶è€Œï¼Œ&lt;a href=&#34;https://en.wikipedia.org/wiki/Spectre_(security_vulnerability)&#34;&gt;Spectre&lt;/a&gt;æ¼æ´ä»ç„¶å…è®¸å¤„äºç”¨æˆ·ç©ºé—´çš„ä»£ç è¯»å–è¿™äº›é¡µé¢ã€‚&lt;/li&gt;
&lt;li&gt;&lt;code&gt;global&lt;/code&gt;æ ‡å¿—ç”¨æ¥å‘Šè¯‰ç¡¬ä»¶ï¼Œè¯¥é¡µåœ¨æ‰€æœ‰çš„åœ°å€ç©ºé—´ä¸­éƒ½å¯ç”¨ï¼Œå› æ­¤åœ¨å‘ç”Ÿåœ°å€ç©ºé—´åˆ‡æ¢çš„æ—¶å€™ä¸éœ€è¦ä»ç¼“å­˜ä¸­åˆ é™¤ï¼ˆè¯·å‚é˜…ä¸‹é¢æœ‰å…³TLBçš„éƒ¨åˆ†ï¼‰ã€‚è¯¥æ ‡å¿—é€šå¸¸ä¸ä¸€ä¸ªæœªè¢«è®¾ç½®çš„&lt;code&gt;user accessible&lt;/code&gt;ä¸€èµ·ä½¿ç”¨ï¼Œç”¨æ¥å°†å†…æ ¸ä»£ç æ˜ å°„åˆ°æ‰€æœ‰åœ°å€ç©ºé—´ã€‚&lt;/li&gt;
&lt;li&gt;&lt;code&gt;huge page&lt;/code&gt;ç”¨åœ¨ç¬¬2çº§æˆ–è€…ç¬¬3çº§é¡µè¡¨ä¸­è¡¨ç¤ºè¯¥é¡µä¸­çš„æ¯ä¸€é¡¹éƒ½ç›´æ¥æŒ‡å‘ä¸€ä¸ªç‰©ç†å¸§ã€‚æœ‰äº†è¿™ä¸ªæ ‡å¿—åï¼Œé¡µé¢å¤§å°å°†å¢åŠ 512å€ï¼Œå¯¹äºç¬¬2çº§çš„é¡µè¡¨é¡¹ï¼Œé¡µé¢å¤§å°å˜ä¸º2MiB = 512 * 4KiBï¼Œå¯¹äºç¬¬3çº§çš„é¡µè¡¨é¡¹ï¼Œé¡µé¢å¤§å°å˜ä¸º1GiB = 512 * 2MiBã€‚ä½¿ç”¨è¾ƒå¤§é¡µé¢çš„ä¼˜ç‚¹æ˜¯ï¼Œæˆ‘ä»¬åªéœ€è¦æ›´å°‘çš„è½¬æ¢ç¼“å­˜è¡Œå’Œæ›´å°‘çš„é¡µè¡¨ã€‚&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Rusté‡Œçš„&lt;code&gt;x86_64&lt;/code&gt;åŒ…å·²ç»æœ‰äº†&lt;a href=&#34;https://docs.rs/x86_64/0.3.4/x86_64/structures/paging/struct.PageTable.html&#34;&gt;é¡µè¡¨&lt;/a&gt;åŠ&lt;a href=&#34;https://docs.rs/x86_64/0.3.4/x86_64/structures/paging/struct.PageTableEntry.html&#34;&gt;é¡µè¡¨é¡¹&lt;/a&gt;è¿™ä¸¤ç§ç±»å‹ï¼Œå› æ­¤æˆ‘ä»¬ä¸éœ€è¦è‡ªå·±åˆ›å»ºå®ƒä»¬ã€‚&lt;/p&gt;

&lt;h2 id=&#34;é¡µè¡¨ç¼“å­˜&#34;&gt;é¡µè¡¨ç¼“å­˜&lt;/h2&gt;

&lt;p&gt;ä¸Šé¢æ‰€è¯´çš„4çº§é¡µè¡¨ä½¿å¾—è™šæ‹Ÿåœ°å€çš„è½¬æ¢å˜å¾—å¾ˆæ˜‚è´µï¼Œå› ä¸ºæ¯æ¬¡è½¬æ¢éƒ½éœ€è¦4æ¬¡å†…å­˜è®¿é—®ã€‚ä¸ºäº†æé«˜æ€§èƒ½ï¼Œx86_64æ¶æ„å°†æœ€è¿‘çš„å‡ æ¬¡è½¬æ¢ç¼“å­˜åœ¨TLBï¼ˆtranslation lookaside bufferï¼‰ä¸­ï¼Œè¿™æ ·åœ°å€è½¬æ¢å°±æœ‰å¯èƒ½ç›´æ¥ä»ç¼“å­˜ä¸­è¯»å–ç»“æœã€‚&lt;/p&gt;

&lt;p&gt;ä¸å…¶ä»–CPUç¼“å­˜ä¸åŒï¼ŒTLBä¸æ˜¯å®Œå…¨é€æ˜çš„ï¼Œå½“é¡µè¡¨çš„å†…å®¹å‘ç”Ÿå˜åŒ–æ—¶ï¼Œå®ƒä¸ä¼šæ›´æ–°æˆ–åˆ é™¤ç¼“å­˜ï¼Œè¿™æ„å‘³ç€å†…æ ¸å¿…é¡»åœ¨ä¿®æ”¹é¡µè¡¨æ—¶æ‰‹åŠ¨æ›´æ–°TLBã€‚ä¸ºæ­¤ï¼Œæœ‰ä¸€ä¸ªåä¸º&lt;a href=&#34;https://www.felixcloutier.com/x86/INVLPG.html&#34;&gt;invlpg&lt;/a&gt;ï¼ˆinvalidate pageï¼‰çš„ç‰¹æ®ŠCPUæŒ‡ä»¤ï¼Œç”¨äºä»TLBä¸­åˆ é™¤æŒ‡å®šé¡µé¢çš„è½¬æ¢ç¼“å­˜ï¼Œä»¥ä¾¿åœ¨ä¸‹ä¸€æ¬¡è®¿é—®æ—¶ä»é¡µè¡¨ä¸­å†æ¬¡åŠ è½½è¯¥é¡µé¢ã€‚å¦å¤–ï¼Œè¿˜å¯ä»¥é€šè¿‡é‡æ–°åŠ è½½&lt;code&gt;CR3&lt;/code&gt;å¯„å­˜å™¨ï¼ˆå³æ¨¡æ‹Ÿä¸€æ¬¡åœ°å€ç©ºé—´åˆ‡æ¢ï¼‰æ¥åˆ·æ–°TLBã€‚&lt;code&gt;x86_64&lt;/code&gt;åŒ…åœ¨&lt;a href=&#34;https://docs.rs/x86_64/0.3.4/x86_64/instructions/tlb/index.html&#34;&gt;&lt;code&gt;tlb&lt;/code&gt;æ¨¡å—&lt;/a&gt;ä¸­å°†è¿™ä¸¤ç§æ–¹æ³•å°è£…æˆäº†ä¸åŒçš„Rustå‡½æ•°ã€‚&lt;/p&gt;

&lt;p&gt;åˆ‡è®°ï¼Œåœ¨æ¯æ¬¡é¡µè¡¨ä¿®æ”¹æ—¶éƒ½è¦åˆ·æ–°TLBï¼Œå¦åˆ™CPUå¯èƒ½ä¼šç»§ç»­ä½¿ç”¨æ—§çš„è½¬æ¢ç¼“å­˜ï¼Œè¿™ä¼šå¯¼è‡´éå¸¸éš¾ä»¥è°ƒè¯•ä¸”åˆä¸ç¡®å®šçš„é”™è¯¯ã€‚&lt;/p&gt;

&lt;h1 id=&#34;å®ç°&#34;&gt;å®ç°&lt;/h1&gt;

&lt;p&gt;æœ‰ä¸€ä»¶äº‹è¿˜æ²¡æœ‰æåˆ°ï¼š&lt;strong&gt;æˆ‘ä»¬çš„å†…æ ¸å·²ç»è¿è¡Œåœ¨åˆ†é¡µä¸Šäº†&lt;/strong&gt;ã€‚æˆ‘ä»¬åœ¨&lt;a href=&#34;https://os.phil-opp.com/minimal-rust-kernel/#creating-a-bootimage&#34;&gt;â€œA minimal Rust Kernelâ€&lt;/a&gt;é‚£ç¯‡æ–‡ç« ä¸­æ·»åŠ çš„å¼•å¯¼ç¨‹åºå·²ç»è®¾ç½®äº†ä¸€ä¸ª4çº§åˆ†é¡µçš„å±‚æ¬¡ç»“æ„ï¼Œå®ƒå°†å†…æ ¸çš„æ¯ä¸ªé¡µé¢éƒ½æ˜ å°„åˆ°ä¸€ä¸ªç‰©ç†å¸§ã€‚è¿™æ ·åšä¸»è¦æ˜¯å› ä¸ºåœ¨x86_64çš„64ä½æ¨¡å¼ä¸‹åˆ†é¡µæ˜¯å¿…éœ€çš„ã€‚&lt;/p&gt;

&lt;p&gt;è¿™æ„å‘³ç€æˆ‘ä»¬åœ¨å†…æ ¸ä¸­ä½¿ç”¨çš„æ¯ä¸ªå†…å­˜åœ°å€éƒ½æ˜¯ä¸€ä¸ªè™šæ‹Ÿåœ°å€ã€‚è®¿é—®åœ°å€ä¸º&lt;code&gt;0xb8000&lt;/code&gt;çš„VGAç¼“å†²åŒºä¼šèµ·ä½œç”¨ï¼Œæ˜¯å› ä¸ºå¼•å¯¼ç¨‹åºå¯¹è¯¥é¡µè¿›è¡Œäº†&lt;em&gt;æ’ç­‰æ˜ å°„&lt;/em&gt; ï¼Œå³è™šæ‹Ÿé¡µ&lt;code&gt;0xb8000&lt;/code&gt;è¢«æ˜ å°„åˆ°ç‰©ç†å¸§&lt;code&gt;0xb8000&lt;/code&gt;ã€‚&lt;/p&gt;

&lt;p&gt;åˆ†é¡µä½¿æˆ‘ä»¬çš„å†…æ ¸å·²ç»ç›¸å¯¹å®‰å…¨ï¼Œå› ä¸ºæ¯ä¸ªè¶…å‡ºè¾¹ç•Œçš„å†…å­˜è®¿é—®éƒ½ä¼šå¯¼è‡´é¡µé”™è¯¯ï¼Œå› æ­¤ä¸ä¼šæœ‰éšæœºçš„ç‰©ç†å†…å­˜å†™å…¥å‘ç”Ÿã€‚å¼•å¯¼ç¨‹åºç”šè‡³ä¸ºæ¯ä¸ªé¡µéƒ½è®¾ç½®äº†æ­£ç¡®çš„è®¿é—®æƒé™ï¼Œè¿™æ„å‘³ç€åªæœ‰åŒ…å«ä»£ç çš„é¡µæ˜¯å¯æ‰§è¡Œçš„ï¼Œä»¥åŠåªæœ‰æ•°æ®é¡µæ˜¯å¯å†™å…¥çš„ã€‚&lt;/p&gt;

&lt;h2 id=&#34;ç¼ºé¡µä¸­æ–­&#34;&gt;ç¼ºé¡µä¸­æ–­&lt;/h2&gt;

&lt;p&gt;è®©æˆ‘ä»¬è¯•ç€é€šè¿‡è®¿é—®å†…æ ¸ä¹‹å¤–çš„ä¸€æ®µå†…å­˜æ¥å¼•èµ·ç¼ºé¡µä¸­æ–­ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªç¼ºé¡µä¸­æ–­å¤„ç†ç¨‹åºå¹¶å°†å…¶æ³¨å†Œåˆ°IDTä¸­ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥å°†å‡ºé”™ä¿¡æ¯æ‰“å°å‡ºæ¥ï¼Œè€Œä¸æ˜¯çœ‹åˆ°ä¸€ä¸ªç¬¼ç»Ÿçš„&lt;a href=&#34;https://os.phil-opp.com/double-fault-exceptions/&#34;&gt;double fault&lt;/a&gt;ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-rust&#34; data-lang=&#34;rust&#34;&gt;&lt;span class=&#34;lnt&#34;&gt; 1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 2
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 3
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 4
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 5
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 6
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 7
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 8
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 9
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;10
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;11
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;12
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;13
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;14
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;15
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;16
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;17
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;18
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;19
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;20
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;21
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;22
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;23
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;24
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;25
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;26
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;27
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;28
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-rust&#34; data-lang=&#34;rust&#34;&gt;&lt;span class=&#34;c1&#34;&gt;// in src/interrupts.rs
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;lazy_static&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;!&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;static&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;ref&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;IDT&lt;/span&gt;: &lt;span class=&#34;nc&#34;&gt;InterruptDescriptorTable&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;let&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;mut&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;idt&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;InterruptDescriptorTable&lt;/span&gt;::&lt;span class=&#34;n&#34;&gt;new&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;();&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;â€¦&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;idt&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;page_fault&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;set_handler_fn&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;page_fault_handler&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// new
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;idt&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;};&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;use&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;x86_64&lt;/span&gt;::&lt;span class=&#34;n&#34;&gt;structures&lt;/span&gt;::&lt;span class=&#34;n&#34;&gt;idt&lt;/span&gt;::&lt;span class=&#34;n&#34;&gt;PageFaultErrorCode&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;extern&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;x86-interrupt&amp;#34;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;fn&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;page_fault_handler&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;stack_frame&lt;/span&gt;: &lt;span class=&#34;kp&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;mut&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ExceptionStackFrame&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;_error_code&lt;/span&gt;: &lt;span class=&#34;nc&#34;&gt;PageFaultErrorCode&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;use&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;crate&lt;/span&gt;::&lt;span class=&#34;n&#34;&gt;hlt_loop&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;use&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;x86_64&lt;/span&gt;::&lt;span class=&#34;n&#34;&gt;registers&lt;/span&gt;::&lt;span class=&#34;n&#34;&gt;control&lt;/span&gt;::&lt;span class=&#34;n&#34;&gt;Cr2&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;println&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;!&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;EXCEPTION: PAGE FAULT&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;println&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;!&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;Accessed Address: {:?}&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Cr2&lt;/span&gt;::&lt;span class=&#34;n&#34;&gt;read&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;());&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;println&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;!&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;{:#?}&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;stack_frame&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;hlt_loop&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;();&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;åœ¨å‘ç”Ÿç¼ºé¡µä¸­æ–­æ—¶ï¼ŒCPUä¼šå°†å¼•èµ·è¯¥é”™è¯¯çš„è™šæ‹Ÿåœ°å€æ”¾ç½®åˆ°&lt;a href=&#34;https://en.wikipedia.org/wiki/Control_register#CR2&#34;&gt;CR2&lt;/a&gt;å¯„å­˜å™¨ä¸­ã€‚æˆ‘ä»¬ä½¿ç”¨x86_64åŒ…çš„&lt;a href=&#34;https://docs.rs/x86_64/0.3.5/x86_64/registers/control/struct.Cr2.html#method.read&#34;&gt;Cr2::read&lt;/a&gt;å‡½æ•°æ¥è¯»å–å¹¶æ‰“å°å®ƒã€‚é€šå¸¸ï¼Œ&lt;a href=&#34;https://docs.rs/x86_64/0.3.4/x86_64/structures/idt/struct.PageFaultErrorCode.html&#34;&gt;PageFaultErrorCode&lt;/a&gt;ä¼šæä¾›è¯¥é”™è¯¯çš„æ›´å¤šä¿¡æ¯ï¼Œä½†ç›®å‰LLVMå­˜åœ¨ä¸€ä¸ªä¼ é€’æ— æ•ˆé”™è¯¯ä»£ç çš„&lt;a href=&#34;https://github.com/rust-lang/rust/issues/57270&#34;&gt;bug&lt;/a&gt;ï¼Œå› æ­¤æˆ‘ä»¬æš‚æ—¶å¿½ç•¥å®ƒã€‚å¦‚æœç¼ºé¡µä¸­æ–­ä¸è¢«è§£å†³ï¼Œæˆ‘ä»¬çš„ä»£ç å°±æ— æ³•ç»§ç»­æ‰§è¡Œï¼Œå› æ­¤æœ€åæˆ‘ä»¬è¿›å…¥äº†ä¸€ä¸ª&lt;a href=&#34;https://os.phil-opp.com/hardware-interrupts/#the&#34;&gt;hlt_loop&lt;/a&gt;çš„å¾ªç¯ã€‚&lt;/p&gt;

&lt;p&gt;ç°åœ¨ï¼Œè®©æˆ‘ä»¬æ¥è®¿é—®å†…æ ¸ä¹‹å¤–çš„ä¸€æ®µå†…å­˜ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-rust&#34; data-lang=&#34;rust&#34;&gt;&lt;span class=&#34;lnt&#34;&gt; 1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 2
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 3
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 4
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 5
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 6
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 7
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 8
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 9
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;10
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;11
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;12
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;13
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;14
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;15
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;16
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;17
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;18
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;19
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;20
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;21
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;22
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;23
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-rust&#34; data-lang=&#34;rust&#34;&gt;&lt;span class=&#34;c1&#34;&gt;// in src/main.rs
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;cp&#34;&gt;#[cfg(not(test))]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;cp&#34;&gt;#[no_mangle]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;pub&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;extern&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;C&amp;#34;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;fn&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;_start&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;-&amp;gt; &lt;span class=&#34;o&#34;&gt;!&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;use&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;blog_os&lt;/span&gt;::&lt;span class=&#34;n&#34;&gt;interrupts&lt;/span&gt;::&lt;span class=&#34;n&#34;&gt;PICS&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;println&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;!&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;Hello World{}&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;!&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// set up the IDT first, otherwise we would enter a boot loop instead of
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// invoking our page fault handler
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;blog_os&lt;/span&gt;::&lt;span class=&#34;n&#34;&gt;gdt&lt;/span&gt;::&lt;span class=&#34;n&#34;&gt;init&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;();&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;blog_os&lt;/span&gt;::&lt;span class=&#34;n&#34;&gt;interrupts&lt;/span&gt;::&lt;span class=&#34;n&#34;&gt;init_idt&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;();&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;unsafe&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;PICS&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;lock&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;().&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;initialize&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;};&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;x86_64&lt;/span&gt;::&lt;span class=&#34;n&#34;&gt;instructions&lt;/span&gt;::&lt;span class=&#34;n&#34;&gt;interrupts&lt;/span&gt;::&lt;span class=&#34;n&#34;&gt;enable&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;();&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// new
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;let&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ptr&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0xdeadbeaf&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;as&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;mut&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;u32&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;unsafe&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ptr&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;42&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;println&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;!&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;It did not crash!&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;blog_os&lt;/span&gt;::&lt;span class=&#34;n&#34;&gt;hlt_loop&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;();&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;è¿è¡Œä¹‹åï¼Œå¯ä»¥çœ‹åˆ°æˆ‘ä»¬çš„ç¼ºé¡µä¸­æ–­å¤„ç†ç¨‹åºè¢«è°ƒç”¨äº†ï¼š&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;//blog.betacat.io/image/introduction-to-paging/qemu-page-fault.png&#34; alt=&#34;qemu-page-fault&#34; /&gt;&lt;/p&gt;

&lt;p&gt;è€Œä¸”&lt;code&gt;CR2&lt;/code&gt;å¯„å­˜å™¨ç¡®å®åŒ…å«æˆ‘ä»¬è¯•å›¾è®¿é—®çš„åœ°å€ï¼š&lt;code&gt;0xdeadbeaf&lt;/code&gt;ã€‚&lt;/p&gt;

&lt;p&gt;æˆ‘ä»¬ä¹Ÿå¯ä»¥çœ‹åˆ°å½“å‰çš„æŒ‡ä»¤æŒ‡é’ˆæ˜¯&lt;code&gt;0x20430a&lt;/code&gt;ï¼Œæ‰€ä»¥æˆ‘ä»¬çŸ¥é“è¿™ä¸ªåœ°å€æŒ‡å‘ä¸€ä¸ªä»£ç é¡µã€‚ä»£ç é¡µç”±å¼•å¯¼åŠ è½½ç¨‹åºä»¥åªè¯»çš„æ–¹å¼æ˜ å°„ï¼Œå› æ­¤è¯¥åœ°å€å…è®¸è¯»æ“ä½œï¼Œè€Œä¸å…è®¸å†™æ“ä½œã€‚è®©æˆ‘ä»¬æŠŠ&lt;code&gt;0xdeadbeaf&lt;/code&gt;æŒ‡é’ˆæ”¹ä¸º&lt;code&gt;0x20430a&lt;/code&gt;æ¥æµ‹è¯•ä¸€ä¸‹ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-rust&#34; data-lang=&#34;rust&#34;&gt;&lt;span class=&#34;lnt&#34;&gt;1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;2
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;3
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;4
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;5
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;6
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;7
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-rust&#34; data-lang=&#34;rust&#34;&gt;&lt;span class=&#34;c1&#34;&gt;// Note: The actual address might be different for you. Use the address that
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// your page fault handler reports.
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;let&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ptr&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0x20430a&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;as&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;mut&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;u32&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// read from a code page -&amp;gt; works
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;unsafe&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;let&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;x&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ptr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// write to a code page -&amp;gt; page fault
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;unsafe&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ptr&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;42&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;å¦‚æœæ³¨é‡Šæ‰æœ€åä¸€è¡Œï¼Œæˆ‘ä»¬çœ‹åˆ°è¯»æ“ä½œæœ‰æ•ˆï¼Œä½†å†™æ“ä½œä¼šå¯¼è‡´é¡µé”™è¯¯ã€‚&lt;/p&gt;

&lt;h2 id=&#34;è®¿é—®é¡µè¡¨&#34;&gt;è®¿é—®é¡µè¡¨&lt;/h2&gt;

&lt;p&gt;è®©æˆ‘ä»¬çœ‹çœ‹å†…æ ¸è¿è¡Œæ—¶çš„é¡µè¡¨ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-rust&#34; data-lang=&#34;rust&#34;&gt;&lt;span class=&#34;lnt&#34;&gt; 1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 2
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 3
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 4
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 5
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 6
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 7
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 8
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 9
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;10
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;11
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;12
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;13
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;14
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;15
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-rust&#34; data-lang=&#34;rust&#34;&gt;&lt;span class=&#34;c1&#34;&gt;// in src/main.rs
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;cp&#34;&gt;#[cfg(not(test))]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;cp&#34;&gt;#[no_mangle]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;pub&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;extern&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;C&amp;#34;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;fn&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;_start&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;-&amp;gt; &lt;span class=&#34;o&#34;&gt;!&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;â€¦&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// initialize GDT, IDT, PICS
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;use&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;x86_64&lt;/span&gt;::&lt;span class=&#34;n&#34;&gt;registers&lt;/span&gt;::&lt;span class=&#34;n&#34;&gt;control&lt;/span&gt;::&lt;span class=&#34;n&#34;&gt;Cr3&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;let&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;level_4_page_table&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Cr3&lt;/span&gt;::&lt;span class=&#34;n&#34;&gt;read&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;();&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;println&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;!&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;Level 4 page table at: {:?}&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;level_4_page_table&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;start_address&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;());&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;println&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;!&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;It did not crash!&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;blog_os&lt;/span&gt;::&lt;span class=&#34;n&#34;&gt;hlt_loop&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;();&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;æˆ‘ä»¬ä½¿ç”¨&lt;code&gt;x86_64&lt;/code&gt;åŒ…çš„&lt;a href=&#34;https://docs.rs/x86_64/0.3.4/x86_64/registers/control/struct.Cr3.html#method.read&#34;&gt;Cr3::read&lt;/a&gt;å‡½æ•°ä»&lt;code&gt;CR3&lt;/code&gt;å¯„å­˜å™¨ä¸­è¯»å–å½“å‰æ´»åŠ¨çš„ç¬¬4çº§é¡µè¡¨ï¼Œè¿™ä¸ªå‡½æ•°çš„è¿”å›å€¼æ˜¯ä¸€ä¸ªäºŒå…ƒç»„ï¼š&lt;a href=&#34;https://docs.rs/x86_64/0.3.4/x86_64/structures/paging/struct.PhysFrame.html&#34;&gt;PhysFrame&lt;/a&gt;å’Œ&lt;a href=&#34;https://docs.rs/x86_64/0.3.4/x86_64/registers/control/struct.Cr3Flags.html&#34;&gt;Cr3Flags&lt;/a&gt;ï¼Œæˆ‘ä»¬åªå…³å¿ƒé¡µå¸§ï¼ˆframeï¼‰ï¼Œæ‰€ä»¥æš‚æ—¶å¿½ç•¥ç¬¬äºŒä¸ªè¿”å›å€¼ã€‚&lt;/p&gt;

&lt;p&gt;è¿è¡Œä¹‹åï¼Œå¯ä»¥çœ‹åˆ°è¿™æ ·çš„è¾“å‡ºï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;span class=&#34;lnt&#34;&gt;1
&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;Level 4 page table at: PhysAddr(0x1000)&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;å¯ä»¥çœ‹åˆ°ï¼Œè¾“å‡ºçš„æ˜¯ä¸€ä¸ª&lt;a href=&#34;https://docs.rs/x86_64/0.3.4/x86_64/struct.PhysAddr.html&#34;&gt;PhysAddr&lt;/a&gt;ç±»å‹ï¼Œå®ƒåŒ…è£…çš„æ˜¯å½“å‰æ´»åŠ¨çš„ç¬¬4çº§é¡µè¡¨çš„&lt;em&gt;ç‰©ç†åœ°å€&lt;/em&gt;&lt;code&gt;0x1000&lt;/code&gt;ï¼Œç°åœ¨çš„é—®é¢˜å°±å˜æˆï¼šæˆ‘ä»¬å¦‚ä½•ä»å†…æ ¸ä¸­è®¿é—®è¯¥é¡µè¡¨ï¼Ÿ&lt;/p&gt;

&lt;p&gt;å½“åˆ†é¡µå¤„äºæ¿€æ´»çŠ¶æ€æ—¶ï¼Œæˆ‘ä»¬ä¸å¯èƒ½ç›´æ¥è®¿é—®ç‰©ç†å†…å­˜ï¼Œå¦åˆ™ä¸€ä¸ªç¨‹åºå°±å¯ä»¥å¾ˆè½»æ˜“åœ°ç»•è¿‡å†…å­˜ä¿æŠ¤æ¥è®¿é—®å¦ä¸€ä¸ªç¨‹åºçš„å†…å­˜ã€‚å› æ­¤ï¼Œè®¿é—®è¯¥è¡¨çš„å”¯ä¸€æ–¹æ³•å°±æ˜¯é€šè¿‡ä¸€ä¸ªè¢«æ˜ å°„åˆ°ç‰©ç†åœ°å€&lt;code&gt;0x1000&lt;/code&gt;çš„è™šæ‹Ÿé¡µã€‚è€Œä¸ºé¡µè¡¨çš„ç‰©ç†å¸§åˆ›å»ºæ˜ å°„æ˜¯ä¸€ä¸ªå¸¸è§çš„é—®é¢˜ï¼Œæ¯”å¦‚å½“å†…æ ¸åœ¨ä¸ºæ–°çº¿ç¨‹åˆ†é…å †æ ˆæ—¶ï¼Œå®ƒå°±éœ€è¦è®¿é—®é¡µè¡¨ã€‚&lt;/p&gt;

&lt;p&gt;ä¸‹ä¸€ç¯‡æ–‡ç« å°†è¯¦ç»†ä»‹ç»æ­¤é—®é¢˜çš„è§£å†³æ–¹æ¡ˆã€‚ç°åœ¨ï¼Œæˆ‘ä»¬åªéœ€è¦çŸ¥é“å¼•å¯¼ç¨‹åºä½¿ç”¨ä¸€ç§å«&lt;em&gt;é€’å½’é¡µè¡¨&lt;/em&gt; çš„æŠ€æœ¯å°†è™šæ‹Ÿåœ°å€ç©ºé—´çš„æœ€åä¸€é¡µæ˜ å°„åˆ°ç¬¬4çº§é¡µè¡¨çš„ç‰©ç†å¸§ã€‚è™šæ‹Ÿåœ°å€ç©ºé—´çš„æœ€åä¸€é¡µæ˜¯&lt;code&gt;0xffff_ffff_ffff_f000&lt;/code&gt;ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡å®ƒæ¥è¯»å–è¯¥è¡¨çš„å†…å®¹ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-rust&#34; data-lang=&#34;rust&#34;&gt;&lt;span class=&#34;lnt&#34;&gt; 1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 2
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 3
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 4
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 5
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 6
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 7
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 8
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 9
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;10
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;11
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;12
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;13
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;14
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;15
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;16
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-rust&#34; data-lang=&#34;rust&#34;&gt;&lt;span class=&#34;c1&#34;&gt;// in src/main.rs
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;cp&#34;&gt;#[cfg(not(test))]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;cp&#34;&gt;#[no_mangle]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;pub&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;extern&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;C&amp;#34;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;fn&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;_start&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;-&amp;gt; &lt;span class=&#34;o&#34;&gt;!&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;â€¦&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// initialize GDT, IDT, PICS
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;let&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;level_4_table_pointer&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0xffff_ffff_ffff_f000&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;as&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;u64&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;for&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;in&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;..&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;10&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;let&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;entry&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;unsafe&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;level_4_table_pointer&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;offset&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;};&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;println&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;!&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;Entry {}: {:#x}&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;entry&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;println&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;!&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;It did not crash!&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;blog_os&lt;/span&gt;::&lt;span class=&#34;n&#34;&gt;hlt_loop&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;();&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;é¦–å…ˆï¼Œæˆ‘ä»¬å°†è¿™ä¸ªåœ°å€å¼ºåˆ¶è½¬æ¢ä¸ºä¸€ä¸ª&lt;code&gt;u64&lt;/code&gt;ç±»å‹çš„æŒ‡é’ˆï¼Œå› ä¸ºæ­£å¦‚&lt;a href=&#34;#é¡µè¡¨ç»“æ„&#34;&gt;ä¸Šä¸€èŠ‚&lt;/a&gt;æ‰€æåˆ°çš„ï¼Œæ¯ä¸ªé¡µè¡¨é¡¹éƒ½æ˜¯8ä¸ªå­—èŠ‚ï¼ˆ64ä½ï¼‰ï¼Œå› æ­¤&lt;code&gt;u64&lt;/code&gt;æ­£å·§å¯ä»¥è£…ä¸‹ä¸€é¡¹ã€‚ç„¶åå†ä½¿ç”¨&lt;code&gt;for&lt;/code&gt;å¾ªç¯æ‰“å°é¡µè¡¨çš„å‰10é¡¹ï¼Œåœ¨å¾ªç¯å†…éƒ¨ï¼Œæˆ‘ä»¬ä½¿ç”¨unsafeå—æ¥è¯»å–åŸå§‹æŒ‡é’ˆï¼Œä½¿ç”¨&lt;a href=&#34;https://doc.rust-lang.org/std/primitive.pointer.html#method.offset&#34;&gt;&lt;code&gt;offset&lt;/code&gt;æ–¹æ³•&lt;/a&gt;æ¥æ‰§è¡ŒæŒ‡é’ˆçš„åç§»è¿ç®—ã€‚&lt;/p&gt;

&lt;p&gt;è¿è¡Œä¹‹åï¼Œæ˜¯è¿™æ ·çš„ç»“æœï¼š&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;//blog.betacat.io/image/introduction-to-paging/qemu-print-p4-entries.png&#34; alt=&#34;qemu-print-p4-entries&#34; /&gt;&lt;/p&gt;

&lt;p&gt;åŒæ ·ï¼Œç”±&lt;a href=&#34;#é¡µè¡¨ç»“æ„&#34;&gt;é¡µè¡¨ç»“æ„&lt;/a&gt;é‚£ä¸€èŠ‚å¯çŸ¥ï¼Œç¬¬0é¡¹çš„&lt;code&gt;0x2023&lt;/code&gt;è¡¨ç¤ºè¯¥é¡¹å­˜åœ¨ã€å¯å†™ã€å·²è¢«CPUè®¿é—®è¿‡ï¼Œå¹¶ä¸”æ˜ å°„åˆ°å¸§&lt;code&gt;0x2000&lt;/code&gt;ã€‚ç¬¬1é¡¹ä¹Ÿæœ‰ç›¸åŒçš„æ ‡å¿—ä½ï¼Œå¹¶ä¸”è¢«æ˜ å°„åˆ°&lt;code&gt;0x6e2000&lt;/code&gt;ï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œå®ƒè¿˜æœ‰ä¸€ä¸ªè¡¨ç¤ºè¯¥é¡µå·²è¢«å†™å…¥çš„&lt;code&gt;dirty&lt;/code&gt;æ ‡å¿—ã€‚ç¬¬2-9é¡¹å…¨ä¸º0ï¼Œè¡¨ç¤ºå®ƒä»¬è¿˜æœªè¢«åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œå› æ­¤è¿™äº›èŒƒå›´å†…çš„è™šæ‹Ÿåœ°å€è¿˜æ²¡æœ‰è¢«æ˜ å°„åˆ°ä»»ä½•ç‰©ç†åœ°å€ä¸Šã€‚&lt;/p&gt;

&lt;p&gt;å½“ç„¶ï¼Œå¦‚æœä¸æƒ³ä½¿ç”¨ä¸å®‰å…¨çš„åŸå§‹æŒ‡é’ˆï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨&lt;code&gt;x86_64&lt;/code&gt;åŒ…æ‰€æä¾›çš„&lt;a href=&#34;https://docs.rs/x86_64/0.3.4/x86_64/structures/paging/struct.PageTable.html&#34;&gt;PageTable&lt;/a&gt;ç±»å‹ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-rust&#34; data-lang=&#34;rust&#34;&gt;&lt;span class=&#34;lnt&#34;&gt; 1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 2
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 3
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 4
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 5
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 6
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 7
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 8
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 9
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;10
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;11
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;12
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;13
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;14
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;15
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;16
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;17
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;18
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-rust&#34; data-lang=&#34;rust&#34;&gt;&lt;span class=&#34;c1&#34;&gt;// in src/main.rs
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;cp&#34;&gt;#[cfg(not(test))]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;cp&#34;&gt;#[no_mangle]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;pub&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;extern&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;C&amp;#34;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;fn&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;_start&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;-&amp;gt; &lt;span class=&#34;o&#34;&gt;!&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;â€¦&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// initialize GDT, IDT, PICS
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;use&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;x86_64&lt;/span&gt;::&lt;span class=&#34;n&#34;&gt;structures&lt;/span&gt;::&lt;span class=&#34;n&#34;&gt;paging&lt;/span&gt;::&lt;span class=&#34;n&#34;&gt;PageTable&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;let&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;level_4_table_ptr&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mh&#34;&gt;0xffff_ffff_ffff_f000&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;as&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;const&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;PageTable&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;let&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;level_4_table&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;unsafe&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;*&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;level_4_table_ptr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;};&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;for&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;in&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;..&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;10&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;println&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;!&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;Entry {}: {:?}&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;level_4_table&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]);&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;println&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;!&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;It did not crash!&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;blog_os&lt;/span&gt;::&lt;span class=&#34;n&#34;&gt;hlt_loop&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;();&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;æˆ‘ä»¬å…ˆå°†&lt;code&gt;0xffff_ffff_ffff_f000&lt;/code&gt;è½¬æ¢ä¸ºä¸€ä¸ªåŸå§‹æŒ‡é’ˆï¼Œç„¶åå†æŠŠå®ƒå˜ä¸ºä¸€ä¸ªRustçš„å¼•ç”¨ï¼Œè¿™ä¸ªæ“ä½œä»ç„¶éœ€è¦åœ¨&lt;code&gt;unsafe&lt;/code&gt;å—ä¸­è¿›è¡Œï¼Œå› ä¸ºç¼–è¯‘å™¨å¹¶ä¸çŸ¥é“èƒ½ä¸èƒ½è®¿é—®è¯¥åœ°å€ã€‚åœ¨è½¬æ¢å®Œæˆä¹‹åï¼Œæˆ‘ä»¬å°±æœ‰äº†ä¸€ä¸ªå®‰å…¨çš„&lt;code&gt;&amp;amp;PageTable&lt;/code&gt;ç±»å‹ï¼Œå®ƒèƒ½è®©æˆ‘ä»¬ä½¿ç”¨&lt;a href=&#34;https://doc.rust-lang.org/core/ops/trait.Index.html&#34;&gt;æ•°ç»„ç´¢å¼•&lt;/a&gt;çš„æ–¹å¼æ¥è®¿é—®å„ä¸ªé¡µè¡¨é¡¹ã€‚&lt;/p&gt;

&lt;p&gt;è¯¥ç±»å‹è¿˜ä¸ºæ¯ä¸ªé¡µè¡¨é¡¹çš„å±æ€§æä¾›äº†æè¿°ä¿¡æ¯ï¼Œå› æ­¤åœ¨æ‰“å°çš„æ—¶å€™æˆ‘ä»¬å°±å¯ä»¥ç›´è§‚çš„çœ‹åˆ°ï¼Œå“ªäº›æ ‡å¿—ä½è¢«è®¾ç½®äº†ï¼š&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;//blog.betacat.io/image/introduction-to-paging/qemu-print-p4-entries-abstraction.png&#34; alt=&#34;qemu-print-p4-entries-abstraction&#34; /&gt;&lt;/p&gt;

&lt;p&gt;ä¸‹ä¸€æ­¥å°±æ˜¯é¡ºç€ç¬¬0æˆ–è€…1ä¸ªé¡µè¡¨é¡¹çš„æŒ‡é’ˆè¿½è¸ªåˆ°ç¬¬3çº§é¡µè¡¨ã€‚ä½†åŒæ ·çš„é—®é¢˜ï¼Œè¿™é‡Œçš„&lt;code&gt;0x2000&lt;/code&gt;å’Œ&lt;code&gt;0x6e5000&lt;/code&gt;éƒ½æ˜¯ç‰©ç†åœ°å€ï¼Œæˆ‘ä»¬ä¸èƒ½ç›´æ¥è®¿é—®å®ƒä»¬ã€‚è¿™ä¸ªé—®é¢˜å°†åœ¨ä¸‹ä¸€ç¯‡æ–‡ç« ä¸­è§£å†³ã€‚&lt;/p&gt;

&lt;h1 id=&#34;æ€»ç»“&#34;&gt;æ€»ç»“&lt;/h1&gt;

&lt;p&gt;æœ¬æ–‡ä»‹ç»äº†ä¸¤ç§å†…å­˜ä¿æŠ¤æŠ€æœ¯ï¼šåˆ†æ®µå’Œåˆ†é¡µã€‚å‰è€…ä½¿ç”¨çš„æ˜¯å¯å˜å¤§å°çš„å†…å­˜åŒºåŸŸï¼Œä½†ä¼šå¼•å‘å¤–éƒ¨ç¢ç‰‡ï¼›åè€…ä½¿ç”¨çš„æ˜¯å›ºå®šå¤§å°çš„é¡µé¢ï¼Œå¹¶æ”¯æŒæ›´ç»†ç²’åº¦çš„è®¿é—®æƒé™æ§åˆ¶ã€‚&lt;/p&gt;

&lt;p&gt;åˆ†é¡µæŠ€æœ¯å°†é¡µçš„æ˜ å°„ä¿¡æ¯å­˜åœ¨é¡µè¡¨å½“ä¸­ï¼Œé¡µè¡¨ä¹‹é—´å¯ä»¥ç»„ç»‡å‡ºæ”¯æŒå¤šä¸ªçº§åˆ«çš„å±‚æ¬¡ç»“æ„ã€‚x86_64æ¶æ„ä½¿ç”¨çš„æ˜¯4çº§é¡µè¡¨å’Œ4KiBé¡µå¤§å°ã€‚ç¡¬ä»¶ä¼šè‡ªåŠ¨éå†é¡µè¡¨ï¼Œå¹¶åœ¨TLBä¸­ç¼“å­˜è½¬æ¢ç»“æœã€‚è¯¥ç¼“å­˜åŒºä¸ä¼šè‡ªåŠ¨æ›´æ–°ï¼Œå› æ­¤éœ€è¦åœ¨æ¯æ¬¡é¡µè¡¨æœ‰å˜åŒ–çš„æ—¶å€™æ‰‹åŠ¨åˆ·æ–°ã€‚&lt;/p&gt;

&lt;p&gt;æˆ‘ä»¬äº†è§£åˆ°å†…æ ¸å·²ç»è¿è¡Œåœ¨åˆ†é¡µæŠ€æœ¯ä¸Šï¼Œå¹¶ä¸”éæ³•çš„å†…å­˜è®¿é—®ä¼šå¯¼è‡´é¡µé”™è¯¯ã€‚æˆ‘ä»¬è¿˜å°è¯•è®¿é—®å½“å‰æ´»åŠ¨çš„é¡µè¡¨ï¼Œä½†åªèƒ½è®¿é—®åˆ°ç¬¬4çº§é¡µè¡¨ï¼Œå› ä¸ºé¡µè¡¨ä¸­å­˜å‚¨çš„æ˜¯ç‰©ç†åœ°å€ï¼Œè€Œæˆ‘ä»¬ä¸èƒ½ä»å†…æ ¸ä¸­ç›´æ¥è®¿é—®ç‰©ç†åœ°å€ã€‚&lt;/p&gt;

&lt;h1 id=&#34;ä¸‹ä¸€æ­¥&#34;&gt;ä¸‹ä¸€æ­¥ï¼Ÿ&lt;/h1&gt;

&lt;p&gt;ä¸‹ä¸€ç¯‡æ–‡ç« å°†åœ¨è¿™ç¯‡æ–‡ç« çš„åŸºç¡€ä¸Šæ›´æ·±å…¥ä¸€æ­¥ï¼Œä»‹ç»ä¸€ç§å«&lt;em&gt;é€’å½’é¡µè¡¨&lt;/em&gt; çš„æŠ€æœ¯ï¼Œç”¨æ¥è§£å†³æˆ‘ä»¬åˆšæ‰é‡åˆ°çš„å†…æ ¸ä»£ç ä¸èƒ½ç›´æ¥è®¿é—®é¡µè¡¨çš„é—®é¢˜ã€‚è¿™ä¸ªæŠ€æœ¯å…è®¸æˆ‘ä»¬éå†æ•´ä¸ªé¡µè¡¨çš„å±‚æ¬¡ç»“æ„ï¼Œå¹¶ä¸”ç”¨è½¯ä»¶å®ç°åœ°å€è½¬æ¢åŠŸèƒ½ã€‚åŒæ—¶ï¼Œæˆ‘ä»¬è¿˜å°†ä»‹ç»æ€æ ·åœ¨å·²æœ‰çš„é¡µè¡¨ä¸­æ·»åŠ ä¸€ä¸ªæ–°çš„æ˜ å°„å…³ç³»ã€‚&lt;/p&gt;
</description>
      
    </item>
    
    <item>
      <title>MVCC åœ¨ etcd ä¸­çš„å®ç°</title>
      <link>//blog.betacat.io/post/mvcc-implementation-in-etcd/</link>
      <pubDate>Mon, 24 Dec 2018 18:26:52 +0800</pubDate>
      
      <guid>//blog.betacat.io/post/mvcc-implementation-in-etcd/</guid>
      
        <description>

&lt;h2 id=&#34;ç®€ä»‹&#34;&gt;ç®€ä»‹&lt;/h2&gt;

&lt;p&gt;åœ¨æ•°æ®åº“é¢†åŸŸï¼Œé¢å¯¹é«˜å¹¶å‘ç¯å¢ƒä¸‹æ•°æ®å†²çªçš„é—®é¢˜ï¼Œä¸šç•Œå¸¸ç”¨çš„è§£å†³æ–¹æ¡ˆæœ‰ä¸¤ç§ï¼š&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;&lt;p&gt;æƒ³åŠæ³•é¿å…å†²çªã€‚ä½¿ç”¨&lt;strong&gt;æ‚²è§‚é”&lt;/strong&gt;æ¥ç¡®ä¿åŒä¸€æ—¶åˆ»åªæœ‰ä¸€äººèƒ½å¯¹æ•°æ®è¿›è¡Œæ›´æ”¹ï¼Œå¸¸è§çš„å®ç°æœ‰è¯»å†™é”ï¼ˆRead/Write Locksï¼‰ã€ä¸¤é˜¶æ®µé”ï¼ˆTwo-Phase Lockingï¼‰ç­‰ã€‚&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;å…è®¸å†²çªï¼Œä½†å‘ç”Ÿå†²çªçš„æ—¶å€™ï¼Œè¦æœ‰èƒ½åŠ›æ£€æµ‹åˆ°ã€‚è¿™ç§æ–¹æ³•è¢«ç§°ä¸º&lt;strong&gt;ä¹è§‚é”&lt;/strong&gt;ï¼Œå³å…ˆä¹è§‚çš„è®¤ä¸ºå†²çªä¸ä¼šå‘ç”Ÿï¼Œé™¤éè¢«è¯æ˜ï¼ˆæ£€æµ‹åˆ°ï¼‰å½“å‰ç¡®å®äº§ç”Ÿå†²çªäº†ã€‚å¸¸è§çš„å®ç°æœ‰é€»è¾‘æ—¶é’Ÿï¼ˆLogical Clockï¼‰ã€&lt;a href=&#34;https://en.wikipedia.org/wiki/Multiversion_concurrency_control&#34;&gt;MVCC&lt;/a&gt;ï¼ˆMulti-version Cocurrent Controlï¼‰ç­‰ã€‚&lt;/p&gt;&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;åœ¨è¿™äº›è§£å†³æ–¹æ¡ˆä¸­ï¼ŒMVCC ç”±äºå…¶å‡ºè‰²çš„æ€§èƒ½ä¼˜åŠ¿ï¼Œè€Œè¢«è¶Šæ¥è¶Šå¤šçš„æ•°æ®åº“æ‰€é‡‡ç”¨ï¼Œæ¯”å¦‚Oracleã€PostgreSQLã€MySQL InnoDBã€etcd ç­‰ã€‚å®ƒçš„åŸºæœ¬æ€æƒ³æ˜¯ä¿å­˜ä¸€ä¸ªæ•°æ®çš„å¤šä¸ªå†å²ç‰ˆæœ¬ï¼Œä»è€Œè§£å†³äº‹åŠ¡ç®¡ç†ä¸­æ•°æ®éš”ç¦»çš„é—®é¢˜ã€‚&lt;/p&gt;

&lt;p&gt;è¿™é‡Œçš„ç‰ˆæœ¬ä¸€èˆ¬é€‰æ‹©ä½¿ç”¨æ—¶é—´æˆ³æˆ–äº‹åŠ¡ ID æ¥æ ‡è¯†ã€‚åœ¨å¤„ç†ä¸€ä¸ªå†™è¯·æ±‚æ—¶ï¼ŒMVCC ä¸æ˜¯ç®€å•çš„ç”¨æ–°å€¼è¦†ç›–æ—§å€¼ï¼Œè€Œæ˜¯ä¸ºè¿™ä¸€é¡¹æ·»åŠ ä¸€ä¸ªæ–°ç‰ˆæœ¬çš„æ•°æ®ã€‚åœ¨è¯»å–ä¸€ä¸ªæ•°æ®é¡¹æ—¶ï¼Œè¦å…ˆç¡®å®šä¸€ä¸ªè¦è¯»å–çš„ç‰ˆæœ¬ï¼Œç„¶åæ ¹æ®ç‰ˆæœ¬æ‰¾åˆ°å¯¹åº”çš„æ•°æ®ã€‚è¿™ç§å†™æ“ä½œåˆ›å»ºæ–°ç‰ˆæœ¬ï¼Œè¯»æ“ä½œè®¿é—®æ—§ç‰ˆæœ¬çš„æ–¹å¼ä½¿å¾—è¯»å†™æ“ä½œå½¼æ­¤éš”ç¦»ï¼Œä»–ä»¬ä¹‹é—´å°±ä¸éœ€è¦ç”¨é”æ¥åè°ƒã€‚æ¢å¥è¯è¯´ï¼Œåœ¨ MVCC é‡Œè¯»æ“ä½œæ°¸è¿œä¸ä¼šè¢«é˜»å¡ï¼Œå› æ­¤å®ƒç‰¹åˆ«é€‚åˆ etcd è¿™ç§è¯»æ“ä½œæ¯”è¾ƒå¤šçš„åœºæ™¯ã€‚&lt;/p&gt;

&lt;p&gt;MVCC çš„åŸºæœ¬åŸç†å°±æ˜¯è¿™ä¹ˆç®€å•ï¼Œä¸‹é¢æ¥ç»“åˆå…·ä½“ä»£ç ï¼Œçœ‹çœ‹ etcd æ˜¯æ€ä¹ˆå®ç°çš„ã€‚è·Ÿ&lt;a href=&#34;//blog.betacat.io/post/raft-implementation-in-etcd/&#34;&gt;ä¸Šç¯‡&lt;/a&gt;ä¸€æ ·ï¼Œè¿™é‡Œçš„åˆ†æä»ä»¥etcd &lt;a href=&#34;https://github.com/etcd-io/etcd/tree/v3.3.10&#34;&gt;v3.3.10&lt;/a&gt; ä¸ºä¾‹ã€‚&lt;/p&gt;

&lt;h2 id=&#34;æ•°æ®ç»“æ„&#34;&gt;æ•°æ®ç»“æ„&lt;/h2&gt;

&lt;p&gt;etcd çš„ä»£ç ä¸­ï¼Œæœ‰å…³ MVCC çš„å®ç°éƒ½åœ¨ä¸€ä¸ªå« &lt;a href=&#34;https://github.com/etcd-io/etcd/tree/v3.3.10/mvcc&#34;&gt;mvcc&lt;/a&gt; çš„åŒ…é‡Œã€‚åœ¨æ­£å¼ä»‹ç»è¯»å†™æµç¨‹ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥äº†è§£ä¸‹è¿™ä¸ªåŒ…é‡Œé¢å®šä¹‰çš„å‡ ä¸ªåŸºç¡€æ•°æ®ç»“æ„ã€‚&lt;/p&gt;

&lt;h3 id=&#34;revision&#34;&gt;revision&lt;/h3&gt;

&lt;p&gt;&lt;a href=&#34;https://github.com/etcd-io/etcd/blob/v3.3.10/mvcc/revision.go&#34;&gt;revision&lt;/a&gt; å³å¯¹åº”åˆ°MVCCä¸­çš„ç‰ˆæœ¬ï¼Œetcd ä¸­çš„æ¯ä¸€æ¬¡&lt;code&gt;key-value&lt;/code&gt;çš„æ“ä½œéƒ½ä¼šæœ‰ä¸€ä¸ªç›¸åº”çš„ &lt;code&gt;revision&lt;/code&gt;ã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;lnt&#34;&gt; 1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 2
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 3
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 4
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 5
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 6
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 7
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 8
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 9
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;10
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;11
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;c1&#34;&gt;// A revision indicates modification of the key-value space.
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// The set of changes that share same main revision changes the key-value space atomically.
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;type&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;revision&lt;/span&gt; &lt;span class=&#34;kd&#34;&gt;struct&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
    &lt;span class=&#34;c1&#34;&gt;// main is the main revision of a set of changes that happen atomically.
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;    &lt;span class=&#34;nx&#34;&gt;main&lt;/span&gt; &lt;span class=&#34;kt&#34;&gt;int64&lt;/span&gt;

    &lt;span class=&#34;c1&#34;&gt;// sub is the the sub revision of a change in a set of changes that happen
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;    &lt;span class=&#34;c1&#34;&gt;// atomically. Each change has different increasing sub revision in that
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;    &lt;span class=&#34;c1&#34;&gt;// set.
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;    &lt;span class=&#34;nx&#34;&gt;sub&lt;/span&gt; &lt;span class=&#34;kt&#34;&gt;int64&lt;/span&gt;
&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;è¿™é‡Œçš„ main å±æ€§å¯¹åº”äº‹åŠ¡ IDï¼Œå…¨å±€é€’å¢ä¸é‡å¤ï¼Œå®ƒåœ¨ etcd ä¸­è¢«å½“åšä¸€ä¸ªé€»è¾‘æ—¶é’Ÿæ¥ä½¿ç”¨ã€‚sub ä»£è¡¨ä¸€æ¬¡äº‹åŠ¡ä¸­ä¸åŒçš„ä¿®æ”¹æ“ä½œï¼ˆå¦‚putå’Œdeleteï¼‰ç¼–å·ï¼Œä»0å¼€å§‹ä¾æ¬¡é€’å¢ã€‚æ‰€ä»¥åœ¨ä¸€æ¬¡äº‹åŠ¡ä¸­ï¼Œæ¯ä¸€ä¸ªä¿®æ”¹æ“ä½œæ‰€ç»‘å®šçš„&lt;code&gt;revision&lt;/code&gt;ä¾æ¬¡ä¸º&lt;code&gt;{txID, 0}&lt;/code&gt;, &lt;code&gt;{txID, 1}&lt;/code&gt;, &lt;code&gt;{txID, 2}&lt;/code&gt;&amp;hellip;&lt;/p&gt;

&lt;h3 id=&#34;keyindex&#34;&gt;keyIndex&lt;/h3&gt;

&lt;p&gt;&lt;a href=&#34;https://github.com/etcd-io/etcd/blob/v3.3.10/mvcc/key_index.go&#34;&gt;keyIndex&lt;/a&gt;ç”¨æ¥è®°å½•ä¸€ä¸ªkeyçš„ç”Ÿå‘½å‘¨æœŸä¸­æ‰€æ¶‰åŠè¿‡çš„ç‰ˆæœ¬ï¼ˆrevisionï¼‰ã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;lnt&#34;&gt;1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;2
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;3
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;4
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;5
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;kd&#34;&gt;type&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;keyIndex&lt;/span&gt; &lt;span class=&#34;kd&#34;&gt;struct&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
    &lt;span class=&#34;nx&#34;&gt;key&lt;/span&gt;         &lt;span class=&#34;p&#34;&gt;[]&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;byte&lt;/span&gt;
    &lt;span class=&#34;nx&#34;&gt;modified&lt;/span&gt;    &lt;span class=&#34;nx&#34;&gt;revision&lt;/span&gt; &lt;span class=&#34;c1&#34;&gt;// the main rev of the last modification
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;    &lt;span class=&#34;nx&#34;&gt;generations&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;[]&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;generation&lt;/span&gt;
&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;å®ƒä¿å­˜çš„æ˜¯å½“å‰&lt;code&gt;key&lt;/code&gt;çš„å…·ä½“å€¼ï¼ˆkeyï¼‰ï¼Œæœ€è¿‘ä¸€æ¬¡ä¿®æ”¹çš„ç‰ˆæœ¬å·ï¼ˆmodifiedï¼‰ï¼Œä»¥åŠè®°å½•&lt;code&gt;key&lt;/code&gt;ç”Ÿå‘½å‘¨æœŸçš„&lt;code&gt;generation&lt;/code&gt;ï¼Œä¸€ä¸ª&lt;code&gt;generation&lt;/code&gt;ä»£è¡¨äº†ä¸€ä¸ª&lt;code&gt;key&lt;/code&gt;ä»åˆ›å»ºåˆ°è¢«åˆ é™¤çš„è¿‡ç¨‹ã€‚å› ä¸ºä¸€ä¸ª&lt;code&gt;key&lt;/code&gt;å¯èƒ½ä¼šç»å†åˆ›å»º -&amp;gt; åˆ é™¤ -&amp;gt; åˆ›å»ºçš„å¥½å‡ ä¸ªè½®å›ï¼Œæ‰€ä»¥å®ƒæœ‰å¯èƒ½ä¼šæœ‰ä¸€ä¸ªæˆ–å¤šä¸ª&lt;code&gt;generation&lt;/code&gt;ã€‚ä¸‹é¢æ¥çœ‹çœ‹ä¸€ä¸ª&lt;code&gt;generation&lt;/code&gt;åŒ…å«å“ªäº›å†…å®¹ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;lnt&#34;&gt;1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;2
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;3
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;4
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;5
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;6
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;c1&#34;&gt;// generation contains multiple revisions of a key.
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;type&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;generation&lt;/span&gt; &lt;span class=&#34;kd&#34;&gt;struct&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
    &lt;span class=&#34;nx&#34;&gt;ver&lt;/span&gt;     &lt;span class=&#34;kt&#34;&gt;int64&lt;/span&gt;
    &lt;span class=&#34;nx&#34;&gt;created&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;revision&lt;/span&gt; &lt;span class=&#34;c1&#34;&gt;// when the generation is created (put in first revision).
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;    &lt;span class=&#34;nx&#34;&gt;revs&lt;/span&gt;    &lt;span class=&#34;p&#34;&gt;[]&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;revision&lt;/span&gt;
&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;å¯ä»¥çœ‹åˆ°ï¼Œä¸€ä¸ª&lt;code&gt;generation&lt;/code&gt;ä¸­æœ€é‡è¦çš„ä¿¡æ¯å°±æ˜¯é‚£ä¸ª&lt;code&gt;revision&lt;/code&gt;æ•°ç»„ï¼Œä»£è¡¨åœ¨å®ƒè¿™ä¸€ä»£ä¸­ï¼Œæ‰€ç»å†è¿‡çš„ç‰ˆæœ¬å˜æ›´ã€‚&lt;/p&gt;

&lt;p&gt;ä¸çŸ¥æ‰€äº‘ï¼Ÿæ²¡å…³ç³»ï¼Œæˆ‘åˆšå¼€å§‹çœ‹è¿™æ®µä»£ç çš„æ—¶å€™ä¹Ÿæ˜¯ä¸€è„¸æ‡µé€¼ï¼Œä¸æ˜ç™½ä¸ºå•¥è¦è¿™æ ·å±‚å±‚åŒ…è£…ã€‚ä¸è¿‡è¿˜å¥½æˆ‘ä»¬æœ‰&lt;a href=&#34;https://github.com/etcd-io/etcd/blob/v3.3.10/mvcc/key_index_test.go&#34;&gt;UT&lt;/a&gt;ï¼Œè·Ÿç€UTé‡Œé¢çš„æµ‹è¯•æ ·ä¾‹å¤§æ¦‚æ¢³ç†å‡ºè¿™æ ·çš„é€»è¾‘ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªå€¼ä¸º&lt;code&gt;foo&lt;/code&gt;çš„key&lt;/li&gt;
&lt;/ul&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;lnt&#34;&gt;1
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;nx&#34;&gt;ki&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;keyIndex&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;key&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;[]&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;byte&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;foo&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;ul&gt;
&lt;li&gt;ä¸ºå®ƒè®°å½•ä¸¤æ¬¡ç‰ˆæœ¬å˜æ›´&lt;/li&gt;
&lt;/ul&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;lnt&#34;&gt;1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;2
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;nx&#34;&gt;ki&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;put&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;zap&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;NewExample&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(),&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;2&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;c1&#34;&gt;// ç¬¬ä¸€æ¬¡å˜æ›´å‘ç”Ÿåœ¨IDä¸º2çš„äº‹åŠ¡ä¸­ï¼Œä¸”æ˜¯ç¬¬ä¸€æ¬¡æ“ä½œ
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;ki&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;put&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;zap&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;NewExample&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(),&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;4&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;2&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;//&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;ç¬¬äºŒæ¬¡å˜æ›´å‘ç”Ÿåœ¨IDä¸º4çš„äº‹åŠ¡ä¸­&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;ï¼Œ&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;ä¸”æ˜¯ç¬¬ä¸‰æ¬¡æ“ä½œ&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;ul&gt;
&lt;li&gt;é‚£è¿™ä¸ª&lt;code&gt;keyIndex&lt;/code&gt;å˜æˆè¿™æ ·çš„ç»“æ„&lt;/li&gt;
&lt;/ul&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-yaml&#34; data-lang=&#34;yaml&#34;&gt;&lt;span class=&#34;lnt&#34;&gt;1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;2
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;3
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;4
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-yaml&#34; data-lang=&#34;yaml&#34;&gt;key&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;foo&amp;#34;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;modified&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;{&lt;span class=&#34;m&#34;&gt;4&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;m&#34;&gt;2&lt;/span&gt;}&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;generations&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;{&lt;span class=&#34;m&#34;&gt;2&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;m&#34;&gt;0&lt;/span&gt;}&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;{&lt;span class=&#34;m&#34;&gt;4&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;m&#34;&gt;2&lt;/span&gt;}&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;ul&gt;
&lt;li&gt;å¦‚æœåœ¨æ­¤åçš„äº‹åŠ¡ä¸­è¿™ä¸ªkeyç»å†äº†è¢«åˆ é™¤ï¼Œå†åˆ›å»ºçš„è¿‡ç¨‹ï¼š&lt;/li&gt;
&lt;/ul&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;lnt&#34;&gt;1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;2
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;3
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;nx&#34;&gt;ki&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;tombstone&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;zap&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;NewExample&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(),&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;6&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;  &lt;span class=&#34;c1&#34;&gt;// åœ¨ç¬¬6æ¬¡äº‹åŠ¡ä¸­è¢«åˆ é™¤
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;ki&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;put&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;zap&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;NewExample&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(),&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;8&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;span class=&#34;nx&#34;&gt;ki&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;put&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;zap&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;NewExample&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(),&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;10&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;ul&gt;
&lt;li&gt;é‚£å®ƒä¼šå¤šä¸€ä¸ª&lt;code&gt;generation&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-yaml&#34; data-lang=&#34;yaml&#34;&gt;&lt;span class=&#34;lnt&#34;&gt;1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;2
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;3
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;4
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;5
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-yaml&#34; data-lang=&#34;yaml&#34;&gt;key&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;foo&amp;#34;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;modified&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;{&lt;span class=&#34;m&#34;&gt;10&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;m&#34;&gt;0&lt;/span&gt;}&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;generations&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;{&lt;span class=&#34;m&#34;&gt;2&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;m&#34;&gt;0&lt;/span&gt;}&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;{&lt;span class=&#34;m&#34;&gt;4&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;m&#34;&gt;2&lt;/span&gt;}&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;{&lt;span class=&#34;m&#34;&gt;6&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;m&#34;&gt;0&lt;/span&gt;}(t)&lt;span class=&#34;p&#34;&gt;],&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;{&lt;span class=&#34;m&#34;&gt;8&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;m&#34;&gt;0&lt;/span&gt;}&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;{&lt;span class=&#34;m&#34;&gt;10&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;m&#34;&gt;0&lt;/span&gt;}&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;å¥½äº†ï¼Œåœ¨çŸ¥é“äº†keyçš„ç‰ˆæœ¬ä¿¡æ¯åŠç›¸åº”çš„æ“ä½œåï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹æ€ä¹ˆæŠŠå®ƒä»¬ç»„ç»‡èµ·æ¥ï¼š&lt;/p&gt;

&lt;h3 id=&#34;treeindex&#34;&gt;treeIndex&lt;/h3&gt;

&lt;p&gt;&lt;a href=&#34;https://github.com/etcd-io/etcd/blob/v3.3.10/mvcc/index.go&#34;&gt;treeIndex&lt;/a&gt;é¡¾åæ€ä¹‰å°±æ˜¯ä¸€ä¸ªæ ‘çŠ¶ç´¢å¼•ï¼Œå®ƒé€šè¿‡åœ¨å†…å­˜ä¸­ç»´æŠ¤ä¸€ä¸ª&lt;a href=&#34;https://github.com/google/btree&#34;&gt;BTree&lt;/a&gt;ï¼Œæ¥è¾¾åˆ°åŠ é€ŸæŸ¥è¯¢keyçš„åŠŸèƒ½ï¼ˆä¸æ˜ç™½ä¸ºå•¥è¿™é‡Œé€‰ç”¨äº†BTreeï¼ŒBTreeä¼¼ä¹æ›´é€‚åˆç£ç›˜çš„åœºæ™¯ï¼Œå†…å­˜ä¸­çš„æ ‘ä¸€èˆ¬ä¸éƒ½ä½¿ç”¨çº¢é»‘æ ‘ç­‰æ¥å®ç°ä¹ˆï¼Ÿï¼‰ã€‚&lt;/p&gt;

&lt;p&gt;è¿™æ£µæ ‘çš„æ¯ä¸€ä¸ªèŠ‚ç‚¹éƒ½æ˜¯&lt;code&gt;keyIndex&lt;/code&gt;ã€‚è¿™æ ·ï¼Œç»™å®šä¸€ä¸ªkeyå°±èƒ½å¾ˆå¿«æŸ¥åˆ°å®ƒå¯¹åº”çš„&lt;code&gt;keyIndex&lt;/code&gt;ï¼Œè¿›è€Œå¯ä»¥å¾—çŸ¥å®ƒçš„ç‰ˆæœ¬ä¿¡æ¯ã€‚æ ‘çŠ¶ç»“æ„æ¯”è¾ƒç®€å•ï¼Œçœ‹çœ‹å›¾å°±èƒ½æ˜ç™½ï¼Œæˆ‘å°±ä¸å†åˆ†æäº†ã€‚&lt;/p&gt;



&lt;div class=&#34;box&#34;&gt;
&lt;figure  itemprop=&#34;associatedMedia&#34;
  itemscope itemtype=&#34;http://schema.org/ImageObject&#34; &gt;
    &lt;div class=&#34;img&#34;&gt;
      &lt;img itemprop=&#34;thumbnail&#34; src=&#34;//blog.betacat.io/image/mvcc-in-etcd/treeIndex.svg&#34; alt=&#34;treeIndexç»“æ„&#34;/&gt;
    &lt;/div&gt;
    &lt;a href=&#34;//blog.betacat.io/image/mvcc-in-etcd/treeIndex.svg&#34; itemprop=&#34;contentUrl&#34;&gt;&lt;/a&gt;
      &lt;figcaption&gt;
          &lt;p&gt;treeIndexç»“æ„&lt;/p&gt;
      &lt;/figcaption&gt;
  &lt;/figure&gt;
&lt;/div&gt;


&lt;p&gt;å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œåªå­˜æœ‰keyçš„ä¿¡æ¯ï¼Œvalueä¿å­˜åœ¨ç£ç›˜é‡Œï¼Œä¸€æ–¹é¢keyä¸€èˆ¬æ¯”è¾ƒå°ï¼ŒåŒæ ·çš„å†…å­˜å¯ä»¥æ”¯æŒå­˜å‚¨æ›´å¤šçš„keyï¼›å¦ä¸€æ–¹é¢ï¼Œvalueå’Œç‰ˆæœ¬æ˜¯ä¸€ä¸€å¯¹åº”çš„ï¼Œå†…å­˜ä¸­ç»´æŠ¤äº†ç‰ˆæœ¬çš„ä¿¡æ¯ï¼Œä¹Ÿå°±æ²¡å¿…è¦å†å¤šå­˜ä¸€ä»½valueäº†ã€‚&lt;/p&gt;

&lt;p&gt;çœ‹å®Œäº†keyä»¥åŠkeyåœ¨å†…å­˜ä¸­çš„ç»„ç»‡ç»“æ„ï¼Œæˆ‘ä»¬å†æ¥çœ‹çœ‹valueæ˜¯æ€ä¹ˆå¤„ç†çš„ã€‚&lt;/p&gt;

&lt;h3 id=&#34;backend&#34;&gt;backend&lt;/h3&gt;

&lt;p&gt;backendå°è£…äº†etcdä¸­çš„å­˜å‚¨ï¼ŒæŒ‰ç…§è®¾è®¡ï¼Œbackendå¯ä»¥å¯¹æ¥å¤šç§å­˜å‚¨ï¼Œå½“å‰ä½¿ç”¨çš„æ˜¯&lt;a href=&#34;https://github.com/etcd-io/bbolt&#34;&gt;boltdb&lt;/a&gt;ï¼Œä½†ä½œä¸ºä¸€ä¸ªCNCFé¡¹ç›®ï¼Œå®˜æ–¹ä¹Ÿåœ¨è€ƒè™‘æ¥å…¥æ›´å¤šçš„å­˜å‚¨å¼•æ“&lt;sup class=&#34;footnote-ref&#34; id=&#34;fnref:pluggable-backend&#34;&gt;&lt;a href=&#34;#fn:pluggable-backend&#34;&gt;1&lt;/a&gt;&lt;/sup&gt;ã€‚boltdbæ˜¯ä¸€ä¸ªå•æœºçš„æ”¯æŒäº‹åŠ¡çš„KVå­˜å‚¨ï¼Œetcdçš„äº‹åŠ¡æ˜¯åŸºäºboltdbçš„äº‹åŠ¡å®ç°çš„ã€‚&lt;/p&gt;

&lt;p&gt;etcdåœ¨boltdbä¸­å­˜å‚¨çš„keyæ˜¯&lt;code&gt;reversion&lt;/code&gt;ï¼Œvalueæ˜¯etcdè‡ªå·±çš„&lt;code&gt;key-value&lt;/code&gt;ç»„åˆã€‚å› æ­¤ï¼Œæ¯æ¬¡æ›´æ–°æ—¶ï¼Œæ–°çš„&lt;code&gt;reversion&lt;/code&gt;ä¼šè¢«è®°åœ¨&lt;code&gt;keyIndex&lt;/code&gt;ä¸­ï¼ŒåŒæ—¶ï¼Œè¿™ä¸ª&lt;code&gt;reversion&lt;/code&gt;æ‰€å¯¹åº”çš„&lt;code&gt;key-value&lt;/code&gt;ç»„åˆä¼šè¢«å­˜åˆ°boltdbä¸­ã€‚&lt;/p&gt;

&lt;p&gt;ä¸¾ä¸ªä¾‹å­ï¼š ç”¨etcdctlé€šè¿‡æ‰¹é‡æ¥å£å†™å…¥ä¸¤æ¡è®°å½•ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;lnt&#34;&gt;1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;2
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;3
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;4
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;etcdctl txn &lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;
&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;put key1 &amp;#34;v1&amp;#34;
&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;put key2 &amp;#34;v2&amp;#34;
&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;å†é€šè¿‡æ‰¹é‡æ¥å£æ›´æ–°è¿™ä¸¤æ¡è®°å½•ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;lnt&#34;&gt;1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;2
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;3
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;4
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;etcdctl txn &lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;
&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;put key1 &amp;#34;v12&amp;#34;
&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;put key2 &amp;#34;v22&amp;#34;
&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;boltdbä¸­å…¶å®æœ‰äº†4æ¡æ•°æ®ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;lnt&#34;&gt;1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;2
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;3
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;4
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;nv&#34;&gt;rev&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;={&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;3&lt;/span&gt; &lt;span class=&#34;m&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;}&lt;/span&gt;, &lt;span class=&#34;nv&#34;&gt;key&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;key1&amp;#34;&lt;/span&gt;, &lt;span class=&#34;nv&#34;&gt;value&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;v1&amp;#34;&lt;/span&gt;
&lt;span class=&#34;nv&#34;&gt;rev&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;={&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;3&lt;/span&gt; &lt;span class=&#34;m&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;}&lt;/span&gt;, &lt;span class=&#34;nv&#34;&gt;key&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;key2&amp;#34;&lt;/span&gt;, &lt;span class=&#34;nv&#34;&gt;value&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;v2&amp;#34;&lt;/span&gt;
&lt;span class=&#34;nv&#34;&gt;rev&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;={&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;4&lt;/span&gt; &lt;span class=&#34;m&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;}&lt;/span&gt;, &lt;span class=&#34;nv&#34;&gt;key&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;key1&amp;#34;&lt;/span&gt;, &lt;span class=&#34;nv&#34;&gt;value&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;v12&amp;#34;&lt;/span&gt;
&lt;span class=&#34;nv&#34;&gt;rev&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;={&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;4&lt;/span&gt; &lt;span class=&#34;m&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;}&lt;/span&gt;, &lt;span class=&#34;nv&#34;&gt;key&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;key2&amp;#34;&lt;/span&gt;, &lt;span class=&#34;nv&#34;&gt;value&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;v22&amp;#34;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;æ‰€ä»¥æ€»çš„æ¥è¯´ï¼Œå†…å­˜ btree ç»´æŠ¤çš„æ˜¯ key åˆ° keyIndex çš„æ˜ å°„ï¼ŒkeyIndex å†…ç»´æŠ¤å¤šç‰ˆæœ¬çš„ revision ä¿¡æ¯ï¼Œè€Œ revision å¯ä»¥æ˜ å°„åˆ°ç£ç›˜bboltä¸­å…·ä½“çš„valueã€‚ä¸‹é¢è¿™ä¸ªå›¾å¾ˆå¥½çš„è¡¨ç¤ºäº†è¿™ä¸ªè¿‡ç¨‹&lt;sup class=&#34;footnote-ref&#34; id=&#34;fnref:lichuang&#34;&gt;&lt;a href=&#34;#fn:lichuang&#34;&gt;2&lt;/a&gt;&lt;/sup&gt;ï¼š&lt;/p&gt;



&lt;div class=&#34;box&#34;&gt;
&lt;figure  itemprop=&#34;associatedMedia&#34;
  itemscope itemtype=&#34;http://schema.org/ImageObject&#34; &gt;
    &lt;div class=&#34;img&#34;&gt;
      &lt;img itemprop=&#34;thumbnail&#34; src=&#34;//blog.betacat.io/image/mvcc-in-etcd/etcd-keyindex.png&#34; alt=&#34;MVCCæ•°æ®æµç¨‹&#34;/&gt;
    &lt;/div&gt;
    &lt;a href=&#34;//blog.betacat.io/image/mvcc-in-etcd/etcd-keyindex.png&#34; itemprop=&#34;contentUrl&#34;&gt;&lt;/a&gt;
      &lt;figcaption&gt;
          &lt;p&gt;MVCCæ•°æ®æµç¨‹&lt;/p&gt;
      &lt;/figcaption&gt;
  &lt;/figure&gt;
&lt;/div&gt;


&lt;p&gt;åŸºæœ¬æ¦‚å¿µå°±ä»‹ç»åˆ°è¿™é‡Œäº†ï¼Œä¸‹é¢æˆ‘ä»¬æŠŠè¿™äº›æ¦‚å¿µä¸²èµ·æ¥ï¼Œçœ‹çœ‹è¯»å†™æ“ä½œçš„å®Œæ•´æµç¨‹æ˜¯æ€æ ·çš„ã€‚&lt;/p&gt;

&lt;h2 id=&#34;å†™æ“ä½œ&#34;&gt;å†™æ“ä½œ&lt;/h2&gt;

&lt;p&gt;é¦–å…ˆå†™æ“ä½œçš„å…¥å£æ˜¯applierV3çš„&lt;a href=&#34;https://github.com/etcd-io/etcd/blob/v3.3.10/etcdserver/apply.go#L50&#34;&gt;Putå‡½æ•°&lt;/a&gt;ï¼Œå®ƒå¼€å¯ä¸€ä¸ªå†™äº‹åŠ¡ï¼Œç„¶åè¿›è¿‡å±‚å±‚å°è£…ï¼Œæœ€åå¹²æ´»çš„æ˜¯å†™äº‹åŠ¡çš„&lt;code&gt;put&lt;/code&gt;å‡½æ•°ï¼Œç²¾ç®€åçš„é€»è¾‘å¤§æ¦‚æ˜¯è¿™æ ·çš„ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;lnt&#34;&gt; 1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 2
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 3
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 4
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 5
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 6
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 7
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 8
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 9
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;10
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;11
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;12
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;13
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;14
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;15
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;16
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;17
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;18
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;19
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;20
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;21
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;22
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;c1&#34;&gt;// https://github.com/etcd-io/etcd/blob/v3.3.10/mvcc/kvstore_txn.go#L151
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;func&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;tw&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;storeTxnWrite&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;put&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;key&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;value&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;[]&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;byte&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;leaseID&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;lease&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;LeaseID&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
    &lt;span class=&#34;nx&#34;&gt;rev&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;tw&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;beginRev&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;+&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;

    &lt;span class=&#34;nx&#34;&gt;ibytes&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;newRevBytes&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;
    &lt;span class=&#34;nx&#34;&gt;idxRev&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;revision&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;main&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;rev&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;sub&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;int64&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;len&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;tw&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;changes&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;))}&lt;/span&gt;
    &lt;span class=&#34;nf&#34;&gt;revToBytes&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;idxRev&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;ibytes&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;

    &lt;span class=&#34;nx&#34;&gt;kv&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;mvccpb&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;KeyValue&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
        &lt;span class=&#34;nx&#34;&gt;Key&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;            &lt;span class=&#34;nx&#34;&gt;key&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
        &lt;span class=&#34;nx&#34;&gt;Value&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;          &lt;span class=&#34;nx&#34;&gt;value&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
        &lt;span class=&#34;nx&#34;&gt;CreateRevision&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;c&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
        &lt;span class=&#34;nx&#34;&gt;ModRevision&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;    &lt;span class=&#34;nx&#34;&gt;rev&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
        &lt;span class=&#34;nx&#34;&gt;Version&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;        &lt;span class=&#34;nx&#34;&gt;ver&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
        &lt;span class=&#34;nx&#34;&gt;Lease&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;          &lt;span class=&#34;nb&#34;&gt;int64&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;leaseID&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;
    &lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
    &lt;span class=&#34;nx&#34;&gt;d&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;err&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;kv&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;Marshal&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;

    &lt;span class=&#34;nx&#34;&gt;tw&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;tx&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;UnsafeSeqPut&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;keyBucketName&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;ibytes&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;d&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
    &lt;span class=&#34;nx&#34;&gt;tw&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;s&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;kvindex&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;Put&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;key&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;idxRev&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
    &lt;span class=&#34;nx&#34;&gt;tw&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;changes&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;append&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;tw&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;changes&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;kv&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;æ­£å¦‚å‰é¢æ‰€åˆ†æçš„ï¼Œè¿™é‡Œçš„&lt;code&gt;put&lt;/code&gt;æ“ä½œé¦–å…ˆè·å–äº†å½“å‰äº‹åŠ¡çš„IDï¼ˆtw.beginRevï¼‰ï¼Œä»¥åŠå½“å‰äº‹åŠ¡ä¸­å·²ç»è¿›è¡Œè¿‡çš„æ›´æ”¹æ•°ï¼ˆtw.changesï¼‰ï¼Œç„¶åä»¥æ­¤ä¸ºåŸºç¡€ç”Ÿæˆäº†&lt;code&gt;revision&lt;/code&gt;ï¼Œå¹¶å‘&lt;code&gt;boltdb&lt;/code&gt;å’Œ&lt;code&gt;treeIndex&lt;/code&gt;åˆ†åˆ«æ‰§è¡Œäº†ä¸¤æ¬¡å†™å…¥æ“ä½œã€‚&lt;/p&gt;

&lt;h2 id=&#34;è¯»æ“ä½œ&#34;&gt;è¯»æ“ä½œ&lt;/h2&gt;

&lt;p&gt;è¯»æ“ä½œçš„å…¥å£æ˜¯applierV3çš„&lt;a href=&#34;https://github.com/etcd-io/etcd/blob/v3.3.10/etcdserver/apply.go#L51&#34;&gt;Rangeå‡½æ•°&lt;/a&gt;ï¼Œè·Ÿå†™æ“ä½œä¸€æ ·ï¼Œå®ƒå¼€å¯äº†ä¸€ä¸ªåªè¯»äº‹åŠ¡ï¼Œç„¶åä¸€è·¯è°ƒç”¨åˆ°&lt;code&gt;rangeKeys&lt;/code&gt;å‡½æ•°ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;lnt&#34;&gt; 1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 2
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 3
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 4
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 5
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 6
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 7
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 8
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 9
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;10
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;11
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;12
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;13
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;14
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;15
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;16
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;17
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;c1&#34;&gt;// https://github.com/etcd-io/etcd/blob/v3.3.10/mvcc/kvstore_txn.go#L111
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;func&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;tr&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;storeTxnRead&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;rangeKeys&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;key&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;end&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;[]&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;byte&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;curRev&lt;/span&gt; &lt;span class=&#34;kt&#34;&gt;int64&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;ro&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;RangeOptions&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;RangeResult&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;kt&#34;&gt;error&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
    &lt;span class=&#34;nx&#34;&gt;rev&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;ro&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Rev&lt;/span&gt;

    &lt;span class=&#34;nx&#34;&gt;revpairs&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;tr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;s&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;kvindex&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;Revisions&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;key&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;end&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;rev&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;

    &lt;span class=&#34;nx&#34;&gt;limit&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;ro&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Limit&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
    &lt;span class=&#34;nx&#34;&gt;kvs&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;make&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;([]&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;mvccpb&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;KeyValue&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;limit&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
    &lt;span class=&#34;nx&#34;&gt;revBytes&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;newRevBytes&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;

    &lt;span class=&#34;k&#34;&gt;for&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;revpair&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;range&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;revpairs&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[:&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;len&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;kvs&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)]&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
        &lt;span class=&#34;nf&#34;&gt;revToBytes&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;revpair&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;revBytes&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
        &lt;span class=&#34;nx&#34;&gt;_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;vs&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;tr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;tx&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;UnsafeRange&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;keyBucketName&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;revBytes&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;kc&#34;&gt;nil&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
        &lt;span class=&#34;nx&#34;&gt;kvs&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;].&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;Unmarshal&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;vs&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;])&lt;/span&gt;
    &lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
    &lt;span class=&#34;k&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;RangeResult&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;KVs&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;kvs&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;Count&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;len&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;revpairs&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;Rev&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;curRev&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;},&lt;/span&gt; &lt;span class=&#34;kc&#34;&gt;nil&lt;/span&gt;
    &lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;è¿™é‡Œå‡½æ•°çš„å‚æ•°&lt;code&gt;curRev&lt;/code&gt;ä»£è¡¨å½“å‰äº‹åŠ¡IDã€‚æ‹¿åˆ°è¿™ä¸ªIDåï¼Œæˆ‘ä»¬å»&lt;code&gt;treeIndex&lt;/code&gt;ä¸­æŸ¥è¯¢ï¼Œæ»¡è¶³æŒ‡å®šæ¡ä»¶çš„&lt;code&gt;revision&lt;/code&gt;æœ‰å“ªäº›ï¼Œç„¶åå†æ ¹æ®è¿™äº›&lt;code&gt;revision&lt;/code&gt;å»&lt;code&gt;boltdb&lt;/code&gt;ä¸­æŸ¥è¯¢å½“æ—¶å­˜çš„&lt;code&gt;key-value&lt;/code&gt;æ˜¯ä»€ä¹ˆã€‚&lt;/p&gt;

&lt;h2 id=&#34;å°ç»“&#34;&gt;å°ç»“&lt;/h2&gt;

&lt;p&gt;æœ¬æ–‡å°†ä¹è§‚é”çš„åŸç†åŠå…¶åœ¨ etcd ä¸­çš„å®ç° MVCC æ¢³ç†äº†ä¸€éï¼Œå¸Œæœ›å¯¹è¯»è€…åœ¨ç†è§£å’Œä½¿ç”¨ä¹è§‚é”ä¸Šèƒ½æœ‰æ‰€å¸®åŠ©ã€‚&lt;/p&gt;

&lt;p&gt;åœ¨ etcd ä¸­ï¼ŒMVCC çš„å®ç°è¿˜æ˜¯æ¯”è¾ƒç®€å•ç›´æ¥çš„ã€‚ä½†åœ¨é˜…è¯»ä»£ç çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä¹Ÿæœ‰ä¸€äº›çœ‹ä¸æ˜ç™½çš„åœ°æ–¹ï¼Œæ¯•ç«Ÿä¸€æ®µä»£ç åœ¨æ¼”åŒ–çš„è¿‡ç¨‹ä¸­ï¼Œä¼šå¤šå‡ºå„ç§å„æ ·çš„ç»†èŠ‚å¤„ç†ï¼Œæ¯”å¦‚è¾¹ç•Œæƒ…å†µï¼Œæ€§èƒ½è°ƒä¼˜ç­‰ã€‚è¿™äº›ç»†èŠ‚ä¼šæ‰°ä¹±è§†çº¿ï¼Œè®©æˆ‘ä»¬éš¾ä»¥æŠ“ä½ä¸»å¹²ã€‚ä¸€èˆ¬ç¢°åˆ°è¿™ç§æƒ…å†µï¼Œæˆ‘ä¼šé‡‡ç”¨ä¸¤ç§æ–¹æ³•ï¼š&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;é˜…è¯»UTï¼Œçœ‹ä»–ä»¬éƒ½åœ¨æµ‹è¯•ä»€ä¹ˆã€‚ä¸€èˆ¬UTçš„è¾“å…¥è¾“å‡ºéƒ½æ¯”è¾ƒç¡®å®šï¼Œå®ƒèƒ½å¤Ÿå‘æˆ‘ä»¬æ­ç¤ºè¿™æ®µä»£ç çš„ä½œè€…æœŸæœ›å®Œæˆçš„åŠŸèƒ½æ˜¯ä»€ä¹ˆã€‚æœ‰äº†è¿™ä¸ªç›®æ ‡åæˆ‘ä»¬å†å»çœ‹å®ç°ï¼Œå°±èƒ½å‰”å‡ºå“ªäº›æ˜¯è·Ÿä¸»å¹²åŠŸèƒ½æœ‰å…³çš„ï¼Œå“ªäº›æ˜¯ç»†èŠ‚å¤„ç†ã€‚&lt;/li&gt;
&lt;li&gt;æŸ¥æ‰¾è¾ƒæ—©çš„æäº¤ã€‚æ—¢ç„¶ä»£ç æ˜¯æ¼”è¿›å‡ºæ¥çš„ï¼Œé‚£å®ƒåˆšå¼€å§‹çš„å‡ ä¸ªç‰ˆæœ¬ä¸€èˆ¬éƒ½æ¯”è¾ƒç²—ç³™ï¼Œæœ‰å¾ˆå¤šç»†èŠ‚æ²¡æœ‰å¤„ç†ï¼Œä½†é‚£ä¹Ÿæ˜¯è¿™ä¸ªåŠŸèƒ½æœ€ç›´æ¥çš„å®ç°ã€‚é€šè¿‡é˜…è¯»ä½œè€…æ—©æœŸçš„å®ç°ï¼Œä¹Ÿèƒ½å¸®åŠ©æˆ‘ä»¬å¿«é€ŸæŠ“ä½ä¸»å¹²ã€‚&lt;/li&gt;
&lt;/ol&gt;
&lt;div class=&#34;footnotes&#34;&gt;

&lt;hr /&gt;

&lt;ol&gt;
&lt;li id=&#34;fn:pluggable-backend&#34;&gt;&lt;a href=&#34;https://github.com/etcd-io/etcd/issues/10321&#34;&gt;Meta issue: Pluggable backend #10321&lt;/a&gt;
 &lt;a class=&#34;footnote-return&#34; href=&#34;#fnref:pluggable-backend&#34;&gt;&lt;sup&gt;[return]&lt;/sup&gt;&lt;/a&gt;&lt;/li&gt;
&lt;li id=&#34;fn:lichuang&#34;&gt;&lt;a href=&#34;https://lichuang.github.io/post/20181125-etcd-server/&#34;&gt;etcdå­˜å‚¨çš„å®ç°&lt;/a&gt;
 &lt;a class=&#34;footnote-return&#34; href=&#34;#fnref:lichuang&#34;&gt;&lt;sup&gt;[return]&lt;/sup&gt;&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;/div&gt;
</description>
      
    </item>
    
    <item>
      <title>Raft åœ¨ etcd ä¸­çš„å®ç°</title>
      <link>//blog.betacat.io/post/raft-implementation-in-etcd/</link>
      <pubDate>Tue, 13 Nov 2018 19:47:17 +0800</pubDate>
      
      <guid>//blog.betacat.io/post/raft-implementation-in-etcd/</guid>
      
        <description>

&lt;p&gt;&lt;a href=&#34;https://en.wikipedia.org/wiki/Raft_(computer_science)&#34;&gt;Raft&lt;/a&gt;æ˜¯è¿‘å¹´æ¥æ¯”è¾ƒæµè¡Œçš„ä¸€ä¸ªä¸€è‡´æ€§ç®—æ³•ã€‚å®ƒçš„åŸç†æ¯”è¾ƒå®¹æ˜“ç†è§£ï¼Œç½‘ä¸Šä¹Ÿæœ‰å¾ˆå¤šç›¸å…³çš„ä»‹ç»ï¼Œå› æ­¤è¿™é‡Œæˆ‘å°±ä¸å†å•°å—¦åŸç†äº†ï¼Œè€Œæ˜¯æ‰“ç®—ä»¥raftåœ¨etcdä¸­çš„å®ç°&lt;sup class=&#34;footnote-ref&#34; id=&#34;fnref:v3-3-10&#34;&gt;&lt;a href=&#34;#fn:v3-3-10&#34;&gt;1&lt;/a&gt;&lt;/sup&gt;ä¸ºä¾‹ï¼Œä»å·¥ç¨‹çš„è§’åº¦æ¥è®²è®²è¿™ä¸ªç®—æ³•çš„ä¸€ä¸ªå…·ä½“å®ç°ï¼Œæ¯•ç«Ÿäº†è§£åŸç†åªç®—æ˜¯â€œçº¸ä¸Šè°ˆå…µâ€ï¼Œç¦»çœŸæ­£èƒ½æŠŠå®ƒåº”ç”¨èµ·æ¥è¿˜æœ‰å¾ˆé•¿ä¸€æ®µè·ç¦»ã€‚&lt;/p&gt;

&lt;!-- The authors claim it is the most widely used Raft library in production. --&gt;

&lt;p&gt;å¦‚æœä½ è¿˜ä¸ç†Ÿæ‚‰raftï¼Œè¿™ä¸ªç»å…¸çš„&lt;a href=&#34;http://thesecretlivesofdata.com/raft/&#34;&gt;åŠ¨ç”»æ¼”ç¤º&lt;/a&gt;ã€&lt;a href=&#34;https://raft.github.io/raft.pdf&#34;&gt;å®ƒçš„è®ºæ–‡&lt;/a&gt;ä»¥åŠ&lt;a href=&#34;https://www.youtube.com/watch?v=YbZ3zDzDnrw&#34;&gt;è¿™ä¸ªlecture&lt;/a&gt;å¯èƒ½ä¼šå¯¹ä½ æœ‰å¸®åŠ©ã€‚æˆ–è€…ä½ ä¹Ÿå¯ä»¥ç›´æ¥è§‚çœ‹&lt;strong&gt;ä¸‹é¢çš„è§†é¢‘&lt;/strong&gt;ï¼Œè¿™æ˜¯æˆ‘ä½œçš„ä¸€æ¬¡æŠ€æœ¯åˆ†äº«ï¼Œè®²çš„æ˜¯&lt;a href=&#34;https://reading.developerlearning.cn/reading/32-2019-03-02-etcd-raft/&#34;&gt;etcdä¸­raftæ¨¡å—çš„æºç è§£æ&lt;/a&gt;ã€‚è¯´å¥é¢˜å¤–è¯ï¼Œå¾ˆå¤šConferenceå’ŒMeetupéƒ½ä¼šæŠŠè§†é¢‘å½•åƒä¸Šä¼ åˆ°YouTubeä¸Šï¼ŒYouTubeç®€ç›´å°±æ˜¯ç¨‹åºå‘˜çš„è¡£æŸœï¼Œæ¯é€›ä¸€æ¬¡éƒ½æœ‰æ–°æ”¶è·ã€‚

&lt;div style=&#34;position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;&#34;&gt;
  &lt;iframe src=&#34;//www.youtube.com/embed/sL02PsR20gE&#34; style=&#34;position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;&#34; allowfullscreen title=&#34;YouTube Video&#34;&gt;&lt;/iframe&gt;
&lt;/div&gt;
&lt;/p&gt;

&lt;h1 id=&#34;overview&#34;&gt;Overview&lt;/h1&gt;

&lt;p&gt;Etcdå°†raftåè®®å®ç°ä¸ºä¸€ä¸ªlibraryï¼Œç„¶åæœ¬èº«ä½œä¸ºä¸€ä¸ªåº”ç”¨ä½¿ç”¨å®ƒã€‚å½“ç„¶ï¼Œå¯èƒ½æ˜¯ä¸ºäº†æ¨å¹¿å®ƒæ‰€å®ç°çš„è¿™ä¸ªlibraryï¼Œetcdè¿˜é¢å¤–æä¾›äº†ä¸€ä¸ªå«&lt;a href=&#34;https://github.com/etcd-io/etcd/tree/v3.3.10/contrib/raftexample&#34;&gt;raftexample&lt;/a&gt;çš„ç¤ºä¾‹ç¨‹åºï¼Œå‘ç”¨æˆ·å±•ç¤ºæ€æ ·åœ¨å®ƒæ‰€æä¾›çš„raft libraryçš„åŸºç¡€ä¸Šæ„å»ºå‡ºä¸€ä¸ªåˆ†å¸ƒå¼çš„KVå­˜å‚¨å¼•æ“ã€‚&lt;/p&gt;

&lt;p&gt;åœ¨etcdä¸­ï¼Œraftä½œä¸ºåº•å±‚çš„å…±è¯†æ¨¡å—ï¼Œè¿è¡Œåœ¨ä¸€ä¸ª&lt;code&gt;goroutine&lt;/code&gt;é‡Œï¼Œé€šè¿‡&lt;code&gt;channel&lt;/code&gt;æ¥å—ä¸Šå±‚ï¼ˆetcdserverï¼‰ä¼ æ¥çš„æ¶ˆæ¯ï¼Œå¹¶å°†å¤„ç†åçš„ç»“æœé€šè¿‡å¦ä¸€ä¸ª&lt;code&gt;channel&lt;/code&gt;è¿”å›ç»™ä¸Šå±‚åº”ç”¨ï¼Œä»–ä»¬çš„äº¤äº’è¿‡ç¨‹å¤§æ¦‚æ˜¯è¿™æ ·çš„ï¼š&lt;/p&gt;



&lt;div class=&#34;box&#34;&gt;
&lt;figure  itemprop=&#34;associatedMedia&#34;
  itemscope itemtype=&#34;http://schema.org/ImageObject&#34; &gt;
    &lt;div class=&#34;img&#34;&gt;
      &lt;img itemprop=&#34;thumbnail&#34; src=&#34;//blog.betacat.io/image/raft-in-etcd/raft-stack.png&#34; alt=&#34;Raft Stack&#34;/&gt;
    &lt;/div&gt;
    &lt;a href=&#34;//blog.betacat.io/image/raft-in-etcd/raft-stack.png&#34; itemprop=&#34;contentUrl&#34;&gt;&lt;/a&gt;
      &lt;figcaption&gt;
          &lt;p&gt;Raft Stack&lt;/p&gt;
      &lt;/figcaption&gt;
  &lt;/figure&gt;
&lt;/div&gt;


&lt;p&gt;è¿™ç§å…¨å¼‚æ­¥çš„äº¤äº’æ–¹å¼å¥½å¤„å°±æ˜¯å®ƒæé«˜äº†æ€§èƒ½ï¼Œä½†åå¤„å°±æ˜¯éš¾ä»¥è°ƒè¯•ï¼Œä»£ç çœ‹èµ·æ¥ä¼šå¾ˆç»•ã€‚æ‹¿etcdä¸¾ä¾‹ï¼Œå¾ˆå¤šæ—¶å€™ä½ åªçœ‹åˆ°å®ƒæŠŠä¸€ä¸ªæ¶ˆæ¯pushåˆ°ä¸€ä¸ªslice/channelé‡Œé¢ï¼Œç„¶åè¿™éƒ¨åˆ†å‡½æ•°è°ƒç”¨é“¾å°±ç»“æŸäº†ï¼Œä½ æ— æ³•ç›´è§‚çš„è¿½è¸ªåˆ°ï¼Œåˆ°åº•æ˜¯è°æœ€åå¤„ç†äº†è¿™ä¸ªæ¶ˆæ¯ã€‚&lt;/p&gt;

&lt;h2 id=&#34;code-breakdown&#34;&gt;Code Breakdown&lt;/h2&gt;

&lt;p&gt;æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹è¿™ä¸ªraft libraryé‡Œé¢éƒ½æœ‰å“ªäº›æ–‡ä»¶ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;lnt&#34;&gt; 1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 2
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 3
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 4
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 5
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 6
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 7
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 8
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 9
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;10
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;11
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;12
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;13
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;14
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;15
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;$ tree --dirsfirst -L &lt;span class=&#34;m&#34;&gt;1&lt;/span&gt; -I &lt;span class=&#34;s1&#34;&gt;&amp;#39;*test*&amp;#39;&lt;/span&gt; -P &lt;span class=&#34;s1&#34;&gt;&amp;#39;*.go&amp;#39;&lt;/span&gt;
.
â”œâ”€â”€ raftpb
â”œâ”€â”€ doc.go
â”œâ”€â”€ log.go
â”œâ”€â”€ log_unstable.go
â”œâ”€â”€ logger.go
â”œâ”€â”€ node.go
â”œâ”€â”€ progress.go
â”œâ”€â”€ raft.go
â”œâ”€â”€ rawnode.go
â”œâ”€â”€ read_only.go
â”œâ”€â”€ status.go
â”œâ”€â”€ storage.go
â””â”€â”€ util.go&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;ä¸‹é¢æŒ‰åŠŸèƒ½æ¨¡å—ä¾æ¬¡ä»‹ç»ï¼š&lt;/p&gt;

&lt;h3 id=&#34;raftpb&#34;&gt;raftpb&lt;/h3&gt;

&lt;p&gt;Raftä¸­çš„åºåˆ—åŒ–æ˜¯å€ŸåŠ©äº&lt;a href=&#34;https://developers.google.com/protocol-buffers/&#34;&gt;Protocol Buffer&lt;/a&gt;æ¥å®ç°çš„ï¼Œè¿™ä¸ªæ–‡ä»¶å¤¹å°±å®šä¹‰äº†éœ€è¦åºåˆ—åŒ–çš„å‡ ä¸ªæ•°æ®ç»“æ„ï¼Œæˆ‘ä»¬å…ˆä»&lt;code&gt;Entry&lt;/code&gt;å’Œ&lt;code&gt;Message&lt;/code&gt;å¼€å§‹çœ‹èµ·ï¼š&lt;/p&gt;

&lt;h4 id=&#34;entry&#34;&gt;&lt;em&gt;Entry&lt;/em&gt;&lt;/h4&gt;

&lt;p&gt;ä»æ•´ä½“ä¸Šæ¥è¯´ï¼Œä¸€ä¸ªé›†ç¾¤ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹éƒ½æ˜¯ä¸€ä¸ªçŠ¶æ€æœºï¼Œè€Œraftç®¡ç†çš„å°±æ˜¯å¯¹è¿™ä¸ªçŠ¶æ€æœºè¿›è¡Œæ›´æ”¹çš„ä¸€äº›æ“ä½œï¼Œè¿™äº›æ“ä½œåœ¨ä»£ç ä¸­è¢«å°è£…ä¸ºä¸€ä¸ªä¸ª&lt;code&gt;Entry&lt;/code&gt;ã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;lnt&#34;&gt;1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;2
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;3
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;4
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;5
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;6
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;7
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;c1&#34;&gt;// https://github.com/etcd-io/etcd/blob/v3.3.10/raft/raftpb/raft.pb.go#L203
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;type&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;Entry&lt;/span&gt; &lt;span class=&#34;kd&#34;&gt;struct&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
    &lt;span class=&#34;nx&#34;&gt;Term&lt;/span&gt;             &lt;span class=&#34;kt&#34;&gt;uint64&lt;/span&gt;
    &lt;span class=&#34;nx&#34;&gt;Index&lt;/span&gt;            &lt;span class=&#34;kt&#34;&gt;uint64&lt;/span&gt;
    &lt;span class=&#34;nx&#34;&gt;Type&lt;/span&gt;             &lt;span class=&#34;nx&#34;&gt;EntryType&lt;/span&gt;
    &lt;span class=&#34;nx&#34;&gt;Data&lt;/span&gt;             &lt;span class=&#34;p&#34;&gt;[]&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;byte&lt;/span&gt;
&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;ul&gt;
&lt;li&gt;Termï¼šé€‰ä¸¾ä»»æœŸï¼Œæ¯æ¬¡é€‰ä¸¾ä¹‹åé€’å¢1ã€‚å®ƒçš„ä¸»è¦ä½œç”¨æ˜¯æ ‡è®°ä¿¡æ¯çš„æ—¶æ•ˆæ€§ï¼Œæ¯”æ–¹è¯´å½“ä¸€ä¸ªèŠ‚ç‚¹å‘å‡ºæ¥çš„æ¶ˆæ¯ä¸­æºå¸¦çš„termæ˜¯2ï¼Œè€Œå¦ä¸€ä¸ªèŠ‚ç‚¹æºå¸¦çš„termæ˜¯3ï¼Œé‚£æˆ‘ä»¬å°±è®¤ä¸ºç¬¬ä¸€ä¸ªèŠ‚ç‚¹çš„ä¿¡æ¯è¿‡æ—¶äº†ã€‚&lt;/li&gt;
&lt;li&gt;Indexï¼šå½“å‰è¿™ä¸ªentryåœ¨æ•´ä¸ªraftæ—¥å¿—ä¸­çš„ä½ç½®ç´¢å¼•ã€‚æœ‰äº†&lt;code&gt;Term&lt;/code&gt;å’Œ&lt;code&gt;Index&lt;/code&gt;ä¹‹åï¼Œä¸€ä¸ªlog entryå°±èƒ½è¢«å”¯ä¸€æ ‡è¯†ã€‚&lt;/li&gt;
&lt;li&gt;Typeï¼šå½“å‰entryçš„ç±»å‹ï¼Œç›®å‰etcdæ”¯æŒä¸¤ç§ç±»å‹ï¼š&lt;a href=&#34;https://github.com/etcd-io/etcd/blob/v3.3.10/raft/raftpb/raft.pb.go#L47&#34;&gt;EntryNormal&lt;/a&gt;å’Œ&lt;a href=&#34;https://github.com/etcd-io/etcd/blob/v3.3.10/raft/raftpb/raft.pb.go#L48&#34;&gt;EntryConfChange&lt;/a&gt;ï¼ŒEntryNormalä»£è¡¨å½“å‰Entryæ˜¯å¯¹çŠ¶æ€æœºçš„æ“ä½œï¼ŒEntryConfChangeåˆ™ä»£è¡¨å¯¹å½“å‰é›†ç¾¤é…ç½®è¿›è¡Œæ›´æ”¹çš„æ“ä½œï¼Œæ¯”å¦‚å¢åŠ æˆ–è€…å‡å°‘èŠ‚ç‚¹ã€‚&lt;/li&gt;
&lt;li&gt;Dataï¼šä¸€ä¸ªè¢«åºåˆ—åŒ–åçš„byteæ•°ç»„ï¼Œä»£è¡¨å½“å‰entryçœŸæ­£è¦æ‰§è¡Œçš„æ“ä½œï¼Œæ¯”æ–¹è¯´å¦‚æœä¸Šé¢çš„&lt;code&gt;Type&lt;/code&gt;æ˜¯&lt;code&gt;EntryNormal&lt;/code&gt;ï¼Œé‚£è¿™é‡Œçš„Dataå°±å¯èƒ½æ˜¯å…·ä½“è¦æ›´æ”¹çš„key-value pairï¼Œå¦‚æœ&lt;code&gt;Type&lt;/code&gt;æ˜¯&lt;code&gt;EntryConfChange&lt;/code&gt;ï¼Œé‚£Dataå°±æ˜¯å…·ä½“çš„é…ç½®æ›´æ”¹é¡¹&lt;a href=&#34;https://github.com/etcd-io/etcd/blob/v3.3.10/raft/raftpb/raft.pb.go#L283&#34;&gt;ConfChange&lt;/a&gt;ã€‚raftç®—æ³•æœ¬èº«å¹¶ä¸å…³å¿ƒè¿™ä¸ªæ•°æ®æ˜¯ä»€ä¹ˆï¼Œå®ƒåªæ˜¯æŠŠè¿™æ®µæ•°æ®å½“åšlogåŒæ­¥è¿‡ç¨‹ä¸­çš„payloadæ¥å¤„ç†ï¼Œå…·ä½“å¯¹è¿™ä¸ªæ•°æ®çš„è§£æåˆ™æœ‰ä¸Šå±‚åº”ç”¨æ¥å®Œæˆã€‚&lt;/li&gt;
&lt;/ul&gt;

&lt;h4 id=&#34;message&#34;&gt;&lt;em&gt;Message&lt;/em&gt;&lt;/h4&gt;

&lt;p&gt;Rafté›†ç¾¤ä¸­èŠ‚ç‚¹ä¹‹é—´çš„é€šè®¯éƒ½æ˜¯é€šè¿‡ä¼ é€’ä¸åŒçš„&lt;code&gt;Message&lt;/code&gt;æ¥å®Œæˆçš„ï¼Œè¿™ä¸ª&lt;code&gt;Message&lt;/code&gt;ç»“æ„å°±æ˜¯ä¸€ä¸ªéå¸¸generalçš„å¤§å®¹å™¨ï¼Œå®ƒæ¶µç›–äº†å„ç§æ¶ˆæ¯æ‰€éœ€çš„å­—æ®µã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;lnt&#34;&gt; 1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 2
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 3
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 4
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 5
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 6
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 7
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 8
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 9
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;10
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;11
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;12
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;13
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;14
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;15
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;c1&#34;&gt;// https://github.com/etcd-io/etcd/blob/v3.3.10/raft/raftpb/raft.pb.go#L239
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;type&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;Message&lt;/span&gt; &lt;span class=&#34;kd&#34;&gt;struct&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
    &lt;span class=&#34;nx&#34;&gt;Type&lt;/span&gt;             &lt;span class=&#34;nx&#34;&gt;MessageType&lt;/span&gt;
    &lt;span class=&#34;nx&#34;&gt;To&lt;/span&gt;               &lt;span class=&#34;kt&#34;&gt;uint64&lt;/span&gt;
    &lt;span class=&#34;nx&#34;&gt;From&lt;/span&gt;             &lt;span class=&#34;kt&#34;&gt;uint64&lt;/span&gt;
    &lt;span class=&#34;nx&#34;&gt;Term&lt;/span&gt;             &lt;span class=&#34;kt&#34;&gt;uint64&lt;/span&gt;
    &lt;span class=&#34;nx&#34;&gt;LogTerm&lt;/span&gt;          &lt;span class=&#34;kt&#34;&gt;uint64&lt;/span&gt;
    &lt;span class=&#34;nx&#34;&gt;Index&lt;/span&gt;            &lt;span class=&#34;kt&#34;&gt;uint64&lt;/span&gt;
    &lt;span class=&#34;nx&#34;&gt;Entries&lt;/span&gt;          &lt;span class=&#34;p&#34;&gt;[]&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Entry&lt;/span&gt;
    &lt;span class=&#34;nx&#34;&gt;Commit&lt;/span&gt;           &lt;span class=&#34;kt&#34;&gt;uint64&lt;/span&gt;
    &lt;span class=&#34;nx&#34;&gt;Snapshot&lt;/span&gt;         &lt;span class=&#34;nx&#34;&gt;Snapshot&lt;/span&gt;
    &lt;span class=&#34;nx&#34;&gt;Reject&lt;/span&gt;           &lt;span class=&#34;kt&#34;&gt;bool&lt;/span&gt;
    &lt;span class=&#34;nx&#34;&gt;RejectHint&lt;/span&gt;       &lt;span class=&#34;kt&#34;&gt;uint64&lt;/span&gt;
    &lt;span class=&#34;nx&#34;&gt;Context&lt;/span&gt;          &lt;span class=&#34;p&#34;&gt;[]&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;byte&lt;/span&gt;
&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;ul&gt;
&lt;li&gt;Typeï¼šå½“å‰ä¼ é€’çš„æ¶ˆæ¯ç±»å‹ï¼Œå®ƒçš„å–å€¼æœ‰&lt;a href=&#34;https://github.com/etcd-io/etcd/blob/v3.3.10/raft/raftpb/raft.pb.go#L80&#34;&gt;å¾ˆå¤šç§&lt;/a&gt;ï¼Œæ¯”å¦‚ç”¨æ¥è¯·æ±‚æŠ•ç¥¨çš„MsgVoteã€ç”¨æ¥å¤„ç†ç½‘ç»œåˆ†åŒºçš„MsgPreVote&lt;sup class=&#34;footnote-ref&#34; id=&#34;fnref:prevote&#34;&gt;&lt;a href=&#34;#fn:prevote&#34;&gt;2&lt;/a&gt;&lt;/sup&gt;ã€ç”¨æ¥å‘ç»™leaderèŠ‚ç‚¹ï¼Œè®©å®ƒåœ¨æ—¥å¿—ä¸­å¢åŠ æ•°æ®çš„MsgProp(ose)ã€ç”¨æ¥å¤åˆ¶æ—¥å¿—çš„MsgApp(end)ã€ç”¨æ¥å®‰è£…snapshotçš„MsgSnapã€‚ä¸åŒç±»å‹çš„æ¶ˆæ¯ä¹Ÿä¼šç”¨åˆ°ä¸‹é¢ä¸åŒçš„å­—æ®µã€‚&lt;/li&gt;
&lt;li&gt;To, Fromåˆ†åˆ«ä»£è¡¨äº†è¿™ä¸ªæ¶ˆæ¯çš„æ¥å—è€…å’Œå‘é€è€…ã€‚&lt;/li&gt;
&lt;li&gt;Termï¼šè¿™ä¸ªæ¶ˆæ¯å‘å‡ºæ—¶æ•´ä¸ªé›†ç¾¤æ‰€å¤„çš„ä»»æœŸã€‚&lt;/li&gt;
&lt;li&gt;LogTermï¼šæ¶ˆæ¯å‘å‡ºè€…æ‰€ä¿å­˜çš„æ—¥å¿—ä¸­æœ€åä¸€æ¡çš„ä»»æœŸå·ï¼Œä¸€èˆ¬&lt;code&gt;MsgVote&lt;/code&gt;ä¼šç”¨åˆ°è¿™ä¸ªå­—æ®µã€‚&lt;/li&gt;
&lt;li&gt;Indexï¼šæ—¥å¿—ç´¢å¼•å·ã€‚å¦‚æœå½“å‰æ¶ˆæ¯æ˜¯&lt;code&gt;MsgVote&lt;/code&gt;çš„è¯ï¼Œä»£è¡¨è¿™ä¸ªcandidateæœ€åä¸€æ¡æ—¥å¿—çš„ç´¢å¼•å·ï¼Œå®ƒè·Ÿä¸Šé¢çš„&lt;code&gt;LogTerm&lt;/code&gt;ä¸€èµ·ä»£è¡¨è¿™ä¸ªcandidateæ‰€æ‹¥æœ‰çš„æœ€æ–°æ—¥å¿—ä¿¡æ¯ï¼Œè¿™æ ·åˆ«äººå°±å¯ä»¥æ¯”è¾ƒè‡ªå·±çš„æ—¥å¿—æ˜¯ä¸æ˜¯æ¯”candidataçš„æ—¥å¿—è¦æ–°ï¼Œä»è€Œå†³å®šæ˜¯å¦æŠ•ç¥¨ã€‚&lt;/li&gt;
&lt;li&gt;Entriesï¼šéœ€è¦å­˜å‚¨çš„æ—¥å¿—ã€‚&lt;/li&gt;
&lt;li&gt;Commitï¼šå·²ç»æäº¤çš„æ—¥å¿—çš„ç´¢å¼•å€¼ï¼Œç”¨æ¥å‘åˆ«äººåŒæ­¥æ—¥å¿—çš„æäº¤ä¿¡æ¯ã€‚&lt;/li&gt;
&lt;li&gt;Snapshotï¼šä¸€èˆ¬è·Ÿ&lt;code&gt;MsgSnap&lt;/code&gt;åˆç”¨ï¼Œç”¨æ¥æ”¾ç½®å…·ä½“çš„Snapshotå€¼ã€‚&lt;/li&gt;
&lt;li&gt;Rejectï¼ŒRejectHintï¼šä»£è¡¨å¯¹æ–¹èŠ‚ç‚¹æ‹’ç»äº†å½“å‰èŠ‚ç‚¹çš„è¯·æ±‚(MsgVote/MsgApp/MsgSnap&amp;hellip;)&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&#34;log-unstable-go&#34;&gt;log_unstable.go&lt;/h3&gt;

&lt;p&gt;é¡¾åæ€ä¹‰ï¼Œunstableæ•°æ®ç»“æ„ç”¨äºè¿˜æ²¡æœ‰è¢«ç”¨æˆ·å±‚æŒä¹…åŒ–çš„æ•°æ®ï¼Œå®ƒç»´æŠ¤äº†ä¸¤éƒ¨åˆ†å†…å®¹&lt;code&gt;snapshot&lt;/code&gt;å’Œ&lt;code&gt;entries&lt;/code&gt;ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;lnt&#34;&gt; 1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 2
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 3
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 4
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 5
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 6
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 7
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 8
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 9
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;10
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;c1&#34;&gt;// https://github.com/etcd-io/etcd/blob/v3.3.10/raft/log_unstable.go#L23
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;type&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;unstable&lt;/span&gt; &lt;span class=&#34;kd&#34;&gt;struct&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
    &lt;span class=&#34;c1&#34;&gt;// the incoming unstable snapshot, if any.
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;    &lt;span class=&#34;nx&#34;&gt;snapshot&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;pb&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Snapshot&lt;/span&gt;
    &lt;span class=&#34;c1&#34;&gt;// all entries that have not yet been written to storage.
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;    &lt;span class=&#34;nx&#34;&gt;entries&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;[]&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;pb&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Entry&lt;/span&gt;
    &lt;span class=&#34;nx&#34;&gt;offset&lt;/span&gt;  &lt;span class=&#34;kt&#34;&gt;uint64&lt;/span&gt;

    &lt;span class=&#34;nx&#34;&gt;logger&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;Logger&lt;/span&gt;
&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;&lt;code&gt;entries&lt;/code&gt;ä»£è¡¨çš„æ˜¯è¦è¿›è¡Œæ“ä½œçš„æ—¥å¿—ï¼Œä½†æ—¥å¿—ä¸å¯èƒ½æ— é™å¢é•¿ï¼Œåœ¨ç‰¹å®šçš„æƒ…å†µä¸‹ï¼ŒæŸäº›è¿‡æœŸçš„æ—¥å¿—ä¼šè¢«æ¸…ç©ºã€‚é‚£è¿™å°±å¼•å…¥ä¸€ä¸ªæ–°é—®é¢˜äº†ï¼Œå¦‚æœæ­¤åä¸€ä¸ªæ–°çš„&lt;code&gt;follower&lt;/code&gt;åŠ å…¥ï¼Œè€Œ&lt;code&gt;leader&lt;/code&gt;åªæœ‰ä¸€éƒ¨åˆ†æ“ä½œæ—¥å¿—ï¼Œé‚£è¿™ä¸ªæ–°&lt;code&gt;follower&lt;/code&gt;ä¸æ˜¯æ²¡æ³•è·Ÿåˆ«äººåŒæ­¥äº†å—ï¼Ÿæ‰€ä»¥è¿™ä¸ªæ—¶å€™&lt;code&gt;snapshot&lt;/code&gt;å°±ç™»åœºäº† - æˆ‘æ— æ³•ç»™ä½ ä¹‹å‰çš„æ—¥å¿—ï¼Œä½†æˆ‘ç»™ä½ æ‰€æœ‰ä¹‹å‰æ—¥å¿—åº”ç”¨åçš„ç»“æœï¼Œä¹‹åçš„æ—¥å¿—ä½ å†ä»¥è¿™ä¸ª&lt;code&gt;snapshot&lt;/code&gt;ä¸ºåŸºç¡€è¿›è¡Œåº”ç”¨ï¼Œé‚£æˆ‘ä»¬çš„çŠ¶æ€å°±å¯ä»¥åŒæ­¥äº†ã€‚å› æ­¤å®ƒä»¬çš„ç»“æ„å…³ç³»å¯ä»¥ç”¨ä¸‹å›¾è¡¨ç¤º&lt;sup class=&#34;footnote-ref&#34; id=&#34;fnref:lichuang&#34;&gt;&lt;a href=&#34;#fn:lichuang&#34;&gt;3&lt;/a&gt;&lt;/sup&gt;ï¼š&lt;/p&gt;



&lt;div class=&#34;box&#34;&gt;
&lt;figure  itemprop=&#34;associatedMedia&#34;
  itemscope itemtype=&#34;http://schema.org/ImageObject&#34; &gt;
    &lt;div class=&#34;img&#34;&gt;
      &lt;img itemprop=&#34;thumbnail&#34; src=&#34;//blog.betacat.io/image/raft-in-etcd/log_unstable.png&#34; /&gt;
    &lt;/div&gt;
    &lt;a href=&#34;//blog.betacat.io/image/raft-in-etcd/log_unstable.png&#34; itemprop=&#34;contentUrl&#34;&gt;&lt;/a&gt;
  &lt;/figure&gt;
&lt;/div&gt;


&lt;p&gt;è¿™é‡Œçš„å‰åŠéƒ¨åˆ†æ˜¯å¿«ç…§æ•°æ®ï¼Œè€ŒååŠéƒ¨åˆ†æ˜¯æ—¥å¿—æ¡ç›®ç»„æˆçš„æ•°ç»„entriesï¼Œå¦å¤–unstable.offsetæˆå‘˜ä¿å­˜çš„æ˜¯entriesæ•°ç»„ä¸­çš„ç¬¬ä¸€æ¡æ•°æ®åœ¨raftæ—¥å¿—ä¸­çš„ç´¢å¼•ï¼Œå³ç¬¬iæ¡entriesåœ¨raftæ—¥å¿—ä¸­çš„ç´¢å¼•ä¸º&lt;code&gt;i + unstable.offset&lt;/code&gt;ã€‚&lt;/p&gt;

&lt;h3 id=&#34;storage-go&#34;&gt;storage.go&lt;/h3&gt;

&lt;p&gt;è¿™ä¸ªæ–‡ä»¶å®šä¹‰äº†ä¸€ä¸ª&lt;a href=&#34;https://github.com/etcd-io/etcd/blob/v3.3.10/raft/storage.go#L46&#34;&gt;Storage&lt;/a&gt;æ¥å£ï¼Œå› ä¸ºetcdä¸­çš„raftå®ç°å¹¶ä¸è´Ÿè´£æ•°æ®çš„æŒä¹…åŒ–ï¼Œæ‰€ä»¥å®ƒå¸Œæœ›ä¸Šé¢çš„åº”ç”¨å±‚èƒ½å®ç°è¿™ä¸ªæ¥å£ï¼Œä»¥ä¾¿æä¾›ç»™å®ƒæŸ¥è¯¢logçš„èƒ½åŠ›ã€‚&lt;/p&gt;

&lt;p&gt;å¦å¤–ï¼Œè¿™ä¸ªæ–‡ä»¶ä¹Ÿæä¾›äº†&lt;code&gt;Storage&lt;/code&gt;æ¥å£çš„ä¸€ä¸ªå†…å­˜ç‰ˆæœ¬çš„å®ç°&lt;a href=&#34;https://github.com/etcd-io/etcd/blob/v3.3.10/raft/storage.go#L74&#34;&gt;MemoryStorage&lt;/a&gt;ï¼Œè¿™ä¸ªå®ç°åŒæ ·ä¹Ÿç»´æŠ¤äº†&lt;code&gt;snapshot&lt;/code&gt;å’Œ&lt;code&gt;entries&lt;/code&gt;è¿™ä¸¤éƒ¨åˆ†ï¼Œä»–ä»¬çš„æ’åˆ—è·Ÿ&lt;code&gt;unstable&lt;/code&gt;ä¸­çš„ç±»ä¼¼ï¼Œä¹Ÿæ˜¯&lt;code&gt;snapshot&lt;/code&gt;åœ¨å‰ï¼Œ&lt;code&gt;entries&lt;/code&gt;åœ¨åã€‚ä»ä»£ç ä¸­çœ‹æ¥&lt;code&gt;etcdserver&lt;/code&gt;å’Œ&lt;code&gt;raftexample&lt;/code&gt;éƒ½æ˜¯ç›´æ¥ç”¨çš„è¿™ä¸ªå®ç°æ¥æä¾›logçš„æŸ¥è¯¢åŠŸèƒ½çš„ã€‚&lt;/p&gt;

&lt;h3 id=&#34;log-go&#34;&gt;log.go&lt;/h3&gt;

&lt;p&gt;æœ‰äº†ä»¥ä¸Šçš„ä»‹ç»unstableã€Storageçš„å‡†å¤‡ä¹‹åï¼Œä¸‹é¢å¯ä»¥æ¥ä»‹ç»raftLogçš„å®ç°ï¼Œè¿™ä¸ªç»“æ„ä½“æ‰¿æ‹…äº†raftæ—¥å¿—ç›¸å…³çš„æ“ä½œã€‚&lt;/p&gt;

&lt;p&gt;raftLogç”±ä»¥ä¸‹æˆå‘˜ç»„æˆï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;storage Storageï¼šå‰é¢æåˆ°çš„å­˜æ”¾å·²ç»æŒä¹…åŒ–æ•°æ®çš„Storageæ¥å£ã€‚&lt;/li&gt;
&lt;li&gt;unstable unstableï¼šå‰é¢åˆ†æè¿‡çš„unstableç»“æ„ä½“ï¼Œç”¨äºä¿å­˜åº”ç”¨å±‚è¿˜æ²¡æœ‰æŒä¹…åŒ–çš„æ•°æ®ã€‚&lt;/li&gt;
&lt;li&gt;committed uint64ï¼šä¿å­˜å½“å‰æäº¤çš„æ—¥å¿—æ•°æ®ç´¢å¼•ã€‚&lt;/li&gt;
&lt;li&gt;applied uint64ï¼šä¿å­˜å½“å‰ä¼ å…¥çŠ¶æ€æœºçš„æ•°æ®æœ€é«˜ç´¢å¼•ã€‚&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;éœ€è¦è¯´æ˜çš„æ˜¯ï¼Œä¸€æ¡æ—¥å¿—æ•°æ®ï¼Œé¦–å…ˆéœ€è¦è¢«æäº¤ï¼ˆcommittedï¼‰æˆåŠŸï¼Œç„¶åæ‰èƒ½è¢«åº”ç”¨ï¼ˆappliedï¼‰åˆ°çŠ¶æ€æœºä¸­ã€‚å› æ­¤ï¼Œä»¥ä¸‹ä¸ç­‰å¼ä¸€ç›´æˆç«‹ï¼š&lt;code&gt;applied &amp;lt;= committed&lt;/code&gt;ã€‚&lt;/p&gt;

&lt;p&gt;raftLogç»“æ„ä½“ä¸­ï¼Œå‡ éƒ¨åˆ†æ•°æ®çš„æ’åˆ—å¦‚ä¸‹å›¾æ‰€ç¤º&lt;sup class=&#34;footnote-ref&#34; id=&#34;fnref:lichuang&#34;&gt;&lt;a href=&#34;#fn:lichuang&#34;&gt;3&lt;/a&gt;&lt;/sup&gt;ï¼š&lt;/p&gt;



&lt;div class=&#34;box&#34;&gt;
&lt;figure  itemprop=&#34;associatedMedia&#34;
  itemscope itemtype=&#34;http://schema.org/ImageObject&#34; &gt;
    &lt;div class=&#34;img&#34;&gt;
      &lt;img itemprop=&#34;thumbnail&#34; src=&#34;//blog.betacat.io/image/raft-in-etcd/raftlog-layout.png&#34; alt=&#34;RaftLog Layout&#34;/&gt;
    &lt;/div&gt;
    &lt;a href=&#34;//blog.betacat.io/image/raft-in-etcd/raftlog-layout.png&#34; itemprop=&#34;contentUrl&#34;&gt;&lt;/a&gt;
      &lt;figcaption&gt;
          &lt;p&gt;RaftLog Layout&lt;/p&gt;
      &lt;/figcaption&gt;
  &lt;/figure&gt;
&lt;/div&gt;


&lt;p&gt;è¿™ä¸ªæ•°æ®æ’å¸ƒçš„æƒ…å†µï¼Œå¯ä»¥ä»raftLogçš„åˆå§‹åŒ–å‡½æ•°ä¸­çœ‹å‡ºæ¥ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;lnt&#34;&gt; 1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 2
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 3
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 4
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 5
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 6
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 7
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 8
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 9
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;10
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;11
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;12
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;13
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;14
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;15
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;16
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;17
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;18
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;19
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;20
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;21
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;22
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;23
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;24
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;25
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;26
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;27
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;c1&#34;&gt;// https://github.com/etcd-io/etcd/blob/v3.3.10/raft/log.go#L45
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// newLog returns log using the given storage. It recovers the log to the state
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// that it just commits and applies the latest snapshot.
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;func&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;newLog&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;storage&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;Storage&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;logger&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;Logger&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;raftLog&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
    &lt;span class=&#34;k&#34;&gt;if&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;storage&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;==&lt;/span&gt; &lt;span class=&#34;kc&#34;&gt;nil&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
        &lt;span class=&#34;nx&#34;&gt;log&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;Panic&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;storage must not be nil&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
    &lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
    &lt;span class=&#34;nx&#34;&gt;log&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;raftLog&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
        &lt;span class=&#34;nx&#34;&gt;storage&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;storage&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
        &lt;span class=&#34;nx&#34;&gt;logger&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;  &lt;span class=&#34;nx&#34;&gt;logger&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
    &lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
    &lt;span class=&#34;nx&#34;&gt;firstIndex&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;err&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;storage&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;FirstIndex&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;
    &lt;span class=&#34;k&#34;&gt;if&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;err&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;!=&lt;/span&gt; &lt;span class=&#34;kc&#34;&gt;nil&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
        &lt;span class=&#34;nb&#34;&gt;panic&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;err&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;c1&#34;&gt;// TODO(bdarnell)
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;    &lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
    &lt;span class=&#34;nx&#34;&gt;lastIndex&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;err&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;storage&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;LastIndex&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;
    &lt;span class=&#34;k&#34;&gt;if&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;err&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;!=&lt;/span&gt; &lt;span class=&#34;kc&#34;&gt;nil&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
        &lt;span class=&#34;nb&#34;&gt;panic&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;err&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;c1&#34;&gt;// TODO(bdarnell)
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;    &lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
    &lt;span class=&#34;nx&#34;&gt;log&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;unstable&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;offset&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;lastIndex&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;+&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;
    &lt;span class=&#34;nx&#34;&gt;log&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;unstable&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;logger&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;logger&lt;/span&gt;
    &lt;span class=&#34;c1&#34;&gt;// Initialize our committed and applied pointers to the time of the last compaction.
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;    &lt;span class=&#34;nx&#34;&gt;log&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;committed&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;firstIndex&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;-&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;
    &lt;span class=&#34;nx&#34;&gt;log&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;applied&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;firstIndex&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;-&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;

    &lt;span class=&#34;k&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;log&lt;/span&gt;
&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;å› æ­¤ï¼Œä»è¿™é‡Œçš„ä»£ç å¯ä»¥çœ‹å‡ºï¼ŒraftLogçš„ä¸¤éƒ¨åˆ†ï¼ŒæŒä¹…åŒ–å­˜å‚¨å’ŒéæŒä¹…åŒ–å­˜å‚¨ï¼Œå®ƒä»¬ä¹‹é—´çš„åˆ†ç•Œçº¿å°±æ˜¯lastIndexï¼Œåœ¨æ­¤ä¹‹å‰éƒ½æ˜¯&lt;code&gt;Storage&lt;/code&gt;ç®¡ç†çš„å·²ç»æŒä¹…åŒ–çš„æ•°æ®ï¼Œè€Œåœ¨æ­¤ä¹‹åéƒ½æ˜¯&lt;code&gt;unstable&lt;/code&gt;ç®¡ç†çš„è¿˜æ²¡æœ‰æŒä¹…åŒ–çš„æ•°æ®ã€‚&lt;/p&gt;

&lt;p&gt;ä»¥ä¸Šåˆ†æä¸­è¿˜æœ‰ä¸€ä¸ªç–‘é—®ï¼Œä¸ºä»€ä¹ˆå¹¶æ²¡æœ‰åˆå§‹åŒ–unstable.snapshotæˆå‘˜ï¼Œä¹Ÿå°±æ˜¯unstableç»“æ„ä½“çš„å¿«ç…§æ•°æ®ï¼ŸåŸå› åœ¨äºï¼Œä¸Šé¢è¿™ä¸ªæ˜¯åˆå§‹åŒ–å‡½æ•°ï¼Œä¹Ÿå°±æ˜¯èŠ‚ç‚¹åˆšå¯åŠ¨çš„æ—¶å€™è°ƒç”¨æ¥åˆå§‹åŒ–å­˜å‚¨çŠ¶æ€çš„å‡½æ•°ï¼Œè€Œunstable.snapshotæ•°æ®ï¼Œæ˜¯åœ¨å¯åŠ¨ä¹‹ååŒæ­¥æ•°æ®çš„è¿‡ç¨‹ä¸­ï¼Œå¦‚æœéœ€è¦åŒæ­¥å¿«ç…§æ•°æ®æ—¶æ‰ä¼šå»è¿›è¡Œèµ‹å€¼ä¿®æ”¹çš„æ•°æ®ï¼Œå› æ­¤åœ¨è¿™é‡Œå¹¶æ²¡æœ‰å¯¹å®ƒè¿›è¡Œæ“ä½œçš„åœ°æ–¹ã€‚&lt;/p&gt;

&lt;h3 id=&#34;progress-go&#34;&gt;progress.go&lt;/h3&gt;

&lt;p&gt;Leaderé€šè¿‡&lt;code&gt;Progress&lt;/code&gt;è¿™ä¸ªæ•°æ®ç»“æ„æ¥è¿½è¸ªä¸€ä¸ªfollowerçš„çŠ¶æ€ï¼Œå¹¶æ ¹æ®&lt;code&gt;Progress&lt;/code&gt;é‡Œçš„ä¿¡æ¯æ¥å†³å®šæ¯æ¬¡åŒæ­¥çš„æ—¥å¿—é¡¹ã€‚è¿™é‡Œä»‹ç»ä¸‰ä¸ªæ¯”è¾ƒé‡è¦çš„å±æ€§ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;lnt&#34;&gt; 1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 2
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 3
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 4
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 5
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 6
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 7
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 8
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 9
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;10
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;c1&#34;&gt;// https://github.com/etcd-io/etcd/blob/v3.3.10/raft/progress.go#L37
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// Progress represents a followerâ€™s progress in the view of the leader. Leader maintains
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// progresses of all followers, and sends entries to the follower based on its progress.
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;type&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;Progress&lt;/span&gt; &lt;span class=&#34;kd&#34;&gt;struct&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
    &lt;span class=&#34;nx&#34;&gt;Match&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;Next&lt;/span&gt; &lt;span class=&#34;kt&#34;&gt;uint64&lt;/span&gt;

    &lt;span class=&#34;nx&#34;&gt;State&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;ProgressStateType&lt;/span&gt;

    &lt;span class=&#34;nx&#34;&gt;ins&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;inflights&lt;/span&gt;
&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;ol&gt;
&lt;li&gt;&lt;p&gt;ç”¨æ¥ä¿å­˜å½“å‰followerèŠ‚ç‚¹çš„æ—¥å¿—çŠ¶æ€çš„å±æ€§ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;Matchï¼šä¿å­˜ç›®å‰ä¸ºæ­¢ï¼Œå·²å¤åˆ¶ç»™è¯¥followerçš„æ—¥å¿—çš„æœ€é«˜ç´¢å¼•å€¼ã€‚å¦‚æœleaderå¯¹è¯¥followerä¸Šçš„æ—¥å¿—æƒ…å†µä¸€æ— æ‰€çŸ¥çš„è¯ï¼Œè¿™ä¸ªå€¼è¢«è®¾ä¸º0ã€‚&lt;/li&gt;
&lt;li&gt;Nextï¼šä¿å­˜ä¸‹ä¸€æ¬¡leaderå‘é€appendæ¶ˆæ¯ç»™è¯¥followerçš„æ—¥å¿—ç´¢å¼•ï¼Œå³ä¸‹ä¸€æ¬¡å¤åˆ¶æ—¥å¿—æ—¶ï¼Œleaderä¼šä»&lt;code&gt;Next&lt;/code&gt;å¼€å§‹å‘é€æ—¥å¿—ã€‚&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;åœ¨æ­£å¸¸æƒ…å†µä¸‹ï¼Œ&lt;code&gt;Next = Match + 1&lt;/code&gt;ï¼Œä¹Ÿå°±æ˜¯ä¸‹ä¸€ä¸ªè¦åŒæ­¥çš„æ—¥å¿—åº”å½“æ˜¯å¯¹æ–¹å·²æœ‰æ—¥å¿—çš„ä¸‹ä¸€æ¡ã€‚&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;&lt;code&gt;State&lt;/code&gt;å±æ€§ç”¨æ¥ä¿å­˜è¯¥èŠ‚ç‚¹å½“å‰çš„åŒæ­¥çŠ¶æ€ï¼Œå®ƒä¼šæœ‰ä¸€ä¸‹å‡ ç§å–å€¼&lt;sup class=&#34;footnote-ref&#34; id=&#34;fnref:progress-design&#34;&gt;&lt;a href=&#34;#fn:progress-design&#34;&gt;4&lt;/a&gt;&lt;/sup&gt;ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;ProgressStateProbe&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;æ¢æµ‹çŠ¶æ€ï¼Œå½“followeræ‹’ç»äº†æœ€è¿‘çš„appendæ¶ˆæ¯æ—¶ï¼Œé‚£ä¹ˆå°±ä¼šè¿›å…¥æ¢æµ‹çŠ¶æ€ï¼Œæ­¤æ—¶leaderä¼šè¯•å›¾ç»§ç»­å¾€å‰è¿½æº¯è¯¥followerçš„æ—¥å¿—ä»å“ªé‡Œå¼€å§‹ä¸¢å¤±çš„ã€‚åœ¨probeçŠ¶æ€æ—¶ï¼Œleaderæ¯æ¬¡æœ€å¤šappendä¸€æ¡æ—¥å¿—ï¼Œå¦‚æœæ”¶åˆ°çš„å›åº”ä¸­å¸¦æœ‰&lt;code&gt;RejectHint&lt;/code&gt;ä¿¡æ¯ï¼Œåˆ™å›é€€&lt;code&gt;Next&lt;/code&gt;ç´¢å¼•ï¼Œä»¥ä¾¿ä¸‹æ¬¡é‡è¯•ã€‚åœ¨åˆå§‹æ—¶ï¼Œleaderä¼šæŠŠæ‰€æœ‰followerçš„çŠ¶æ€è®¾ä¸ºprobeï¼Œå› ä¸ºå®ƒå¹¶ä¸çŸ¥é“å„ä¸ªfollowerçš„åŒæ­¥çŠ¶æ€ï¼Œæ‰€ä»¥éœ€è¦æ…¢æ…¢è¯•æ¢ã€‚&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;ProgressStateReplicate&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;å½“leaderç¡®è®¤æŸä¸ªfollowerçš„åŒæ­¥çŠ¶æ€åï¼Œå®ƒå°±ä¼šæŠŠè¿™ä¸ªfollowerçš„stateåˆ‡æ¢åˆ°è¿™ä¸ªçŠ¶æ€ï¼Œå¹¶ä¸”ç”¨&lt;code&gt;pipeline&lt;/code&gt;çš„æ–¹å¼å¿«é€Ÿå¤åˆ¶æ—¥å¿—ã€‚leaderåœ¨å‘é€å¤åˆ¶æ¶ˆæ¯ä¹‹åï¼Œå°±ä¿®æ”¹è¯¥èŠ‚ç‚¹çš„&lt;code&gt;Next&lt;/code&gt;ç´¢å¼•ä¸ºå‘é€æ¶ˆæ¯çš„æœ€å¤§ç´¢å¼•+1ã€‚&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;ProgressStateSnapshot&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;æ¥æ”¶å¿«ç…§çŠ¶æ€ã€‚å½“leaderå‘æŸä¸ªfollowerå‘é€appendæ¶ˆæ¯ï¼Œè¯•å›¾è®©è¯¥followerçŠ¶æ€è·Ÿä¸Šleaderæ—¶ï¼Œå‘ç°æ­¤æ—¶leaderä¸Šä¿å­˜çš„ç´¢å¼•æ•°æ®å·²ç»å¯¹ä¸ä¸Šäº†ï¼Œæ¯”å¦‚leaderåœ¨indexä¸º10ä¹‹å‰çš„æ•°æ®éƒ½å·²ç»å†™å…¥å¿«ç…§ä¸­äº†ï¼Œä½†æ˜¯è¯¥followeréœ€è¦çš„æ˜¯10ä¹‹å‰çš„æ•°æ®ï¼Œæ­¤æ—¶å°±ä¼šåˆ‡æ¢åˆ°è¯¥çŠ¶æ€ä¸‹ï¼Œå‘é€å¿«ç…§ç»™è¯¥followerã€‚å½“å¿«ç…§æ•°æ®åŒæ­¥è¿½ä¸Šä¹‹åï¼Œå¹¶ä¸æ˜¯ç›´æ¥åˆ‡æ¢åˆ°ReplicateçŠ¶æ€ï¼Œè€Œæ˜¯é¦–å…ˆåˆ‡æ¢åˆ°ProbeçŠ¶æ€ã€‚&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;&lt;code&gt;ins&lt;/code&gt;å±æ€§ç”¨æ¥åšæµé‡æ§åˆ¶ï¼Œå› ä¸ºå¦‚æœåŒæ­¥è¯·æ±‚éå¸¸å¤šï¼Œå†ç¢°ä¸Šç½‘ç»œåˆ†åŒºæ—¶ï¼Œleaderå¯èƒ½ä¼šç´¯ç§¯å¾ˆå¤šå¾…å‘é€æ¶ˆæ¯ï¼Œä¸€æ—¦ç½‘ç»œæ¢å¤ï¼Œå¯èƒ½ä¼šæœ‰éå¸¸å¤§æµé‡å‘é€ç»™followerï¼Œæ‰€ä»¥è¿™é‡Œè¦åšflow controlã€‚å®ƒçš„å®ç°æœ‰ç‚¹ç±»ä¼¼TCPçš„&lt;a href=&#34;https://en.wikipedia.org/wiki/Sliding_window_protocol&#34;&gt;æ»‘åŠ¨çª—å£&lt;/a&gt;ï¼Œè¿™é‡Œä¸å†èµ˜è¿°ã€‚&lt;/p&gt;&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;ç»¼ä¸Šï¼Œ&lt;code&gt;Progress&lt;/code&gt;å…¶å®ä¹Ÿæ˜¯ä¸ªçŠ¶æ€æœºï¼Œä¸‹é¢æ˜¯å®ƒçš„çŠ¶æ€è½¬ç§»å›¾ï¼š&lt;/p&gt;



&lt;div class=&#34;box&#34;&gt;
&lt;figure  itemprop=&#34;associatedMedia&#34;
  itemscope itemtype=&#34;http://schema.org/ImageObject&#34; &gt;
    &lt;div class=&#34;img&#34;&gt;
      &lt;img itemprop=&#34;thumbnail&#34; src=&#34;//blog.betacat.io/image/raft-in-etcd/progress-state-machine.png&#34; alt=&#34;Progress State Machine&#34;/&gt;
    &lt;/div&gt;
    &lt;a href=&#34;//blog.betacat.io/image/raft-in-etcd/progress-state-machine.png&#34; itemprop=&#34;contentUrl&#34;&gt;&lt;/a&gt;
      &lt;figcaption&gt;
          &lt;p&gt;Progress State Machine&lt;/p&gt;
      &lt;/figcaption&gt;
  &lt;/figure&gt;
&lt;/div&gt;


&lt;h3 id=&#34;raft-go&#34;&gt;raft.go&lt;/h3&gt;

&lt;p&gt;å‰é¢é“ºè®¾äº†ä¸€å¤§å †æ¦‚å¿µï¼Œç°åœ¨ç»ˆäºè½®åˆ°å®ç°é€»è¾‘äº†ã€‚ä»åå­—ä¹Ÿå¯ä»¥çœ‹å‡ºï¼Œraftåè®®çš„å…·ä½“å®ç°å°±åœ¨è¿™ä¸ªæ–‡ä»¶é‡Œã€‚è¿™å…¶ä¸­ï¼Œå¤§éƒ¨åˆ†çš„é€»è¾‘æ˜¯ç”±&lt;code&gt;Step&lt;/code&gt;å‡½æ•°é©±åŠ¨çš„ã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;lnt&#34;&gt; 1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 2
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 3
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 4
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 5
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 6
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 7
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 8
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 9
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;10
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;11
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;12
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;c1&#34;&gt;// https://github.com/etcd-io/etcd/blob/v3.3.10/raft/raft.go#L752
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;func&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;r&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;raft&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;Step&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;m&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;pb&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Message&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;kt&#34;&gt;error&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
    &lt;span class=&#34;c1&#34;&gt;//...
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;    &lt;span class=&#34;k&#34;&gt;switch&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;m&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Type&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
        &lt;span class=&#34;k&#34;&gt;case&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;pb&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;MsgHup&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;
        &lt;span class=&#34;c1&#34;&gt;//...
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;        &lt;span class=&#34;k&#34;&gt;case&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;pb&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;MsgVote&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;pb&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;MsgPreVote&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;
        &lt;span class=&#34;c1&#34;&gt;//...
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;        &lt;span class=&#34;k&#34;&gt;default&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;
            &lt;span class=&#34;nx&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;step&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;m&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
    &lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;&lt;code&gt;Step&lt;/code&gt;çš„ä¸»è¦ä½œç”¨æ˜¯å¤„ç†ä¸åŒçš„&lt;a href=&#34;#message&#34;&gt;æ¶ˆæ¯&lt;/a&gt;ï¼Œæ‰€ä»¥ä»¥åå½“æˆ‘ä»¬æƒ³çŸ¥é“raftå¯¹æŸç§æ¶ˆæ¯çš„å¤„ç†é€»è¾‘æ—¶ï¼Œåˆ°è¿™é‡Œæ‰¾å°±å¯¹äº†ã€‚åœ¨å‡½æ•°çš„æœ€åï¼Œæœ‰ä¸ª&lt;code&gt;default&lt;/code&gt;è¯­å¥ï¼Œå³æ‰€æœ‰ä¸Šé¢ä¸èƒ½å¤„ç†çš„æ¶ˆæ¯éƒ½è½å…¥è¿™é‡Œï¼Œç”±ä¸€ä¸ªå°å†™çš„&lt;code&gt;step&lt;/code&gt;å‡½æ•°å¤„ç†ï¼Œè¿™ä¸ªè®¾è®¡çš„åŸå› æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ&lt;/p&gt;

&lt;p&gt;å…¶å®æ˜¯å› ä¸ºè¿™é‡Œçš„raftä¹Ÿè¢«å®ç°ä¸ºä¸€ä¸ªçŠ¶æ€æœºï¼Œå®ƒçš„&lt;code&gt;step&lt;/code&gt;å±æ€§æ˜¯ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆï¼Œæ ¹æ®å½“å‰èŠ‚ç‚¹çš„ä¸åŒè§’è‰²ï¼ŒæŒ‡å‘ä¸åŒçš„æ¶ˆæ¯å¤„ç†å‡½æ•°ï¼š&lt;a href=&#34;https://github.com/etcd-io/etcd/blob/v3.3.10/raft/raft.go#L875&#34;&gt;stepLeader&lt;/a&gt;/&lt;a href=&#34;https://github.com/etcd-io/etcd/blob/v3.3.10/raft/raft.go#L1121&#34;&gt;stepFollower&lt;/a&gt;/&lt;a href=&#34;https://github.com/etcd-io/etcd/blob/v3.3.10/raft/raft.go#L1079&#34;&gt;stepCandidate&lt;/a&gt;ã€‚ä¸å®ƒç±»ä¼¼çš„è¿˜æœ‰ä¸€ä¸ª&lt;code&gt;tick&lt;/code&gt;å‡½æ•°æŒ‡é’ˆï¼Œæ ¹æ®è§’è‰²çš„ä¸åŒï¼Œä¹Ÿä¼šåœ¨&lt;a href=&#34;https://github.com/etcd-io/etcd/blob/v3.3.10/raft/raft.go#L608&#34;&gt;tickHeartbeat&lt;/a&gt;å’Œ&lt;a href=&#34;https://github.com/etcd-io/etcd/blob/v3.3.10/raft/raft.go#L598&#34;&gt;tickElection&lt;/a&gt;ä¹‹é—´æ¥å›åˆ‡æ¢ï¼Œåˆ†åˆ«ç”¨æ¥è§¦å‘å®šæ—¶å¿ƒè·³å’Œé€‰ä¸¾æ£€æµ‹ã€‚è¿™é‡Œçš„å‡½æ•°æŒ‡é’ˆæ„Ÿè§‰åƒå®ç°äº†&lt;code&gt;OOP&lt;/code&gt;é‡Œçš„å¤šæ€ã€‚&lt;/p&gt;



&lt;div class=&#34;box&#34;&gt;
&lt;figure  itemprop=&#34;associatedMedia&#34;
  itemscope itemtype=&#34;http://schema.org/ImageObject&#34; &gt;
    &lt;div class=&#34;img&#34;&gt;
      &lt;img itemprop=&#34;thumbnail&#34; src=&#34;//blog.betacat.io/image/raft-in-etcd/raft-function-state-machine.png&#34; alt=&#34;Raft State Machine&#34;/&gt;
    &lt;/div&gt;
    &lt;a href=&#34;//blog.betacat.io/image/raft-in-etcd/raft-function-state-machine.png&#34; itemprop=&#34;contentUrl&#34;&gt;&lt;/a&gt;
      &lt;figcaption&gt;
          &lt;p&gt;Raft State Machine&lt;/p&gt;
      &lt;/figcaption&gt;
  &lt;/figure&gt;
&lt;/div&gt;


&lt;h3 id=&#34;node-go&#34;&gt;node.go&lt;/h3&gt;

&lt;p&gt;&lt;code&gt;node&lt;/code&gt;çš„ä¸»è¦ä½œç”¨æ˜¯åº”ç”¨å±‚ï¼ˆetcdserverï¼‰å’Œå…±è¯†æ¨¡å—ï¼ˆraftï¼‰çš„è¡”æ¥ã€‚å°†åº”ç”¨å±‚çš„æ¶ˆæ¯ä¼ é€’ç»™åº•å±‚å…±è¯†æ¨¡å—ï¼Œå¹¶å°†åº•å±‚å…±è¯†æ¨¡å—å…±è¯†åçš„ç»“æœåé¦ˆç»™åº”ç”¨å±‚ã€‚æ‰€ä»¥å®ƒçš„&lt;a href=&#34;https://github.com/etcd-io/etcd/blob/v3.3.10/raft/node.go#L243&#34;&gt;åˆå§‹åŒ–å‡½æ•°&lt;/a&gt;åˆ›å»ºäº†å¾ˆå¤šç”¨æ¥é€šä¿¡çš„&lt;code&gt;channel&lt;/code&gt;ï¼Œç„¶åå°±åœ¨å¦ä¸€ä¸ª&lt;code&gt;goroutine&lt;/code&gt;é‡Œé¢å¼€å§‹äº†äº‹ä»¶å¾ªç¯ï¼Œä¸åœçš„åœ¨å„ç§&lt;code&gt;channel&lt;/code&gt;ä¸­å€’è…¾æ•°æ®ï¼ˆè²Œä¼¼è¿™ç§ç”±&lt;code&gt;for-select-channel&lt;/code&gt;ç»„æˆçš„äº‹ä»¶å¾ªç¯åœ¨Goé‡Œé¢å¾ˆå—æ¬¢è¿ï¼‰ã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;lnt&#34;&gt; 1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 2
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 3
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 4
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 5
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 6
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 7
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 8
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 9
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;10
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;11
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;12
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;13
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;14
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;15
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;16
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;17
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;18
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;19
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;20
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;21
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;22
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;c1&#34;&gt;// https://github.com/etcd-io/etcd/blob/v3.3.10/raft/node.go#L286
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;for&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
  &lt;span class=&#34;k&#34;&gt;select&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
    &lt;span class=&#34;k&#34;&gt;case&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;m&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;&amp;lt;-&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;propc&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;
        &lt;span class=&#34;nx&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;Step&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;m&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
    &lt;span class=&#34;k&#34;&gt;case&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;m&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;&amp;lt;-&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;n&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;recvc&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;
        &lt;span class=&#34;nx&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;Step&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;m&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
    &lt;span class=&#34;k&#34;&gt;case&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;cc&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;&amp;lt;-&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;n&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;confc&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;
        &lt;span class=&#34;c1&#34;&gt;// Add/remove/update node according to cc.Type
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;    &lt;span class=&#34;k&#34;&gt;case&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;&amp;lt;-&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;n&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;tickc&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;
        &lt;span class=&#34;nx&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;tick&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;
    &lt;span class=&#34;k&#34;&gt;case&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;readyc&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;rd&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;
        &lt;span class=&#34;c1&#34;&gt;// Cleaning after result is consumed by application
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;    &lt;span class=&#34;k&#34;&gt;case&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;&amp;lt;-&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;advancec&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;
        &lt;span class=&#34;c1&#34;&gt;// Stablize logs
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;    &lt;span class=&#34;k&#34;&gt;case&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;c&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;&amp;lt;-&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;n&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;status&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;
        &lt;span class=&#34;c1&#34;&gt;// Update status
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;    &lt;span class=&#34;k&#34;&gt;case&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;&amp;lt;-&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;n&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;stop&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;
        &lt;span class=&#34;nb&#34;&gt;close&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;n&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;done&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
        &lt;span class=&#34;k&#34;&gt;return&lt;/span&gt;
    &lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;&lt;code&gt;propc&lt;/code&gt;å’Œ&lt;code&gt;recvc&lt;/code&gt;ä¸­æ‹¿åˆ°çš„æ˜¯ä»ä¸Šå±‚åº”ç”¨ä¼ è¿›æ¥çš„æ¶ˆæ¯ï¼Œè¿™ä¸ªæ¶ˆæ¯ä¼šè¢«äº¤ç»™raftå±‚çš„&lt;code&gt;Step&lt;/code&gt;å‡½æ•°å¤„ç†ï¼Œå…·ä½“å¤„ç†é€»è¾‘æˆ‘ä¸Šé¢æœ‰è¿‡ä»‹ç»ã€‚&lt;/p&gt;

&lt;p&gt;ä¸‹é¢æ¥è§£é‡Šä¸‹&lt;code&gt;readyc&lt;/code&gt;çš„ä½œç”¨ã€‚åœ¨etcdçš„è¿™ä¸ªå®ç°ä¸­ï¼Œ&lt;code&gt;node&lt;/code&gt;å¹¶ä¸è´Ÿè´£æ•°æ®çš„æŒä¹…åŒ–ã€ç½‘ç»œæ¶ˆæ¯çš„é€šä¿¡ã€ä»¥åŠå°†å·²ç»æäº¤çš„logåº”ç”¨åˆ°çŠ¶æ€æœºä¸­ï¼Œæ‰€ä»¥&lt;code&gt;node&lt;/code&gt;ä½¿ç”¨&lt;code&gt;readyc&lt;/code&gt;è¿™ä¸ª&lt;code&gt;channel&lt;/code&gt;å¯¹å¤–é€šçŸ¥æœ‰æ•°æ®è¦å¤„ç†äº†ï¼Œå¹¶å°†è¿™äº›éœ€è¦å¤–éƒ¨å¤„ç†çš„æ•°æ®æ‰“åŒ…åˆ°ä¸€ä¸ª&lt;code&gt;Ready&lt;/code&gt;ç»“æ„ä½“ä¸­ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;lnt&#34;&gt; 1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 2
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 3
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 4
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 5
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 6
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 7
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 8
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 9
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;10
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;11
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;12
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;13
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;14
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;15
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;16
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;17
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;18
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;19
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;20
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;21
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;22
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;23
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;24
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;25
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;26
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;27
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;28
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;29
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;30
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;31
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;32
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;33
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;34
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;35
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;36
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;37
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;38
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;39
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;40
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;41
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;42
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;43
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;c1&#34;&gt;// https://github.com/etcd-io/etcd/blob/v3.3.10/raft/node.go#L52
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// Ready encapsulates the entries and messages that are ready to read,
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// be saved to stable storage, committed or sent to other peers.
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// All fields in Ready are read-only.
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;type&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;Ready&lt;/span&gt; &lt;span class=&#34;kd&#34;&gt;struct&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
    &lt;span class=&#34;c1&#34;&gt;// The current volatile state of a Node.
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;    &lt;span class=&#34;c1&#34;&gt;// SoftState will be nil if there is no update.
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;    &lt;span class=&#34;c1&#34;&gt;// It is not required to consume or store SoftState.
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;    &lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;SoftState&lt;/span&gt;

    &lt;span class=&#34;c1&#34;&gt;// The current state of a Node to be saved to stable storage BEFORE
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;    &lt;span class=&#34;c1&#34;&gt;// Messages are sent.
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;    &lt;span class=&#34;c1&#34;&gt;// HardState will be equal to empty state if there is no update.
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;    &lt;span class=&#34;nx&#34;&gt;pb&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;HardState&lt;/span&gt;

    &lt;span class=&#34;c1&#34;&gt;// ReadStates can be used for node to serve linearizable read requests locally
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;    &lt;span class=&#34;c1&#34;&gt;// when its applied index is greater than the index in ReadState.
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;    &lt;span class=&#34;c1&#34;&gt;// Note that the readState will be returned when raft receives msgReadIndex.
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;    &lt;span class=&#34;c1&#34;&gt;// The returned is only valid for the request that requested to read.
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;    &lt;span class=&#34;nx&#34;&gt;ReadStates&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;[]&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;ReadState&lt;/span&gt;

    &lt;span class=&#34;c1&#34;&gt;// Entries specifies entries to be saved to stable storage BEFORE
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;    &lt;span class=&#34;c1&#34;&gt;// Messages are sent.
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;    &lt;span class=&#34;nx&#34;&gt;Entries&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;[]&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;pb&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Entry&lt;/span&gt;

    &lt;span class=&#34;c1&#34;&gt;// Snapshot specifies the snapshot to be saved to stable storage.
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;    &lt;span class=&#34;nx&#34;&gt;Snapshot&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;pb&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Snapshot&lt;/span&gt;

    &lt;span class=&#34;c1&#34;&gt;// CommittedEntries specifies entries to be committed to a
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;    &lt;span class=&#34;c1&#34;&gt;// store/state-machine. These have previously been committed to stable
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;    &lt;span class=&#34;c1&#34;&gt;// store.
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;    &lt;span class=&#34;nx&#34;&gt;CommittedEntries&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;[]&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;pb&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Entry&lt;/span&gt;

    &lt;span class=&#34;c1&#34;&gt;// Messages specifies outbound messages to be sent AFTER Entries are
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;    &lt;span class=&#34;c1&#34;&gt;// committed to stable storage.
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;    &lt;span class=&#34;c1&#34;&gt;// If it contains a MsgSnap message, the application MUST report back to raft
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;    &lt;span class=&#34;c1&#34;&gt;// when the snapshot has been received or has failed by calling ReportSnapshot.
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;    &lt;span class=&#34;nx&#34;&gt;Messages&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;[]&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;pb&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Message&lt;/span&gt;

    &lt;span class=&#34;c1&#34;&gt;// MustSync indicates whether the HardState and Entries must be synchronously
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;    &lt;span class=&#34;c1&#34;&gt;// written to disk or if an asynchronous write is permissible.
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;    &lt;span class=&#34;nx&#34;&gt;MustSync&lt;/span&gt; &lt;span class=&#34;kt&#34;&gt;bool&lt;/span&gt;
&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;åº”ç”¨ç¨‹åºå¾—åˆ°è¿™ä¸ª&lt;code&gt;Ready&lt;/code&gt;ä¹‹åï¼Œéœ€è¦ï¼š&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;å°†HardState, Entries, SnapshotæŒä¹…åŒ–åˆ°storageã€‚&lt;/li&gt;
&lt;li&gt;å°†Messageså¹¿æ’­ç»™å…¶ä»–èŠ‚ç‚¹ã€‚&lt;/li&gt;
&lt;li&gt;å°†CommittedEntriesï¼ˆå·²ç»commitè¿˜æ²¡æœ‰applyï¼‰åº”ç”¨åˆ°çŠ¶æ€æœºã€‚&lt;/li&gt;
&lt;li&gt;å¦‚æœå‘ç°CommittedEntriesä¸­æœ‰æˆå‘˜å˜æ›´ç±»å‹çš„entryï¼Œè°ƒç”¨&lt;code&gt;node.ApplyConfChange()&lt;/code&gt;æ–¹æ³•è®©&lt;code&gt;node&lt;/code&gt;çŸ¥é“ã€‚&lt;/li&gt;
&lt;li&gt;æœ€åå†è°ƒç”¨&lt;code&gt;node.Advance()&lt;/code&gt;å‘Šè¯‰raftï¼Œè¿™æ‰¹çŠ¶æ€æ›´æ–°å¤„ç†å®Œäº†ï¼ŒçŠ¶æ€å·²ç»æ¼”è¿›äº†ï¼Œå¯ä»¥ç»™æˆ‘ä¸‹ä¸€æ‰¹Readyè®©æˆ‘å¤„ç†ã€‚&lt;/li&gt;
&lt;/ol&gt;

&lt;h1 id=&#34;life-of-a-request&#34;&gt;Life of a Request&lt;/h1&gt;

&lt;p&gt;å‰é¢æˆ‘ä»¬æŠŠæ•´ä¸ªåŒ…çš„ç»“æ„è¿‡äº†ä¸€éï¼Œä¸‹é¢æ¥ç»“åˆå…·ä½“çš„ä»£ç çœ‹çœ‹raftå¯¹ä¸€ä¸ªè¯·æ±‚çš„å¤„ç†è¿‡ç¨‹æ˜¯æ€æ ·çš„ã€‚æˆ‘ä¸€ç›´è§‰å¾—ï¼Œå¦‚æœèƒ½ä»ä»£ç çš„å±‚é¢è¿½è¸ªåˆ°ä¸€ä¸ªè¯·æ±‚çš„å¤„ç†è¿‡ç¨‹ï¼Œé‚£æ— è®ºæ˜¯ä»å®è§‚è¿˜æ˜¯å¾®è§‚çš„è§’åº¦ï¼Œå¯¹ç†è§£æ•´ä¸ªç³»ç»Ÿéƒ½æ˜¯éå¸¸æœ‰å¸®åŠ©çš„ã€‚&lt;/p&gt;

&lt;h2 id=&#34;life-of-a-vote-request&#34;&gt;Life of a Vote Request&lt;/h2&gt;

&lt;ol&gt;
&lt;li&gt;&lt;p&gt;é¦–å…ˆï¼Œåœ¨&lt;code&gt;node&lt;/code&gt;çš„å¤§å¾ªç¯é‡Œï¼Œæœ‰ä¸€ä¸ªä¼šå®šæ—¶è¾“å‡ºçš„&lt;code&gt;tick channel&lt;/code&gt;ï¼Œå®ƒæ¥è§¦å‘&lt;code&gt;raft.tick()&lt;/code&gt;å‡½æ•°ï¼Œæ ¹æ®ä¸Šé¢çš„ä»‹ç»å¯çŸ¥ï¼Œå¦‚æœå½“å‰èŠ‚ç‚¹æ˜¯followerï¼Œé‚£å®ƒçš„&lt;code&gt;tick&lt;/code&gt;å‡½æ•°ä¼šæŒ‡å‘&lt;code&gt;tickElection&lt;/code&gt;ã€‚&lt;code&gt;tickElection&lt;/code&gt;çš„å¤„ç†é€»è¾‘æ˜¯ç»™è‡ªå·±å‘é€ä¸€ä¸ª&lt;code&gt;MsgHup&lt;/code&gt;çš„å†…éƒ¨æ¶ˆæ¯ï¼Œ&lt;code&gt;Step&lt;/code&gt;å‡½æ•°çœ‹åˆ°è¿™ä¸ªæ¶ˆæ¯åä¼šè°ƒç”¨&lt;code&gt;campaign&lt;/code&gt;å‡½æ•°ï¼Œè¿›å…¥ç«é€‰çŠ¶æ€ã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;lnt&#34;&gt; 1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 2
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 3
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 4
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 5
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 6
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 7
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 8
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 9
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;10
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;11
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;12
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;13
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;14
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;15
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;16
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;17
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;c1&#34;&gt;// tickElection is run by followers and candidates after r.electionTimeout.
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;func&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;r&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;raft&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;tickElection&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
    &lt;span class=&#34;nx&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;electionElapsed&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;++&lt;/span&gt;

    &lt;span class=&#34;k&#34;&gt;if&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;promotable&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;pastElectionTimeout&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
        &lt;span class=&#34;nx&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;electionElapsed&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;
        &lt;span class=&#34;nx&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;Step&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;pb&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Message&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;From&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;id&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;Type&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;pb&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;MsgHup&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;})&lt;/span&gt;
    &lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;

&lt;span class=&#34;kd&#34;&gt;func&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;r&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;raft&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;Step&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;m&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;pb&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Message&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;kt&#34;&gt;error&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
    &lt;span class=&#34;c1&#34;&gt;//...
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;    &lt;span class=&#34;k&#34;&gt;switch&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;m&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Type&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
    &lt;span class=&#34;k&#34;&gt;case&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;pb&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;MsgHup&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;
        &lt;span class=&#34;nx&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;campaign&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;campaignElection&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
    &lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;ol&gt;
&lt;li&gt;&lt;code&gt;campaign&lt;/code&gt;åˆ™ä¼šè°ƒç”¨&lt;code&gt;becomeCandidate&lt;/code&gt;æŠŠè‡ªå·±åˆ‡æ¢åˆ°candidateæ¨¡å¼ï¼Œå¹¶é€’å¢&lt;code&gt;Term&lt;/code&gt;å€¼ã€‚ç„¶åå†å°†è‡ªå·±çš„&lt;code&gt;Term&lt;/code&gt;åŠæ—¥å¿—ä¿¡æ¯å‘é€ç»™å…¶ä»–çš„èŠ‚ç‚¹ï¼Œè¯·æ±‚æŠ•ç¥¨ã€‚&lt;/li&gt;
&lt;/ol&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;lnt&#34;&gt;1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;2
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;3
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;4
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;5
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;6
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;7
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;8
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;9
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;kd&#34;&gt;func&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;r&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;raft&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;campaign&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;t&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;CampaignType&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
    &lt;span class=&#34;c1&#34;&gt;//...
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;    &lt;span class=&#34;nx&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;becomeCandidate&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;
    &lt;span class=&#34;c1&#34;&gt;// Get peer id from progress
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;    &lt;span class=&#34;k&#34;&gt;for&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;id&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;range&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;prs&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
        &lt;span class=&#34;c1&#34;&gt;//...
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;        &lt;span class=&#34;nx&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;send&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;pb&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Message&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Term&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;term&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;To&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;id&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;Type&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;voteMsg&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;Index&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;raftLog&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;lastIndex&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(),&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;LogTerm&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;raftLog&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;lastTerm&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(),&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;Context&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;ctx&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;})&lt;/span&gt;
    &lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;å¦ä¸€æ–¹é¢ï¼Œå…¶ä»–èŠ‚ç‚¹åœ¨æ¥å—åˆ°è¿™ä¸ªè¯·æ±‚åï¼Œä¼šé¦–å…ˆæ¯”è¾ƒæ¥æ”¶åˆ°çš„&lt;code&gt;Term&lt;/code&gt;æ˜¯ä¸æ˜¯æ¯”è‡ªå·±çš„å¤§ï¼Œä»¥åŠæ¥å—åˆ°çš„æ—¥å¿—ä¿¡æ¯æ˜¯ä¸æ˜¯æ¯”è‡ªå·±çš„è¦æ–°ï¼Œä»è€Œå†³å®šæ˜¯å¦æŠ•ç¥¨ã€‚è¿™ä¸ªé€»è¾‘æˆ‘ä»¬è¿˜æ˜¯å¯ä»¥ä»&lt;code&gt;Step&lt;/code&gt;å‡½æ•°ä¸­æ‰¾åˆ°ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;lnt&#34;&gt; 1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 2
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 3
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 4
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 5
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 6
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 7
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 8
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 9
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;10
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;11
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;12
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;13
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;14
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;15
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;16
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;17
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;18
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;kd&#34;&gt;func&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;r&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;raft&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;Step&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;m&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;pb&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Message&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;kt&#34;&gt;error&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
    &lt;span class=&#34;c1&#34;&gt;//...
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;    &lt;span class=&#34;k&#34;&gt;switch&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;m&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Type&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
    &lt;span class=&#34;k&#34;&gt;case&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;pb&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;MsgVote&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;pb&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;MsgPreVote&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;
        &lt;span class=&#34;c1&#34;&gt;// We can vote if this is a repeat of a vote we&amp;#39;ve already cast...
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;        &lt;span class=&#34;nx&#34;&gt;canVote&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Vote&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;==&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;m&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;From&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;||&lt;/span&gt;
            &lt;span class=&#34;c1&#34;&gt;// ...we haven&amp;#39;t voted and we don&amp;#39;t think there&amp;#39;s a leader yet in this term...
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;            &lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Vote&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;==&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;None&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;lead&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;==&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;None&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;||&lt;/span&gt;
            &lt;span class=&#34;c1&#34;&gt;// ...or this is a PreVote for a future term...
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;            &lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;m&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Type&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;==&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;pb&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;MsgPreVote&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;m&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Term&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Term&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
        &lt;span class=&#34;c1&#34;&gt;// ...and we believe the candidate is up to date.
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;        &lt;span class=&#34;k&#34;&gt;if&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;canVote&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;raftLog&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;isUpToDate&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;m&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Index&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;m&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;LogTerm&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
            &lt;span class=&#34;nx&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;send&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;pb&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Message&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;To&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;m&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;From&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;Term&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;m&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Term&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;Type&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;voteRespMsgType&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;m&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Type&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)})&lt;/span&gt;
        &lt;span class=&#34;p&#34;&gt;}&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;else&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
            &lt;span class=&#34;nx&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;send&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;pb&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Message&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;To&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;m&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;From&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;Term&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Term&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;Type&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;voteRespMsgType&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;m&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Type&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;Reject&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;kc&#34;&gt;true&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;})&lt;/span&gt;
        &lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
    &lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;ol&gt;
&lt;li&gt;æœ€åå½“candidateèŠ‚ç‚¹æ”¶åˆ°æŠ•ç¥¨å›å¤åï¼Œå°±ä¼šè®¡ç®—æ”¶åˆ°çš„é€‰ç¥¨æ•°ç›®æ˜¯å¦å¤§äºæ‰€æœ‰èŠ‚ç‚¹æ•°çš„ä¸€åŠï¼Œå¦‚æœå¤§äºåˆ™è‡ªå·±æˆä¸ºleaderï¼Œå¹¶æ˜­å‘Šå¤©ä¸‹ï¼Œå¦åˆ™å°†è‡ªå·±ç½®ä¸ºfollowerï¼š&lt;/li&gt;
&lt;/ol&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;lnt&#34;&gt; 1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 2
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 3
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 4
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 5
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 6
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 7
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 8
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 9
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;10
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;11
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;12
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;13
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;14
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;15
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;16
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;17
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;kd&#34;&gt;func&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;r&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;raft&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;Step&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;m&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;pb&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Message&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;kt&#34;&gt;error&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
    &lt;span class=&#34;c1&#34;&gt;//...
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;    &lt;span class=&#34;k&#34;&gt;switch&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;m&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Type&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
    &lt;span class=&#34;k&#34;&gt;case&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;myVoteRespType&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;
        &lt;span class=&#34;nx&#34;&gt;gr&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;poll&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;m&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;From&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;m&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Type&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;!&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;m&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Reject&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
        &lt;span class=&#34;k&#34;&gt;switch&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;quorum&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
        &lt;span class=&#34;k&#34;&gt;case&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;gr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;
            &lt;span class=&#34;k&#34;&gt;if&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;state&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;==&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;StatePreCandidate&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
                &lt;span class=&#34;nx&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;campaign&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;campaignElection&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
            &lt;span class=&#34;p&#34;&gt;}&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;else&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
                &lt;span class=&#34;nx&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;becomeLeader&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;
                &lt;span class=&#34;nx&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;bcastAppend&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;
            &lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
        &lt;span class=&#34;k&#34;&gt;case&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;len&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;votes&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;-&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;gr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;
            &lt;span class=&#34;nx&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;becomeFollower&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Term&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;None&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
    &lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;/li&gt;
&lt;/ol&gt;

&lt;h2 id=&#34;life-of-a-write-request&#34;&gt;Life of a Write Request&lt;/h2&gt;

&lt;ol&gt;
&lt;li&gt;ä¸€ä¸ªå†™è¯·æ±‚ä¸€èˆ¬ä¼šé€šè¿‡è°ƒç”¨&lt;code&gt;node.Propose&lt;/code&gt;å¼€å§‹ï¼Œ&lt;code&gt;Propose&lt;/code&gt;æ–¹æ³•å°†è¿™ä¸ªå†™è¯·æ±‚å°è£…åˆ°ä¸€ä¸ª&lt;code&gt;MsgProp&lt;/code&gt;æ¶ˆæ¯é‡Œé¢ï¼Œå‘é€ç»™è‡ªå·±å¤„ç†ã€‚&lt;/li&gt;

&lt;li&gt;&lt;p&gt;æ¶ˆæ¯å¤„ç†å‡½æ•°&lt;code&gt;Step&lt;/code&gt;æ— æ³•ç›´æ¥å¤„ç†è¿™ä¸ªæ¶ˆæ¯ï¼Œå®ƒä¼šè°ƒç”¨é‚£ä¸ªå°å†™çš„&lt;code&gt;step&lt;/code&gt;å‡½æ•°ï¼Œæ¥æ ¹æ®å½“å‰çš„çŠ¶æ€è¿›è¡Œå¤„ç†ã€‚&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;å¦‚æœå½“å‰æ˜¯followerï¼Œé‚£å®ƒä¼šæŠŠè¿™ä¸ªæ¶ˆæ¯è½¬å‘ç»™leaderã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;lnt&#34;&gt;1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;2
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;3
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;4
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;5
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;6
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;7
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;8
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;kd&#34;&gt;func&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;stepFollower&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;r&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;raft&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;m&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;pb&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Message&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;kt&#34;&gt;error&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
    &lt;span class=&#34;k&#34;&gt;switch&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;m&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Type&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
    &lt;span class=&#34;k&#34;&gt;case&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;pb&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;MsgProp&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;
        &lt;span class=&#34;c1&#34;&gt;//...
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;        &lt;span class=&#34;nx&#34;&gt;m&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;To&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;lead&lt;/span&gt;
        &lt;span class=&#34;nx&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;send&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;m&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
    &lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;ol&gt;
&lt;li&gt;Leaderæ”¶åˆ°è¿™ä¸ªæ¶ˆæ¯åï¼ˆä¸ç®¡æ˜¯followerè½¬å‘è¿‡æ¥çš„è¿˜æ˜¯è‡ªå·±å†…éƒ¨äº§ç”Ÿçš„ï¼‰ä¼šæœ‰ä¸¤æ­¥æ“ä½œï¼š&lt;/li&gt;
&lt;li&gt;å°†è¿™ä¸ªæ¶ˆæ¯æ·»åŠ åˆ°è‡ªå·±çš„logé‡Œ&lt;/li&gt;
&lt;li&gt;å‘å…¶ä»–followerå¹¿æ’­è¿™ä¸ªæ¶ˆæ¯&lt;/li&gt;
&lt;/ol&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;lnt&#34;&gt; 1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 2
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 3
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 4
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 5
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 6
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 7
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 8
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 9
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;10
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;11
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;kd&#34;&gt;func&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;stepLeader&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;r&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;raft&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;m&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;pb&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Message&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;kt&#34;&gt;error&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
    &lt;span class=&#34;k&#34;&gt;switch&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;m&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Type&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
    &lt;span class=&#34;k&#34;&gt;case&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;pb&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;MsgProp&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;
        &lt;span class=&#34;c1&#34;&gt;//...
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;        &lt;span class=&#34;k&#34;&gt;if&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;!&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;appendEntry&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;m&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Entries&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;...&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
            &lt;span class=&#34;k&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;ErrProposalDropped&lt;/span&gt;
        &lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
        &lt;span class=&#34;nx&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;bcastAppend&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;
        &lt;span class=&#34;k&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;kc&#34;&gt;nil&lt;/span&gt;
    &lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;åœ¨followeræ¥å—å®Œè¿™ä¸ªlogåï¼Œä¼šè¿”å›ä¸€ä¸ª&lt;code&gt;MsgAppResp&lt;/code&gt;æ¶ˆæ¯ã€‚&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;å½“leaderç¡®è®¤å·²ç»æœ‰è¶³å¤Ÿå¤šçš„followeræ¥å—äº†è¿™ä¸ªlogåï¼Œå®ƒé¦–å…ˆä¼šcommitè¿™ä¸ªlogï¼Œç„¶åå†å¹¿æ’­ä¸€æ¬¡ï¼Œå‘Šè¯‰åˆ«äººå®ƒçš„commitçŠ¶æ€ã€‚è¿™é‡Œçš„å®ç°å°±æœ‰ç‚¹åƒä¸¤é˜¶æ®µæäº¤äº†ã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;lnt&#34;&gt; 1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 2
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 3
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 4
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 5
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 6
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 7
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 8
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 9
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;10
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;11
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;12
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;13
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;14
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;15
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;16
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;17
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;18
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;19
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;20
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;21
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;22
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;23
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;24
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;25
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;kd&#34;&gt;func&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;stepLeader&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;r&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;raft&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;m&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;pb&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Message&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;kt&#34;&gt;error&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
    &lt;span class=&#34;k&#34;&gt;switch&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;m&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Type&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
    &lt;span class=&#34;k&#34;&gt;case&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;pb&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;MsgAppResp&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;
        &lt;span class=&#34;c1&#34;&gt;//...
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;        &lt;span class=&#34;k&#34;&gt;if&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;maybeCommit&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
            &lt;span class=&#34;nx&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;bcastAppend&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;
        &lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
    &lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;

&lt;span class=&#34;c1&#34;&gt;// maybeCommit attempts to advance the commit index. Returns true if
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// the commit index changed (in which case the caller should call
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// r.bcastAppend).
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;func&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;r&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;raft&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;maybeCommit&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt; &lt;span class=&#34;kt&#34;&gt;bool&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
    &lt;span class=&#34;c1&#34;&gt;//...
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;    &lt;span class=&#34;nx&#34;&gt;mis&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;matchBuf&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[:&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;len&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;prs&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)]&lt;/span&gt;
    &lt;span class=&#34;nx&#34;&gt;idx&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;
    &lt;span class=&#34;k&#34;&gt;for&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;p&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;range&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;prs&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
        &lt;span class=&#34;nx&#34;&gt;mis&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;idx&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;p&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Match&lt;/span&gt;
        &lt;span class=&#34;nx&#34;&gt;idx&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;++&lt;/span&gt;
    &lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
    &lt;span class=&#34;nx&#34;&gt;sort&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;Sort&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;mis&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
    &lt;span class=&#34;nx&#34;&gt;mci&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;mis&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;len&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;mis&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;quorum&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()]&lt;/span&gt;
    &lt;span class=&#34;k&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;raftLog&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;maybeCommit&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;mci&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Term&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;h1 id=&#34;conclusion&#34;&gt;Conclusion&lt;/h1&gt;

&lt;p&gt;Etcdé‡Œçš„raftæ¨¡å—åªå®ç°äº†raftå…±è¯†ç®—æ³•ï¼Œè€Œåƒæ¶ˆæ¯çš„ç½‘ç»œä¼ è¾“ï¼Œæ•°æ®å­˜å‚¨éƒ½ç”±ä¸Šå±‚åº”ç”¨æ¥å®Œæˆã€‚è¿™ç¯‡æ–‡ç« å…ˆä»‹ç»äº†åŸºæœ¬çš„æ•°æ®ç»“æ„ï¼Œç„¶ååœ¨è¿™äº›æ•°æ®ç»“æ„çš„åŸºç¡€ä¸Šå¼•å…¥äº†raftç®—æ³•ã€‚åŒæ—¶ï¼Œè¿™é‡Œè¿˜ä»¥ä¸€ä¸ªæŠ•ç¥¨è¯·æ±‚å’Œå†™è¯·æ±‚ä¸ºä¾‹ï¼Œä»‹ç»äº†ä¸€ä¸ªè¯·æ±‚ä»æ¥å—åˆ°åº”ç­”çš„å®Œæ•´å¤„ç†è¿‡ç¨‹ã€‚&lt;/p&gt;

&lt;p&gt;ä½†åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬è¿˜æœ‰å¾ˆå¤šç»†èŠ‚æ²¡æœ‰æ¶‰åŠï¼Œæ¯”å¦‚è¯´Linearizable Readï¼Œsnapshotæœºåˆ¶ï¼ŒWALçš„å­˜å‚¨ä¸å›æ”¾ï¼Œæ‰€ä»¥å¸Œæœ›ä½ èƒ½ä»¥è¿™ç¯‡æ–‡ç« ä¸ºåŸºç¡€ï¼Œé¡ºè—¤æ‘¸ç“œï¼Œç»§ç»­æ·±å…¥ç ”ç©¶ä¸‹å»ã€‚&lt;/p&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;div class=&#34;footnotes&#34;&gt;

&lt;hr /&gt;

&lt;ol&gt;
&lt;li id=&#34;fn:v3-3-10&#34;&gt;åˆ°å†™è¿™ç¯‡æ–‡ç« ä¸ºæ­¢ï¼Œetcdçš„æœ€æ–°ç‰ˆæœ¬ä¸º&lt;a href=&#34;https://github.com/etcd-io/etcd/tree/v3.3.10&#34;&gt;v3.3.10&lt;/a&gt;ï¼Œæ‰€ä»¥è¿™é‡Œçš„åˆ†æéƒ½æ˜¯ä»¥v3.3.10ä¸ºåŸºç¡€ã€‚
 &lt;a class=&#34;footnote-return&#34; href=&#34;#fnref:v3-3-10&#34;&gt;&lt;sup&gt;[return]&lt;/sup&gt;&lt;/a&gt;&lt;/li&gt;
&lt;li id=&#34;fn:prevote&#34;&gt;&lt;a href=&#34;https://zhesi.io/post/raft_prevote/&#34;&gt;Raftçš„PreVoteå®ç°æœºåˆ¶&lt;/a&gt;
 &lt;a class=&#34;footnote-return&#34; href=&#34;#fnref:prevote&#34;&gt;&lt;sup&gt;[return]&lt;/sup&gt;&lt;/a&gt;&lt;/li&gt;
&lt;li id=&#34;fn:lichuang&#34;&gt;&lt;a href=&#34;https://lichuang.github.io/post/20180922-etcd-raft/&#34;&gt;etcd Raftåº“è§£æ&lt;/a&gt;
 &lt;a class=&#34;footnote-return&#34; href=&#34;#fnref:lichuang&#34;&gt;&lt;sup&gt;[return]&lt;/sup&gt;&lt;/a&gt;&lt;/li&gt;
&lt;li id=&#34;fn:progress-design&#34;&gt;&lt;a href=&#34;https://github.com/etcd-io/etcd/blob/v3.3.10/raft/design.md#progress&#34;&gt;Design spec for Raft Progress&lt;/a&gt;
 &lt;a class=&#34;footnote-return&#34; href=&#34;#fnref:progress-design&#34;&gt;&lt;sup&gt;[return]&lt;/sup&gt;&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;/div&gt;
</description>
      
    </item>
    
    <item>
      <title>æˆ‘æ‰€äº†è§£çš„IBMä¸»æœº</title>
      <link>//blog.betacat.io/post/introduction-to-ibm-mainframe/</link>
      <pubDate>Tue, 16 Oct 2018 17:16:09 +0800</pubDate>
      
      <guid>//blog.betacat.io/post/introduction-to-ibm-mainframe/</guid>
      
        <description>

&lt;p&gt;æˆ‘ç›®å‰çš„å·¥ä½œä¸»è¦æ˜¯è·ŸIBMä¸»æœºæ‰“äº¤é“ï¼Œä½†æ¯æ¬¡å‘åˆ«äººä»‹ç»ä¸»æœºæ—¶ï¼Œæ€»è§‰å¾—å¯¹æ–¹å¾ˆéš¾getåˆ°å®ƒçš„ä»·å€¼ã€‚ä¸€æ–¹é¢æ˜¯å› ä¸ºä¸»æœºè¿™ä¸ªç³»ç»Ÿå¤ªå¤è€ï¼Œåˆç›¸å¯¹å°é—­ï¼Œå®ƒä»èŠ¯ç‰‡ï¼Œåˆ°å­˜å‚¨ï¼Œå†åˆ°æ“ä½œç³»ç»Ÿéƒ½æ˜¯IBMä¸€æ‰‹åŒ…åŠçš„ï¼Œå¤–ç•Œå¾ˆéš¾æ¥è§¦åˆ°è¿™ä¸ªç³»ç»Ÿï¼Œå¦ä¸€æ–¹é¢ä¸€ç›´ä»¥æ¥ä¸»æœºçš„åŠªåŠ›æ–¹å‘éƒ½æ˜¯å¸Œæœ›ä¸€å°æœºå™¨å°±èƒ½æ»¡è¶³ç”¨æˆ·é«˜æ€§èƒ½ï¼Œé«˜å¯ç”¨çš„éœ€æ±‚ï¼Œè¿™è·Ÿç°åœ¨ç”¨å»‰ä»·æœºå™¨æ­å»ºåˆ†å¸ƒå¼é›†ç¾¤çš„å“²å­¦æ˜¯ç›¸å¯¹çš„ï¼Œæ‰€ä»¥åœ¨è¿™æ ·çš„æ—¶ä»£èƒŒæ™¯ä¸‹ï¼Œä¸»æœºå°±æ›´æ˜¾å¾—æ ¼æ ¼ä¸å…¥äº†ã€‚
æˆ‘æ‰“ç®—ç”¨è¿™ç¯‡åšå®¢æ¥ä»‹ç»ä¸€ä¸‹æˆ‘æ‰€äº†è§£çš„ä¸»æœºï¼Œä¹Ÿé¡ºå¸¦æ•´ç†ä¸€ä¸‹è¿™äº›é›¶é›¶ç¢ç¢çš„çŸ¥è¯†ã€‚å½“ç„¶ç”±äºæˆ‘å¹¶æ²¡æœ‰æ¥å—è¿‡ç³»ç»Ÿçš„ä¸»æœºåŸ¹è®­ï¼ŒæŒæ¡çš„æŠ€èƒ½éƒ½æ˜¯ç”±åŒäº‹ä¼ æˆï¼Œå¤–åŠ æŸ¥èµ„æ–™æ‘¸ç´¢å‡ºæ¥çš„ï¼Œæ‰€ä»¥è¿™é‡Œå¦‚æœ‰ç–æ¼æˆ–è€…æè¿°ä¸å½“çš„åœ°æ–¹ï¼Œæ¬¢è¿æŒ‡æ­£ã€‚&lt;/p&gt;

&lt;h2 id=&#34;å†å²åŠç°çŠ¶&#34;&gt;å†å²åŠç°çŠ¶&lt;/h2&gt;

&lt;p&gt;IBMä¸»æœºåˆç§°å¤§å‹æœºï¼ˆMainframeï¼‰ï¼Œæœ€æ—©å¯ä»¥è¿½æº¯åˆ°ä¸Šä¸–çºª60å¹´ä»£IBMç ”å‘çš„&lt;a href=&#34;https://zh.wikipedia.org/wiki/IBM_System/360&#34;&gt;S/360ç³»ç»Ÿ&lt;/a&gt;ï¼Œç»è¿‡åŠä¸ªå¤šä¸–çºªçš„ä¸æ–­æ›´æ–°ï¼ŒIBMçš„ä¸»æœºäº§å“çº¿å·²ç»ä»å½“åˆçš„S/360ã€S/370ã€S/390ï¼Œå‘å±•åˆ°åæ¥çš„z9ã€z10ç³»åˆ—ï¼Œç°åœ¨ï¼ˆ2018ï¼‰å·²ç»GAçš„æœ€æ–°ç‰ˆæœ¬æ˜¯&lt;a href=&#34;https://www.ibm.com/us-en/marketplace/z14&#34;&gt;z14&lt;/a&gt;ï¼š&lt;/p&gt;

&lt;!-- ![z14(zMidas)](/ibm-mainframe/ibm_z14-large.jpg) --&gt;



&lt;div class=&#34;box&#34;&gt;
&lt;figure  itemprop=&#34;associatedMedia&#34;
  itemscope itemtype=&#34;http://schema.org/ImageObject&#34; &gt;
    &lt;div class=&#34;img&#34;&gt;
      &lt;img itemprop=&#34;thumbnail&#34; src=&#34;//blog.betacat.io/image/ibm-mainframe/z14.png&#34; alt=&#34;å……æ»¡ç§‘æŠ€æ„Ÿçš„ z14&#34;/&gt;
    &lt;/div&gt;
    &lt;a href=&#34;//blog.betacat.io/image/ibm-mainframe/z14.png&#34; itemprop=&#34;contentUrl&#34;&gt;&lt;/a&gt;
      &lt;figcaption&gt;
          &lt;p&gt;å……æ»¡ç§‘æŠ€æ„Ÿçš„ z14&lt;/p&gt;
      &lt;/figcaption&gt;
  &lt;/figure&gt;
&lt;/div&gt;


&lt;p&gt;IBMä¸»æœºç›¸æ¯”äºå…¶ä»–è®¡ç®—æœºç³»ç»Ÿï¼Œå…¶ä¸»è¦ç‰¹ç‚¹åœ¨äºå®ƒçš„ &lt;a href=&#34;https://zh.wikipedia.org/wiki/%E5%8F%AF%E9%9D%A0%E6%80%A7%E3%80%81%E5%8F%AF%E7%94%A8%E6%80%A7%E5%92%8C%E5%8F%AF%E7%B6%AD%E8%AD%B7%E6%80%A7&#34;&gt;RAS&lt;/a&gt; (Reliability, Availability, Serviceability é«˜å¯é æ€§ã€é«˜å¯ç”¨æ€§ã€é«˜å¯ç»´æŠ¤æ€§)ã€‚æ›¾ç»æœ‰ç”¨æˆ·åé¦ˆï¼Œåœ¨ä½¿ç”¨ä¸»æœºçš„æ•°åå¹´æ—¶é—´å†…ï¼Œä»æœªå‘ç”Ÿè¿‡å¼‚å¸¸åœæœºäº‹ä»¶ã€‚æ­£æ˜¯å› ä¸ºè¿™äº›æ–¹é¢çš„ä¼˜ç‚¹å’Œå¼ºå¤§çš„å¤„ç†èƒ½åŠ›ï¼Œåˆ°ç°åœ¨ä¸ºæ­¢è¿˜æ²¡æœ‰å…¶ä»–çš„ç³»ç»Ÿå¯ä»¥æ›¿ä»£å®ƒã€‚ä½†ç”±äºæˆæœ¬å·¨å¤§ï¼ˆä¸€å°ä¸»æœºé€šå¸¸ä»¥äº¿ä¸ºè®¡ä»·å•ä½ï¼‰ï¼Œä½¿ç”¨ä¸»æœºç³»ç»Ÿçš„ä¸€èˆ¬ä»¥æ”¿åºœã€é“¶è¡Œã€ä¿é™©å…¬å¸å’Œå¤§å‹åˆ¶é€ ä¼ä¸šä¸ºä¸»ï¼Œå› ä¸ºè¿™äº›æœºæ„å¯¹ä¿¡æ¯çš„ç¨³å®šæ€§å’Œå®‰å…¨æ€§è¦æ±‚å¾ˆé«˜ã€‚å…¨çƒè´¢å¯Œ500å¼ºä¼ä¸šä¸­çš„71%æ˜¯IBMä¸»æœºç”¨æˆ·ï¼Œå…¨çƒä¼ä¸šçº§æ•°æ®æœ‰80%é©»ç•™åœ¨IBMä¸»æœºä¸Š&lt;sup class=&#34;footnote-ref&#34; id=&#34;fnref:market-share&#34;&gt;&lt;a href=&#34;#fn:market-share&#34;&gt;1&lt;/a&gt;&lt;/sup&gt;ã€‚åœ¨æˆ‘å›½ï¼Œä»å¤®è¡Œåˆ°å·¥å†œä¸­å»ºå››å¤§å•†ä¸šé“¶è¡Œï¼Œå…¶æ ¸å¿ƒä¸šåŠ¡å¹³å°éƒ½æ˜¯è·‘åœ¨IBMä¸»æœºä¸Šçš„ï¼ˆå¸Œæœ›é“¶è¡Œèƒ½ç»™ç‚¹åŠ›ï¼Œæ—©æ—¥æ‘†è„±å¯¹å›½å¤–æŠ€æœ¯çš„ä¾èµ–ï¼‰ã€‚&lt;/p&gt;

&lt;p&gt;è¿™é‡Œæœ‰ä¸€ä¸ª z14 çš„å®£ä¼ è§†é¢‘ï¼Œå¸Œæœ›èƒ½ç»™å¤§å®¶å¸¦æ¥ä¸€å®šçš„æ„Ÿæ€§è®¤è¯†ï¼š&lt;/p&gt;


&lt;div style=&#34;position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;&#34;&gt;
  &lt;iframe src=&#34;//www.youtube.com/embed/iCinf0v44Y4&#34; style=&#34;position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;&#34; allowfullscreen title=&#34;YouTube Video&#34;&gt;&lt;/iframe&gt;
&lt;/div&gt;


&lt;h2 id=&#34;ç¡¬ä»¶&#34;&gt;ç¡¬ä»¶&lt;/h2&gt;

&lt;p&gt;æˆ‘å¯¹ç¡¬ä»¶ä¸æ˜¯å¾ˆäº†è§£ï¼Œåªèƒ½åˆ—ä¸¾ä¸€äº›æ•°æ®æ¥è¯´æ˜ä¸»æœºçš„ç¡¬ä»¶æ€§èƒ½ï¼ˆä»¥æœ€æ–°çš„ z14 ä¸ºä¾‹ï¼‰&lt;sup class=&#34;footnote-ref&#34; id=&#34;fnref:performance&#34;&gt;&lt;a href=&#34;#fn:performance&#34;&gt;2&lt;/a&gt;&lt;/sup&gt;ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;14nm åˆ¶é€ å·¥è‰º&lt;/li&gt;
&lt;li&gt;5.2GHz ä¸»é¢‘&lt;/li&gt;
&lt;li&gt;170 é¢—å¤„ç†å™¨&lt;/li&gt;
&lt;li&gt;L1 private cache 128k i, 128k d&lt;/li&gt;
&lt;li&gt;L2 private cache 2 MB i, 4 MB d&lt;/li&gt;
&lt;li&gt;L3 shared cache 128 MB / chip&lt;/li&gt;
&lt;li&gt;L4 shared cache 672 MB / drawer&lt;/li&gt;
&lt;li&gt;æ”¯æŒ 32TB å†…å­˜&lt;/li&gt;
&lt;li&gt;æ”¯æŒ8000ä¸ªè™šæ‹Ÿæœº&lt;/li&gt;
&lt;li&gt;å¯ä»¥æ¨ªå‘æ‰©å±•ï¼ˆscale outï¼‰åˆ°2ç™¾ä¸‡ä¸ªDockerå®¹å™¨&lt;/li&gt;
&lt;/ul&gt;



&lt;div class=&#34;box&#34;&gt;
&lt;figure  itemprop=&#34;associatedMedia&#34;
  itemscope itemtype=&#34;http://schema.org/ImageObject&#34; &gt;
    &lt;div class=&#34;img&#34;&gt;
      &lt;img itemprop=&#34;thumbnail&#34; src=&#34;//blog.betacat.io/image/ibm-mainframe/z14-hardware.jpeg&#34; alt=&#34;ç¡¬ä»¶é…ç½®çš„å‘å±•&#34;/&gt;
    &lt;/div&gt;
    &lt;a href=&#34;//blog.betacat.io/image/ibm-mainframe/z14-hardware.jpeg&#34; itemprop=&#34;contentUrl&#34;&gt;&lt;/a&gt;
      &lt;figcaption&gt;
          &lt;p&gt;ç¡¬ä»¶é…ç½®çš„å‘å±•&lt;/p&gt;
      &lt;/figcaption&gt;
  &lt;/figure&gt;
&lt;/div&gt;


&lt;p&gt;ä¸»æœºçš„ä¸€ä¸ªé²œæ˜çš„ç‰¹è‰²å°±æ˜¯é‡‡ç”¨äº†ä¸­å¤®å¤„ç†å™¨ï¼ˆ&lt;code&gt;CP&lt;/code&gt;ï¼‰ä¸ç³»ç»Ÿè¾…åŠ©å¤„ç†å™¨ï¼ˆ&lt;code&gt;SAP&lt;/code&gt;ï¼ŒSystem Assist Processorï¼‰ç»„æˆï¼Œå…¶æ‰€é‡‡ç”¨çš„CPæ—¢ä¸æ˜¯IBMè‡ªå®¶çš„POWERï¼Œä¹Ÿä¸æ˜¯x86ï¼Œè€Œæ˜¯ä¸€ä¸ªâ€œIBMç‹¬ç«‹è‡ªä¸»â€çš„ï¼ŒåŸºäºz/Architectureä¸»æœºæ¶æ„è€Œå¼€å‘çš„å¤„ç†å™¨ï¼Œå…¶é‡‡ç”¨å¤æ‚æŒ‡ä»¤é›†æ¶æ„ï¼ˆCISCï¼‰ï¼Œæœ‰ä¸€äº›å¤æ‚æŒ‡ä»¤è´Ÿè´£å¾®ç ï¼ˆmillicodeï¼‰æ‰§è¡Œï¼Œä¹Ÿæœ‰ä¸€äº›è¢«åˆ†è§£ä¸ºç±»ä¼¼äºRISCçš„æ“ä½œï¼Œå› æ­¤è™½ç„¶åœ¨æ€»ä½“æ¶æ„ä¸Šæ˜¯CISCï¼Œä½†ä¹Ÿå…¼å…·äº†RISCçš„ä¼˜ç‚¹ã€‚&lt;sup class=&#34;footnote-ref&#34; id=&#34;fnref:cpu-architecture&#34;&gt;&lt;a href=&#34;#fn:cpu-architecture&#34;&gt;3&lt;/a&gt;&lt;/sup&gt;&lt;/p&gt;



&lt;div class=&#34;box&#34;&gt;
&lt;figure  itemprop=&#34;associatedMedia&#34;
  itemscope itemtype=&#34;http://schema.org/ImageObject&#34; 
  style=&#34;max-width:400px&#34; &gt;
    &lt;div class=&#34;img&#34;&gt;
      &lt;img itemprop=&#34;thumbnail&#34; src=&#34;//blog.betacat.io/image/ibm-mainframe/z14-core-chip-spec-sheet-2017.png&#34; alt=&#34;z14 10-core CP chip&#34;/&gt;
    &lt;/div&gt;
    &lt;a href=&#34;//blog.betacat.io/image/ibm-mainframe/z14-core-chip-spec-sheet-2017.png&#34; itemprop=&#34;contentUrl&#34;&gt;&lt;/a&gt;
      &lt;figcaption&gt;
          &lt;p&gt;z14 10-core CP chip&lt;/p&gt;
      &lt;/figcaption&gt;
  &lt;/figure&gt;
&lt;/div&gt;


&lt;p&gt;é™¤æ­¤ä¹‹å¤–ï¼Œä¸»æœºè¿˜å°†ä¸€äº›å¸¸ç”¨çš„è½¯ä»¶æ¨¡å—ç”¨ç¡¬ä»¶å®ç°äº†ï¼Œæ¯”å¦‚ç¡¬ä»¶å‹ç¼©å¡ï¼ˆzEDCï¼‰ï¼Œæ’åºæŒ‡ä»¤ï¼ŒåŠ å¯†æŒ‡ä»¤ï¼Œå‘é‡è¿ç®—æŒ‡ä»¤ç­‰ã€‚è¿™äº›åŸæœ¬éœ€è¦é€šè¿‡è½¯ä»¶æ¨¡æ‹Ÿæ¥å®ç°çš„åŠŸèƒ½ï¼Œç›´æ¥æœ‰äº†å¯¹åº”çš„ç¡¬ä»¶æ”¯æŒï¼Œè¿™ç§éœ¸æ°”çš„è®¾è®¡æ–¹æ³•ï¼Œå¯¹å¹´è½»çš„æˆ‘é€ æˆäº†å·¨å¤§çš„å†²å‡»ã€‚&lt;/p&gt;

&lt;h2 id=&#34;æ“ä½œç³»ç»Ÿ&#34;&gt;æ“ä½œç³»ç»Ÿ&lt;/h2&gt;

&lt;p&gt;ä¸»æœºä¸Šçš„æ“ä½œç³»ç»Ÿå«åš&lt;a href=&#34;https://en.wikipedia.org/wiki/Z/OS&#34;&gt;z/OS&lt;/a&gt;ï¼Œ&lt;code&gt;z&lt;/code&gt;ä»£è¡¨ç»ˆæçš„æ„æ€ã€‚æˆ‘ä»¬éœ€è¦é€šè¿‡ä¸€ä¸ªå«&lt;a href=&#34;https://en.wikipedia.org/wiki/3270_emulator&#34;&gt;3270&lt;/a&gt;çš„ç»ˆç«¯æ¥è¿æ¥å®ƒï¼Œç”±äºè¿™ä¸ªç»ˆç«¯çš„é…è‰²ä»¥ç»¿è‰²ä¸ºä¸»ï¼Œæ‰€ä»¥æˆ‘ä»¬åˆå«å®ƒ&lt;code&gt;å°ç»¿å±&lt;/code&gt;ã€‚è¿™ä¸ªå°ç»¿å±å®åœ¨å¤ªæ˜¾çœ¼äº†ï¼Œæœ‰åŒäº‹æ›¾åœ¨å®œå®¶çš„æ”¶é“¶å°ä¸€çœ¼è®¤å‡ºæ¥è¿‡ï¼Œä¸è¿‡æˆ‘å¾ˆå¥½å¥‡ï¼Œå®œå®¶çš„æ”¶é“¶å‘˜éš¾é“è¿˜è¦æ‡‚æ€ä¹ˆæ“ä½œåº•å±‚çš„z/OSï¼Ÿ&lt;/p&gt;



&lt;div class=&#34;box&#34;&gt;
&lt;figure  itemprop=&#34;associatedMedia&#34;
  itemscope itemtype=&#34;http://schema.org/ImageObject&#34; &gt;
    &lt;div class=&#34;img&#34;&gt;
      &lt;img itemprop=&#34;thumbnail&#34; src=&#34;//blog.betacat.io/image/ibm-mainframe/ispf.png&#34; alt=&#34;å°ç»¿å±&#34;/&gt;
    &lt;/div&gt;
    &lt;a href=&#34;//blog.betacat.io/image/ibm-mainframe/ispf.png&#34; itemprop=&#34;contentUrl&#34;&gt;&lt;/a&gt;
      &lt;figcaption&gt;
          &lt;p&gt;å°ç»¿å±&lt;/p&gt;
      &lt;/figcaption&gt;
  &lt;/figure&gt;
&lt;/div&gt;


&lt;p&gt;ä¸z/OSçš„äº¤äº’è·Ÿç°ä»£ç³»ç»Ÿå¾ˆä¸ä¸€æ ·ï¼Œå®ƒæ˜¯ä¸€ä¸ªç”¨æ–‡æœ¬ç”»å‡ºæ¥çš„ç•Œé¢ï¼ˆå¦‚ä¸Šå›¾ï¼‰ï¼Œå¯ä»¥åœ¨ç•Œé¢çš„ä¸åŒä½ç½®è¾“å…¥ä¸åŒçš„å‘½ä»¤æ¥å®Œæˆä¸åŒçš„åŠŸèƒ½ã€‚æ¯”å¦‚è¿™é‡Œæˆ‘å¯ä»¥åœ¨&lt;code&gt;Option ===&amp;gt;&lt;/code&gt;é‚£ä¸€æ é€šè¿‡è¾“å…¥menuä¹‹å‰çš„æ•°å­—æˆ–è€…å­—æ¯æ¥è¿›å…¥ç›¸åº”menuã€‚å¦å¤–çš„ä¸€äº›åŠŸèƒ½åˆ™éœ€è¦é€šè¿‡&lt;code&gt;fn&lt;/code&gt;é”®æ¥å®Œæˆï¼Œæ¯”å¦‚&lt;code&gt;F3&lt;/code&gt;æ˜¯è¿”å›ï¼Œ&lt;code&gt;F8&lt;/code&gt;æ˜¯å‘ä¸‹æ»šå±ï¼Œ&lt;code&gt;F7&lt;/code&gt;æ˜¯å‘ä¸Šæ»šå±ã€‚&lt;/p&gt;

&lt;h3 id=&#34;æ–‡ä»¶ç³»ç»Ÿ&#34;&gt;æ–‡ä»¶ç³»ç»Ÿ&lt;/h3&gt;

&lt;p&gt;åœ¨z/OSé‡Œï¼Œæ–‡ä»¶å«åš&lt;code&gt;DataSet&lt;/code&gt;ï¼Œå®ƒä¹Ÿæœ‰å¥½å¤šç§ç±»ï¼Œå…¶ä¸­æœ€å¸¸è§çš„æ˜¯è¿™3ç§ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;Sequential - æœ‰ç‚¹ç±»ä¼¼æ•°æ®ç»“æ„é‡Œçš„&lt;code&gt;Array&lt;/code&gt;ï¼ŒæŒ‰é¡ºåºæ’æ”¾çš„æ•°æ®é›†ï¼Œé¡ºåºè¯»å†™æ•ˆç‡é«˜ï¼Œä½†éšæœºè¯»å†™æ•ˆç‡å°±ä¸è¡Œäº†ã€‚&lt;/li&gt;
&lt;li&gt;Partitioned - æœ‰ç‚¹ç±»ä¼¼æ–‡ä»¶å¤¹çš„æ¦‚å¿µï¼Œå®ƒé‡Œé¢çš„æ•°æ®é›†å«åšmemberã€‚&lt;/li&gt;
&lt;li&gt;VSAM - æœ‰ç‚¹ç±»ä¼¼&lt;code&gt;map&lt;/code&gt;ï¼Œæ”¯æŒé€šè¿‡&lt;code&gt;key&lt;/code&gt;æ¥å»ºç«‹è®¿é—®ç´¢å¼•ã€‚&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;åŒæ ·ä¸ç°ä»£çš„æµå¼æ–‡ä»¶ç³»ç»Ÿä¸ä¸€æ ·ï¼ŒDataSetæ˜¯åŸºäºrecordçš„ï¼Œæ¯æ¬¡è¯»å’Œå†™éƒ½åªèƒ½ä»¥recordä¸ºå•ä½ï¼Œè¿™é‡Œå°±æœ‰ä¸€ä¸ªå¾ˆå®¹æ˜“ç¢°åˆ°çš„å‘ï¼Œå¦‚æœä¸€æ¬¡å†™æ“ä½œçš„æ•°æ®é‡è¶…è¿‡äº†ä¸€ä¸ªrecordçš„é•¿åº¦ï¼Œé‚£è¶…è¿‡éƒ¨åˆ†ä¼šè¢«æˆªæ‰ï¼Œå¹¶ä¸”æ²¡æœ‰ä»»ä½•æç¤ºçš„ï¼Œå¦‚æœæ€»çš„å†™å…¥é‡è¶…è¿‡äº†è¿™ä¸ªDataSetåˆ›å»ºæ—¶åˆ†é…çš„å¤§å°ï¼Œé‚£è¶…è¿‡éƒ¨åˆ†ä¹Ÿä¼šè¢«æ— æƒ…çš„æˆªæ‰ğŸ˜ªã€‚æ‰€ä»¥æ¯æ¬¡åˆ›å»ºDataSetçš„æ—¶å€™ï¼Œæˆ‘ä»¬éƒ½è¦é¢„å…ˆè®¾å¥½å®ƒçš„å„ç§å±æ€§ï¼ˆè¿™å…¶ä¸­çš„å¤§éƒ¨åˆ†ç»†èŠ‚éƒ½è¢«ç°ä»£çš„æ–‡ä»¶ç³»ç»Ÿç”¨&lt;a href=&#34;https://zh.wikipedia.org/wiki/Inode&#34;&gt;inode&lt;/a&gt;ç»™éšè—èµ·æ¥äº†ï¼‰ã€‚&lt;/p&gt;



&lt;div class=&#34;box&#34;&gt;
&lt;figure  itemprop=&#34;associatedMedia&#34;
  itemscope itemtype=&#34;http://schema.org/ImageObject&#34; &gt;
    &lt;div class=&#34;img&#34;&gt;
      &lt;img itemprop=&#34;thumbnail&#34; src=&#34;//blog.betacat.io/image/ibm-mainframe/allocate-dataset.png&#34; alt=&#34;åˆ›å»ºä¸€ä¸ªDataSetæ—¶å¯é€‰çš„å‚æ•°&#34;/&gt;
    &lt;/div&gt;
    &lt;a href=&#34;//blog.betacat.io/image/ibm-mainframe/allocate-dataset.png&#34; itemprop=&#34;contentUrl&#34;&gt;&lt;/a&gt;
      &lt;figcaption&gt;
          &lt;p&gt;åˆ›å»ºä¸€ä¸ªDataSetæ—¶å¯é€‰çš„å‚æ•°&lt;/p&gt;
      &lt;/figcaption&gt;
  &lt;/figure&gt;
&lt;/div&gt;


&lt;p&gt;DataSetçš„åå­—ç”¨ç‚¹(&lt;code&gt;.&lt;/code&gt;)ä½œä¸ºåˆ†éš”ç¬¦ï¼Œä¸€èˆ¬æ¥è¯´æ•´ä¸ªz/OSçš„æ–‡ä»¶ç³»ç»Ÿéƒ½æ˜¯æ‰å¹³åŒ–çš„ï¼Œå³ä¸ä¼šå‡ºç°ä¸€ä¸ªæ–‡ä»¶å¤¹é‡Œé¢åµŒå¥—å¥½å‡ å±‚æ–‡ä»¶å¤¹çš„æƒ…å†µï¼Œä¸ºäº†æ–¹ä¾¿åœ¨è¿™ç§ç»“æ„ä¸‹ç»„ç»‡æ–‡ä»¶ï¼Œz/OSæ”¯æŒç”¨&lt;code&gt;?&lt;/code&gt;æˆ–è€…&lt;code&gt;*&lt;/code&gt;æ¥æ¨¡ç³ŠåŒ¹é…ä¸€éƒ¨åˆ†æ–‡ä»¶è·¯å¾„ã€‚è¿˜æœ‰ä¸€ç‚¹å€¼å¾—æåŠçš„æ˜¯ï¼Œå¸¦å•å¼•å·(&lt;code&gt;&#39;&lt;/code&gt;)çš„DataSetæ˜¯ç»å¯¹è·¯å¾„ï¼Œä¸å¸¦å•å¼•å·çš„æ˜¯ç›¸å¯¹è·¯å¾„ï¼Œç›¸å¯¹äºå½“å‰ç”¨æˆ·çš„HOMEï¼ˆzé‡Œé¢å«HLQï¼‰ï¼Œæ‰€ä»¥å¦‚æœæˆ‘è¯´è¦è®¿é—®&lt;code&gt;COBLOG0.JCL&lt;/code&gt;ï¼Œå…¶å®æˆ‘è®¿é—®çš„æ˜¯&lt;code&gt;&#39;MYUSER.COBLOG0.JCL&#39;&lt;/code&gt;ã€‚&lt;/p&gt;

&lt;p&gt;&lt;code&gt;Migrate&lt;/code&gt;æ˜¯å¦ä¸€ä¸ªæœ‰è¶£çš„ç‰¹æ€§ã€‚z/OSä¼šå®šæœŸ&lt;code&gt;Migrate&lt;/code&gt;æ‰é•¿æœŸä¸ç”¨çš„DataSetï¼Œè¿™äº›DataSetä¼šè¢«ç§»åˆ°ä¸€ä¸ªå®¹é‡æ¯”è¾ƒå¤§çš„Tapeä¸Šï¼Œä»¥èŠ‚çº¦å½“å‰æ–‡ä»¶ç³»ç»Ÿçš„ç©ºé—´ï¼Œå½“ä¸‹æ¬¡éœ€è¦ä½¿ç”¨è¿™ä¸ªDataSetçš„æ—¶å€™ï¼Œè¦å…ˆæŠŠä»–&lt;code&gt;Recall&lt;/code&gt;å›æ¥ã€‚è¿™å°±æœ‰ç‚¹ç±»ä¼¼&lt;code&gt;Page Cache&lt;/code&gt;å’Œç£ç›˜çš„å…³ç³»ï¼Œ&lt;code&gt;Page Cache&lt;/code&gt;æ€»é‡å°±é‚£ä¹ˆå¤§ï¼Œåªèƒ½ç”¨æ¥å­˜çƒ­ç‚¹æ•°æ®ï¼Œé‚£äº›å†·æ•°æ®å°±è®©å®ƒå‘†åœ¨ç£ç›˜ï¼Œåˆ°ç”¨çš„æ—¶å€™å†åŠ è½½è¿›æ¥å¥½äº†ã€‚&lt;/p&gt;

&lt;h3 id=&#34;å‘åå…¼å®¹æ€§&#34;&gt;å‘åå…¼å®¹æ€§&lt;/h3&gt;

&lt;p&gt;z/OSçš„å‘åå…¼å®¹æ€§ç®€ç›´å¯ä»¥ç”¨å…¸èŒƒæ¥å½¢å®¹&lt;sup class=&#34;footnote-ref&#34; id=&#34;fnref:quote-of-john&#34;&gt;&lt;a href=&#34;#fn:quote-of-john&#34;&gt;4&lt;/a&gt;&lt;/sup&gt;ï¼Œæ®è¯´ä¸€ä¸ªä¸Šä¸–çºª80å¹´ä»£ç¼–è¯‘å‡ºæ¥çš„ç¨‹åºï¼Œåœ¨ç°åœ¨çš„ä¸»æœºä¸Šä¾ç„¶å¯ä»¥è¿è¡Œã€‚ä½†ä¹Ÿæ­£æ˜¯è¿™ç§ä¸¥è‹›çš„å‘åå…¼å®¹æ€§è®©ä¸»æœºèƒŒä¸Šäº†æ²‰é‡çš„å†å²åŒ…è¢±ï¼Œæ¯”å¦‚ä¸»æœºä¸Šä½¿ç”¨çš„å­—ç¬¦é›†æ˜¯&lt;a href=&#34;https://zh.wikipedia.org/wiki/EBCDIC&#34;&gt;EBCDIC&lt;/a&gt;ï¼Œå®ƒè·ŸASCIIæ˜¯ä¸å…¼å®¹çš„ï¼ˆæ¯”ASCIIæ ‡å‡†å‡ºæ¥çš„è¦æ—©ï¼‰ã€‚ç”¨ç°åœ¨çš„çœ¼å…‰çœ‹ï¼ŒEBCDICæ˜¯ä¸€ç§å¥‡æ€ªçš„ç¼–ç æ ¼å¼ï¼Œå®ƒçš„&lt;code&gt;I&lt;/code&gt;å’Œ&lt;code&gt;J&lt;/code&gt;ã€&lt;code&gt;R&lt;/code&gt;å’Œ&lt;code&gt;S&lt;/code&gt;æ˜¯ä¸è¿ç»­çš„ã€‚è¿™ä¸ªæ ¼å¼æºè‡ªäº&lt;a href=&#34;https://zh.wikipedia.org/wiki/%E6%89%93%E5%AD%94%E5%8D%A1&#34;&gt;æ‰“å­”å¡&lt;/a&gt;æ—¶ä»£ï¼Œé‚£ä¸ªæ—¶ä»£ï¼ŒIBMæ˜¯è®¡ç®—æœºé¢†åŸŸçš„å¤´å·ç©å®¶ï¼Œæ‰€ä»¥ä»–ä»¬åˆ¶å®šçš„ç¼–ç æ ‡å‡†ä¹Ÿå¸Œæœ›èƒ½ä¸è‡ªå·±çš„&lt;code&gt;æ‰“å­”å¡&lt;/code&gt;ç›¸å…¼å®¹&lt;sup class=&#34;footnote-ref&#34; id=&#34;fnref:quote-of-john&#34;&gt;&lt;a href=&#34;#fn:quote-of-john&#34;&gt;4&lt;/a&gt;&lt;/sup&gt;ã€‚&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;//blog.betacat.io/image/ibm-mainframe/ebcdic.png&#34; alt=&#34;EBCDIC Standard&#34; /&gt;&lt;/p&gt;

&lt;p&gt;è¿™ä¸ªåœ¨å½“æ—¶çœ‹æ¥æ— æ¯”æ­£ç¡®çš„å†³å®šå´ç»™ç°åœ¨çš„æˆ‘ä»¬å¸¦æ¥æ— æ•°çš„å‘ï¼Œåœ¨ç§»æ¤x86å¹³å°çš„ç¨‹åºåˆ°ä¸»æœºæ—¶ï¼Œæœ€å¤§çš„éº»çƒ¦å°±åœ¨äºå­—ç¬¦é›†çš„å¤„ç†ã€‚ä½†è¿™ç§å¤‡å—å¼€å‘äººå‘˜åæ§½çš„å‘åå…¼å®¹æ€§å´å¾ˆå—å®¢æˆ·çš„æ¬¢è¿ï¼Œå› ä¸ºå®¢æˆ·çš„è¯‰æ±‚å°±æ˜¯ç¨³å®šå¯é ï¼Œä»–ä»¬å¸Œæœ›åº”ç”¨ç¨‹åºå¼€å‘å®Œäº†ä¹‹åï¼Œä¸åº”è¯¥å› ä¸ºæ“ä½œç³»ç»Ÿçš„å‡çº§è€Œéœ€è¦é‡æ–°å¼€å‘ï¼Œä»è¿™ç‚¹ä¹Ÿå¯ä»¥çœ‹å‡ºIBM&lt;code&gt;å®¢æˆ·è‡³ä¸Š&lt;/code&gt;çš„ç†å¿µã€‚&lt;/p&gt;

&lt;h3 id=&#34;å…¶ä»–ç»„ä»¶&#34;&gt;å…¶ä»–ç»„ä»¶&lt;/h3&gt;

&lt;p&gt;z/OSæ˜¯ä¸€ä¸ªéå¸¸åºå¤§çš„ç³»ç»Ÿï¼Œå®ƒé‡Œé¢åŒ…å«äº†éå¸¸å¤šçš„ç»„ä»¶ï¼Œå…¶ä¸­å¤§å®¶æ¯”è¾ƒç†ŸçŸ¥çš„å¯èƒ½æœ‰&lt;a href=&#34;https://en.wikipedia.org/wiki/CICS&#34;&gt;CICS&lt;/a&gt;å’Œ&lt;a href=&#34;https://en.wikipedia.org/wiki/IBM_Db2_Family&#34;&gt;DB2&lt;/a&gt;ã€‚è¿™é‡Œï¼Œæˆ‘åªä»‹ç»å‡ ä¸ªæˆ‘æ¯”è¾ƒç†Ÿæ‚‰åˆéå¸¸åŸºç¡€çš„ç»„ä»¶ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;p&gt;USS - z/OS Unix System Servicesï¼Œè¿™æ˜¯IBMå¼€å‘çš„ä¸€ä¸ªå…¼å®¹POSIXçš„å­ç³»ç»Ÿï¼Œå®ƒç»™å…¶ä»–Unixå¹³å°çš„ç¨‹åºåœ¨z/OSä¸Šçš„è¿è¡Œå¸¦æ¥äº†å¯èƒ½æ€§ã€‚ä¸€å®¶å«&lt;a href=&#34;http://www.rocketsoftware.com/ported-tools&#34;&gt;Rocket&lt;/a&gt;çš„è½¯ä»¶å…¬å¸å°±æ˜¯é€šè¿‡ç»™z/OSç§»æ¤å¤–ç•Œçš„åº”ç”¨ç¨‹åºè€Œèµ·å®¶çš„ã€‚æœ‰äº†USSçš„æ”¯æŒåï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡&lt;code&gt;ssh&lt;/code&gt;ç™»ä¸Šz/OSï¼Œç”¨&lt;code&gt;bash&lt;/code&gt;æ“ä½œä¸€äº›åŸæœ¬éœ€è¦å°ç»¿å±æ‰èƒ½å®Œæˆçš„æ“ä½œäº†ã€‚&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;JES - Job Entry Subsystemï¼Œåœ¨å°ç»¿å±ä¸Šçš„æ“ä½œå…¶å®æ˜¯å«åšå‰å°æ“ä½œï¼Œè¿™å¯¹ä¸€äº›ç®€å•æˆ–è€…éœ€è¦äººæœºäº¤äº’çš„ä»»åŠ¡æ¥è¯´å¾ˆæœ‰å¿…è¦ã€‚ä½†å¦‚æœä¸€ä¸ªä»»åŠ¡éœ€è¦é•¿æ—¶é—´çš„è¿è¡Œï¼Œè‚¯å®šä¸èƒ½è®©ç”¨æˆ·ä¸€ç›´åœ¨å‰å°å¹²ç­‰ï¼Œæ‰€ä»¥z/OSé‡Œæœ‰JESè¿™ä¸ªå­ç³»ç»Ÿï¼Œå®ƒå¯ä»¥è®©ç”¨æˆ·å°†éœ€è¦é•¿æ—¶é—´è¿è¡Œçš„ç¨‹åºé€šè¿‡Jobçš„å½¢å¼æäº¤è¿›æ¥ï¼Œç„¶ååœ¨åå°è·‘è¿™ä¸ªJobï¼Œå¹¶é€šçŸ¥ç”¨æˆ·æœ€ç»ˆçš„ç»“æœã€‚è¿™é‡Œæäº¤Jobçš„å½¢å¼å°±æ˜¯å†™ä¸€ä¸ª&lt;code&gt;JCL&lt;/code&gt;ï¼ˆJob Control Languageï¼‰ï¼Œå®ƒæä¾›äº†ç±»ä¼¼shellè„šæœ¬çš„åŠŸèƒ½ï¼Œå¯ä»¥è®©ç”¨æˆ·ä½¿ç”¨å„ç§å¾ªç¯åŠåˆ¤æ–­è¯­å¥ã€‚è¿™é‡Œæ˜¯ä¸€ä¸ªç®€å•çš„æ‰¹å¤„ç†JCLï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-jcl&#34; data-lang=&#34;jcl&#34;&gt;&lt;span class=&#34;lnt&#34;&gt;1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;2
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;3
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;4
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-jcl&#34; data-lang=&#34;jcl&#34;&gt;//MYJOB JOB ,NOTIFY=&amp;amp;SYSUID
//STEP1 EXEC PGM=MYPGM
//STEP2 EXEC PGM=MYPGM2
//STEP3 EXEC PGM=MYPGM3&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;ul&gt;
&lt;li&gt;FTP - z/OSä¸Šçš„FTPåŠŸèƒ½ç›¸å½“å¼ºå¤§ï¼Œå®ƒçš„æ“ä½œå¯¹è±¡ä¸ä»…å¯ä»¥æ˜¯DataSetï¼Œä¹Ÿå¯ä»¥æ˜¯USSä¸‹çš„æ–‡ä»¶ç³»ç»Ÿï¼Œç”šè‡³è¿˜å¯ä»¥å‘JESæäº¤Jobï¼Œå‘DB2æäº¤SQLè¯­å¥ã€‚å› æ­¤ï¼Œåœ¨æˆ‘ä»¬çš„ä¸€ä¸ªé¡¹ç›®ä¸­ï¼Œä¸ºäº†ä½¿Node.jsèƒ½ä¸z/OSäº¤äº’ï¼Œæˆ‘ä»¬ç”¨Node.jså°è£…äº†FTPçš„è¿™äº›ç‰¹æ€§ï¼Œå¹¶å¼€æºå‡ºæ¥ä¸€ä¸ªåº“ï¼š&lt;a href=&#34;https://github.com/IBM/zos-node-accessor/&#34;&gt;z/OS Node Accessor&lt;/a&gt;ï¼Œå¸Œæœ›å®ƒèƒ½æˆä¸ºNode.jsç¤¾åŒºä¸z/OSè¿æ¥çš„æ¡¥æ¢ã€‚&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;æ€»ç»“&#34;&gt;æ€»ç»“&lt;/h2&gt;

&lt;p&gt;å†™äº†åŠå¤©æ‰å‘è§‰æˆ‘è¿˜åªä»‹ç»äº†ä¸»æœºçš„å†°å±±ä¸€è§’ï¼Œä¸»æœºç»è¿‡åŠä¸ªå¤šä¸–çºªçš„å‘å±•ï¼Œå®ƒçš„å¤æ‚ç¨‹åº¦è¿œè¿œä¸æ˜¯ä¸€ç¯‡åšå®¢å°±èƒ½ä»‹ç»å®Œçš„ã€‚æ‰€ä»¥è¿™åªèƒ½ç®—æ˜¯ä¸€ä¸ªå…¥é—¨çº§åˆ«çš„ä»‹ç»ï¼Œå¸Œæœ›è¯»å®Œä¹‹åèƒ½è®©ä½ å¯¹ä¸»æœºæœ‰ä¸ªå¤§è‡´çš„äº†è§£ã€‚&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;div class=&#34;footnotes&#34;&gt;

&lt;hr /&gt;

&lt;ol&gt;
&lt;li id=&#34;fn:market-share&#34;&gt;&lt;a href=&#34;https://servers.pconline.com.cn/gc/1202/2679853_3.html&#34;&gt;å¤§å‹æœºå¸‚åœºç°çŠ¶&lt;/a&gt;
 &lt;a class=&#34;footnote-return&#34; href=&#34;#fnref:market-share&#34;&gt;&lt;sup&gt;[return]&lt;/sup&gt;&lt;/a&gt;&lt;/li&gt;
&lt;li id=&#34;fn:performance&#34;&gt;&lt;a href=&#34;https://cloud.tencent.com/developer/news/268909&#34;&gt;æ–°ä¸€ä»£IBM z14ä¸»æœºæŠ€æœ¯ä»‹ç»&lt;/a&gt;
 &lt;a class=&#34;footnote-return&#34; href=&#34;#fnref:performance&#34;&gt;&lt;sup&gt;[return]&lt;/sup&gt;&lt;/a&gt;&lt;/li&gt;
&lt;li id=&#34;fn:cpu-architecture&#34;&gt;&lt;a href=&#34;https://mainframecn.com/article-71-1.html&#34;&gt;æµ…æIBMæ–°ä¸€ä»£zEnterprise Systemå¤§å‹ä¸»æœºçš„è®¾è®¡&lt;/a&gt;
 &lt;a class=&#34;footnote-return&#34; href=&#34;#fnref:cpu-architecture&#34;&gt;&lt;sup&gt;[return]&lt;/sup&gt;&lt;/a&gt;&lt;/li&gt;
&lt;li id=&#34;fn:quote-of-john&#34;&gt;&lt;a href=&#34;https://groups.google.com/d/msg/golang-dev/f6IC8Dm7weI/4Vzs9EY9CAAJ&#34;&gt;John McKown on glang-dev mail-list&lt;/a&gt;
 &lt;a class=&#34;footnote-return&#34; href=&#34;#fnref:quote-of-john&#34;&gt;&lt;sup&gt;[return]&lt;/sup&gt;&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;/div&gt;
</description>
      
    </item>
    
    <item>
      <title>[Practical Guide] How to Extract Main Content From Web Pages Using Machine-Learning</title>
      <link>//blog.betacat.io/post/how-to-extract-main-content-from-web-pages-using-machine-learning/</link>
      <pubDate>Tue, 18 Sep 2018 01:15:57 +0800</pubDate>
      
      <guid>//blog.betacat.io/post/how-to-extract-main-content-from-web-pages-using-machine-learning/</guid>
      
        <description>&lt;p&gt;Following Jupyter Notebook is a step-by-step tutorial I took when making the &lt;a href=&#34;http://hackernews.betacat.io/&#34;&gt;Hacker News Digest&lt;/a&gt;, hope you find it helpful:&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;https://github.com/polyrabbit/hacker-news-digest/blob/master/%5Btutorial%5D%20How-to-extract-main-content-from-web-pages-using-Machine-Learning.ipynb&#34;&gt;How to extract main content from web pages using Machine-Learning&lt;/a&gt;&lt;/p&gt;
</description>
      
    </item>
    
    <item>
      <title>WeCronæ˜¯æ€æ ·å¤„ç†å®šæ—¶ä»»åŠ¡çš„</title>
      <link>//blog.betacat.io/post/how-wecron-schedules/</link>
      <pubDate>Wed, 08 Aug 2018 21:11:37 +0800</pubDate>
      
      <guid>//blog.betacat.io/post/how-wecron-schedules/</guid>
      
        <description>

&lt;p&gt;&lt;a href=&#34;http://wecron.betacat.io/&#34;&gt;WeCron&lt;/a&gt;ï¼ˆå¾®å®šæ—¶ï¼‰æ˜¯æˆ‘å¼€å‘çš„ä¸€ä¸ªå¾®ä¿¡ä¸Šçš„å®šæ—¶æé†’æœºå™¨äººï¼Œå®ƒèƒ½è§£æç”¨æˆ·è¾“å…¥çš„è¯­éŸ³æˆ–è€…æ–‡å­—ï¼Œæå–å…¶ä¸­çš„æ—¶é—´å’Œäº‹ä»¶ä¿¡æ¯ï¼Œç„¶åä¸ºç”¨æˆ·è®¾ç½®æé†’ã€‚è¿™ä¸ªæœåŠ¡ä¸Šçº¿åï¼Œç»å¸¸æœ‰ç”¨æˆ·é—®æˆ‘è¿™é‡Œå®šæ—¶æé†’çš„å®ç°ï¼Œå› æ­¤è¿™ç¯‡æ–‡ç« æˆ‘å°±æ‰“ç®—æ¥è°ˆè°ˆWeCronæ˜¯æ€ä¹ˆå®ç°è¿™ä¸ªåŠŸèƒ½çš„ï¼Œå¸Œæœ›å¤§å®¶ä»¥åè®¾è®¡å®šæ—¶è°ƒåº¦ç±»ç³»ç»Ÿæ—¶èƒ½å¤šä¸€ä¸ªå‚è€ƒã€‚&lt;/p&gt;



&lt;div class=&#34;box&#34;&gt;
&lt;figure  itemprop=&#34;associatedMedia&#34;
  itemscope itemtype=&#34;http://schema.org/ImageObject&#34; 
  style=&#34;max-width:200px&#34; &gt;
    &lt;div class=&#34;img&#34;&gt;
      &lt;img itemprop=&#34;thumbnail&#34; src=&#34;https://user-images.githubusercontent.com/2657334/34242455-7c9ae230-e656-11e7-8420-3da003d87ce5.jpeg&#34; alt=&#34;é€šè¿‡å¾®ä¿¡è®¾ç½®å®šæ—¶æé†’&#34;/&gt;
    &lt;/div&gt;
    &lt;a href=&#34;https://user-images.githubusercontent.com/2657334/34242455-7c9ae230-e656-11e7-8420-3da003d87ce5.jpeg&#34; itemprop=&#34;contentUrl&#34;&gt;&lt;/a&gt;
      &lt;figcaption&gt;
          &lt;p&gt;é€šè¿‡å¾®ä¿¡è®¾ç½®å®šæ—¶æé†’&lt;/p&gt;
      &lt;/figcaption&gt;
  &lt;/figure&gt;
&lt;/div&gt;


&lt;h1 id=&#34;æ¶æ„&#34;&gt;æ¶æ„&lt;/h1&gt;

&lt;p&gt;ä¸‹é¢æ˜¯å®šæ—¶æé†’éƒ¨åˆ†çš„æ¶æ„å›¾ï¼š&lt;/p&gt;



&lt;div class=&#34;box&#34;&gt;
&lt;figure  itemprop=&#34;associatedMedia&#34;
  itemscope itemtype=&#34;http://schema.org/ImageObject&#34; &gt;
    &lt;div class=&#34;img&#34;&gt;
      &lt;img itemprop=&#34;thumbnail&#34; src=&#34;//blog.betacat.io/image/wecron-schedule/wecron-schedule-architecture.png&#34; alt=&#34;WeCronå®šæ—¶åŠŸèƒ½æ¶æ„å›¾&#34;/&gt;
    &lt;/div&gt;
    &lt;a href=&#34;//blog.betacat.io/image/wecron-schedule/wecron-schedule-architecture.png&#34; itemprop=&#34;contentUrl&#34;&gt;&lt;/a&gt;
      &lt;figcaption&gt;
          &lt;p&gt;WeCronå®šæ—¶åŠŸèƒ½æ¶æ„å›¾&lt;/p&gt;
      &lt;/figcaption&gt;
  &lt;/figure&gt;
&lt;/div&gt;


&lt;p&gt;æ•´ä¸ªæµç¨‹è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ï¼š&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;ç”¨æˆ·è¾“å…¥ä¸€æ¡æé†’è¯­éŸ³åï¼Œ&lt;code&gt;parser&lt;/code&gt;ä¼šæŠŠå…¶ä¸­çš„æ—¶é—´å’Œäº‹ä»¶ä¿¡æ¯è§£æå‡ºæ¥ï¼Œå­˜åˆ°æ•°æ®åº“ä¸­ï¼›&lt;/li&gt;
&lt;li&gt;åŒæ—¶ï¼Œå®šæ—¶è°ƒåº¦å™¨ä¼šè¢«è§¦å‘ï¼Œå®ƒåˆ°æ•°æ®åº“ä¸­æ‰¾åˆ°ä¸€ä¸ªæœ€è¿‘çš„æé†’ï¼Œè®¡ç®—å‡ºåˆ°å½“å‰æ—¶é—´çš„æ—¶é—´å·®ï¼Œç„¶åsleepç›¸åº”çš„ç§’æ•°ï¼›&lt;/li&gt;
&lt;li&gt;è¿‡æ®µæ—¶é—´ï¼Œè°ƒåº¦å™¨é†’æ¥ï¼Œå®ƒä¼šå°†æœ€è¿‘ä¸€æ®µæ—¶é—´è¦å‘é€çš„æé†’ä»»åŠ¡æäº¤åˆ°ä¸€ä¸ªé˜Ÿåˆ—é‡Œé¢ï¼Œç”±ä¸“é—¨å‘é€æ¶ˆæ¯çš„workerå‘ç”¨æˆ·æ¨é€æ¶ˆæ¯ã€‚è¿™é‡Œä½¿ç”¨é˜Ÿåˆ—çš„ç›®çš„ï¼Œä¸€æ–¹é¢æ˜¯æ¶ˆå³°ï¼Œå¦ä¸€æ–¹é¢æ˜¯ä¸ºäº†è®©å‘é€æ¶ˆæ¯çš„workerèƒ½å¤Ÿæ¨ªå‘æ‰©å±•ã€‚&lt;/li&gt;
&lt;/ol&gt;

&lt;h1 id=&#34;å®šæ—¶è°ƒåº¦å™¨&#34;&gt;å®šæ—¶è°ƒåº¦å™¨&lt;/h1&gt;

&lt;p&gt;å®šæ—¶æé†’ç±»ç³»ç»Ÿæœ‰ä¸€ä¸ªç‰¹ç‚¹ï¼Œå°±æ˜¯å®ƒçš„å³°å€¼ç‰¹åˆ«æ˜æ˜¾ã€‚ç”¨æˆ·è®¾ç½®çš„æé†’å¤§å¤šä¼šé›†ä¸­åœ¨æ•´ç‚¹æ—¶é—´è§¦å‘ï¼Œå°¤å…¶æ˜¯æ—©æ™¨8ã€9ç‚¹ã€‚é¢å¯¹è¿™æ ·ä¸€ä¸ªä¸å‡è¡¡çš„åˆ†å¸ƒï¼Œå›ºå®šæ—¶é—´è½®è®­çš„è°ƒåº¦æ³•å°±æ˜¾å¾—æœ‰äº›naÃ¯Ã¯veï¼Œå®ƒå¾ˆéš¾åœ¨è¿è¡Œæ•ˆç‡å’Œæé†’çš„åŠæ—¶æ€§ä¸­æ‰¾åˆ°ä¸€ä¸ªå¹³è¡¡ç‚¹ã€‚å› æ­¤ï¼ŒWeCronä¸­å®šæ—¶è°ƒåº¦å™¨è¢«è®¾è®¡ä¸ºä¸€ä¸ªäº‹ä»¶å¾ªç¯ï¼Œå®ƒèƒ½å“åº”ä¸¤ç§äº‹ä»¶ï¼š&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;æ•°æ®åº“æœ‰æ›´æ–°æˆ–è€…æ’å…¥æ“ä½œ&lt;/li&gt;
&lt;li&gt;ä¸Šä¸€æ¬¡è®¾ç½®çš„ä¼‘çœ æ—¶é—´åˆ°äº†&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;æ¯å½“è¿™ä¸ªè°ƒåº¦å™¨è¢«å”¤é†’ï¼Œå®ƒä¼šé¦–å…ˆæ£€æŸ¥æœ‰æ²¡æœ‰æé†’è¦å‘é€ï¼Œç„¶åå†æ‰¾åˆ°æœ€è¿‘ä¸€ä¸ªå°†è¦è§¦å‘çš„æé†’ï¼Œä¼‘çœ ç›¸åº”çš„æ—¶é—´ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªç®€çŸ­çš„å®ç°ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-python&#34; data-lang=&#34;python&#34;&gt;&lt;span class=&#34;lnt&#34;&gt; 1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 2
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 3
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 4
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 5
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 6
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 7
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 8
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 9
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;10
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;11
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;12
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;13
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;14
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;15
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;16
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;17
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;18
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;19
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;20
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-python&#34; data-lang=&#34;python&#34;&gt;&lt;span class=&#34;n&#34;&gt;remind_event&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;threading&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Event&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;

&lt;span class=&#34;k&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;event_loop&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;():&lt;/span&gt;
    &lt;span class=&#34;k&#34;&gt;while&lt;/span&gt; &lt;span class=&#34;bp&#34;&gt;True&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;
        &lt;span class=&#34;n&#34;&gt;wait_seconds&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;process_jobs&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;
        &lt;span class=&#34;c1&#34;&gt;# This event wakes up on timeout or someone else sets it&lt;/span&gt;
        &lt;span class=&#34;n&#34;&gt;remind_event&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;wait&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;wait_seconds&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;

&lt;span class=&#34;k&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;on_remind_update&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;():&lt;/span&gt;
    &lt;span class=&#34;c1&#34;&gt;# This will wake up the remind_event&lt;/span&gt;
    &lt;span class=&#34;n&#34;&gt;remind_event&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;set&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;

&lt;span class=&#34;k&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;process_jobs&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;():&lt;/span&gt;
    &lt;span class=&#34;c1&#34;&gt;# Send reminds&lt;/span&gt;
    &lt;span class=&#34;n&#34;&gt;reminds&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;get_unfired_reminds_older_than_now&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;
    &lt;span class=&#34;n&#34;&gt;send_notification&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;reminds&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;

    &lt;span class=&#34;c1&#34;&gt;# And get the most recent remind&lt;/span&gt;
    &lt;span class=&#34;n&#34;&gt;next_remind&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;get_unfired_reminds_newer_than_now&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;limit&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
    &lt;span class=&#34;k&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;next_remind&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;notify_time&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;-&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;now&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;seconds&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;å¦å¤–ï¼Œä¸ºäº†æé«˜æé†’çš„åŠæ—¶æ€§ï¼Œè¿™é‡Œçš„è°ƒåº¦å™¨ä¼šè¢«å¯åŠ¨å¥½å‡ ä»½ã€‚è¿™æ—¶é¢ä¸´çš„ä¸€ä¸ªé—®é¢˜å°±æ˜¯åŒä¸€ä¸ªæé†’å¯èƒ½ä¼šè¢«å¤šä¸ªè°ƒåº¦å™¨è°ƒåº¦åˆ°ï¼Œç”¨æˆ·ä¹Ÿå°±æœ‰å¯èƒ½é‡å¤æ”¶åˆ°æé†’ã€‚æ‰€ä»¥WeCronåœ¨é€‰æ‹©æé†’é¡¹çš„æ—¶å€™ä½¿ç”¨äº†&lt;code&gt;select ... for update&lt;/code&gt;è¯­å¥ï¼Œåˆ©ç”¨ï¼ˆè¡Œï¼‰é”æ¥åŒæ­¥å¤šä¸ªè°ƒåº¦å™¨ã€‚&lt;/p&gt;

&lt;h1 id=&#34;ç»“æŸ&#34;&gt;ç»“æŸ&lt;/h1&gt;

&lt;p&gt;å¥½äº†ï¼Œæˆ‘å°±å…ˆç®€å•çš„ä»‹ç»åˆ°è¿™é‡Œï¼Œå¸Œæœ›å¯ä»¥å¸®åŠ©åˆ°æœ‰éœ€è¦çš„äººã€‚å¦‚æœæƒ³è¦çœ‹åˆ°å…·ä½“å®ç°ï¼Œè¯·å‚è€ƒWeCronçš„&lt;a href=&#34;https://github.com/polyrabbit/WeCron&#34;&gt;ä»£ç åº“&lt;/a&gt;ã€‚å¦‚æœæƒ³è¦ä½“éªŒè¿™ä¸ªå®šæ—¶åŠŸèƒ½ï¼Œä¹Ÿæ¬¢è¿æ‰«ç å…³æ³¨ğŸ˜ï¼š


&lt;div class=&#34;box&#34;&gt;
&lt;figure  itemprop=&#34;associatedMedia&#34;
  itemscope itemtype=&#34;http://schema.org/ImageObject&#34; 
  style=&#34;max-width:150px&#34; &gt;
    &lt;div class=&#34;img&#34;&gt;
      &lt;img itemprop=&#34;thumbnail&#34; src=&#34;https://camo.githubusercontent.com/6f87c83d4bb324babcf1fd94751cf1ead16be13e/687474703a2f2f7778332e73696e61696d672e636e2f6d773639302f61633437323334386c793166696c646438686d677a6a323037363037366467612e6a7067&#34; /&gt;
    &lt;/div&gt;
    &lt;a href=&#34;https://camo.githubusercontent.com/6f87c83d4bb324babcf1fd94751cf1ead16be13e/687474703a2f2f7778332e73696e61696d672e636e2f6d773639302f61633437323334386c793166696c646438686d677a6a323037363037366467612e6a7067&#34; itemprop=&#34;contentUrl&#34;&gt;&lt;/a&gt;
  &lt;/figure&gt;
&lt;/div&gt;
&lt;/p&gt;
</description>
      
    </item>
    
  </channel>
</rss>
